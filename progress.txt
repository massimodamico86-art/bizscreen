# Progress Log

## Learnings
(Patterns discovered during implementation)

---

## Iteration 1 - US-001: Create database function for scenes with device counts
- What was implemented:
  - Created `get_scenes_with_device_counts(p_tenant_id UUID)` function
  - Returns JSON array of scenes with nested layout/playlist objects and deviceCount
  - Uses subquery for device count instead of N+1 pattern
  - SECURITY DEFINER with explicit tenant/superadmin check
- Files changed:
  - `supabase/migrations/109_scenes_device_counts_function.sql` (new)
- Learnings for future iterations:
  - Supabase nested selects return objects like `layout: {id, name}` - must match this format in RPC
  - Use `COALESCE(json_agg(...), '[]'::JSON)` to handle empty results
  - Device count uses correlated subquery - efficient with index on `tv_devices.active_scene_id`
  - Build passes (no typecheck script, but `npm run build` works)
---

## Iteration 2 - US-002: Update sceneService to use new database function
- What was implemented:
  - Replaced `fetchScenesWithDeviceCounts()` to call RPC `get_scenes_with_device_counts`
  - Added descriptive error message on failure
  - Kept `getDeviceCountByScene()` - still used by SceneDetailPage.jsx for single scene view
- Files changed:
  - `src/services/sceneService.js` (modified)
- Learnings for future iterations:
  - Check all usages before removing a function - Grep for function name across src/
  - Supabase RPC call: `supabase.rpc('function_name', { param: value })`
  - RPC returns `{ data, error }` like regular queries
---

## Iteration 3 - US-003: Add missing indexes to layout_zones table
- What was implemented:
  - NO CODE CHANGES - indexes already exist!
  - Verified existing indexes in migrations 014 and 061
- Files changed:
  - None (PRD updated to reflect existing state)
- Learnings for future iterations:
  - ALWAYS verify audit findings before implementing - grep for `idx_` patterns
  - Indexes found: `idx_layout_zones_layout_id`, `idx_layout_zones_playlist_id`, `idx_layout_zones_media_id`
  - Partial indexes used: `WHERE assigned_playlist_id IS NOT NULL` - good for sparse columns
---

## Iteration 4 - US-004: Add server-side pagination to fetchScenesForTenant
- What was implemented:
  - Updated `fetchScenesForTenant()` to accept `{ page, pageSize }` params
  - Added `.range(from, to)` for offset-based pagination
  - Added `{ count: 'exact' }` option to get total count
  - Returns `{ data, totalCount, page, pageSize, totalPages }` object
  - Updated callers: App.jsx, ContentPerformancePage.jsx
- Files changed:
  - `src/services/sceneService.js` (modified)
  - `src/App.jsx` (modified)
  - `src/pages/ContentPerformancePage.jsx` (modified)
- Learnings for future iterations:
  - ALWAYS grep for function usages before changing return shape
  - Supabase pagination: `.range(from, to)` where from/to are 0-indexed
  - Get total count: `select('*', { count: 'exact' })` returns `count` in response
  - Callers checking `.length` must change to `.totalCount` or `.data.length`
---

## Iteration 5 - US-005: Update ScenesPage to use paginated fetch
- What was implemented:
  - Created migration 111 to add pagination to RPC function `get_scenes_with_device_counts`
  - Updated `fetchScenesWithDeviceCounts()` service to accept pagination params
  - Added pagination state and URL params to ScenesPage (useSearchParams)
  - Added Previous/Next pagination controls with page counter
  - Loading state disables buttons during transitions
- Files changed:
  - `supabase/migrations/111_scenes_device_counts_pagination.sql` (new)
  - `src/services/sceneService.js` (modified)
  - `src/pages/ScenesPage.jsx` (modified)
- Learnings for future iterations:
  - When RPC function already exists, update it in a new migration (don't modify old migration)
  - Use `DROP FUNCTION IF EXISTS` before `CREATE OR REPLACE` when changing params
  - React Router's `useSearchParams` hook for URL state management
  - `useCallback` for functions used in useEffect dependencies
---

## Iteration 6 - US-006: Add server-side pagination to fetchMediaAssets
- What was implemented:
  - Updated `fetchMediaAssets()` to accept `{ page, pageSize }` params
  - Added `.range()` and `{ count: 'exact' }` for pagination
  - Returns `{ data, totalCount, page, pageSize, totalPages }` object
  - Updated InsertContentModal.jsx to use `result?.data`
- Files changed:
  - `src/services/mediaService.js` (modified)
  - `src/components/modals/InsertContentModal.jsx` (modified)
- Learnings for future iterations:
  - PlaylistEditorPage and MediaLibraryPage have their own `fetchMediaAssets` functions that shadow the import
  - Only callers using the actual import from mediaService need updating
  - Grep shows imports AND local function definitions - check actual usage
---

## Iteration 7 - US-007: Update MediaLibraryPage to use server-side pagination
- What was implemented:
  - Replaced local `fetchMediaAssets` function with service call
  - Added `totalCount` and `totalPages` state variables
  - Service now handles search, folder, type filtering server-side
  - Added useEffect hooks to refetch when page/filters change
  - Kept client-side orientation filter (not supported by service yet)
- Files changed:
  - `src/pages/MediaLibraryPage.jsx` (modified)
- Learnings for future iterations:
  - When replacing local function with service, import with alias: `fetchMediaAssets as fetchMediaAssetsService`
  - Complex pages may have multiple filter systems - some server-side, some client-side
  - useCallback for fetch functions to ensure stable dependencies
---

## Iteration 8 - US-008: Add server-side pagination to fetchTemplates
- What was implemented:
  - Updated `fetchTemplates()` to accept `{ page, pageSize }` params
  - Added `.range()` and `{ count: 'exact' }` for pagination
  - Returns `{ data, totalCount, page, pageSize, totalPages }` object
  - Default pageSize = 24 (good for grid)
  - Updated internal callers in templateService.js to use `.data`
  - Updated TemplatesPage.jsx to use new return shape
- Files changed:
  - `src/services/templateService.js` (modified)
  - `src/pages/TemplatesPage.jsx` (modified)
- Learnings for future iterations:
  - Service functions that call other service functions need updating too
  - For grouping/filtering views, fetch all with high pageSize rather than paginated
---
