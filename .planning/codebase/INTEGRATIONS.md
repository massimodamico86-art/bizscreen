# External Integrations

**Analysis Date:** 2026-01-22

## APIs & External Services

**Database & Backend:**
- Supabase - Backend-as-a-Service for database, auth, and realtime
  - SDK/Client: `@supabase/supabase-js` 2.80.0
  - Auth: `VITE_SUPABASE_URL`, `VITE_SUPABASE_ANON_KEY`
  - Usage: User authentication, profile management, content storage, realtime subscriptions
  - Implementation: `src/supabase.js` initializes client with PKCE flow and auto-refresh

**Weather Data:**
- OpenWeatherMap - Weather API for weather widget
  - Endpoint: `https://api.openweathermap.org/data/2.5/weather`
  - Auth: `VITE_OPENWEATHER_API_KEY`
  - Service: `src/services/weatherService.js`
  - Features: Supports Celsius/Fahrenheit, in-memory caching (30-min duration, 50-entry LRU)
  - Fallback: Mock weather data if API key not configured or API fails

**Design & Media:**
- Polotno - Design editor library for SVG template creation
  - SDK/Client: `polotno` 2.33.2
  - Purpose: Template design editor with canvas manipulation
  - Implementation: Used in template/scene creation workflows

- Fabric.js - Canvas drawing and manipulation
  - SDK/Client: `fabric` 6.9.0
  - Purpose: Advanced canvas operations for design features

- QR Code Generation:
  - qrcode 1.5.4 - Core QR code generation
  - qrcode.react 4.2.0 - React component wrapper
  - Purpose: TV device pairing QR codes
  - Implementation: `src/services/qrcodeService.js`

**AI & Auto-Tagging:**
- Anthropic Claude API - AI-powered template tagging
  - Auth: `ANTHROPIC_API_KEY` (server-side only)
  - Purpose: Automated SVG template analysis, tag generation, category suggestions
  - Implementation: `src/services/autoTaggingService.js`
  - Fallback: Rule-based tagging if AI API unavailable
  - Endpoint: `/api/ai/generate-tags` (server-side)

## Data Storage

**Databases:**
- PostgreSQL (via Supabase)
  - Connection: `VITE_SUPABASE_URL` (connection pooling via Supabase)
  - Client: @supabase/supabase-js JavaScript client
  - Tables: 100+ tables across auth, content, scheduling, analytics
  - RLS: Row-level security enabled for multi-tenant isolation
  - Migrations: 114+ migration files in `supabase/migrations/`

**File Storage:**
- AWS S3 - Primary media storage for images, videos, audio, documents
  - Bucket: `AWS_S3_BUCKET` (via environment)
  - Region: `AWS_REGION` (default: us-east-1)
  - Upload Method: Presigned URLs generated by `vite.config.js` middleware
  - Service: `src/services/s3UploadService.js`
  - Supported Types: images, videos, audio, PDFs, Office documents
  - Organization: `/uploads/{mediaType}/{uuid}.{ext}`

- Cloudinary - Optional alternative media storage
  - Cloud Name: `VITE_CLOUDINARY_CLOUD_NAME`
  - Upload Preset: `VITE_CLOUDINARY_UPLOAD_PRESET`
  - Status: Optional, primarily for legacy support or fallback

- Supabase Storage Buckets:
  - Purpose: Additional static assets storage (if needed)

**Caching:**
- IndexedDB - Browser local storage for offline functionality
  - Library: `idb` 8.0.3
  - Purpose: Offline mode caching, draft content storage
  - Service: `src/services/cacheService.js`

- In-Memory Cache:
  - Weather API responses (30-min TTL, 50-entry limit)
  - Various service-level caches for frequent queries

## Authentication & Identity

**Auth Provider:**
- Supabase Auth - Custom authentication with email/password
  - Implementation: `src/supabase.js` with PKCE flow
  - Features:
    - Email/password signup and login
    - Session management with auto-refresh
    - Magic link authentication
    - Multi-factor authentication (MFA) support via `src/services/mfaService.js`
  - Database: PostgreSQL users table via Supabase Auth
  - Session Storage: Browser sessionStorage (via Supabase client config)

**Authorization & RBAC:**
- Database-level roles (via PostgreSQL):
  - `superadmin` - Full platform access
  - `admin` - Multi-client management
  - `client` - Standard tenant user
  - `viewer` - Read-only access
  - `tv_device` - Device-specific auth for players

- Row-Level Security (RLS):
  - PostgreSQL policies enforce tenant isolation
  - Migrations: `009_add_roles_and_rbac.sql`, `011_rbac_tv_qr_pms_activity.sql`, `012_finalize_rls_rbac.sql`

**SSO & Enterprise:**
- Single Sign-On (SSO)
  - Service: `src/services/ssoService.js`
  - Support for enterprise authentication

- SCIM (System for Cross-domain Identity Management)
  - Service: `src/services/scimService.js`
  - Purpose: Enterprise user provisioning integration

## Monitoring & Observability

**Error Tracking:**
- Sentry - Error and crash reporting
  - DSN: `VITE_SENTRY_DSN`
  - Enabled: `VITE_ERROR_TRACKING_ENABLED` (false by default)
  - SDK: @sentry/react 10.36.0
  - Implementation: `src/services/errorTrackingService.js`
  - Status: Optional, console-only mode by default
  - Note: Requires `@sentry/browser` package to be installed separately

**Logs:**
- Console logging (primary in development)
- Structured logging to optional remote endpoint
  - Endpoint: `VITE_LOG_ENDPOINT` (optional)

**Web Vitals & Analytics:**
- Web Vitals - Core Web Vitals collection
  - Library: `web-vitals` 5.1.0
  - Service: `src/services/webVitalsService.js`
  - Purpose: Performance metrics monitoring

- Custom analytics endpoint:
  - `VITE_ANALYTICS_ENDPOINT` (optional)
  - Used by `web-vitals` service for metric submission

**Player Analytics:**
- Playback tracking and screen diagnostics
  - Service: `src/services/playerAnalyticsService.js`
  - Service: `src/services/screenDiagnosticsService.js`
  - Data stored in PostgreSQL via Supabase

## Payments & Billing

**Payment Processor:**
- Stripe - Subscription management and billing
  - Publishable Key: `VITE_STRIPE_PUBLISHABLE_KEY`
  - SDK: `stripe` 20.0.0
  - Implementation: `src/services/billingService.js`
  - Endpoints:
    - `POST /api/billing/checkout` - Create Stripe Checkout session
    - `POST /api/billing/portal` - Create Billing Portal session
  - Features:
    - Plan upgrades (starter, pro)
    - Subscription management
    - Billing portal access
  - Plans stored in database: `src/config/plans.js`

## CI/CD & Deployment

**Hosting:**
- Static site deployment (Vercel, Netlify, AWS S3 + CloudFront, etc.)
- Environment variables configured at deployment platform

**Build:**
- Vite build artifacts: `dist/` directory
- Static files served from: `/public`

**API Routes:**
- Development: Vite middleware (`vite.config.js`)
- Production: Requires serverless functions or backend service:
  - `/api/media/presign` - S3 presigned URL generation
  - `/api/billing/checkout` - Stripe checkout
  - `/api/billing/portal` - Stripe billing portal
  - `/api/ai/generate-tags` - AI template tagging

**Database Migrations:**
- Supabase CLI-compatible migrations in `supabase/migrations/`
- Applied via Supabase dashboard or CLI
- 114+ production migrations with version numbering

## Environment Configuration

**Required env vars:**
- `VITE_SUPABASE_URL` - Supabase project URL (must start with https:// or http://localhost)
- `VITE_SUPABASE_ANON_KEY` - Supabase public key (>20 chars)

**Production-required env vars:**
- `VITE_STRIPE_PUBLISHABLE_KEY` - Stripe public key (format: pk_live_* or pk_test_*)
- `VITE_CLOUDINARY_CLOUD_NAME` - Cloudinary cloud name

**Optional env vars:**
- `VITE_OPENWEATHER_API_KEY` - OpenWeatherMap API key
- `VITE_ERROR_TRACKING_ENABLED` - Enable Sentry (false by default)
- `VITE_SENTRY_DSN` - Sentry DSN
- `VITE_DEVICE_TOKEN` - TV device pairing token
- `VITE_CLOUDINARY_UPLOAD_PRESET` - Cloudinary upload configuration
- `VITE_LOG_ENDPOINT` - Remote logging endpoint
- `VITE_ANALYTICS_ENDPOINT` - Analytics collection endpoint
- `ANTHROPIC_API_KEY` - Claude API for auto-tagging (server-side)
- `AWS_REGION` - S3 region (default: us-east-1)
- `AWS_ACCESS_KEY_ID` - AWS credentials (server-side)
- `AWS_SECRET_ACCESS_KEY` - AWS credentials (server-side)
- `AWS_S3_BUCKET` - S3 bucket name (server-side)
- `AWS_CLOUDFRONT_URL` - CloudFront CDN URL (optional)

**Secrets location:**
- Local development: `.env` file (git-ignored)
- Production: Deployment platform's environment/secrets configuration
- Security: All sensitive keys should use production variants (pk_live_, not pk_test_)

## Webhooks & Callbacks

**Incoming:**
- Stripe webhooks (for subscription events)
  - Handled by backend API routes
  - Events: `charge.succeeded`, `customer.subscription.updated`, etc.

**Outgoing:**
- Webhook Service: `src/services/webhookService.js`
- Purpose: Outbound notifications for external integrations
- Database table: `webhooks` with configuration and logs

**Callbacks:**
- Supabase Auth callback: `{origin}/auth/callback`
  - Used for email verification and password reset flows
  - Email redirect configured in `authService.js`

## Testing Integrations

**E2E Testing:**
- Playwright 1.57.0 for browser automation tests
- Test users created by migration: `060_seed_test_data.sql`
- Credentials (local only):
  - Super Admin: `superadmin@bizscreen.test` / `TestSuperAdmin123!`
  - Admin: `admin@bizscreen.test` / `TestAdmin123!`
  - Client: `client@bizscreen.test` / `TestClient123!`

**Mocking:**
- Mock Service Worker (MSW) 2.12.3 for API mocking in tests
- JSDOM 27.3.0 for DOM simulation in unit tests

---

*Integration audit: 2026-01-22*
