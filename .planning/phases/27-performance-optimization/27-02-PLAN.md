---
phase: 27-performance-optimization
plan: 02
type: execute
wave: 2
depends_on: [27-01]
files_modified:
  - package.json
  - .planning/phases/27-performance-optimization/27-VERIFICATION.md
autonomous: true

must_haves:
  truths:
    - "package.json has sideEffects: false for tree shaking"
    - "Tree shaking is verified working (unused exports not in bundle)"
    - "Major routes load separate chunks (dashboard, editor, player)"
  artifacts:
    - path: "package.json"
      provides: "sideEffects configuration"
      contains: '"sideEffects"'
    - path: ".planning/phases/27-performance-optimization/27-VERIFICATION.md"
      provides: "Tree shaking verification results"
      min_lines: 30
  key_links:
    - from: "package.json"
      to: "dist/assets/*.js"
      via: "Vite build with tree shaking"
      pattern: '"sideEffects".*false'
---

<objective>
Implement code splitting optimizations and verify tree shaking

Purpose: Apply optimizations identified in Plan 27-01's baseline analysis. Enable tree shaking via sideEffects flag, verify it works, and optimize the Player route based on explicit criteria from baseline findings.

Output: Optimized bundle with verified tree shaking, documented verification results
</objective>

<execution_context>
@/Users/massimodamico/.claude/get-shit-done/workflows/execute-plan.md
@/Users/massimodamico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-performance-optimization/27-RESEARCH.md
@.planning/phases/27-performance-optimization/27-01-SUMMARY.md
@.planning/phases/27-performance-optimization/27-BASELINE.md
@vite.config.js
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable tree shaking and verify it works</name>
  <files>package.json, .planning/phases/27-performance-optimization/27-VERIFICATION.md</files>
  <action>
**Step 1: Add sideEffects to package.json**

Add to package.json (top level, not in scripts):
```json
"sideEffects": ["*.css", "*.scss"]
```

This tells bundlers that all JS modules are side-effect free and safe to tree-shake. CSS files are marked as having side effects since they must always be included.

**Step 2: Build and record baseline bundle state**

Run `npm run build` and record:
- Total bundle size (for comparison)
- Player chunk filename: `dist/assets/Player-*.js`

**Step 3: Verify tree shaking via barrel export analysis**

Check that barrel exports are being tree-shaken by examining what's actually in the Player chunk:

1. Find the Player chunk: `ls dist/assets/Player-*.js`
2. Search for dashboard-specific components that should NOT be in Player:
   ```bash
   grep -E "(Dashboard|Sidebar|CampaignList|ScreenList|MediaLibrary)" dist/assets/Player-*.js
   ```
3. Tree shaking is verified working if:
   - grep returns empty (no dashboard components in Player)
   - OR if grep returns only string literals/comments (not actual component code)

**Step 4: Additional verification via test export**

As secondary verification:
1. Add test export to loggingService.js: `export const TREE_SHAKE_TEST_UNUSED = 'should-not-appear';`
2. Run `npm run build`
3. Verify: `grep -r "TREE_SHAKE_TEST_UNUSED" dist/` returns nothing
4. Remove the test export
5. Run `npm run build` again to produce clean output

**Step 5: Document verification results**

Create 27-VERIFICATION.md with:
- sideEffects configuration applied
- Barrel export analysis results (what was/wasn't in Player chunk)
- Test export verification result
- Before/after bundle comparison

Document the barrel export analysis explicitly - this is the PRIMARY verification method.
  </action>
  <verify>
- `"sideEffects"` exists in package.json
- `npm run build` completes without errors
- `grep -E "(Dashboard|Sidebar|CampaignList)" dist/assets/Player-*.js` returns empty or only string literals
- 27-VERIFICATION.md documents barrel export analysis results
  </verify>
  <done>
Tree shaking is enabled and verified via barrel export analysis (dashboard components absent from Player chunk)
  </done>
</task>

<task type="auto">
  <name>Task 2: Evaluate and optimize Player route (bounded scope)</name>
  <files>.planning/phases/27-performance-optimization/27-VERIFICATION.md</files>
  <action>
**Decision Criteria (read from 27-BASELINE.md):**

Evaluate the "Optimization Opportunities" section of 27-BASELINE.md. Apply the following decision tree:

**OPTIMIZE if ANY of these are true:**
1. Player chunk contains >50KB of dashboard-specific imports (DashboardLayout, Sidebar, CampaignEditor, etc.)
2. Player chunk contains services not used by player (check for CampaignService, ScreenService if Player only needs PlayerService/playlistService)
3. 27-BASELINE.md explicitly recommends Player import refactoring

**DOCUMENT AS OPTIMAL if ALL of these are true:**
1. Player chunk contains only: player/* code, React, hooks, caching/offline services, supabase client
2. No dashboard components found in Player chunk
3. 27-BASELINE.md shows no significant opportunities for Player

**SCOPE BOUNDS:**
- Maximum 5 file modifications allowed in this task
- If optimizations require >5 files: document in 27-VERIFICATION.md as "Future Optimization: [description]" for potential Phase 28 work
- Do NOT refactor shared services or create new abstraction layers

**If OPTIMIZE path:**
1. List specific imports to change (e.g., "Change `import { X } from './components'` to `import X from './components/X'`")
2. Make the changes (max 5 files)
3. Run `npm run build`
4. Document before/after Player chunk size in 27-VERIFICATION.md

**If DOCUMENT AS OPTIMAL path:**
1. Add to 27-VERIFICATION.md:
   ```markdown
   ## Player Route Analysis

   **Decision:** Already optimal

   **Rationale:**
   - Player chunk contains [list what it contains]
   - No dashboard code found
   - Size of 274KB is justified by: [offline caching, service workers, etc.]
   ```

**Re-measure (always):**
Run `npm run build` and compare final chunk sizes to 27-BASELINE.md.
  </action>
  <verify>
- 27-VERIFICATION.md contains "Player Route Analysis" section
- Section contains explicit "Decision:" (either "Optimized" or "Already optimal")
- Section contains "Rationale:" explaining the decision
- If optimized: before/after sizes documented
- If deferred work exists: documented as "Future Optimization"
- `npm run build` succeeds
  </verify>
  <done>
Player route evaluation complete with documented decision, rationale, and measurements
  </done>
</task>

<task type="auto">
  <name>Task 3: Document final state and ongoing practices</name>
  <files>.planning/phases/27-performance-optimization/27-VERIFICATION.md</files>
  <action>
Complete 27-VERIFICATION.md with final documentation:

**Final Metrics:**
Compare to baseline from 27-BASELINE.md:
```markdown
## Final Metrics

| Metric | Baseline | After | Change |
|--------|----------|-------|--------|
| Total size (gzip) | X MB | X MB | +/- X% |
| Initial load (gzip) | X KB | X KB | +/- X% |
| Player chunk (gzip) | X KB | X KB | +/- X% |
```

**Route Chunk Verification:**
Confirm major routes have separate chunks:
- Dashboard (App.jsx) loads its own chunk
- Editor pages load their own chunks
- Player loads its own chunk without dashboard code

Method: Check dist/assets/ for route-specific chunks, verify via bundle visualizer.

**Ongoing Practices:**
Add guidance for maintaining bundle health:
```markdown
## Ongoing Practices

### When to run bundle analysis
- Before merging large feature branches
- When adding new dependencies
- Quarterly review

### Warning signs to watch for
- New chunks >200KB (gzip)
- Initial load increasing
- Player chunk growing

### How to investigate issues
1. Run `npm run analyze`
2. Find suspicious chunk in treemap
3. Check imports for unexpected dependencies
```

**Requirements Verification:**
- PERF-01: Bundle analysis report exists with baseline metrics - 27-BASELINE.md
- PERF-02: Major routes load their own chunks - verify and document
- PERF-03: Unused exports not in production bundles - tree shake test passed
  </action>
  <verify>
- 27-VERIFICATION.md contains final metrics comparison
- Route chunk separation is verified and documented
- Ongoing practices section exists
- All three PERF requirements addressed
  </verify>
  <done>
Verification documentation complete with final metrics, route verification, and ongoing guidance
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds
2. `grep -E "(Dashboard|Sidebar|CampaignList)" dist/assets/Player-*.js` returns empty
3. 27-VERIFICATION.md exists with complete documentation including:
   - Tree shaking verification via barrel export analysis
   - Player Route Analysis with explicit decision and rationale
4. All PERF requirements (PERF-01, PERF-02, PERF-03) are satisfied
</verification>

<success_criteria>
- Tree shaking enabled (`sideEffects: false` in package.json)
- Tree shaking verified via barrel export analysis (primary) and test export (secondary)
- Player route evaluated with explicit decision criteria and documented rationale
- If optimizations applied: max 5 files changed, before/after sizes documented
- If optimizations deferred: documented as Future Optimization with scope
- Major routes confirmed loading separate chunks (PERF-02)
- Final metrics documented with comparison to baseline
- Ongoing bundle monitoring guidance documented
- Phase 27 complete: PERF-01, PERF-02, PERF-03 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/27-performance-optimization/27-02-SUMMARY.md`
</output>
