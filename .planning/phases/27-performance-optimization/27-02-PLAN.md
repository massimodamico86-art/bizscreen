---
phase: 27-performance-optimization
plan: 02
type: execute
wave: 2
depends_on: [27-01]
files_modified:
  - package.json
  - .planning/phases/27-performance-optimization/27-VERIFICATION.md
autonomous: true

must_haves:
  truths:
    - "package.json has sideEffects: false for tree shaking"
    - "Tree shaking is verified working (unused exports not in bundle)"
    - "Major routes load separate chunks (dashboard, editor, player)"
  artifacts:
    - path: "package.json"
      provides: "sideEffects configuration"
      contains: '"sideEffects"'
    - path: ".planning/phases/27-performance-optimization/27-VERIFICATION.md"
      provides: "Tree shaking verification results"
      min_lines: 30
  key_links:
    - from: "package.json"
      to: "dist/assets/*.js"
      via: "Vite build with tree shaking"
      pattern: '"sideEffects".*false'
---

<objective>
Implement code splitting optimizations and verify tree shaking

Purpose: Apply optimizations identified in Plan 27-01's baseline analysis. Enable tree shaking via sideEffects flag, verify it works, and optimize the Player route if necessary.

Output: Optimized bundle with verified tree shaking, documented verification results
</objective>

<execution_context>
@/Users/massimodamico/.claude/get-shit-done/workflows/execute-plan.md
@/Users/massimodamico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-performance-optimization/27-RESEARCH.md
@.planning/phases/27-performance-optimization/27-01-SUMMARY.md
@.planning/phases/27-performance-optimization/27-BASELINE.md
@vite.config.js
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable tree shaking and verify it works</name>
  <files>package.json, .planning/phases/27-performance-optimization/27-VERIFICATION.md</files>
  <action>
**Step 1: Add sideEffects to package.json**

Add to package.json (top level, not in scripts):
```json
"sideEffects": ["*.css", "*.scss"]
```

This tells bundlers that all JS modules are side-effect free and safe to tree-shake. CSS files are marked as having side effects since they must always be included.

**Step 2: Verify tree shaking works**

Method: Create a temporary unused export, build, and verify it's not in the bundle.

1. Add a clearly named unused export to a file that IS used (e.g., add `export const TREE_SHAKE_TEST_UNUSED = 'should-not-appear';` to src/services/loggingService.js)
2. Run `npm run build`
3. Search the dist folder: `grep -r "TREE_SHAKE_TEST_UNUSED" dist/`
4. If grep returns nothing, tree shaking is working
5. Remove the test export

**Step 3: Verify barrel exports are tree-shaken**

Check if importing from player/components/index.js pulls in all components:
1. Find a file that imports only one component from the barrel
2. Check if other unused exports appear in that file's chunk
3. Document findings

**Step 4: Document verification results**

Create 27-VERIFICATION.md with:
- sideEffects configuration applied
- Tree shake test results
- Barrel export analysis
- Before/after bundle sizes if changes were made
  </action>
  <verify>
- `"sideEffects"` exists in package.json
- `npm run build` completes without errors
- Tree shake test export is NOT in dist/ (grep returns empty)
- 27-VERIFICATION.md documents results
  </verify>
  <done>
Tree shaking is enabled and verified working via test export
  </done>
</task>

<task type="auto">
  <name>Task 2: Optimize Player route if needed</name>
  <files>Varies based on 27-01 findings</files>
  <action>
Based on findings from 27-01-SUMMARY.md and 27-BASELINE.md, apply Player route optimizations if needed.

**If Player chunk contains dashboard code:**
- Ensure Player.jsx and ViewPage only import from:
  - player/ directory
  - services/ (only services actually used by player)
  - hooks/ (only hooks actually used by player)
- Check for accidental imports that pull in dashboard components

**If barrel exports are bloating Player:**
- Consider direct imports instead of barrel imports for performance-critical player code
- Example: `import { ViewPage } from './player/pages/ViewPage'` instead of `import { ViewPage } from './player/pages'`

**If no significant opportunities found:**
- Document that Player route is already well-optimized
- The 274KB includes necessary dependencies (React, hooks, services for offline playback)

**Apply optimizations:**
Only make changes if 27-01 analysis identified specific, impactful opportunities. The Player handles offline playback which legitimately requires caching and offline services.

**Re-measure:**
Run `npm run build` after any changes and compare chunk sizes to baseline.
  </action>
  <verify>
- If changes made: `npm run build` succeeds and Player chunk size documented
- If no changes: Document reasoning in 27-VERIFICATION.md
- No regressions in functionality
  </verify>
  <done>
Player route is optimized (or confirmed already optimal) with documented results
  </done>
</task>

<task type="auto">
  <name>Task 3: Document final state and ongoing practices</name>
  <files>.planning/phases/27-performance-optimization/27-VERIFICATION.md</files>
  <action>
Complete 27-VERIFICATION.md with final documentation:

**Final Metrics:**
Compare to baseline from 27-BASELINE.md:
```markdown
## Final Metrics

| Metric | Baseline | After | Change |
|--------|----------|-------|--------|
| Total size (gzip) | X MB | X MB | +/- X% |
| Initial load (gzip) | X KB | X KB | +/- X% |
| Player chunk (gzip) | X KB | X KB | +/- X% |
```

**Route Chunk Verification:**
Confirm major routes have separate chunks:
- Dashboard (App.jsx) loads its own chunk
- Editor pages load their own chunks
- Player loads its own chunk without dashboard code

Method: Check dist/assets/ for route-specific chunks, verify via bundle visualizer.

**Ongoing Practices:**
Add guidance for maintaining bundle health:
```markdown
## Ongoing Practices

### When to run bundle analysis
- Before merging large feature branches
- When adding new dependencies
- Quarterly review

### Warning signs to watch for
- New chunks >200KB (gzip)
- Initial load increasing
- Player chunk growing

### How to investigate issues
1. Run `npm run analyze`
2. Find suspicious chunk in treemap
3. Check imports for unexpected dependencies
```

**Requirements Verification:**
- PERF-01: Bundle analysis report exists with baseline metrics - 27-BASELINE.md
- PERF-02: Major routes load their own chunks - verify and document
- PERF-03: Unused exports not in production bundles - tree shake test passed
  </action>
  <verify>
- 27-VERIFICATION.md contains final metrics comparison
- Route chunk separation is verified and documented
- Ongoing practices section exists
- All three PERF requirements addressed
  </verify>
  <done>
Verification documentation complete with final metrics, route verification, and ongoing guidance
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. `npm run build` succeeds
2. `grep -r "TREE_SHAKE_TEST_UNUSED" dist/` returns nothing (test was removed after verification)
3. 27-VERIFICATION.md exists with complete documentation
4. All PERF requirements (PERF-01, PERF-02, PERF-03) are satisfied
</verification>

<success_criteria>
- Tree shaking enabled (`sideEffects: false` in package.json)
- Tree shaking verified working (test export not in bundle)
- Player route analyzed and optimized if opportunities exist
- Major routes confirmed loading separate chunks (PERF-02)
- Final metrics documented with comparison to baseline
- Ongoing bundle monitoring guidance documented
- Phase 27 complete: PERF-01, PERF-02, PERF-03 satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/27-performance-optimization/27-02-SUMMARY.md`
</output>
