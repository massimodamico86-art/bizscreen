---
phase: 23-platform-polish-onboarding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/136_welcome_tour_onboarding.sql
  - src/services/onboardingService.js
  - src/components/onboarding/WelcomeTour.jsx
  - src/components/onboarding/WelcomeTourStep.jsx
  - src/components/onboarding/index.js

autonomous: true

must_haves:
  truths:
    - "New users see welcome tour modal on first dashboard visit"
    - "Tour has 5-6 steps explaining key features"
    - "User can navigate between tour steps with Next/Back"
    - "Tour ends with call-to-action linking to starter pack selection"
    - "Tour can be skipped via subtle skip link"
    - "Tour progress persists across page refreshes"
  artifacts:
    - path: "supabase/migrations/136_welcome_tour_onboarding.sql"
      provides: "Schema extension for tour progress tracking"
      contains: "completed_welcome_tour"
    - path: "src/components/onboarding/WelcomeTour.jsx"
      provides: "Modal wizard for 5-6 step feature tour"
      min_lines: 150
    - path: "src/components/onboarding/WelcomeTourStep.jsx"
      provides: "Individual step rendering with illustration"
      min_lines: 50
  key_links:
    - from: "src/components/onboarding/WelcomeTour.jsx"
      to: "onboardingService"
      via: "getOnboardingProgress, updateWelcomeTourStep"
      pattern: "onboardingService"
---

<objective>
Create welcome tour modal for new users with 5-6 step feature walkthrough.

Purpose: Guide new users through BizScreen's key features (content, screens, scheduling, templates, media) in a modern modal wizard format before routing them to starter pack selection.

Output: WelcomeTour component, database schema extension, and onboardingService updates.
</objective>

<execution_context>
@/Users/massimodamico/.claude/get-shit-done/workflows/execute-plan.md
@/Users/massimodamico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-platform-polish-onboarding/23-CONTEXT.md
@.planning/phases/23-platform-polish-onboarding/23-RESEARCH.md

Key existing files:
@src/services/onboardingService.js - Existing service with RPC functions
@src/components/OnboardingWizard.jsx - Existing task wizard (different from feature tour)
@src/design-system/components/Modal.jsx - Modal component with size/animation props
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend onboarding schema for welcome tour tracking</name>
  <files>supabase/migrations/136_welcome_tour_onboarding.sql</files>
  <action>
Create migration to extend onboarding_progress table:

```sql
-- Add tour-specific columns to existing onboarding_progress table
ALTER TABLE public.onboarding_progress
  ADD COLUMN IF NOT EXISTS completed_welcome_tour BOOLEAN DEFAULT false,
  ADD COLUMN IF NOT EXISTS current_tour_step INTEGER DEFAULT 0,
  ADD COLUMN IF NOT EXISTS tour_skipped_at TIMESTAMPTZ;

-- Create RPC to get/update welcome tour progress
CREATE OR REPLACE FUNCTION public.get_welcome_tour_progress()
RETURNS TABLE (
  completed_welcome_tour BOOLEAN,
  current_tour_step INTEGER,
  tour_skipped_at TIMESTAMPTZ,
  skipped_at TIMESTAMPTZ
)
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  -- Ensure row exists
  INSERT INTO public.onboarding_progress (user_id)
  VALUES (auth.uid())
  ON CONFLICT (user_id) DO NOTHING;

  RETURN QUERY
  SELECT
    op.completed_welcome_tour,
    op.current_tour_step,
    op.tour_skipped_at,
    op.skipped_at
  FROM public.onboarding_progress op
  WHERE op.user_id = auth.uid();
END;
$$;

CREATE OR REPLACE FUNCTION public.update_welcome_tour_step(
  p_step INTEGER,
  p_completed BOOLEAN DEFAULT false
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_result JSONB;
BEGIN
  -- Ensure row exists
  INSERT INTO public.onboarding_progress (user_id)
  VALUES (auth.uid())
  ON CONFLICT (user_id) DO NOTHING;

  IF p_completed THEN
    -- Mark tour as complete
    UPDATE public.onboarding_progress
    SET completed_welcome_tour = true,
        current_tour_step = p_step,
        updated_at = now()
    WHERE user_id = auth.uid();
  ELSE
    -- Update current step
    UPDATE public.onboarding_progress
    SET current_tour_step = p_step,
        updated_at = now()
    WHERE user_id = auth.uid();
  END IF;

  v_result := jsonb_build_object(
    'success', true,
    'step', p_step,
    'completed', p_completed
  );

  RETURN v_result;
END;
$$;

CREATE OR REPLACE FUNCTION public.skip_welcome_tour()
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  INSERT INTO public.onboarding_progress (user_id, tour_skipped_at)
  VALUES (auth.uid(), now())
  ON CONFLICT (user_id)
  DO UPDATE SET tour_skipped_at = now(), updated_at = now();

  RETURN jsonb_build_object('success', true);
END;
$$;
```

Grant execute permissions to authenticated users.
  </action>
  <verify>Run `supabase db push --local` succeeds or test migration with Supabase CLI</verify>
  <done>Migration file exists with ALTER TABLE, RPCs for get/update/skip tour progress</done>
</task>

<task type="auto">
  <name>Task 2: Create WelcomeTour component with step-by-step feature walkthrough</name>
  <files>src/components/onboarding/WelcomeTour.jsx, src/components/onboarding/WelcomeTourStep.jsx, src/components/onboarding/index.js</files>
  <action>
Create new WelcomeTour.jsx component:

1. Import Modal from design-system, framer-motion for AnimatePresence transitions, lucide icons
2. Define TOUR_STEPS array with 5-6 steps:
   - Step 1: "Welcome to BizScreen" - Overview of digital signage platform
   - Step 2: "Your Media Library" - Upload and organize images/videos (Image icon)
   - Step 3: "Create Playlists" - Arrange media into playlists (ListVideo icon)
   - Step 4: "Design with Templates" - Browse marketplace for pre-built scenes (LayoutTemplate icon)
   - Step 5: "Manage Your Screens" - Register and pair displays (Monitor icon)
   - Step 6: "Schedule Content" - Set up when content plays (Calendar icon)

3. Component structure:
```jsx
export function WelcomeTour({ isOpen, onClose, onComplete, onGetStarted }) {
  const [currentStep, setCurrentStep] = useState(0);
  const [loading, setLoading] = useState(true);
  const [tourProgress, setTourProgress] = useState(null);

  // Load tour progress on mount
  useEffect(() => {
    if (isOpen) loadTourProgress();
  }, [isOpen]);

  // Persist step changes
  const handleStepChange = async (newStep) => {
    setCurrentStep(newStep);
    await updateWelcomeTourStep(newStep);
  };

  const handleComplete = async () => {
    await updateWelcomeTourStep(TOUR_STEPS.length - 1, true);
    onComplete?.();
    onGetStarted?.(); // Route to starter pack selection
  };

  const handleSkip = async () => {
    await skipWelcomeTour();
    onClose();
  };

  // Modal with full-height content, step dots, next/back buttons
  // Use AnimatePresence for smooth step transitions
  // Final step has "Get Started with Templates" CTA button
}
```

4. Create WelcomeTourStep.jsx for individual step rendering:
   - Takes step object with title, description, icon, illustration
   - Renders centered content with icon/illustration at top
   - Description text below
   - Use framer-motion fadeIn for entrance animation

5. Visual design:
   - Modal size="lg" for comfortable reading
   - Gradient header (blue-600 to indigo-600)
   - Step indicator dots at bottom
   - "Skip for now" subtle link below main navigation
   - Next/Back buttons in footer
   - Final step changes to "Get Started" primary button

6. Update index.js barrel exports to include WelcomeTour, WelcomeTourStep
  </action>
  <verify>Component renders, steps navigate correctly, tour completes</verify>
  <done>WelcomeTour modal shows 5-6 feature steps with animations, progress dots, skip link</done>
</task>

<task type="auto">
  <name>Task 3: Extend onboardingService with tour-specific functions</name>
  <files>src/services/onboardingService.js</files>
  <action>
Add new functions to onboardingService.js:

```javascript
/**
 * Get welcome tour progress
 * @returns {Promise<{completedWelcomeTour: boolean, currentTourStep: number, tourSkippedAt: string|null}>}
 */
export async function getWelcomeTourProgress() {
  const { data, error } = await supabase.rpc('get_welcome_tour_progress');

  if (error) {
    logger.error('Error fetching welcome tour progress:', { error });
    return {
      completedWelcomeTour: false,
      currentTourStep: 0,
      tourSkippedAt: null
    };
  }

  const row = Array.isArray(data) ? data[0] : data;
  return {
    completedWelcomeTour: row?.completed_welcome_tour || false,
    currentTourStep: row?.current_tour_step || 0,
    tourSkippedAt: row?.tour_skipped_at || null,
    skippedAt: row?.skipped_at || null
  };
}

/**
 * Update welcome tour step progress
 * @param {number} step - Current step index
 * @param {boolean} completed - Whether tour is complete
 */
export async function updateWelcomeTourStep(step, completed = false) {
  const { data, error } = await supabase.rpc('update_welcome_tour_step', {
    p_step: step,
    p_completed: completed
  });

  if (error) {
    logger.error('Error updating welcome tour step:', { error });
    return { success: false, error: error.message };
  }

  return data || { success: true };
}

/**
 * Skip welcome tour
 */
export async function skipWelcomeTour() {
  const { data, error } = await supabase.rpc('skip_welcome_tour');

  if (error) {
    logger.error('Error skipping welcome tour:', { error });
    return { success: false, error: error.message };
  }

  return { success: true };
}

/**
 * Check if welcome tour should be shown
 * @returns {Promise<boolean>}
 */
export async function shouldShowWelcomeTour() {
  const progress = await getWelcomeTourProgress();
  return !progress.completedWelcomeTour && !progress.tourSkippedAt && !progress.skippedAt;
}
```

Export all new functions.
  </action>
  <verify>New functions are exported, can be imported and called</verify>
  <done>onboardingService has getWelcomeTourProgress, updateWelcomeTourStep, skipWelcomeTour, shouldShowWelcomeTour</done>
</task>

</tasks>

<verification>
1. Migration applies successfully to database
2. WelcomeTour component renders with all 5-6 steps
3. Step navigation (Next/Back) works correctly
4. Progress persists when modal closes and reopens
5. Skip link dismisses tour and marks as skipped
6. Final step "Get Started" button fires onGetStarted callback
7. Component uses design-system Modal and framer-motion animations
</verification>

<success_criteria>
- [ ] Migration file 136_welcome_tour_onboarding.sql created and valid
- [ ] WelcomeTour.jsx created with 5-6 feature steps
- [ ] WelcomeTourStep.jsx created for individual step rendering
- [ ] onboardingService extended with tour functions
- [ ] Step navigation works with persistence
- [ ] Skip functionality marks tour as skipped
- [ ] Final step routes to starter pack selection (onGetStarted callback)
</success_criteria>

<output>
After completion, create `.planning/phases/23-platform-polish-onboarding/23-01-SUMMARY.md`
</output>
