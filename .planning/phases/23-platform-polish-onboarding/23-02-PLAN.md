---
phase: 23-platform-polish-onboarding
plan: 02
type: execute
wave: 2
depends_on: ["23-01"]
files_modified:
  - supabase/migrations/137_industry_selection.sql
  - src/services/onboardingService.js
  - src/components/onboarding/IndustrySelectionModal.jsx
  - src/components/onboarding/StarterPackOnboarding.jsx
  - src/components/onboarding/OnboardingBanner.jsx
  - src/components/onboarding/index.js
  - src/pages/DashboardPage.jsx
  - src/pages/SettingsPage.jsx

autonomous: true

must_haves:
  truths:
    - "New users see industry selection after welcome tour or on first dashboard visit"
    - "Industry selection offers 10-12 business types in visual grid"
    - "Selecting industry filters template suggestions"
    - "User can select starter pack immediately after industry selection"
    - "Skipped onboarding shows dismissible banner on next dashboard visit"
    - "Onboarding can be restarted from Settings page"
    - "Industry can be changed later from Settings"
  artifacts:
    - path: "supabase/migrations/137_industry_selection.sql"
      provides: "Schema for storing selected industry"
      contains: "selected_industry"
    - path: "src/components/onboarding/IndustrySelectionModal.jsx"
      provides: "Grid of industry cards for selection"
      min_lines: 100
    - path: "src/components/onboarding/StarterPackOnboarding.jsx"
      provides: "Starter pack selection during onboarding flow"
      min_lines: 80
    - path: "src/components/onboarding/OnboardingBanner.jsx"
      provides: "Dismissible banner for incomplete onboarding"
      min_lines: 30
  key_links:
    - from: "src/pages/DashboardPage.jsx"
      to: "IndustrySelectionModal"
      via: "conditional render after tour or first visit"
      pattern: "IndustrySelectionModal"
    - from: "src/pages/SettingsPage.jsx"
      to: "onboarding settings tab"
      via: "new tab with restart/industry change"
      pattern: "onboarding|restartTour"
---

<objective>
Implement industry selection and starter pack flow for new user onboarding.

Purpose: After welcome tour, guide users to select their business type (10-12 options) which filters template suggestions, then offer starter packs. Users who skip can return via Settings or a dashboard banner.

Output: IndustrySelectionModal, StarterPackOnboarding, OnboardingBanner components, Settings integration, and DashboardPage orchestration.
</objective>

<execution_context>
@/Users/massimodamico/.claude/get-shit-done/workflows/execute-plan.md
@/Users/massimodamico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-platform-polish-onboarding/23-CONTEXT.md
@.planning/phases/23-platform-polish-onboarding/23-RESEARCH.md
@.planning/phases/23-platform-polish-onboarding/23-01-SUMMARY.md

Key existing files:
@src/pages/dashboard/WelcomeModal.jsx - Existing BUSINESS_TYPES (5 options)
@src/components/templates/StarterPackCard.jsx - Existing pack display component
@src/components/templates/StarterPacksRow.jsx - Existing row component
@src/services/templateService.js - applyPack, getStarterPacks functions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add industry selection schema and expand industry options</name>
  <files>supabase/migrations/137_industry_selection.sql</files>
  <action>
Create migration to add selected_industry column and track onboarding completion:

```sql
-- Add industry selection column
ALTER TABLE public.onboarding_progress
  ADD COLUMN IF NOT EXISTS selected_industry TEXT,
  ADD COLUMN IF NOT EXISTS industry_selected_at TIMESTAMPTZ,
  ADD COLUMN IF NOT EXISTS starter_pack_applied BOOLEAN DEFAULT false,
  ADD COLUMN IF NOT EXISTS starter_pack_applied_at TIMESTAMPTZ;

-- Create RPC to save industry selection
CREATE OR REPLACE FUNCTION public.set_selected_industry(
  p_industry TEXT
)
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  INSERT INTO public.onboarding_progress (user_id, selected_industry, industry_selected_at)
  VALUES (auth.uid(), p_industry, now())
  ON CONFLICT (user_id)
  DO UPDATE SET
    selected_industry = p_industry,
    industry_selected_at = now(),
    updated_at = now();

  RETURN jsonb_build_object('success', true, 'industry', p_industry);
END;
$$;

-- Create RPC to get user's selected industry
CREATE OR REPLACE FUNCTION public.get_selected_industry()
RETURNS TEXT
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
DECLARE
  v_industry TEXT;
BEGIN
  SELECT selected_industry INTO v_industry
  FROM public.onboarding_progress
  WHERE user_id = auth.uid();

  RETURN v_industry;
END;
$$;

-- Create RPC to mark starter pack as applied
CREATE OR REPLACE FUNCTION public.mark_starter_pack_applied()
RETURNS JSONB
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  UPDATE public.onboarding_progress
  SET starter_pack_applied = true,
      starter_pack_applied_at = now(),
      updated_at = now()
  WHERE user_id = auth.uid();

  RETURN jsonb_build_object('success', true);
END;
$$;

-- Grant permissions
GRANT EXECUTE ON FUNCTION public.set_selected_industry(TEXT) TO authenticated;
GRANT EXECUTE ON FUNCTION public.get_selected_industry() TO authenticated;
GRANT EXECUTE ON FUNCTION public.mark_starter_pack_applied() TO authenticated;
```
  </action>
  <verify>Migration applies successfully</verify>
  <done>Migration adds selected_industry, industry_selected_at, starter_pack_applied columns and RPCs</done>
</task>

<task type="auto">
  <name>Task 2: Create IndustrySelectionModal with expanded industry options</name>
  <files>src/components/onboarding/IndustrySelectionModal.jsx, src/components/onboarding/index.js</files>
  <action>
Create IndustrySelectionModal.jsx:

1. Define expanded INDUSTRIES array with 10-12 options (per CONTEXT.md):
```javascript
const INDUSTRIES = [
  { id: 'restaurant', label: 'Restaurant / Cafe', icon: Utensils, color: 'bg-orange-100 text-orange-600' },
  { id: 'retail', label: 'Retail / Store', icon: ShoppingBag, color: 'bg-blue-100 text-blue-600' },
  { id: 'salon', label: 'Salon / Spa', icon: Scissors, color: 'bg-pink-100 text-pink-600' },
  { id: 'fitness', label: 'Gym / Fitness', icon: Dumbbell, color: 'bg-purple-100 text-purple-600' },
  { id: 'healthcare', label: 'Healthcare', icon: Stethoscope, color: 'bg-cyan-100 text-cyan-600' },
  { id: 'hotel', label: 'Hotel / Hospitality', icon: Building2, color: 'bg-amber-100 text-amber-600' },
  { id: 'education', label: 'Education', icon: GraduationCap, color: 'bg-green-100 text-green-600' },
  { id: 'corporate', label: 'Corporate Office', icon: Briefcase, color: 'bg-slate-100 text-slate-600' },
  { id: 'realestate', label: 'Real Estate', icon: Home, color: 'bg-emerald-100 text-emerald-600' },
  { id: 'auto', label: 'Auto / Dealership', icon: Car, color: 'bg-red-100 text-red-600' },
  { id: 'coffee', label: 'Coffee Shop', icon: Coffee, color: 'bg-yellow-100 text-yellow-700' },
  { id: 'other', label: 'Other Business', icon: Building, color: 'bg-gray-100 text-gray-600' },
];
```

2. Component props:
```jsx
export function IndustrySelectionModal({
  isOpen,
  onClose,
  onSelect,       // Called with industry ID after selection
  currentIndustry, // Pre-selected industry if editing
}) {
  const [selected, setSelected] = useState(currentIndustry);
  const [saving, setSaving] = useState(false);

  const handleConfirm = async () => {
    setSaving(true);
    await setSelectedIndustry(selected);
    onSelect(selected);
    setSaving(false);
  };
}
```

3. Visual design (per CONTEXT.md - grid of cards with icons):
   - Modal size="lg"
   - Header: "What type of business do you run?"
   - Subtext: "We'll suggest templates tailored for your industry"
   - Grid: 3 columns on desktop, 2 on mobile
   - Each card: icon (colored background), label
   - Selected state: ring-2 ring-blue-500, checkmark overlay
   - Footer: "Skip for now" link, "Continue" primary button
   - Skip saves null industry and closes

4. Export from index.js
  </action>
  <verify>Component renders 12 industry cards in responsive grid, selection highlights, confirms correctly</verify>
  <done>IndustrySelectionModal shows 10-12 industries in visual grid with selection and save</done>
</task>

<task type="auto">
  <name>Task 3: Create StarterPackOnboarding for pack selection during onboarding</name>
  <files>src/components/onboarding/StarterPackOnboarding.jsx</files>
  <action>
Create StarterPackOnboarding.jsx:

1. Component wraps starter pack selection for onboarding context:
```jsx
export function StarterPackOnboarding({
  isOpen,
  onClose,
  onComplete,
  industry, // Filter packs by industry if available
}) {
  const [packs, setPacks] = useState([]);
  const [loading, setLoading] = useState(true);
  const [applying, setApplying] = useState(false);
  const [selectedPack, setSelectedPack] = useState(null);

  // Fetch packs filtered by industry
  useEffect(() => {
    if (isOpen) fetchPacks();
  }, [isOpen, industry]);

  const fetchPacks = async () => {
    const data = await getStarterPacks({ industry });
    setPacks(data);
    setLoading(false);
  };

  const handleApply = async (pack, templates) => {
    setApplying(true);
    try {
      await applyPackTemplates(pack, templates);
      await markStarterPackApplied();
      onComplete?.();
    } finally {
      setApplying(false);
    }
  };
}
```

2. Visual design:
   - Modal with "Choose a Starter Pack" header
   - Industry-specific subtitle if industry is set
   - List of StarterPackCard components (reuse existing)
   - "Skip for now" link at bottom
   - After apply: success message then close

3. Leverage existing StarterPackCard for pack display with template grid

4. On skip: close modal, mark onboarding as skipped but allow banner
  </action>
  <verify>Component fetches packs, displays StarterPackCard list, applies selected templates</verify>
  <done>StarterPackOnboarding modal shows packs filtered by industry, applies selected</done>
</task>

<task type="auto">
  <name>Task 4: Create OnboardingBanner for incomplete onboarding</name>
  <files>src/components/onboarding/OnboardingBanner.jsx</files>
  <action>
Create OnboardingBanner.jsx:

```jsx
/**
 * Dismissible banner shown when onboarding was skipped partway.
 * Appears once on next dashboard visit if incomplete.
 */
export function OnboardingBanner({ onResume, onDismiss }) {
  return (
    <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 flex items-center justify-between">
      <div className="flex items-center gap-3">
        <Sparkles className="w-5 h-5 text-blue-600" />
        <div>
          <p className="font-medium text-gray-900">Complete your setup</p>
          <p className="text-sm text-gray-600">
            Finish setting up your workspace with templates tailored for your business.
          </p>
        </div>
      </div>
      <div className="flex items-center gap-2">
        <button
          onClick={onDismiss}
          className="text-sm text-gray-500 hover:text-gray-700 px-3 py-1"
        >
          Dismiss
        </button>
        <Button size="sm" onClick={onResume}>
          Complete Setup
        </Button>
      </div>
    </div>
  );
}
```

Per CONTEXT.md: shown once on next visit if incomplete, dismissible per session.
Use sessionStorage to track dismissal within session.
  </action>
  <verify>Banner renders with resume and dismiss buttons, dismiss hides for session</verify>
  <done>OnboardingBanner shows for incomplete onboarding, dismissible per session</done>
</task>

<task type="auto">
  <name>Task 5: Integrate onboarding flow into DashboardPage</name>
  <files>src/pages/DashboardPage.jsx</files>
  <action>
Update DashboardPage to orchestrate the full onboarding flow:

1. Import new components:
```javascript
import {
  WelcomeTour,
  IndustrySelectionModal,
  StarterPackOnboarding,
  OnboardingBanner,
} from '../components/onboarding';
import {
  shouldShowWelcomeTour,
  getWelcomeTourProgress,
  getSelectedIndustry,
} from '../services/onboardingService';
```

2. Add state for onboarding flow:
```javascript
const [showWelcomeTour, setShowWelcomeTour] = useState(false);
const [showIndustryModal, setShowIndustryModal] = useState(false);
const [showStarterPackModal, setShowStarterPackModal] = useState(false);
const [selectedIndustry, setSelectedIndustry] = useState(null);
const [showOnboardingBanner, setShowOnboardingBanner] = useState(false);
```

3. Check onboarding state on mount:
```javascript
// In fetchData or new useEffect
const checkOnboarding = async () => {
  const shouldShow = await shouldShowWelcomeTour();
  if (shouldShow) {
    setShowWelcomeTour(true);
  } else {
    // Check if industry selected but pack not applied
    const progress = await getWelcomeTourProgress();
    if (progress.completedWelcomeTour && !progress.starterPackApplied) {
      // Check session storage for banner dismiss
      if (!sessionStorage.getItem('onboarding_banner_dismissed')) {
        setShowOnboardingBanner(true);
      }
    }
  }
};
```

4. Flow handlers:
```javascript
// After tour completes, show industry selection
const handleTourComplete = () => {
  setShowWelcomeTour(false);
  setShowIndustryModal(true);
};

// After industry selected, show starter pack
const handleIndustrySelect = (industry) => {
  setSelectedIndustry(industry);
  setShowIndustryModal(false);
  setShowStarterPackModal(true);
};

// After pack applied or skipped
const handlePackComplete = () => {
  setShowStarterPackModal(false);
  // Refresh dashboard data
  fetchData();
};

// Banner handlers
const handleResume = async () => {
  const industry = await getSelectedIndustry();
  setSelectedIndustry(industry);
  if (industry) {
    setShowStarterPackModal(true);
  } else {
    setShowIndustryModal(true);
  }
  setShowOnboardingBanner(false);
};

const handleDismissBanner = () => {
  sessionStorage.setItem('onboarding_banner_dismissed', 'true');
  setShowOnboardingBanner(false);
};
```

5. Add modals to render:
```jsx
{showWelcomeTour && (
  <WelcomeTour
    isOpen={showWelcomeTour}
    onClose={() => setShowWelcomeTour(false)}
    onComplete={handleTourComplete}
    onGetStarted={handleTourComplete}
  />
)}

{showIndustryModal && (
  <IndustrySelectionModal
    isOpen={showIndustryModal}
    onClose={() => setShowIndustryModal(false)}
    onSelect={handleIndustrySelect}
  />
)}

{showStarterPackModal && (
  <StarterPackOnboarding
    isOpen={showStarterPackModal}
    onClose={() => setShowStarterPackModal(false)}
    onComplete={handlePackComplete}
    industry={selectedIndustry}
  />
)}

{showOnboardingBanner && (
  <OnboardingBanner
    onResume={handleResume}
    onDismiss={handleDismissBanner}
  />
)}
```

Keep existing WelcomeModal for demo flow (different from new tour).
  </action>
  <verify>Dashboard shows tour on first visit, then industry, then packs; banner shows if skipped</verify>
  <done>DashboardPage orchestrates full onboarding flow with tour > industry > pack > banner</done>
</task>

<task type="auto">
  <name>Task 6: Add onboarding settings tab to SettingsPage</name>
  <files>src/pages/SettingsPage.jsx</files>
  <action>
Add new "Onboarding" tab to SettingsPage:

1. Add to tabs array:
```javascript
const tabs = [
  // ... existing tabs
  { id: 'onboarding', label: t('settings.tabs.onboarding', 'Onboarding'), icon: Sparkles },
];
```

2. Add state for onboarding settings:
```javascript
const [onboardingSettings, setOnboardingSettings] = useState(null);
const [restartingTour, setRestartingTour] = useState(false);
```

3. Fetch onboarding data when tab selected:
```javascript
useEffect(() => {
  if (activeTab === 'onboarding') {
    fetchOnboardingSettings();
  }
}, [activeTab]);

const fetchOnboardingSettings = async () => {
  const [tourProgress, industry] = await Promise.all([
    getWelcomeTourProgress(),
    getSelectedIndustry()
  ]);
  setOnboardingSettings({ ...tourProgress, industry });
};
```

4. Add onboarding tab content:
```jsx
{activeTab === 'onboarding' && (
  <Card>
    <CardHeader>
      <CardTitle>Onboarding Settings</CardTitle>
    </CardHeader>
    <CardContent>
      <Stack gap="md">
        {/* Current Industry */}
        <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
          <div>
            <p className="font-medium">Business Type</p>
            <p className="text-sm text-gray-500">
              {onboardingSettings?.industry
                ? INDUSTRIES.find(i => i.id === onboardingSettings.industry)?.label
                : 'Not set'}
            </p>
          </div>
          <Button variant="outline" size="sm" onClick={() => setShowIndustryModal(true)}>
            Change
          </Button>
        </div>

        {/* Restart Tour */}
        <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
          <div>
            <p className="font-medium">Welcome Tour</p>
            <p className="text-sm text-gray-500">
              {onboardingSettings?.completedWelcomeTour
                ? 'Completed'
                : onboardingSettings?.tourSkippedAt
                  ? 'Skipped'
                  : 'Not started'}
            </p>
          </div>
          <Button
            variant="outline"
            size="sm"
            onClick={handleRestartTour}
            disabled={restartingTour}
          >
            {restartingTour ? <Loader2 className="animate-spin" size={16} /> : 'Restart Tour'}
          </Button>
        </div>

        {/* Starter Pack Status */}
        <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
          <div>
            <p className="font-medium">Starter Pack</p>
            <p className="text-sm text-gray-500">
              {onboardingSettings?.starterPackApplied
                ? 'Applied'
                : 'Not applied'}
            </p>
          </div>
          <Button
            variant="outline"
            size="sm"
            onClick={() => setCurrentPage('template-marketplace')}
          >
            Browse Templates
          </Button>
        </div>
      </Stack>
    </CardContent>
  </Card>
)}
```

5. Implement restartTour:
```javascript
const handleRestartTour = async () => {
  setRestartingTour(true);
  // Reset tour progress in DB (need new RPC or update existing)
  await resetWelcomeTour();
  // Navigate to dashboard to trigger tour
  setCurrentPage('dashboard');
};
```

6. Add resetWelcomeTour to onboardingService (simple update setting completed_welcome_tour to false and tour_skipped_at to null)
  </action>
  <verify>Settings page shows Onboarding tab with industry, tour status, and restart option</verify>
  <done>SettingsPage has Onboarding tab to change industry and restart tour</done>
</task>

<task type="auto">
  <name>Task 7: Extend onboardingService with industry and reset functions</name>
  <files>src/services/onboardingService.js</files>
  <action>
Add new functions:

```javascript
/**
 * Set user's selected industry
 * @param {string} industry - Industry ID
 */
export async function setSelectedIndustry(industry) {
  const { data, error } = await supabase.rpc('set_selected_industry', {
    p_industry: industry
  });

  if (error) {
    logger.error('Error setting industry:', { error });
    return { success: false, error: error.message };
  }

  return data || { success: true };
}

/**
 * Get user's selected industry
 * @returns {Promise<string|null>}
 */
export async function getSelectedIndustry() {
  const { data, error } = await supabase.rpc('get_selected_industry');

  if (error) {
    logger.error('Error getting industry:', { error });
    return null;
  }

  return data;
}

/**
 * Mark starter pack as applied
 */
export async function markStarterPackApplied() {
  const { data, error } = await supabase.rpc('mark_starter_pack_applied');

  if (error) {
    logger.error('Error marking starter pack applied:', { error });
    return { success: false, error: error.message };
  }

  return { success: true };
}

/**
 * Reset welcome tour to allow restart
 */
export async function resetWelcomeTour() {
  const { error } = await supabase
    .from('onboarding_progress')
    .update({
      completed_welcome_tour: false,
      current_tour_step: 0,
      tour_skipped_at: null
    })
    .eq('user_id', (await supabase.auth.getUser()).data.user?.id);

  if (error) {
    logger.error('Error resetting welcome tour:', { error });
    return { success: false, error: error.message };
  }

  return { success: true };
}
```

Export all new functions.
  </action>
  <verify>Functions are exported, setSelectedIndustry/getSelectedIndustry/markStarterPackApplied/resetWelcomeTour work</verify>
  <done>onboardingService has all industry and reset functions</done>
</task>

</tasks>

<verification>
1. Industry selection shows 10-12 options in responsive grid
2. Selecting industry saves to database
3. Starter pack modal shows packs filtered by industry
4. Applying pack marks onboarding as complete
5. Skipping shows banner on next dashboard visit
6. Banner dismisses for session only
7. Settings page shows onboarding tab
8. Can change industry from Settings
9. Can restart tour from Settings
10. Full flow: Tour > Industry > Pack works end-to-end
</verification>

<success_criteria>
- [ ] Migration 137 adds industry columns and RPCs
- [ ] IndustrySelectionModal shows 10-12 industries in grid
- [ ] StarterPackOnboarding wraps pack selection for onboarding
- [ ] OnboardingBanner shows for incomplete onboarding
- [ ] DashboardPage orchestrates full flow
- [ ] SettingsPage has Onboarding tab with industry and restart options
- [ ] onboardingService has all new functions
- [ ] Skip/resume behavior works as specified
</success_criteria>

<output>
After completion, create `.planning/phases/23-platform-polish-onboarding/23-02-SUMMARY.md`
</output>
