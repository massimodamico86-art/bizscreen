---
phase: 11-gdpr-compliance
plan: 07
type: execute
wave: 4
depends_on: ["11-03"]
files_modified:
  - src/components/compliance/DataPrivacySettings.jsx
autonomous: true

must_haves:
  truths:
    - "User can download completed export from UI"
    - "Export status shows processing, ready, or expired state"
    - "Download button fetches export_data and triggers file download"
    - "Expired exports show appropriate message"
  artifacts:
    - path: "src/components/compliance/DataPrivacySettings.jsx"
      provides: "Updated export UI with download capability"
      contains: "downloadExportAsFile"
  key_links:
    - from: "DataPrivacySettings.jsx"
      to: "gdprService.downloadExportAsFile"
      via: "import and onClick handler"
      pattern: "downloadExportAsFile"
---

<objective>
Update DataPrivacySettings UI to support completed export download

Purpose: Users need to download their data export from the Settings page. The UI must show export status and provide a download button when ready.

Output: Updated DataPrivacySettings component with export download functionality
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-gdpr-compliance/11-RESEARCH.md

# Existing UI component
@src/components/compliance/DataPrivacySettings.jsx

# Service with new functions
@src/services/gdprService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update import and add download handler</name>
  <files>src/components/compliance/DataPrivacySettings.jsx</files>
  <action>
Update imports to include new gdprService functions:

```javascript
import {
  requestDataExport,
  getLatestExportStatus,
  downloadClientSideExport,
  downloadExportAsFile,  // Add this import
  requestAccountDeletion,
  cancelAccountDeletion,
  getDeletionStatus,
  DELETION_REASONS,
} from '../../services/gdprService';
```

Add handler for downloading completed export:

After the existing handleFullExport function, add:

```javascript
const handleDownloadExport = async () => {
  if (!exportStatus?.id) return;

  setExportLoading(true);
  try {
    await downloadExportAsFile(exportStatus.id);
    showToast?.('Your data export has been downloaded');
  } catch (error) {
    showToast?.(error.message || 'Failed to download export', 'error');
  } finally {
    setExportLoading(false);
  }
};
```
  </action>
  <verify>
- downloadExportAsFile imported from gdprService
- handleDownloadExport function added
  </verify>
  <done>
Import and handler added for downloading completed exports
  </done>
</task>

<task type="auto">
  <name>Task 2: Update export status display and download button</name>
  <files>src/components/compliance/DataPrivacySettings.jsx</files>
  <action>
Update the export status display section to use the new download method.

Find the existing status display for completed exports (around line 174-187) and update to:

```jsx
{exportStatus && exportStatus.status === 'completed' && (
  <div className="mt-3 p-3 bg-green-50 border border-green-200 rounded-lg">
    <div className="flex items-center gap-2 text-sm text-green-700">
      <Check className="w-4 h-4" />
      <span>Your export is ready!</span>
    </div>
    {exportStatus.expires_at && (
      <p className="text-xs text-green-600 mt-1">
        Available until {new Date(exportStatus.expires_at).toLocaleDateString()}
      </p>
    )}
    <Button
      variant="outline"
      size="sm"
      onClick={handleDownloadExport}
      disabled={exportLoading}
      className="mt-2"
    >
      {exportLoading ? (
        <Loader2 className="w-4 h-4 animate-spin" />
      ) : (
        <Download className="w-4 h-4" />
      )}
      Download Export
    </Button>
  </div>
)}

{exportStatus && exportStatus.status === 'expired' && (
  <div className="mt-3 p-3 bg-gray-50 border border-gray-200 rounded-lg flex items-center gap-2 text-sm text-gray-600">
    <Clock className="w-4 h-4" />
    Your previous export has expired. Request a new export to download your data.
  </div>
)}
```

This replaces the existing completed status section that used file_url with the new pattern that uses downloadExportAsFile.
  </action>
  <verify>
- Completed export shows download button that calls handleDownloadExport
- Expires_at date displayed
- Expired status shows appropriate message
- Loading state handled on download button
  </verify>
  <done>
Export status display updated with proper download button and expiration handling
  </done>
</task>

<task type="auto">
  <name>Task 3: Add deletion grace period banner</name>
  <files>src/components/compliance/DataPrivacySettings.jsx</files>
  <action>
Enhance the deletion status section to show a more prominent banner during grace period.

Update the deletionStatus display section (around line 254-280) to:

```jsx
{deletionStatus && (
  <div className="mt-3 p-4 bg-yellow-50 border border-yellow-300 rounded-lg">
    <div className="flex items-start gap-3">
      <AlertTriangle className="w-5 h-5 text-yellow-600 flex-shrink-0 mt-0.5" />
      <div className="flex-1">
        <h4 className="font-medium text-yellow-800">
          Account Scheduled for Deletion
        </h4>
        <p className="text-sm text-yellow-700 mt-1">
          Your account and all data will be permanently deleted on{' '}
          <strong>{new Date(deletionStatus.scheduled_deletion_at).toLocaleDateString()}</strong>.
        </p>
        <p className="text-sm text-yellow-600 mt-1">
          {deletionStatus.days_remaining} days remaining to cancel.
        </p>
        <div className="mt-2 p-2 bg-yellow-100 rounded text-xs text-yellow-800">
          During the grace period, your account is in read-only mode.
          You can view your data but cannot make changes.
        </div>
        <Button
          variant="outline"
          size="sm"
          onClick={handleCancelDeletion}
          disabled={deletionLoading}
          className="mt-3"
        >
          {deletionLoading ? (
            <Loader2 className="w-4 h-4 animate-spin" />
          ) : (
            <X className="w-4 h-4" />
          )}
          Cancel Deletion & Keep Account
        </Button>
      </div>
    </div>
  </div>
)}
```

This provides clearer information about the grace period and read-only status.
  </action>
  <verify>
- Deletion banner shows scheduled date
- Days remaining displayed
- Read-only mode message shown
- Cancel button prominent and clear
  </verify>
  <done>
Deletion grace period banner enhanced with clearer messaging about read-only status and cancellation option
  </done>
</task>

</tasks>

<verification>
- [ ] downloadExportAsFile imported from gdprService
- [ ] handleDownloadExport function added
- [ ] Completed export shows download button (not external link)
- [ ] Expiration date displayed for completed exports
- [ ] Expired status shows message to request new export
- [ ] Deletion grace period banner enhanced with read-only message
- [ ] Cancel deletion button has clear "Keep Account" label
- [ ] All loading states handled properly
</verification>

<success_criteria>
- User can download completed export by clicking Download button
- Export expiration clearly communicated
- Expired exports prompt user to request new export
- Deletion grace period clearly shows countdown and read-only status
- Cancel deletion button is prominent and clearly labeled
</success_criteria>

<output>
After completion, create `.planning/phases/11-gdpr-compliance/11-07-SUMMARY.md`
</output>
