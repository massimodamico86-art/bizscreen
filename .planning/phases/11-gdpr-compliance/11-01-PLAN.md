---
phase: 11-gdpr-compliance
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/119_gdpr_export_data_collection.sql
autonomous: true

must_haves:
  truths:
    - "RPC collects all user data from database tables"
    - "Export includes profile, settings, content, devices, activity summary"
    - "Media assets export metadata only (URLs, sizes), not actual files"
    - "Activity logs aggregated by month per CONTEXT.md"
  artifacts:
    - path: "supabase/migrations/119_gdpr_export_data_collection.sql"
      provides: "collect_user_export_data RPC function"
      contains: "CREATE OR REPLACE FUNCTION collect_user_export_data"
  key_links:
    - from: "collect_user_export_data"
      to: "profiles, user_settings, media_assets, playlists, layouts, schedules, scenes, listings, tv_devices, activity_log, consent_records"
      via: "SELECT queries with owner_id filter"
      pattern: "SELECT.*FROM.*WHERE.*owner_id"
---

<objective>
Create database RPC function to collect all user data for GDPR export

Purpose: GDPR Article 20 requires data portability - users must receive a copy of all their personal data in machine-readable format. This RPC collects data from all tables containing user information.

Output: Migration file with collect_user_export_data() function that returns comprehensive JSON structure
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/11-gdpr-compliance/11-RESEARCH.md

# Existing GDPR infrastructure
@supabase/migrations/106_gdpr_compliance.sql
@src/services/gdprService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create data collection RPC migration</name>
  <files>supabase/migrations/119_gdpr_export_data_collection.sql</files>
  <action>
Create migration file with collect_user_export_data(p_user_id UUID) function.

The function should:
1. Accept p_user_id parameter (for service_role execution)
2. Return JSONB with structured export data
3. Collect from these tables (per RESEARCH.md Data Tables section):

**Profile section:**
- profiles: all columns
- user_settings: all columns

**Content section:**
- media_assets: id, name, type, url, thumbnail_url, mime_type, file_size, duration, width, height, created_at (metadata only, not downloading files)
- playlists: all columns, include nested playlist_items via LEFT JOIN or subquery
- layouts: all columns, include nested layout_zones
- schedules: all columns, include nested schedule_entries
- scenes: all columns where tenant_id matches user's tenant

**Devices section:**
- listings: all columns where owner_id matches
- tv_devices: all columns via listings relationship
- qr_codes: all columns via listings relationship

**Activity section (aggregated per CONTEXT.md):**
- activity_log: GROUP BY to_char(created_at, 'YYYY-MM') to get counts per month, not individual events

**Consent section:**
- consent_records: all columns

Return structure:
```json
{
  "metadata": { "exportDate", "userId", "email", "format", "version" },
  "profile": { ... },
  "settings": { ... },
  "content": { "mediaAssets": [], "playlists": [], "layouts": [], "schedules": [], "scenes": [] },
  "devices": { "listings": [], "tvDevices": [], "qrCodes": [] },
  "activitySummary": { "monthlyActivityCounts": {} },
  "consent": { "history": [] }
}
```

Use SECURITY DEFINER to allow service_role to call for any user.
Grant EXECUTE to service_role only (not authenticated - this is for background job).

Include comments explaining each section and GDPR Article 20 compliance.
  </action>
  <verify>
Migration file exists with:
- collect_user_export_data function
- RETURNS JSONB
- Queries all required tables
- GRANT to service_role
  </verify>
  <done>
RPC function created that collects comprehensive user data for GDPR export with proper structure and tenant isolation
  </done>
</task>

<task type="auto">
  <name>Task 2: Add helper function for nested content</name>
  <files>supabase/migrations/119_gdpr_export_data_collection.sql</files>
  <action>
In the same migration file, add helper for collecting playlist with items:

```sql
-- Helper to get playlist with nested items
CREATE OR REPLACE FUNCTION get_playlist_with_items(p_playlist_id UUID)
RETURNS JSONB
LANGUAGE sql
STABLE
AS $$
  SELECT jsonb_build_object(
    'playlist', to_jsonb(p.*),
    'items', COALESCE(
      (SELECT jsonb_agg(to_jsonb(pi.*) ORDER BY pi.position)
       FROM playlist_items pi WHERE pi.playlist_id = p.id),
      '[]'::jsonb
    )
  )
  FROM playlists p WHERE p.id = p_playlist_id;
$$;
```

Similar helpers for layouts with zones and schedules with entries.

These helpers make the main collect function cleaner and more maintainable.
  </action>
  <verify>
Helper functions exist:
- get_playlist_with_items
- get_layout_with_zones (if needed)
- get_schedule_with_entries (if needed)
  </verify>
  <done>
Helper functions created for nested content structures, making export data complete and well-organized
  </done>
</task>

</tasks>

<verification>
- [ ] Migration file 119_gdpr_export_data_collection.sql exists
- [ ] collect_user_export_data function defined with RETURNS JSONB
- [ ] Function queries all user data tables (profiles, user_settings, media_assets, playlists, layouts, schedules, scenes, listings, tv_devices, qr_codes, activity_log, consent_records)
- [ ] Activity logs aggregated by month (not individual events)
- [ ] Media assets include metadata only (urls, sizes, not file contents)
- [ ] Function has SECURITY DEFINER and service_role GRANT
- [ ] Return structure matches GDPR-compliant JSON format
</verification>

<success_criteria>
- collect_user_export_data(user_id) returns complete JSON structure with all user data
- Data is properly structured with metadata, profile, settings, content, devices, activitySummary, consent sections
- Nested relationships (playlist_items, layout_zones, schedule_entries) included
- Ready to be called by export processing job
</success_criteria>

<output>
After completion, create `.planning/phases/11-gdpr-compliance/11-01-SUMMARY.md`
</output>
