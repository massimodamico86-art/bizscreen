---
phase: 11-gdpr-compliance
plan: 06
type: execute
wave: 4
depends_on: ["11-03", "11-05"]
files_modified:
  - src/services/emailService.js
  - src/services/gdprService.js
autonomous: true

must_haves:
  truths:
    - "Export ready email sent when export completes"
    - "Deletion confirmation email sent on day 1"
    - "Deletion reminder email sent on day 7 and day 25"
    - "Deletion completed email sent after execution"
  artifacts:
    - path: "src/services/emailService.js"
      provides: "GDPR email notification functions"
      exports: ["sendExportReadyEmail", "sendDeletionConfirmationEmail", "sendDeletionReminderEmail", "sendDeletionCompletedEmail"]
  key_links:
    - from: "src/services/emailService.js"
      to: "Resend API"
      via: "resend.emails.send"
      pattern: "resend\\.emails\\.send"
---

<objective>
Add GDPR email notification functions to emailService

Purpose: GDPR compliance requires notifying users about their data requests. Export ready, deletion confirmation, reminders, and completion emails keep users informed throughout the process.

Output: Extended emailService with GDPR-specific email templates and sending functions
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/11-gdpr-compliance/11-RESEARCH.md

# Existing email service
@src/services/emailService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add export ready email function</name>
  <files>src/services/emailService.js</files>
  <action>
Add sendExportReadyEmail function to emailService.js.

After the existing sendAlertEmail function, add:

```javascript
/**
 * Send data export ready notification
 *
 * @param {Object} options Email options
 * @param {string} options.to Recipient email address
 * @param {string} options.downloadUrl URL to download the export
 * @param {string} options.expiresAt Expiration date
 * @returns {Promise<{success: boolean, messageId?: string, error?: string}>}
 */
export async function sendExportReadyEmail({ to, downloadUrl, expiresAt }) {
  if (!resend) {
    logger.warn('Email not sent - VITE_RESEND_API_KEY not configured');
    return { success: false, error: 'Email service not configured' };
  }

  try {
    const expiryDate = new Date(expiresAt).toLocaleDateString('en-US', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });

    const html = buildGdprEmailHtml({
      title: 'Your Data Export is Ready',
      message: `Your personal data export has been prepared and is ready for download. The download link will expire on ${expiryDate}.`,
      actionUrl: downloadUrl,
      actionText: 'Download Your Data',
      footer: 'This export contains all your personal data stored in BizScreen as required by GDPR Article 20 (Right to Data Portability).',
    });

    const { data, error } = await resend.emails.send({
      from: 'BizScreen Privacy <privacy@bizscreen.com>',
      to: [to],
      subject: 'Your BizScreen Data Export is Ready',
      html,
    });

    if (error) {
      logger.error('Export ready email failed', { error, to });
      return { success: false, error: error.message };
    }

    logger.info('Export ready email sent', { messageId: data.id, to });
    return { success: true, messageId: data.id };
  } catch (error) {
    logger.error('Failed to send export ready email', { error: error.message, to });
    return { success: false, error: error.message };
  }
}
```
  </action>
  <verify>
sendExportReadyEmail function exists with:
- Accepts to, downloadUrl, expiresAt
- Uses buildGdprEmailHtml (to be created)
- Proper error handling
  </verify>
  <done>
Export ready email function created for notifying users when their data export is available
  </done>
</task>

<task type="auto">
  <name>Task 2: Add deletion notification emails</name>
  <files>src/services/emailService.js</files>
  <action>
Add deletion-related email functions to emailService.js.

```javascript
/**
 * Send account deletion confirmation email (Day 1)
 *
 * @param {Object} options Email options
 * @param {string} options.to Recipient email address
 * @param {string} options.scheduledDate When deletion will occur
 * @param {string} options.cancelUrl URL to cancel deletion
 * @returns {Promise<{success: boolean, messageId?: string, error?: string}>}
 */
export async function sendDeletionConfirmationEmail({ to, scheduledDate, cancelUrl }) {
  if (!resend) {
    logger.warn('Email not sent - VITE_RESEND_API_KEY not configured');
    return { success: false, error: 'Email service not configured' };
  }

  try {
    const deletionDate = new Date(scheduledDate).toLocaleDateString('en-US', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });

    const html = buildGdprEmailHtml({
      title: 'Account Deletion Scheduled',
      message: `Your account has been scheduled for permanent deletion on ${deletionDate}. During the 30-day grace period, you can still access your account in read-only mode and cancel the deletion if you change your mind.`,
      actionUrl: cancelUrl,
      actionText: 'Cancel Deletion',
      warning: 'After the grace period, all your data will be permanently deleted and cannot be recovered.',
      footer: 'You requested this deletion per GDPR Article 17 (Right to Erasure). If you did not request this, please contact support immediately.',
    });

    const { data, error } = await resend.emails.send({
      from: 'BizScreen Privacy <privacy@bizscreen.com>',
      to: [to],
      subject: 'Your BizScreen Account Deletion is Scheduled',
      html,
    });

    if (error) {
      logger.error('Deletion confirmation email failed', { error, to });
      return { success: false, error: error.message };
    }

    logger.info('Deletion confirmation email sent', { messageId: data.id, to });
    return { success: true, messageId: data.id };
  } catch (error) {
    logger.error('Failed to send deletion confirmation email', { error: error.message, to });
    return { success: false, error: error.message };
  }
}

/**
 * Send deletion reminder email (Day 7 and Day 25)
 *
 * @param {Object} options Email options
 * @param {string} options.to Recipient email address
 * @param {number} options.daysRemaining Days until deletion
 * @param {string} options.cancelUrl URL to cancel deletion
 * @returns {Promise<{success: boolean, messageId?: string, error?: string}>}
 */
export async function sendDeletionReminderEmail({ to, daysRemaining, cancelUrl }) {
  if (!resend) {
    logger.warn('Email not sent - VITE_RESEND_API_KEY not configured');
    return { success: false, error: 'Email service not configured' };
  }

  try {
    const isFinalWarning = daysRemaining <= 5;
    const title = isFinalWarning
      ? `Final Warning: ${daysRemaining} Days Until Account Deletion`
      : `Reminder: ${daysRemaining} Days Until Account Deletion`;

    const html = buildGdprEmailHtml({
      title,
      message: isFinalWarning
        ? `This is your final reminder. Your BizScreen account and all associated data will be permanently deleted in ${daysRemaining} days. This action cannot be undone.`
        : `Your BizScreen account is scheduled for deletion in ${daysRemaining} days. If you want to keep your account, you can cancel the deletion request.`,
      actionUrl: cancelUrl,
      actionText: 'Keep My Account',
      warning: isFinalWarning ? 'This is your last chance to cancel. After deletion, your data cannot be recovered.' : null,
      footer: 'You can cancel this deletion at any time before the scheduled date by logging in and visiting your privacy settings.',
    });

    const { data, error } = await resend.emails.send({
      from: 'BizScreen Privacy <privacy@bizscreen.com>',
      to: [to],
      subject: isFinalWarning
        ? `FINAL WARNING: Your BizScreen Account Will Be Deleted in ${daysRemaining} Days`
        : `Reminder: Your BizScreen Account Deletion in ${daysRemaining} Days`,
      html,
    });

    if (error) {
      logger.error('Deletion reminder email failed', { error, to });
      return { success: false, error: error.message };
    }

    logger.info('Deletion reminder email sent', { messageId: data.id, to, daysRemaining });
    return { success: true, messageId: data.id };
  } catch (error) {
    logger.error('Failed to send deletion reminder email', { error: error.message, to });
    return { success: false, error: error.message };
  }
}

/**
 * Send account deletion completed email
 *
 * @param {Object} options Email options
 * @param {string} options.to Recipient email address (stored before deletion)
 * @returns {Promise<{success: boolean, messageId?: string, error?: string}>}
 */
export async function sendDeletionCompletedEmail({ to }) {
  if (!resend) {
    logger.warn('Email not sent - VITE_RESEND_API_KEY not configured');
    return { success: false, error: 'Email service not configured' };
  }

  try {
    const html = buildGdprEmailHtml({
      title: 'Account Deletion Complete',
      message: 'Your BizScreen account and all associated personal data have been permanently deleted from our systems. This includes your profile, content, media files, and activity history.',
      actionUrl: null,
      actionText: null,
      footer: 'Per GDPR Article 17, all your data has been erased from BizScreen and our third-party processors (cloud storage). Thank you for using BizScreen.',
    });

    const { data, error } = await resend.emails.send({
      from: 'BizScreen Privacy <privacy@bizscreen.com>',
      to: [to],
      subject: 'Your BizScreen Account Has Been Deleted',
      html,
    });

    if (error) {
      logger.error('Deletion completed email failed', { error, to });
      return { success: false, error: error.message };
    }

    logger.info('Deletion completed email sent', { messageId: data.id, to });
    return { success: true, messageId: data.id };
  } catch (error) {
    logger.error('Failed to send deletion completed email', { error: error.message, to });
    return { success: false, error: error.message };
  }
}
```
  </action>
  <verify>
Functions exist:
- sendDeletionConfirmationEmail
- sendDeletionReminderEmail (handles both day 7 and day 25 with isFinalWarning)
- sendDeletionCompletedEmail
  </verify>
  <done>
Deletion notification email functions created for the full deletion lifecycle (confirmation, reminders, completion)
  </done>
</task>

<task type="auto">
  <name>Task 3: Add GDPR email template builder</name>
  <files>src/services/emailService.js</files>
  <action>
Add buildGdprEmailHtml template function to emailService.js.

After the existing buildAlertEmailHtml function, add:

```javascript
/**
 * Build HTML for GDPR notification emails
 */
function buildGdprEmailHtml({ title, message, actionUrl, actionText, warning, footer }) {
  return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; background-color: #f9fafb;">
  <table width="100%" cellpadding="0" cellspacing="0" style="max-width: 600px; margin: 0 auto; padding: 20px;">
    <tr>
      <td style="background-color: white; border-radius: 12px; padding: 32px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <!-- Logo -->
        <div style="text-align: center; margin-bottom: 24px;">
          <span style="font-size: 24px; font-weight: 700; color: #f97316;">BizScreen</span>
        </div>

        <!-- Privacy Badge -->
        <div style="text-align: center; margin-bottom: 16px;">
          <span style="display: inline-block; padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 600; background-color: #dbeafe; color: #1e40af;">
            Privacy Notice
          </span>
        </div>

        <!-- Title -->
        <h1 style="color: #111827; font-size: 20px; font-weight: 600; text-align: center; margin: 0 0 16px 0;">
          ${escapeHtml(title)}
        </h1>

        <!-- Message -->
        <p style="color: #6b7280; font-size: 16px; line-height: 1.6; text-align: center; margin: 0 0 24px 0;">
          ${escapeHtml(message)}
        </p>

        ${warning ? `
        <!-- Warning Box -->
        <div style="background-color: #fef3c7; border: 1px solid #fcd34d; border-radius: 8px; padding: 12px 16px; margin-bottom: 24px;">
          <p style="color: #92400e; font-size: 14px; margin: 0; text-align: center;">
            <strong>Warning:</strong> ${escapeHtml(warning)}
          </p>
        </div>
        ` : ''}

        ${actionUrl && actionText ? `
        <!-- CTA Button -->
        <div style="text-align: center; margin-bottom: 24px;">
          <a href="${escapeHtml(actionUrl)}" style="display: inline-block; background-color: #f97316; color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 500; font-size: 14px;">
            ${escapeHtml(actionText)}
          </a>
        </div>
        ` : ''}

        <!-- Footer -->
        <div style="border-top: 1px solid #e5e7eb; padding-top: 16px; margin-top: 24px;">
          <p style="color: #9ca3af; font-size: 12px; text-align: center; margin: 0;">
            ${escapeHtml(footer)}
          </p>
        </div>
      </td>
    </tr>
  </table>
</body>
</html>
  `.trim();
}
```

Also update the default export to include the new functions:

```javascript
export default {
  sendAlertEmail,
  sendExportReadyEmail,
  sendDeletionConfirmationEmail,
  sendDeletionReminderEmail,
  sendDeletionCompletedEmail,
};
```
  </action>
  <verify>
- buildGdprEmailHtml function exists
- Handles optional warning and actionUrl/actionText
- Default export includes all GDPR email functions
  </verify>
  <done>
GDPR email template builder created with consistent styling and proper HTML escaping
  </done>
</task>

</tasks>

<verification>
- [ ] sendExportReadyEmail function exists and sends email via Resend
- [ ] sendDeletionConfirmationEmail function exists (Day 1)
- [ ] sendDeletionReminderEmail function exists (Day 7, Day 25 with different urgency)
- [ ] sendDeletionCompletedEmail function exists
- [ ] buildGdprEmailHtml template function exists
- [ ] All emails use Privacy badge and consistent styling
- [ ] Warning box shown for final warning emails
- [ ] Default export updated with all new functions
</verification>

<success_criteria>
- Export ready email sent with download link and expiration date
- Deletion confirmation email sent with 30-day warning and cancel link
- Deletion reminder emails differentiate between regular (Day 7) and final warning (Day 25)
- Deletion completed email confirms data has been erased
- All emails have consistent GDPR-compliant messaging
</success_criteria>

<output>
After completion, create `.planning/phases/11-gdpr-compliance/11-06-SUMMARY.md`
</output>
