---
phase: 16-scheduling-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/127_campaign_analytics.sql
  - src/services/campaignAnalyticsService.js
  - src/components/analytics/CampaignAnalyticsCard.jsx
  - src/pages/CampaignEditorPage.jsx
autonomous: true

must_haves:
  truths:
    - "User can view play count for a campaign"
    - "User can view total playback duration for a campaign"
    - "User can view unique screens reached by a campaign"
    - "User can compare campaign performance across date ranges"
  artifacts:
    - path: "supabase/migrations/127_campaign_analytics.sql"
      provides: "RPC for campaign analytics aggregation"
      contains: "get_campaign_analytics"
    - path: "src/services/campaignAnalyticsService.js"
      provides: "Frontend service for campaign analytics"
      exports: ["getCampaignAnalytics", "getCampaignRotationStats"]
    - path: "src/components/analytics/CampaignAnalyticsCard.jsx"
      provides: "Summary card component for campaign metrics"
      exports: ["CampaignAnalyticsCard"]
  key_links:
    - from: "src/pages/CampaignEditorPage.jsx"
      to: "src/services/campaignAnalyticsService.js"
      via: "getCampaignAnalytics call"
      pattern: "getCampaignAnalytics"
    - from: "src/services/campaignAnalyticsService.js"
      to: "supabase.rpc('get_campaign_analytics')"
      via: "RPC call"
      pattern: "supabase\\.rpc\\('get_campaign_analytics'"
---

<objective>
Add campaign-level analytics showing performance metrics grouped by campaign.

Purpose: Users need to understand how campaigns perform to optimize scheduling decisions.
Output: RPC for aggregation, analytics service, and UI component showing campaign stats.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-scheduling-polish/16-RESEARCH.md

Key patterns:
- Pure CSS visualizations (ViewingHeatmap.jsx pattern)
- DATE_RANGES from analyticsService.js for consistent date presets
- getEffectiveOwnerId() for tenant context
- createScopedLogger('ServiceName') for logging
</context>

<tasks>

<task type="auto">
  <name>Task 1: Campaign Analytics RPC</name>
  <files>supabase/migrations/127_campaign_analytics.sql</files>
  <action>
Create migration with `get_campaign_analytics` RPC function:

```sql
CREATE OR REPLACE FUNCTION public.get_campaign_analytics(
  p_tenant_id UUID,
  p_campaign_id UUID DEFAULT NULL,
  p_from_ts TIMESTAMPTZ,
  p_to_ts TIMESTAMPTZ
)
RETURNS TABLE (
  campaign_id UUID,
  campaign_name TEXT,
  campaign_status TEXT,
  total_play_count BIGINT,
  total_duration_seconds BIGINT,
  unique_screens BIGINT,
  avg_plays_per_screen NUMERIC,
  peak_hour INT
)
```

Implementation:
- Join campaigns with playback_events on campaign_id
- Filter by tenant_id (RLS-safe via SECURITY DEFINER)
- Filter by date range (p_from_ts to p_to_ts)
- Optional single campaign filter (p_campaign_id)
- Calculate peak_hour using mode() within group
- Include campaign status for display
- Order by total_play_count DESC

Add GRANT EXECUTE to authenticated role.
  </action>
  <verify>Run `npx supabase db push` or check migration applies without error</verify>
  <done>RPC exists and returns campaign metrics when called</done>
</task>

<task type="auto">
  <name>Task 2: Campaign Analytics Service</name>
  <files>src/services/campaignAnalyticsService.js</files>
  <action>
Create new service following existing analyticsService.js pattern:

```javascript
import { supabase } from '../supabase';
import { getEffectiveOwnerId } from './tenantService';
import { createScopedLogger } from './loggingService';
import { getDateRange, DATE_RANGES } from './analyticsService';

const logger = createScopedLogger('CampaignAnalyticsService');

// Re-export date utilities for consistent API
export { DATE_RANGES, getDateRange };

// Get analytics for all campaigns or specific campaign
export async function getCampaignAnalytics(dateRange = '7d', campaignId = null)

// Get rotation stats for a campaign (how content actually played vs configured weights)
export async function getCampaignRotationStats(campaignId, dateRange = '7d')
```

getCampaignAnalytics implementation:
- Get tenant ID via getEffectiveOwnerId()
- Call getDateRange(dateRange) for fromTs/toTs
- Call supabase.rpc('get_campaign_analytics', params)
- Return data array or empty array on error

getCampaignRotationStats implementation:
- Query playback_events grouped by content for the campaign
- Calculate actual percentages vs configured weights
- Return comparison data for rotation visualization
  </action>
  <verify>Import service in a test file or component, call functions without error</verify>
  <done>Service exports getCampaignAnalytics and getCampaignRotationStats functions</done>
</task>

<task type="auto">
  <name>Task 3: Campaign Analytics UI</name>
  <files>src/components/analytics/CampaignAnalyticsCard.jsx, src/pages/CampaignEditorPage.jsx</files>
  <action>
Create CampaignAnalyticsCard component:

```jsx
import { BarChart3, Monitor, Clock, TrendingUp } from 'lucide-react';
import { Card, Badge } from '../../design-system';
import { formatHours } from '../../services/analyticsService';

export function CampaignAnalyticsCard({ analytics, dateRange, loading }) {
  // Display: total plays, duration hours, unique screens, avg plays/screen, peak hour
  // Use Card from design system
  // Show loading skeleton when loading=true
  // Handle empty state when no analytics data
}
```

Integrate in CampaignEditorPage:
- Add Analytics section in right column (below Summary card)
- Import and use CampaignAnalyticsCard
- Fetch analytics on mount/campaign change using getCampaignAnalytics
- Add date range selector (7d, 30d, 90d from DATE_RANGES)
- Only show analytics for non-new campaigns (isNew check)

Card layout:
- Header: "Performance" with date range dropdown
- Grid of 4 metrics: Plays, Duration, Screens, Avg/Screen
- Footer: Peak hour indicator (e.g., "Peak hour: 12pm - 1pm")
  </action>
  <verify>Load CampaignEditorPage for existing campaign, see analytics card with metrics</verify>
  <done>Campaign editor shows performance analytics with date range selection</done>
</task>

</tasks>

<verification>
1. Database: `get_campaign_analytics` RPC exists and returns data
2. Service: campaignAnalyticsService exports functions
3. UI: CampaignEditorPage shows analytics card for saved campaigns
4. Integration: Changing date range updates displayed metrics
</verification>

<success_criteria>
- User can view play count, duration, screen reach for any campaign
- User can change date range and see updated metrics
- Analytics display loads within 2 seconds
- Empty state shown when campaign has no playback events
</success_criteria>

<output>
After completion, create `.planning/phases/16-scheduling-polish/16-01-SUMMARY.md`
</output>
