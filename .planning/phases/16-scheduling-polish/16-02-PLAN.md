---
phase: 16-scheduling-polish
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/128_rotation_frequency_limits.sql
  - src/services/campaignService.js
  - src/components/campaigns/RotationControls.jsx
  - src/components/campaigns/FrequencyLimitControls.jsx
  - src/pages/CampaignEditorPage.jsx
autonomous: true

must_haves:
  truths:
    - "User can set percentage-based rotation for campaign content"
    - "User can set maximum plays per hour for content"
    - "User can set maximum plays per day for content"
    - "User sees warning when frequency limits are restrictive"
  artifacts:
    - path: "supabase/migrations/128_rotation_frequency_limits.sql"
      provides: "Schema changes for rotation and frequency columns"
      contains: "rotation_percentage"
    - path: "src/components/campaigns/RotationControls.jsx"
      provides: "UI for configuring content rotation"
      exports: ["RotationControls"]
    - path: "src/components/campaigns/FrequencyLimitControls.jsx"
      provides: "UI for configuring frequency limits"
      exports: ["FrequencyLimitControls"]
  key_links:
    - from: "src/pages/CampaignEditorPage.jsx"
      to: "src/components/campaigns/RotationControls.jsx"
      via: "component import and render"
      pattern: "RotationControls"
    - from: "src/services/campaignService.js"
      to: "campaign_contents table"
      via: "updateContent with rotation/frequency fields"
      pattern: "rotation_percentage|max_plays"
---

<objective>
Add content rotation controls and frequency limits to campaign content configuration.

Purpose: Users need to control how often content plays and in what proportions within campaigns.
Output: Schema updates, service functions, and UI components for rotation and frequency management.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-scheduling-polish/16-RESEARCH.md

Key decisions from RESEARCH:
- Four rotation modes: weight, percentage, sequence, random
- Percentage mode requires sum to 100% (validated in application)
- Frequency limits are per-screen (not tenant-wide)
- Warn when limits are restrictive (< 3/hour or < 10/day)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rotation and Frequency Schema</name>
  <files>supabase/migrations/128_rotation_frequency_limits.sql</files>
  <action>
Create migration adding rotation and frequency columns:

```sql
-- Add rotation columns to campaign_contents
ALTER TABLE campaign_contents
ADD COLUMN IF NOT EXISTS rotation_percentage INT DEFAULT NULL
  CHECK (rotation_percentage IS NULL OR (rotation_percentage >= 0 AND rotation_percentage <= 100)),
ADD COLUMN IF NOT EXISTS rotation_mode TEXT DEFAULT 'weight'
  CHECK (rotation_mode IN ('weight', 'percentage', 'sequence', 'random'));

-- Add frequency limit columns to campaign_contents
ALTER TABLE campaign_contents
ADD COLUMN IF NOT EXISTS max_plays_per_hour INT DEFAULT NULL
  CHECK (max_plays_per_hour IS NULL OR max_plays_per_hour > 0),
ADD COLUMN IF NOT EXISTS max_plays_per_day INT DEFAULT NULL
  CHECK (max_plays_per_day IS NULL OR max_plays_per_day > 0);

-- Add campaign-level defaults for frequency
ALTER TABLE campaigns
ADD COLUMN IF NOT EXISTS default_max_plays_per_hour INT DEFAULT NULL,
ADD COLUMN IF NOT EXISTS default_max_plays_per_day INT DEFAULT NULL;
```

Add comments explaining column purposes.
  </action>
  <verify>Run `npx supabase db push`, verify columns exist with `\d campaign_contents`</verify>
  <done>Schema has rotation_percentage, rotation_mode, max_plays_per_hour, max_plays_per_day columns</done>
</task>

<task type="auto">
  <name>Task 2: Rotation and Frequency Service Functions</name>
  <files>src/services/campaignService.js</files>
  <action>
Extend campaignService.js with new functions:

Add constants:
```javascript
export const ROTATION_MODES = {
  WEIGHT: 'weight',
  PERCENTAGE: 'percentage',
  SEQUENCE: 'sequence',
  RANDOM: 'random'
};
```

Add updateContentRotation function:
```javascript
/**
 * Update rotation settings for campaign contents
 * @param {string} campaignId
 * @param {Array} contents - [{id, rotation_percentage, weight}]
 * @param {string} mode - rotation mode
 */
export async function updateContentRotation(campaignId, contents, mode = 'weight')
```
- Validate percentages sum to 100 if mode is 'percentage'
- Update each content's rotation_percentage and weight
- Return updated contents

Add updateContentFrequencyLimits function:
```javascript
/**
 * Update frequency limits for a campaign content
 * @param {string} contentId - campaign_content ID
 * @param {Object} limits - {max_plays_per_hour, max_plays_per_day}
 */
export async function updateContentFrequencyLimits(contentId, limits)
```

Add calculateEffectiveRotation helper:
```javascript
/**
 * Calculate effective rotation percentages from weights or explicit percentages
 */
export function calculateEffectiveRotation(contents, mode)
```
- If mode is 'percentage', use rotation_percentage values
- If mode is 'weight', calculate from weights
- If mode is 'sequence' or 'random', return equal splits

Update updateContent to accept rotation/frequency fields in updates object.
  </action>
  <verify>Import functions and call with test data, verify database updates</verify>
  <done>campaignService exports ROTATION_MODES, updateContentRotation, updateContentFrequencyLimits</done>
</task>

<task type="auto">
  <name>Task 3: Rotation and Frequency UI Components</name>
  <files>src/components/campaigns/RotationControls.jsx, src/components/campaigns/FrequencyLimitControls.jsx, src/pages/CampaignEditorPage.jsx</files>
  <action>
Create RotationControls.jsx:
```jsx
import { useState, useEffect } from 'react';
import { Percent, Scale, Shuffle, ListOrdered } from 'lucide-react';
import { Button, Badge } from '../../design-system';
import { ROTATION_MODES, calculateEffectiveRotation } from '../../services/campaignService';

export function RotationControls({ contents, mode, onChange, onModeChange }) {
  // Mode selector buttons (weight, percentage, sequence, random)
  // For each content: show name and input based on mode
  // - percentage mode: number input 0-100 with % suffix
  // - weight mode: number input 1-100 with calculated percentage badge
  // - sequence/random: just show equal split
  // Error message when percentages don't sum to 100
  // Visual distribution bar showing color segments for each content
}
```

Create FrequencyLimitControls.jsx:
```jsx
import { AlertTriangle } from 'lucide-react';

export function FrequencyLimitControls({ content, onChange }) {
  // Two inputs: max per hour, max per day
  // Placeholder "Unlimited" when empty
  // Warning icon + message when limits are restrictive
  // Restrictive = hour < 3 OR day < 10
}
```

Integrate in CampaignEditorPage:
- Add "Content Settings" section below Content list
- Show RotationControls when campaign has 2+ contents
- Show FrequencyLimitControls for each content (expandable/collapsible)
- Wire onChange handlers to service functions
- Save rotation/frequency on campaign save

UI placement:
- In the Content card, add a "Settings" expand/collapse for each content item
- Show rotation mode selector at top of content list when multiple contents
  </action>
  <verify>Load campaign editor, add multiple contents, see rotation controls and frequency inputs</verify>
  <done>Campaign editor allows configuring rotation mode/percentages and frequency limits</done>
</task>

</tasks>

<verification>
1. Schema: campaign_contents has rotation_percentage, rotation_mode, max_plays columns
2. Service: ROTATION_MODES, updateContentRotation, updateContentFrequencyLimits exported
3. UI: RotationControls shows mode buttons and percentage/weight inputs
4. UI: FrequencyLimitControls shows hour/day inputs with warning for restrictive limits
5. Integration: Changes persist to database when campaign is saved
</verification>

<success_criteria>
- User can select rotation mode (weight/percentage/sequence/random)
- User can set percentages that sum to 100% (with validation)
- User can set max plays per hour/day for each content
- Warning displayed when frequency limits are restrictive
- Settings persist across page reload
</success_criteria>

<output>
After completion, create `.planning/phases/16-scheduling-polish/16-02-SUMMARY.md`
</output>
