---
phase: 16-scheduling-polish
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/129_campaign_templates_seasonal.sql
  - src/services/campaignTemplateService.js
  - src/components/campaigns/TemplatePickerModal.jsx
  - src/components/campaigns/SeasonalDatePicker.jsx
  - src/pages/CampaignEditorPage.jsx
  - src/pages/CampaignsPage.jsx
autonomous: true

must_haves:
  truths:
    - "User can save campaign configuration as a reusable template"
    - "User can create new campaign from template"
    - "User can configure seasonal recurrence (yearly auto-activation)"
    - "Seasonal campaigns auto-calculate next activation dates"
  artifacts:
    - path: "supabase/migrations/129_campaign_templates_seasonal.sql"
      provides: "campaign_templates table and recurrence_rule column"
      contains: "campaign_templates"
    - path: "src/services/campaignTemplateService.js"
      provides: "Template CRUD and seasonal activation functions"
      exports: ["saveAsTemplate", "createFromTemplate", "getTemplates"]
    - path: "src/components/campaigns/TemplatePickerModal.jsx"
      provides: "Modal for selecting and applying templates"
      exports: ["TemplatePickerModal"]
    - path: "src/components/campaigns/SeasonalDatePicker.jsx"
      provides: "UI for configuring seasonal recurrence"
      exports: ["SeasonalDatePicker"]
  key_links:
    - from: "src/pages/CampaignEditorPage.jsx"
      to: "src/services/campaignTemplateService.js"
      via: "saveAsTemplate call"
      pattern: "saveAsTemplate"
    - from: "src/pages/CampaignsPage.jsx"
      to: "src/components/campaigns/TemplatePickerModal.jsx"
      via: "template picker for new campaign"
      pattern: "TemplatePickerModal"
---

<objective>
Add campaign templates for reuse and seasonal scheduling for auto-activation.

Purpose: Users need to quickly recreate similar campaigns and set up recurring seasonal campaigns.
Output: Template table and service, template picker UI, seasonal recurrence configuration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/16-scheduling-polish/16-RESEARCH.md

Key decisions from RESEARCH:
- Templates store structure only (targets, settings), NOT specific content IDs
- Templates have JSONB template_data field
- Seasonal uses recurrence_rule JSONB: {type, month, day, duration_days}
- Existing update_campaign_statuses() handles scheduled->active transitions
</context>

<tasks>

<task type="auto">
  <name>Task 1: Templates and Seasonal Schema</name>
  <files>supabase/migrations/129_campaign_templates_seasonal.sql</files>
  <action>
Create migration for templates table and seasonal column:

```sql
-- Campaign Templates table
CREATE TABLE IF NOT EXISTS public.campaign_templates (
  id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
  tenant_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
  name TEXT NOT NULL,
  description TEXT,
  template_data JSONB NOT NULL,
  is_system BOOLEAN DEFAULT false,
  tags TEXT[] DEFAULT '{}',
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

-- template_data structure:
-- {
--   "targets": [{"target_type": "screen_group", "target_id": null}],
--   "contents": [{"content_type": "playlist", "content_id": null, "weight": 1, "position": 0}],
--   "settings": {"priority": 100, "rotation_mode": "weight"},
--   "schedule": {"days_of_week": [1,2,3,4,5]}
-- }

CREATE INDEX idx_campaign_templates_tenant ON campaign_templates(tenant_id);

-- RLS policies (user's own + system templates)
ALTER TABLE campaign_templates ENABLE ROW LEVEL SECURITY;

CREATE POLICY "campaign_templates_select" ON campaign_templates FOR SELECT
  USING (tenant_id = auth.uid() OR is_system = true);

CREATE POLICY "campaign_templates_insert" ON campaign_templates FOR INSERT
  WITH CHECK (tenant_id = auth.uid());

CREATE POLICY "campaign_templates_update" ON campaign_templates FOR UPDATE
  USING (tenant_id = auth.uid() AND is_system = false);

CREATE POLICY "campaign_templates_delete" ON campaign_templates FOR DELETE
  USING (tenant_id = auth.uid() AND is_system = false);

-- Add seasonal recurrence to campaigns
ALTER TABLE campaigns
ADD COLUMN IF NOT EXISTS recurrence_rule JSONB DEFAULT NULL;

-- recurrence_rule structure:
-- {
--   "type": "yearly",
--   "month": 12,
--   "day": 15,
--   "duration_days": 20
-- }

COMMENT ON COLUMN campaigns.recurrence_rule IS
'Seasonal recurrence pattern. Type: yearly. Auto-activates campaign on month/day for duration_days.';

-- Function to update seasonal campaigns
CREATE OR REPLACE FUNCTION public.update_seasonal_campaigns()
RETURNS void
LANGUAGE plpgsql SECURITY DEFINER AS $$
DECLARE
  v_campaign RECORD;
  v_start DATE;
  v_end DATE;
BEGIN
  FOR v_campaign IN
    SELECT * FROM campaigns
    WHERE recurrence_rule IS NOT NULL
      AND status IN ('completed', 'paused')
  LOOP
    v_start := make_date(
      EXTRACT(YEAR FROM CURRENT_DATE)::INT,
      (v_campaign.recurrence_rule->>'month')::INT,
      (v_campaign.recurrence_rule->>'day')::INT
    );
    v_end := v_start + ((v_campaign.recurrence_rule->>'duration_days')::INT || ' days')::INTERVAL;

    IF CURRENT_DATE >= v_start AND CURRENT_DATE <= v_end THEN
      UPDATE campaigns
      SET
        status = 'active',
        start_at = v_start::TIMESTAMPTZ,
        end_at = v_end::TIMESTAMPTZ,
        updated_at = now()
      WHERE id = v_campaign.id;
    END IF;
  END LOOP;
END;
$$;

GRANT SELECT, INSERT, UPDATE, DELETE ON campaign_templates TO authenticated;
GRANT EXECUTE ON FUNCTION update_seasonal_campaigns TO authenticated;
```
  </action>
  <verify>Run `npx supabase db push`, verify campaign_templates table and recurrence_rule column exist</verify>
  <done>Schema has campaign_templates table with RLS, campaigns.recurrence_rule column, update_seasonal_campaigns function</done>
</task>

<task type="auto">
  <name>Task 2: Template and Seasonal Service</name>
  <files>src/services/campaignTemplateService.js</files>
  <action>
Create new service for template operations:

```javascript
import { supabase } from '../supabase';
import { getEffectiveOwnerId } from './tenantService';
import { createScopedLogger } from './loggingService';
import { getCampaign, createCampaign } from './campaignService';

const logger = createScopedLogger('CampaignTemplateService');

/**
 * Get all templates for current tenant (plus system templates)
 */
export async function getTemplates()

/**
 * Get single template by ID
 */
export async function getTemplate(templateId)

/**
 * Save existing campaign as template
 * Extracts structure but NOT specific content/target IDs
 */
export async function saveAsTemplate(campaignId, templateName, description = '')

/**
 * Create new campaign from template
 * Applies template settings, user must add specific content
 */
export async function createFromTemplate(templateId, campaignName, overrides = {})

/**
 * Delete a template
 */
export async function deleteTemplate(templateId)

/**
 * Update campaign's seasonal recurrence rule
 */
export async function setSeasonalRecurrence(campaignId, recurrenceRule)
// recurrenceRule: {type: 'yearly', month: 12, day: 15, duration_days: 20}

/**
 * Clear seasonal recurrence (make campaign one-time)
 */
export async function clearSeasonalRecurrence(campaignId)

/**
 * Calculate next activation date for seasonal campaign
 */
export function calculateNextActivation(recurrenceRule)
```

saveAsTemplate implementation:
- Load campaign with getCampaign()
- Extract template_data with target types (not IDs), content types (not IDs), settings
- Insert into campaign_templates
- Return created template

createFromTemplate implementation:
- Load template
- Create campaign with template settings
- Return new campaign (user fills in content/targets separately)
  </action>
  <verify>Import service, call getTemplates/saveAsTemplate, verify database records</verify>
  <done>Service exports getTemplates, saveAsTemplate, createFromTemplate, setSeasonalRecurrence</done>
</task>

<task type="auto">
  <name>Task 3: Template and Seasonal UI</name>
  <files>src/components/campaigns/TemplatePickerModal.jsx, src/components/campaigns/SeasonalDatePicker.jsx, src/pages/CampaignEditorPage.jsx, src/pages/CampaignsPage.jsx</files>
  <action>
Create TemplatePickerModal.jsx:
```jsx
import { useState, useEffect } from 'react';
import { X, FileText, Check } from 'lucide-react';
import { Button, Card, Badge } from '../../design-system';
import { getTemplates } from '../../services/campaignTemplateService';

export function TemplatePickerModal({ onSelect, onClose }) {
  // List available templates (grouped: My Templates, System Templates)
  // Each template shows: name, description, tags
  // Preview: target types, content types, settings summary
  // Select button calls onSelect(templateId)
  // Cancel button calls onClose
}
```

Create SeasonalDatePicker.jsx:
```jsx
import { useState } from 'react';
import { Calendar, Repeat, AlertCircle } from 'lucide-react';
import { Badge } from '../../design-system';

export function SeasonalDatePicker({ value, onChange }) {
  // value: {type, month, day, duration_days} or null
  // Enable/disable toggle for seasonal
  // Month dropdown (Jan-Dec)
  // Day input (1-31, validated per month)
  // Duration input (days)
  // Preview: "Activates Dec 15 for 20 days (ends Jan 4)"
  // Next activation date calculation shown
}
```

Integrate in CampaignEditorPage:
- Add "Save as Template" button in header actions
- Opens simple modal: template name, description, save/cancel
- Calls saveAsTemplate on confirm
- Add SeasonalDatePicker in Campaign Details card (below dates)
- Label: "Seasonal Recurrence (Optional)"
- Wire to setSeasonalRecurrence on save

Integrate in CampaignsPage:
- Add "Create from Template" option in "New Campaign" dropdown/button
- Opens TemplatePickerModal
- On select: createFromTemplate, navigate to new campaign editor
  </action>
  <verify>
1. Campaign editor: save campaign as template, template appears in list
2. Campaigns page: create from template, new campaign has template settings
3. Campaign editor: set seasonal recurrence, verify saved to database
  </verify>
  <done>Users can save/apply templates and configure seasonal auto-activation</done>
</task>

</tasks>

<verification>
1. Schema: campaign_templates table exists with proper RLS
2. Schema: campaigns.recurrence_rule column exists
3. Service: Template CRUD functions work
4. Service: Seasonal recurrence functions work
5. UI: "Save as Template" creates template record
6. UI: "Create from Template" creates campaign with template settings
7. UI: SeasonalDatePicker configures recurrence_rule
</verification>

<success_criteria>
- User can save any campaign as a template
- User can create new campaign from template
- User can configure yearly seasonal recurrence
- Seasonal preview shows next activation date
- Templates appear in template picker (user's + system)
</success_criteria>

<output>
After completion, create `.planning/phases/16-scheduling-polish/16-03-SUMMARY.md`
</output>
