---
phase: 06-player-reliability
plan: 03
type: execute
wave: 2
depends_on:
  - 06-01
  - 06-02
files_modified: []
autonomous: false

must_haves:
  truths:
    - "Failed syncs retry with exponential backoff and jitter"
    - "Screenshots taken offline upload when connection restores"
    - "Kiosk exit requires correct password when offline"
    - "Incorrect password is rejected when offline"
    - "Error logs include context for debugging"
  artifacts:
    - path: "src/services/playerService.js"
      provides: "calculateBackoff with full jitter, offline password verification"
      exports: ["calculateBackoff", "validateKioskPasswordOffline"]
    - path: "src/player/offlineService.js"
      provides: "Complete screenshot sync implementation"
      contains: "syncPendingScreenshots"
    - path: "src/Player.jsx"
      provides: "Structured error logging in catch blocks"
      contains: "appDataLogger.warn"
  key_links:
    - from: "Player retry logic"
      to: "calculateBackoff"
      via: "exponential backoff with full jitter"
      pattern: "calculateBackoff\\("
    - from: "Screenshot capture offline"
      to: "offline queue sync"
      via: "queueOfflineEvent -> syncPendingScreenshots"
      pattern: "queueOfflineEvent\\('screenshot'"
    - from: "Kiosk exit"
      to: "offline password verification"
      via: "validateKioskPasswordOffline with cached hash"
      pattern: "validateKioskPasswordOffline\\("
---

<objective>
Verify that retry logic, offline screenshot sync, and kiosk exit password all work correctly through manual testing.

Purpose: Confirm PLR-01 through PLR-04 are fully functional in realistic scenarios (network failures, offline operation, error conditions).

Output: Human-verified confirmation that all player reliability improvements work as intended.
</objective>

<execution_context>
@/Users/massimodamico/bizscreen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/massimodamico/bizscreen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/massimodamico/bizscreen/.planning/PROJECT.md
@/Users/massimodamico/bizscreen/.planning/ROADMAP.md
@/Users/massimodamico/bizscreen/.planning/STATE.md
@/Users/massimodamico/bizscreen/.planning/phases/06-player-reliability/06-CONTEXT.md
@/Users/massimodamico/bizscreen/.planning/phases/06-player-reliability/06-RESEARCH.md

## Prior Plans

Plan 06-01:
- Updated calculateBackoff to use full jitter (0-100% randomization)
- Replaced empty catch blocks at lines 209, 239 with logger.warn calls

Plan 06-02:
- Implemented syncPendingScreenshots with blob serialization
- Added offline screenshot queueing in screenshotService.js
- Added validateKioskPasswordOffline with SHA-256 cached hash
- Added cacheKioskPasswordHash for storing admin password hash
</context>

<tasks>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Plans 06-01 and 06-02 implemented:
- Exponential backoff with full jitter (0-100% randomization)
- Offline screenshot queue with automatic sync on reconnect
- Kiosk exit password verification using cached SHA-256 hash
- Structured error logging in Player.jsx catch blocks
  </what-built>

  <how-to-verify>
**Test 1: Retry with exponential backoff (PLR-01)**

1. Start dev server: `npm run dev`
2. Open browser DevTools (Network tab)
3. Navigate to player page
4. Enable network throttling: DevTools -> Network -> "Offline" checkbox
5. Watch console logs for retry attempts
6. Verify delays increase: ~0-1s, ~0-2s, ~0-4s, ~0-8s (randomized within range)
7. Disable "Offline" mode
8. Verify player reconnects and syncs content
9. Check that delays are randomized (not fixed 1s, 2s, 4s)

Expected: Console shows retry attempts with increasing, randomized delays. No "thundering herd" pattern (all requests at same interval).

**Test 2: Offline screenshot sync (PLR-02)**

1. With dev server running, navigate to player page as admin
2. Enable network throttling: DevTools -> Network -> "Offline"
3. Trigger screenshot (via admin panel or scheduled screenshot)
4. Check console: Should see "Screenshot queued for offline sync"
5. Check IndexedDB: Application tab -> IndexedDB -> offlineQueue store
6. Verify screenshot entry exists with base64 imageData
7. Disable "Offline" mode (restore network)
8. Wait 10-30 seconds for automatic sync
9. Check console: Should see "Synced queued screenshot"
10. Verify screenshot appears in admin dashboard

Expected: Screenshot taken while offline appears in queue, uploads automatically when online, visible in admin panel.

**Test 3: Kiosk exit offline password verification (PLR-03)**

**Setup: Cache password hash**
1. Add this to Player.jsx componentDidMount or admin login success handler:
```javascript
import { cacheKioskPasswordHash } from './services/playerService.js';
// After successful admin login:
await cacheKioskPasswordHash('your-admin-password');
```
2. Reload player, login as admin to cache hash
3. Check localStorage: Key "kiosk_password_hash" should exist with 64-char hex string

**Test offline verification:**
1. Enable network throttling: DevTools -> Network -> "Offline"
2. Trigger kiosk exit (5 taps on bottom-right corner OR keyboard shortcut)
3. Enter CORRECT admin password
4. Verify kiosk exit is granted (exits fullscreen/redirects)
5. Re-enter kiosk mode
6. Trigger kiosk exit again
7. Enter INCORRECT password (wrong characters)
8. Verify kiosk exit is rejected with error message
9. Try again with CORRECT password
10. Verify kiosk exit is granted

Expected: Kiosk exit works offline with correct password, rejects incorrect password, no network calls made during verification.

**Test 4: Error logging (PLR-04)**

1. Open browser console (Console tab)
2. Navigate to player page
3. Trigger cache operations (refresh page, trigger app data fetch)
4. Simulate storage error: DevTools -> Application -> Storage -> Block cookies/localStorage
5. Refresh page
6. Check console for structured log messages:
   - "Failed to cache app data" with error context
   - "Failed to read cached app data" with cacheKey
7. Verify logs include contextual data (cacheKey, dataSize, error.message)
8. Verify no silent failures (no empty catch blocks)

Expected: All cache errors produce visible warn logs with context. No operations fail silently.

**Success Criteria:**
- [ ] Test 1: Retry delays are randomized and exponential (0-1s, 0-2s, 0-4s...)
- [ ] Test 2: Screenshots queue offline and sync automatically on reconnect
- [ ] Test 3: Kiosk exit works offline with correct password, rejects incorrect
- [ ] Test 4: Cache errors produce structured logs with context
  </how-to-verify>

  <resume-signal>
Type "approved" if all 4 tests pass.

If issues found, describe:
- Which test failed
- Expected vs actual behavior
- Console errors or logs
  </resume-signal>
</task>

</tasks>

<verification>
Manual testing confirms:
1. Exponential backoff with full jitter works correctly (PLR-01)
2. Screenshots queue offline and upload on reconnect (PLR-02)
3. Kiosk exit password verified offline via cached hash (PLR-03)
4. Error logs include context instead of silent failures (PLR-04)
</verification>

<success_criteria>
**Phase 6 complete:** All player reliability requirements verified through manual testing

**PLR-01:** Failed syncs retry with exponential backoff and jitter ✓
**PLR-02:** Offline screenshots queue and sync on reconnect ✓
**PLR-03:** Kiosk exit password works offline with cached hash ✓
**PLR-04:** Empty catch blocks replaced with structured logging ✓

User confirms all tests pass and reliability improvements work in realistic scenarios.
</success_criteria>

<output>
After completion, create `.planning/phases/06-player-reliability/06-03-SUMMARY.md` with:
- Test results for each verification scenario
- Any issues encountered and resolutions
- Confirmation that Phase 6 requirements are met
- Ready for Phase 7 (Player Refactoring)
</output>
