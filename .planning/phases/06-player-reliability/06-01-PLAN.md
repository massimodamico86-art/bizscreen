---
phase: 06-player-reliability
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/playerService.js
  - src/Player.jsx
autonomous: true

must_haves:
  truths:
    - "Failed sync retries with increasing delays (1s, 2s, 4s...)"
    - "Retry delays include randomization to prevent thundering herd"
    - "Error logs include context instead of silent failures"
  artifacts:
    - path: "src/services/playerService.js"
      provides: "calculateBackoff with full jitter (0-100% randomization)"
      exports: ["calculateBackoff"]
    - path: "src/Player.jsx"
      provides: "Error logging with context for cache operations"
      min_lines: 2400
  key_links:
    - from: "src/Player.jsx"
      to: "src/services/playerService.js"
      via: "calculateBackoff import"
      pattern: "import.*calculateBackoff.*from.*playerService"
    - from: "src/Player.jsx catch blocks"
      to: "loggingService"
      via: "logger.warn calls"
      pattern: "logger\\.warn\\("
---

<objective>
Standardize retry behavior across the player and replace empty catch blocks with proper error logging.

Purpose: Ensures network failures trigger consistent exponential backoff with full jitter (preventing thundering herd), and all errors are observable in logs for debugging.

Output: Updated calculateBackoff with full jitter, Player.jsx using structured logging in catch blocks.
</objective>

<execution_context>
@/Users/massimodamico/bizscreen/.claude/get-shit-done/workflows/execute-plan.md
@/Users/massimodamico/bizscreen/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/massimodamico/bizscreen/.planning/PROJECT.md
@/Users/massimodamico/bizscreen/.planning/ROADMAP.md
@/Users/massimodamico/bizscreen/.planning/STATE.md
@/Users/massimodamico/bizscreen/.planning/phases/06-player-reliability/06-CONTEXT.md
@/Users/massimodamico/bizscreen/.planning/phases/06-player-reliability/06-RESEARCH.md

## Prior Phase Context

Phase 4 (Logging Migration) established structured logging patterns:
- loggingService.js provides logger.warn, logger.error with PII redaction
- All services migrated from console.log to structured logging
- useLogger hook available for React components

## Files to Modify

src/services/playerService.js:
- Contains calculateBackoff() at lines 435-440
- Current jitter: ±20% (delay * 0.2 * (Math.random() - 0.5))
- Need: Full jitter 0-100% (delay * Math.random())

src/Player.jsx:
- Empty catch at line 209: sessionStorage.setItem - ignores storage errors
- Empty catch at line 239: sessionStorage.getItem - ignores cache errors
- Need: logger.warn with error message, contextual data (cacheKey, dataSize)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update calculateBackoff to use full jitter</name>
  <files>src/services/playerService.js</files>
  <action>
Modify calculateBackoff() function (lines 435-440) to use full jitter instead of ±20%:

**Current implementation:**
```javascript
const jitter = delay * 0.2 * (Math.random() - 0.5);
return Math.round(delay + jitter);
```

**Updated implementation:**
```javascript
// Use full jitter (0-100% of delay) to prevent thundering herd
const jitter = delay * Math.random();
return Math.round(jitter);
```

Why: Full jitter (0-100% randomization) prevents all offline devices from retrying simultaneously when network restores. The ±20% jitter provides insufficient distribution.

Update the JSDoc comment to reflect full jitter behavior:
```javascript
* Calculates exponential backoff delay with full jitter
* @param {number} attempt - Retry attempt number (0-indexed)
* @param {number} baseDelay - Base delay in milliseconds (default: 1000)
* @param {number} maxDelay - Maximum delay cap (default: 60000)
* @returns {number} Delay in milliseconds with full jitter (0-100% of calculated delay)
```

This function is used by retryWithBackoff() at line 465, which is called throughout the codebase for network operations.
  </action>
  <verify>
Run tests to ensure calculateBackoff still works:
```bash
npm test -- playerService
```

Verify jitter produces values in 0-100% range (not ±20%):
```bash
node -e "
const calculateBackoff = (attempt, baseDelay = 1000, maxDelay = 60000) => {
  const delay = Math.min(baseDelay * Math.pow(2, attempt), maxDelay);
  const jitter = delay * Math.random();
  return Math.round(jitter);
};
console.log('Attempt 0:', calculateBackoff(0)); // 0-1000ms
console.log('Attempt 1:', calculateBackoff(1)); // 0-2000ms
console.log('Attempt 2:', calculateBackoff(2)); // 0-4000ms
console.log('Attempt 3:', calculateBackoff(3)); // 0-8000ms
"
```
  </verify>
  <done>calculateBackoff uses full jitter (delay * Math.random()), JSDoc updated, tests pass</done>
</task>

<task type="auto">
  <name>Task 2: Replace empty catch blocks with structured logging</name>
  <files>src/Player.jsx</files>
  <action>
Replace the two empty catch blocks identified in research with proper error logging.

**Line 209 - sessionStorage.setItem error:**

Current:
```javascript
} catch (e) {
  // Ignore storage errors
}
```

Replace with:
```javascript
} catch (error) {
  appDataLogger.warn('Failed to cache app data', {
    error: error.message,
    cacheKey,
    dataSize: JSON.stringify(result.data).length,
  });
  // Non-critical: continue execution without cache
}
```

Why: Storage errors (QuotaExceededError, SecurityError) should be logged for debugging. Include context (cacheKey, dataSize) to understand what failed. Use existing appDataLogger from line 198.

**Line 239 - sessionStorage.getItem error:**

Current:
```javascript
} catch (e) {
  // Ignore cache errors
}
```

Replace with:
```javascript
} catch (error) {
  appDataLogger.warn('Failed to read cached app data', {
    error: error.message,
    cacheKey,
  });
  // Non-critical: fall through to fetchData()
}
```

Why: Cache read failures (invalid JSON, storage access denied) should be logged. Use warn level (not error) because cache is optional - fetchData() will run anyway.

Both catches are non-critical (app continues without cache), so logger.warn is appropriate. Include error.message not full error object (loggingService handles serialization).
  </action>
  <verify>
Search for remaining empty catch blocks in Player.jsx:
```bash
grep -n "} catch" src/Player.jsx | head -20
```

Verify the two identified catches now have logger.warn calls:
```bash
grep -A 3 "} catch (error)" src/Player.jsx | grep -B 1 "appDataLogger.warn"
```

Run linter to check for console.log:
```bash
npm run lint -- src/Player.jsx
```
  </verify>
  <done>Lines 209 and 239 have logger.warn with error context, no more empty catch blocks in those locations</done>
</task>

</tasks>

<verification>
1. calculateBackoff produces delays in range [0, delay] not [delay*0.8, delay*1.2]
2. Player.jsx has no empty catch blocks at lines 209, 239
3. All catch blocks include logger.warn or logger.error calls
4. npm test passes without new failures
5. ESLint passes src/Player.jsx and src/services/playerService.js
</verification>

<success_criteria>
**PLR-01 partial:** calculateBackoff uses full jitter (complete exponential backoff pattern)
**PLR-04 partial:** Empty catch blocks at lines 209, 239 replaced with structured logging

Measurable outcomes:
- calculateBackoff(3) returns 0-8000ms (not 6400-9600ms)
- grep "} catch (e)" src/Player.jsx at lines 209, 239 returns nothing
- grep "appDataLogger.warn.*Failed to.*cache" src/Player.jsx returns 2 matches
</success_criteria>

<output>
After completion, create `.planning/phases/06-player-reliability/06-01-SUMMARY.md` with:
- Tasks completed
- Code changes summary
- Test results
- Files modified with line counts
</output>
