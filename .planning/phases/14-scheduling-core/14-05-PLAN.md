---
phase: 14-scheduling-core
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/scheduleService.js
  - src/components/schedules/WeekPreview.jsx
  - src/components/schedules/DateDurationPicker.jsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "DST transitions handled correctly (no double-plays or skips)"
    - "Date calculations use timezone-aware TZDate from @date-fns/tz"
    - "Week preview generates correct days across DST boundaries"
  artifacts:
    - path: "src/services/scheduleService.js"
      provides: "TZDate import and DST-safe week calculations"
      contains: "@date-fns/tz"
    - path: "src/components/schedules/WeekPreview.jsx"
      provides: "Timezone-aware date handling"
      contains: "TZDate"
  key_links:
    - from: "scheduleService.js"
      to: "@date-fns/tz"
      via: "import statement"
      pattern: "from '@date-fns/tz'"
    - from: "WeekPreview.jsx"
      to: "@date-fns/tz"
      via: "import statement"
      pattern: "from '@date-fns/tz'"
---

<objective>
Integrate @date-fns/tz for DST-safe date handling

Purpose: Close Gap 2 from VERIFICATION.md - @date-fns/tz is installed but never used, causing potential DST failures (double-plays or skips at 2am transitions)

Output: All schedule date calculations use TZDate for timezone awareness, DST transitions handled correctly
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-scheduling-core/14-VERIFICATION.md
@src/services/scheduleService.js
@src/components/schedules/WeekPreview.jsx
@src/components/schedules/DateDurationPicker.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add TZDate to scheduleService.js getWeekPreview</name>
  <files>src/services/scheduleService.js</files>
  <action>
    1. Add import at top of file (after existing date-fns imports or near other imports):
    ```javascript
    import { TZDate } from '@date-fns/tz';
    ```

    2. In getWeekPreview function (around line 790), replace:
    ```javascript
    const startDate = new Date(weekStartDate);
    ```
    With:
    ```javascript
    // Use TZDate for DST-safe date calculations
    // Default to UTC if no timezone provided, actual device timezone used at playback
    const startDate = new TZDate(weekStartDate, 'UTC');
    ```

    3. In the week building loop (around line 892-894), update date increment to use TZDate:
    ```javascript
    for (let i = 0; i < 7; i++) {
      // Use TZDate for DST-safe day increments
      const date = new TZDate(startDate.getTime() + i * 24 * 60 * 60 * 1000, 'UTC');
    ```

    4. Update dateStr calculation to handle TZDate properly:
    ```javascript
    const dateStr = date.toISOString().split('T')[0];
    ```

    Note: The key change is using TZDate which correctly handles the ambiguous hour during DST transitions. When content plays at 2am during "fall back", TZDate distinguishes between the first and second 2am. During "spring forward", TZDate correctly skips the non-existent 2am.
  </action>
  <verify>
    1. Run: `grep -n "@date-fns/tz" src/services/scheduleService.js` - should show import
    2. Run: `grep -n "TZDate" src/services/scheduleService.js` - should show usage
    3. Run: `npm run dev` - no import errors
    4. Test getWeekPreview in browser console or via API - returns 7 days correctly
  </verify>
  <done>scheduleService.js uses TZDate for week preview date calculations</done>
</task>

<task type="auto">
  <name>Task 2: Add TZDate to WeekPreview.jsx date handling</name>
  <files>src/components/schedules/WeekPreview.jsx</files>
  <action>
    1. Add import at top of file:
    ```javascript
    import { TZDate } from '@date-fns/tz';
    ```

    2. Update getWeekStart function (around line 32) to use TZDate:
    ```javascript
    function getWeekStart(date) {
      // Use TZDate for DST-safe week start calculation
      const d = new TZDate(date, 'UTC');
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      const result = new TZDate(d.getFullYear(), d.getMonth(), diff, 0, 0, 0, 0, 'UTC');
      return result;
    }
    ```

    3. Update goToPreviousWeek (around line 167):
    ```javascript
    const goToPreviousWeek = () => {
      const prevTime = weekStart.getTime() - 7 * 24 * 60 * 60 * 1000;
      setWeekStart(new TZDate(prevTime, 'UTC'));
    };
    ```

    4. Update goToNextWeek (around line 173):
    ```javascript
    const goToNextWeek = () => {
      const nextTime = weekStart.getTime() + 7 * 24 * 60 * 60 * 1000;
      setWeekStart(new TZDate(nextTime, 'UTC'));
    };
    ```

    5. Update goToCurrentWeek (around line 179):
    ```javascript
    const goToCurrentWeek = () => {
      setWeekStart(getWeekStart(new TZDate(Date.now(), 'UTC')));
    };
    ```

    6. Update isCurrentWeek check (around line 184) to handle TZDate comparison:
    ```javascript
    const isCurrentWeek = getWeekStart(new TZDate(Date.now(), 'UTC')).getTime() === weekStart.getTime();
    ```

    Note: We use 'UTC' timezone for all calculations since the actual display timezone is the device's local time. This ensures consistent behavior across server and client.
  </action>
  <verify>
    1. Run: `grep -n "@date-fns/tz" src/components/schedules/WeekPreview.jsx` - should show import
    2. Run: `grep -n "TZDate" src/components/schedules/WeekPreview.jsx` - should show multiple usages
    3. Open ScheduleEditorPage, verify week preview loads correctly
    4. Click previous/next week buttons, verify navigation works
    5. Click "Today" button, verify returns to current week
  </verify>
  <done>WeekPreview.jsx uses TZDate for all date navigation and calculations</done>
</task>

<task type="auto">
  <name>Task 3: Add TZDate to DateDurationPicker.jsx duration calculations</name>
  <files>src/components/schedules/DateDurationPicker.jsx</files>
  <action>
    1. Add import at top of file, updating existing date-fns imports:
    ```javascript
    import { TZDate } from '@date-fns/tz';
    ```

    2. Update calculateEndDate function (around line 100) to use TZDate for DST-safe calculations:
    ```javascript
    const calculateEndDate = useCallback((start, durationValue) => {
      if (!start) return null;
      // Use TZDate for DST-safe duration calculations
      const startDateObj = new TZDate(start, 'UTC');
      const preset = DURATION_PRESETS.find(p => p.value === durationValue);

      if (!preset) return null;
      if (preset.forever) return null;
      if (preset.custom) return endDate;

      if (preset.days) {
        return addDays(startDateObj, preset.days - 1);
      }
      if (preset.months) {
        return addDays(addMonths(startDateObj, preset.months), -1);
      }
      if (preset.special === 'weekend') {
        const dayOfWeek = getDay(startDateObj);
        const daysToSunday = dayOfWeek === 0 ? 0 : 7 - dayOfWeek;
        return addDays(startDateObj, daysToSunday);
      }
      if (preset.special === 'this_week') {
        return endOfWeek(startDateObj, { weekStartsOn: 1 });
      }

      return null;
    }, [endDate]);
    ```

    Note: The date-fns functions (addDays, addMonths, endOfWeek) already work correctly with TZDate objects passed to them. The key is ensuring the input date is a TZDate.

    3. Add a JSDoc comment above the import to document the DST handling pattern:
    ```javascript
    /**
     * DateDurationPicker Component
     *
     * Uses @date-fns/tz TZDate for DST-safe date calculations.
     * All internal date operations use UTC timezone to ensure consistent
     * behavior. Display formatting respects the provided timezone prop.
     * ...
     */
    ```
  </action>
  <verify>
    1. Run: `grep -n "@date-fns/tz" src/components/schedules/DateDurationPicker.jsx` - should show import
    2. Run: `grep -n "TZDate" src/components/schedules/DateDurationPicker.jsx` - should show usage
    3. Open event modal, select a start date
    4. Select "1 week" duration, verify end date is 6 days later (correct math)
    5. Select "1 month" duration, verify end date is ~30 days later
  </verify>
  <done>DateDurationPicker.jsx uses TZDate for duration calculations across DST boundaries</done>
</task>

</tasks>

<verification>
After all tasks complete:
1. grep shows @date-fns/tz imported in all 3 files
2. grep shows TZDate usage in all 3 files
3. WeekPreview loads and navigates correctly
4. DateDurationPicker calculates durations correctly
5. No runtime errors in console
6. Week preview shows 7 consecutive days (no gaps or duplicates)
</verification>

<success_criteria>
- TZDate imported and used in scheduleService.js, WeekPreview.jsx, DateDurationPicker.jsx
- Week calculations produce exactly 7 days with no gaps
- Duration calculations work across DST boundaries
- No "double-play" or "skip" scenarios possible at DST transitions
- Truth #5 from VERIFICATION.md now passable: "DST transitions handled correctly"
</success_criteria>

<output>
After completion, create `.planning/phases/14-scheduling-core/14-05-SUMMARY.md`
</output>
