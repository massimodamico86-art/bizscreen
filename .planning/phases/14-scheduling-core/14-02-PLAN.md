---
phase: 14-scheduling-core
plan: 02
type: execute
wave: 2
depends_on: ["14-01"]
files_modified:
  - src/components/schedules/ConflictWarning.jsx
  - src/pages/ScheduleEditorPage.jsx
autonomous: true

must_haves:
  truths:
    - "User cannot save entry when conflicts exist"
    - "User sees which device(s) are affected by conflict"
    - "User sees conflicting content name and date/time overlap details"
    - "Existing conflicts shown in entry list with warning highlight"
  artifacts:
    - path: "src/components/schedules/ConflictWarning.jsx"
      provides: "Blocking conflict display with device info"
      min_lines: 80
  key_links:
    - from: "src/pages/ScheduleEditorPage.jsx"
      to: "ConflictWarning"
      via: "blocks save button when hasConflicts"
      pattern: "hasConflicts.*disabled|disabled.*hasConflicts"
    - from: "src/components/schedules/ConflictWarning.jsx"
      to: "conflict.devices"
      via: "displays affected devices"
      pattern: "device|affected"
---

<objective>
Enhance conflict detection to block saves and show device-specific information

Purpose: Prevent users from creating overlapping schedules by blocking save until conflicts are resolved, with clear device-specific feedback (SCHED-03).

Output: Enhanced ConflictWarning component that blocks saves, device-aware conflict display, integrated blocking behavior in ScheduleEditorPage
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/14-scheduling-core/14-CONTEXT.md
@.planning/phases/14-scheduling-core/14-RESEARCH.md
@.planning/phases/14-scheduling-core/14-01-PLAN.md
@src/components/schedules/ConflictWarning.jsx
@src/pages/ScheduleEditorPage.jsx
@src/services/scheduleService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance ConflictWarning component</name>
  <files>src/components/schedules/ConflictWarning.jsx</files>
  <action>
Upgrade ConflictWarning from informational to blocking per CONTEXT.md:
- "Block saving until conflict resolved - cannot save with active conflicts"
- "Detailed conflict info: conflicting content name, date range overlap, which device(s) affected"

**Current state (to preserve):**
- Red alert box with conflict details
- Lists each conflicting entry with time range and content name
- Resolution suggestions text

**Enhancements:**

1. **Update header to indicate blocking:**
```jsx
<h4 className="font-medium text-red-800 text-sm">
  Cannot Save - Time Conflict Detected
</h4>
```

2. **Add device information display:**
Each conflict should show affected devices:
```jsx
{conflict.devices && conflict.devices.length > 0 && (
  <div className="flex items-center gap-1 mt-1 text-xs text-gray-500">
    <Monitor size={12} />
    <span>{conflict.devices.length} device(s): {conflict.devices.map(d => d.name).join(', ')}</span>
  </div>
)}
```

3. **Add date range overlap details:**
```jsx
{conflict.start_date && (
  <div className="text-xs text-gray-500 mt-0.5">
    {formatDateDisplay(conflict.start_date)}
    {conflict.end_date ? ` - ${formatDateDisplay(conflict.end_date)}` : ' (no end date)'}
  </div>
)}
```

4. **Add resolution action buttons (optional):**
Per CONTEXT.md pattern:
```jsx
<div className="flex gap-2 mt-2">
  <button
    onClick={() => onResolve?.('adjust', conflict)}
    className="text-xs text-blue-600 hover:text-blue-800"
  >
    Adjust this entry
  </button>
</div>
```

5. **Export blocking state:**
Add prop for parent to know if saving should be blocked:
```jsx
// Parent can use conflicts.length > 0 to disable save button
// No new prop needed, just document the pattern
```

**Props update:**
- conflicts: array (existing)
- onDismiss: function (existing - but should NOT allow dismissing blocking conflicts)
- onResolve: function (new - optional, for resolution actions)
- className: string (existing)

**Import additions:**
- Monitor from lucide-react for device icon
- Add date formatting helper (reuse from scheduleService or add locally)
  </action>
  <verify>
Component renders with:
- "Cannot Save" header text
- Device information displayed when available
- Date range overlap shown
- Resolution suggestion text remains
  </verify>
  <done>
ConflictWarning displays blocking header, device names, date overlap details, and is ready for save-blocking integration
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate blocking behavior into ScheduleEditorPage</name>
  <files>src/pages/ScheduleEditorPage.jsx</files>
  <action>
Update ScheduleEditorPage to block saves when conflicts exist:

**1. Track conflict state:**
The page already calls `checkEntryConflicts` - ensure the result includes device info.

Current flow:
- User edits entry form
- Real-time conflict check on time/date changes
- ConflictWarning displays if conflicts found
- User can still save (current behavior)

New flow:
- Same detection
- Save button disabled when conflicts.length > 0
- Clear visual indication that save is blocked

**2. Disable save button when conflicts exist:**
Find the save button in entry form and add disabled state:
```jsx
<Button
  onClick={handleSaveEntry}
  disabled={isLoading || hasConflicts}
  className={hasConflicts ? 'opacity-50 cursor-not-allowed' : ''}
>
  {hasConflicts ? 'Resolve Conflicts to Save' : 'Save Entry'}
</Button>
```

**3. Enhance conflict check to include device info:**
The existing `checkEntryConflicts` RPC returns basic conflict data. To get device info:

Option A: Client-side enrichment
After getting conflicts, fetch assigned devices for the schedule and cross-reference which devices would be affected by the overlap.

Option B: Accept that current RPC shows schedule-level conflicts
Per RESEARCH.md: "Post-process client-side: filter conflicts by device overlap"

Implementation (Option A - recommended):
```javascript
// After checkEntryConflicts returns
if (result.hasConflicts) {
  // Fetch devices/groups assigned to this schedule
  const { devices, groups } = await getAssignedDevicesAndGroups(scheduleId);
  // Add device info to each conflict
  const enrichedConflicts = result.conflicts.map(c => ({
    ...c,
    devices: devices, // All devices on this schedule see the conflict
  }));
  setConflicts(enrichedConflicts);
}
```

**4. Show conflicts in entry list (existing entries with conflicts):**
Per CONTEXT.md: "Existing conflicts shown in list view with highlighted row (warning background color)"

In the entry list rendering:
```jsx
<div className={`entry-row ${entry.hasConflict ? 'bg-red-50 border-red-200' : ''}`}>
  {/* entry content */}
  {entry.hasConflict && (
    <Badge variant="error" size="sm">Conflict</Badge>
  )}
</div>
```

To detect existing conflicts: run conflict check for each entry on load, or add a batch conflict check.

**5. Remove dismiss behavior for blocking conflicts:**
The onDismiss prop should NOT allow dismissing while conflicts exist. Either:
- Don't pass onDismiss when conflicts are blocking
- Or have ConflictWarning ignore dismiss when in blocking mode
  </action>
  <verify>
1. Open ScheduleEditorPage, create/edit entry with time overlap
2. ConflictWarning appears with blocking header
3. Save button is disabled and shows "Resolve Conflicts to Save"
4. Adjust time to remove overlap
5. ConflictWarning disappears, save button enables
6. Can save entry successfully
7. If existing entries have conflicts, they show warning highlight in list
  </verify>
  <done>
- Save button disabled when conflicts exist
- Button text indicates blocking state
- Conflicts show device info when available
- Existing conflicting entries highlighted in list
- No way to bypass conflict blocking
  </done>
</task>

</tasks>

<verification>
Overall phase checks:
1. `npm run build` completes without errors
2. Cannot save entry with active conflicts (button disabled)
3. Conflict warning shows device names
4. Conflict warning shows date overlap details
5. Resolving conflict (changing time) re-enables save
6. Existing entries with conflicts show warning in list
</verification>

<success_criteria>
- ConflictWarning blocks saves (not just warns)
- Device-specific conflict information displayed
- Date range overlap details shown
- Save button disabled + text change when conflicts exist
- Existing conflicts visible in entry list
- No regressions to conflict detection
</success_criteria>

<output>
After completion, create `.planning/phases/14-scheduling-core/14-02-SUMMARY.md`
</output>
