---
phase: 02-xss-prevention
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/security/sanitize.js
  - src/security/SafeHTML.jsx
  - src/security/index.js
autonomous: true

must_haves:
  truths:
    - "DOMPurify is available as a project dependency"
    - "SafeHTML component sanitizes HTML before rendering"
    - "Sanitization config allows rich text (bold, italic, links, images) but blocks scripts"
  artifacts:
    - path: "src/security/sanitize.js"
      provides: "DOMPurify configuration and sanitization function"
      exports: ["sanitizeHTML", "SANITIZE_CONFIG"]
    - path: "src/security/SafeHTML.jsx"
      provides: "Wrapper component for safe HTML rendering"
      exports: ["SafeHTML"]
    - path: "src/security/index.js"
      provides: "Public exports for security module"
      exports: ["SafeHTML", "sanitizeHTML"]
  key_links:
    - from: "src/security/SafeHTML.jsx"
      to: "src/security/sanitize.js"
      via: "import sanitizeHTML"
      pattern: "import.*sanitize"
---

<objective>
Create security infrastructure for HTML sanitization using DOMPurify.

Purpose: Establish the foundation for XSS prevention with a centralized SafeHTML component that can be used throughout the codebase wherever dangerouslySetInnerHTML is currently used.

Output: Installed DOMPurify dependency, sanitization configuration, and SafeHTML wrapper component.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-xss-prevention/02-CONTEXT.md
@.planning/phases/02-xss-prevention/02-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install isomorphic-dompurify dependency</name>
  <files>package.json</files>
  <action>
    Run `npm install isomorphic-dompurify` to add DOMPurify with server-side support.

    Verify the dependency is added to package.json dependencies (not devDependencies).

    isomorphic-dompurify wraps DOMPurify with jsdom for Node.js compatibility, which is needed for any SSR or build-time sanitization.
  </action>
  <verify>
    - `npm ls isomorphic-dompurify` shows the package is installed
    - `grep "isomorphic-dompurify" package.json` shows it in dependencies
  </verify>
  <done>isomorphic-dompurify is installed and available for import</done>
</task>

<task type="auto">
  <name>Task 2: Create sanitization configuration and SafeHTML component</name>
  <files>src/security/sanitize.js, src/security/SafeHTML.jsx, src/security/index.js</files>
  <action>
    Create `src/security/` directory if it doesn't exist.

    **src/security/sanitize.js:**
    - Import DOMPurify from 'isomorphic-dompurify'
    - Export SANITIZE_CONFIG constant with:
      - ALLOWED_TAGS: ['b', 'i', 'u', 's', 'em', 'strong', 'mark', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 'p', 'br', 'hr', 'ul', 'ol', 'li', 'table', 'thead', 'tbody', 'tr', 'th', 'td', 'a', 'img']
      - ALLOWED_ATTR: ['href', 'target', 'rel', 'src', 'alt', 'title', 'style', 'class']
      - ALLOW_DATA_ATTR: false (security-first per research)
      - KEEP_CONTENT: true (preserve text when removing tags)
    - Export sanitizeHTML(html, customConfig = {}) function that merges custom config with defaults and returns sanitized string
    - Do NOT add logging hooks yet (that's Plan 04)

    **src/security/SafeHTML.jsx:**
    - Import sanitizeHTML from './sanitize'
    - Export SafeHTML component accepting: html (required), className (optional), as (optional, default 'div')
    - Component sanitizes html prop and renders using dangerouslySetInnerHTML
    - Use the 'as' prop to control wrapper element (div, span, etc.)
    - Return null if html is falsy

    **src/security/index.js:**
    - Re-export SafeHTML from './SafeHTML'
    - Re-export sanitizeHTML, SANITIZE_CONFIG from './sanitize'
  </action>
  <verify>
    - All three files exist in src/security/
    - `import { SafeHTML, sanitizeHTML } from './src/security'` works without errors
    - SafeHTML renders sanitized content: `<SafeHTML html="<b>test</b><script>alert('xss')</script>" />` renders only the bold text
  </verify>
  <done>
    - src/security/sanitize.js exports sanitizeHTML and SANITIZE_CONFIG
    - src/security/SafeHTML.jsx exports SafeHTML component
    - src/security/index.js provides public API
    - Injecting script tags produces no script in output
  </done>
</task>

</tasks>

<verification>
1. `npm ls isomorphic-dompurify` shows package installed
2. `ls src/security/` shows sanitize.js, SafeHTML.jsx, index.js
3. Manual test in Node REPL or test file:
   ```javascript
   import { sanitizeHTML } from './src/security';
   const dirty = '<b>bold</b><script>alert("xss")</script>';
   const clean = sanitizeHTML(dirty);
   console.log(clean); // Should be '<b>bold</b>' with no script tag
   ```
</verification>

<success_criteria>
- isomorphic-dompurify installed in package.json dependencies
- SafeHTML component exists and sanitizes input before rendering
- Script tags, onclick handlers, and other XSS vectors are stripped
- Allowed formatting (bold, italic, links, images) passes through
</success_criteria>

<output>
After completion, create `.planning/phases/02-xss-prevention/02-01-SUMMARY.md`
</output>
