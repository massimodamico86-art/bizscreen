---
phase: 02-xss-prevention
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/svg-editor/LeftSidebar.jsx
autonomous: true

must_haves:
  truths:
    - "Image error handler uses React state, not innerHTML mutation"
    - "Failed images show alt text fallback without XSS risk"
    - "SVG editor functionality unchanged for working images"
  artifacts:
    - path: "src/components/svg-editor/LeftSidebar.jsx"
      provides: "Fixed image error handler"
      contains: "useState"
  key_links:
    - from: "src/components/svg-editor/LeftSidebar.jsx"
      to: "React state"
      via: "useState hook for image errors"
      pattern: "useState.*imageError|setImageError"
---

<objective>
Replace innerHTML mutation in SVG editor LeftSidebar with React state management.

Purpose: Eliminate XSS vulnerability where item.alt content could contain malicious HTML/scripts that execute when image fails to load. This is requirement SEC-02.

Output: LeftSidebar uses React state to track image errors and renders fallback via JSX, not innerHTML.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-xss-prevention/02-CONTEXT.md
@.planning/phases/02-xss-prevention/02-RESEARCH.md
@src/components/svg-editor/LeftSidebar.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace innerHTML mutation with React state pattern</name>
  <files>src/components/svg-editor/LeftSidebar.jsx</files>
  <action>
    Locate the vulnerable code around line 744:
    ```javascript
    onError={(e) => {
      e.target.style.display = 'none';
      e.target.parentElement.innerHTML = `<span class="text-xs text-gray-400">${item.alt}</span>`;
    }}
    ```

    The fix requires tracking which images have errored. Since this is inside a map() rendering multiple items, use a Set or object to track errored image IDs.

    **Implementation approach:**
    1. Add state at the component level (or relevant render function): `const [erroredImages, setErroredImages] = useState(new Set())`
    2. Replace the onError handler:
       ```javascript
       onError={() => setErroredImages(prev => new Set(prev).add(item.id || item.url))}
       ```
    3. Replace the img rendering with conditional:
       ```javascript
       {erroredImages.has(item.id || item.url) ? (
         <span className="text-xs text-gray-400">{item.alt}</span>
       ) : (
         <img
           src={item.thumb}
           alt={item.alt}
           className="w-full h-full object-cover"
           loading="lazy"
           onError={() => setErroredImages(prev => new Set(prev).add(item.id || item.url))}
         />
       )}
       ```

    **Important considerations:**
    - Check if LeftSidebar is a class component or functional component - adjust state management accordingly
    - If it's a large component, add the state at the narrowest appropriate scope
    - Preserve the existing className and styling behavior
    - The alt text should render as plain text (via JSX), NOT as HTML
    - If there are multiple places with similar pattern in this file, fix all of them
  </action>
  <verify>
    - `grep -n "innerHTML" src/components/svg-editor/LeftSidebar.jsx` returns no matches
    - `grep -n "erroredImages\|setErroredImages" src/components/svg-editor/LeftSidebar.jsx` shows state usage
    - File still imports useState (or uses class state if class component)
  </verify>
  <done>
    - No innerHTML mutations remain in LeftSidebar.jsx
    - Image error fallback renders via React state + JSX
    - Alt text displays as text content, not parsed HTML
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify SVG editor still functions correctly</name>
  <files>src/components/svg-editor/LeftSidebar.jsx</files>
  <action>
    After the fix, verify the component still works:

    1. Check for any syntax errors: `npx eslint src/components/svg-editor/LeftSidebar.jsx`
    2. If there are existing tests for LeftSidebar, run them
    3. Verify imports are correct (useState from 'react' if not already imported)

    Also search for any OTHER innerHTML usages in the file that might need fixing:
    `grep -n "innerHTML\|outerHTML" src/components/svg-editor/LeftSidebar.jsx`

    If additional innerHTML usages found, apply the same React state pattern.
  </action>
  <verify>
    - ESLint passes (or only shows pre-existing warnings)
    - No runtime errors when importing the component
    - `grep "innerHTML" src/components/svg-editor/LeftSidebar.jsx` returns empty
  </verify>
  <done>
    - LeftSidebar.jsx passes linting
    - Zero innerHTML/outerHTML mutations remain
    - Component is syntactically valid
  </done>
</task>

</tasks>

<verification>
1. `grep -rn "innerHTML" src/components/svg-editor/LeftSidebar.jsx` returns nothing
2. `grep -n "useState" src/components/svg-editor/LeftSidebar.jsx` shows state hook usage
3. Component imports and renders without errors
</verification>

<success_criteria>
- innerHTML mutation at line ~744 replaced with React state pattern
- Image error fallback shows alt text as plain text (not HTML)
- No other innerHTML mutations remain in the file
- SVG editor component still loads without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-xss-prevention/02-02-SUMMARY.md`
</output>
