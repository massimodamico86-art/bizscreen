---
phase: 02-xss-prevention
plan: 05
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - src/security/__tests__/sanitize.test.js
  - src/security/__tests__/SafeHTML.test.jsx
  - src/pages/__tests__/HelpCenterPage.test.jsx
autonomous: true

must_haves:
  truths:
    - "Script injection produces no alert or script execution"
    - "Tests verify XSS vectors are blocked"
    - "Tests verify allowed formatting passes through"
  artifacts:
    - path: "src/security/__tests__/sanitize.test.js"
      provides: "Unit tests for sanitization"
      min_lines: 30
    - path: "src/security/__tests__/SafeHTML.test.jsx"
      provides: "Component tests for SafeHTML"
      min_lines: 20
  key_links:
    - from: "src/security/__tests__/sanitize.test.js"
      to: "src/security/sanitize.js"
      via: "import and test sanitizeHTML"
      pattern: "import.*sanitizeHTML"
---

<objective>
Create tests verifying XSS prevention works correctly.

Purpose: Ensure sanitization blocks XSS vectors while allowing legitimate formatting. Tests serve as regression protection and document expected behavior. This verifies Phase 2 success criteria.

Output: Test files for sanitize.js, SafeHTML.jsx, and integration test for HelpCenterPage.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-xss-prevention/02-CONTEXT.md
@.planning/phases/02-xss-prevention/02-01-SUMMARY.md
@.planning/phases/02-xss-prevention/02-02-SUMMARY.md
@.planning/phases/02-xss-prevention/02-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create unit tests for sanitizeHTML function</name>
  <files>src/security/__tests__/sanitize.test.js</files>
  <action>
    Create `src/security/__tests__/sanitize.test.js` with Vitest (matching project test setup).

    **Test categories:**

    1. XSS vectors are blocked:
       - `<script>alert('xss')</script>` stripped to empty
       - `<img src=x onerror="alert('xss')">` has onerror removed
       - `<a href="javascript:alert('xss')">` has javascript: href removed
       - `<div onclick="alert('xss')">` has onclick removed
       - `<iframe src="evil.com">` stripped entirely
       - `<style>@import url('evil')</style>` stripped entirely
       - Nested XSS: `<b><script>alert('xss')</script></b>` keeps b, strips script

    2. Allowed formatting passes through:
       - `<b>bold</b>` unchanged
       - `<i>italic</i>` unchanged
       - `<strong>strong</strong>` unchanged
       - `<em>emphasis</em>` unchanged
       - `<a href="https://example.com">link</a>` unchanged
       - `<img src="https://example.com/img.png" alt="test">` unchanged
       - `<ul><li>item</li></ul>` unchanged
       - `<h1>heading</h1>` through `<h6>heading</h6>` unchanged
       - `<table><tr><td>cell</td></tr></table>` unchanged

    3. Style attribute handling:
       - `<p style="color: red">styled</p>` allowed (per user decision)
       - Style attributes preserved on allowed tags

    4. Edge cases:
       - Empty string returns empty string
       - null/undefined handled gracefully (return empty or null)
       - Malformed HTML handled without throwing

    **Test structure:**
    ```javascript
    import { describe, it, expect } from 'vitest';
    import { sanitizeHTML, SANITIZE_CONFIG } from '../sanitize';

    describe('sanitizeHTML', () => {
      describe('XSS prevention', () => {
        it('strips script tags', () => {
          const dirty = '<script>alert("xss")</script>';
          expect(sanitizeHTML(dirty)).toBe('');
        });
        // ... more XSS tests
      });

      describe('allowed formatting', () => {
        it('preserves bold tags', () => {
          const html = '<b>bold text</b>';
          expect(sanitizeHTML(html)).toBe('<b>bold text</b>');
        });
        // ... more formatting tests
      });
    });
    ```
  </action>
  <verify>
    - `ls src/security/__tests__/sanitize.test.js` shows file exists
    - `npm test src/security/__tests__/sanitize.test.js` passes all tests
    - Tests cover both XSS blocking and allowed formatting
  </verify>
  <done>
    - sanitize.test.js has 15+ test cases
    - All XSS vector tests pass (scripts stripped)
    - All allowed formatting tests pass (tags preserved)
  </done>
</task>

<task type="auto">
  <name>Task 2: Create component tests for SafeHTML</name>
  <files>src/security/__tests__/SafeHTML.test.jsx</files>
  <action>
    Create `src/security/__tests__/SafeHTML.test.jsx` with React Testing Library.

    **Test cases:**

    1. Renders sanitized content:
       - SafeHTML with clean HTML renders correctly
       - SafeHTML with XSS payload renders without script

    2. Supports className prop:
       - Wrapper element has className applied

    3. Supports 'as' prop (if implemented):
       - `as="span"` renders span element
       - `as="p"` renders p element
       - Default renders div

    4. Handles edge cases:
       - Empty html prop renders nothing (or empty element)
       - null html prop doesn't crash

    **Test structure:**
    ```javascript
    import { describe, it, expect } from 'vitest';
    import { render, screen } from '@testing-library/react';
    import { SafeHTML } from '../SafeHTML';

    describe('SafeHTML', () => {
      it('renders clean HTML', () => {
        render(<SafeHTML html="<b>bold</b>" />);
        expect(screen.getByText('bold')).toBeInTheDocument();
      });

      it('strips XSS payloads', () => {
        render(<SafeHTML html='<b>text</b><script>alert("xss")</script>' />);
        expect(screen.getByText('text')).toBeInTheDocument();
        // Script should not be in DOM
        expect(document.querySelector('script')).toBeNull();
      });

      it('applies className to wrapper', () => {
        const { container } = render(<SafeHTML html="<b>test</b>" className="custom-class" />);
        expect(container.firstChild).toHaveClass('custom-class');
      });
    });
    ```
  </action>
  <verify>
    - `ls src/security/__tests__/SafeHTML.test.jsx` shows file exists
    - `npm test src/security/__tests__/SafeHTML.test.jsx` passes all tests
  </verify>
  <done>
    - SafeHTML.test.jsx has 5+ test cases
    - Tests verify XSS is blocked in component rendering
    - Tests verify props work correctly
  </done>
</task>

<task type="auto">
  <name>Task 3: Add XSS verification test for HelpCenterPage</name>
  <files>src/pages/__tests__/HelpCenterPage.test.jsx</files>
  <action>
    Add tests to verify HelpCenterPage sanitization (create file if doesn't exist).

    **Test focus:**
    The critical verification is that markdown-like formatting with XSS payloads is sanitized.

    **Test cases:**

    1. Verify content with **bold** renders as <strong>
    2. Verify content with script tags renders without scripts
    3. Verify content with event handlers (onclick) is sanitized

    **Mock approach:**
    - Mock helpService to return controlled test content
    - Content should include XSS payloads: `**bold** <script>alert('xss')</script>`
    - Verify rendered output has <strong> but no <script>

    **Test structure:**
    ```javascript
    import { describe, it, expect, vi } from 'vitest';
    import { render, screen, waitFor } from '@testing-library/react';
    import HelpCenterPage from '../HelpCenterPage';
    import * as helpService from '../../services/helpService';

    vi.mock('../../services/helpService');

    describe('HelpCenterPage XSS Prevention', () => {
      it('sanitizes help content with XSS payloads', async () => {
        helpService.getHelpTopic.mockResolvedValue({
          id: '1',
          title: 'Test Topic',
          slug: 'test',
          content: '**bold text** <script>alert("xss")</script>\n- list **item** <img src=x onerror="alert(1)">'
        });

        render(<HelpCenterPage />);
        // Navigate to topic (implementation depends on component)

        await waitFor(() => {
          // Bold should render
          expect(screen.getByText('bold text')).toBeInTheDocument();
          // Script should NOT be in document
          expect(document.querySelector('script')).toBeNull();
        });
      });
    });
    ```

    **Note:** If HelpCenterPage tests already exist, add these test cases to existing file.
  </action>
  <verify>
    - Test file exists for HelpCenterPage
    - XSS prevention tests pass
    - `npm test HelpCenterPage` completes successfully
  </verify>
  <done>
    - HelpCenterPage has XSS verification tests
    - Tests prove script tags don't render
    - Tests prove allowed formatting still works
  </done>
</task>

</tasks>

<verification>
1. Run all new tests: `npm test src/security/__tests__/ src/pages/__tests__/HelpCenterPage`
2. All tests pass
3. No scripts or event handlers in rendered output for XSS test cases
4. Allowed formatting (bold, links, etc.) preserved in test output
</verification>

<success_criteria>
- sanitize.test.js has comprehensive XSS vector tests (15+ cases)
- SafeHTML.test.jsx verifies component behavior (5+ cases)
- HelpCenterPage tests verify real-world sanitization
- All tests pass: `npm test` completes without failures
- Success Criteria #3 from roadmap verified: Injecting `<script>alert('xss')</script>` produces no alert
</success_criteria>

<output>
After completion, create `.planning/phases/02-xss-prevention/02-05-SUMMARY.md`
</output>
