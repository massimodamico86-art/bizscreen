---
phase: 19-templates-intelligence
plan: 04
type: execute
wave: 3
depends_on: ["19-01", "19-02"]
files_modified:
  - src/components/templates/FeaturedTemplatesRow.jsx
  - src/pages/TemplateMarketplacePage.jsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "User sees 'Used Nx' badge on templates they have applied before"
    - "Usage counts load automatically when marketplace page loads"
    - "Usage badges appear on both regular grid and featured templates row"
  artifacts:
    - path: "src/pages/TemplateMarketplacePage.jsx"
      provides: "Usage counts state and fetch logic"
      contains: "getTemplateUsageCounts"
    - path: "src/components/templates/FeaturedTemplatesRow.jsx"
      provides: "usageCounts prop support"
      contains: "usageCounts"
  key_links:
    - from: "src/pages/TemplateMarketplacePage.jsx"
      to: "getTemplateUsageCounts"
      via: "import from marketplaceService"
      pattern: "import.*getTemplateUsageCounts.*from.*marketplaceService"
    - from: "src/pages/TemplateMarketplacePage.jsx"
      to: "TemplateGrid"
      via: "usageCounts prop"
      pattern: "usageCounts=\\{usageCounts\\}"
---

<objective>
Wire template usage analytics in the marketplace page

Purpose: Close TMPL-13 gap - complete the data flow from database RPC to UI so users can see which templates they've used most frequently via "Used Nx" badges.

Output: TemplateMarketplacePage fetches and passes usage counts to grid components, enabling usage badges to display actual data.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-templates-intelligence/19-VERIFICATION.md

# Existing code to modify
@src/pages/TemplateMarketplacePage.jsx
@src/components/templates/FeaturedTemplatesRow.jsx

# Service function already exists
@src/services/marketplaceService.js (lines 898-909 - getTemplateUsageCounts)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add usageCounts prop to FeaturedTemplatesRow</name>
  <files>src/components/templates/FeaturedTemplatesRow.jsx</files>
  <action>
Add usageCounts prop to FeaturedTemplatesRow component to enable usage badges on featured templates:

1. Add `usageCounts = null` to destructured props (line 30, after onToggleFavorite)
2. Pass usageCount to TemplateCard (line 48, after onToggleFavorite):
   `usageCount={usageCounts?.get(template.id) || 0}`
3. Add PropTypes entry for usageCounts:
   `usageCounts: PropTypes.instanceOf(Map),`

This mirrors how TemplateGrid already handles usageCounts.
  </action>
  <verify>
grep -n "usageCounts" src/components/templates/FeaturedTemplatesRow.jsx
# Should show: prop destructuring, TemplateCard prop, PropTypes entry
  </verify>
  <done>FeaturedTemplatesRow accepts usageCounts Map prop and passes usage count to each TemplateCard</done>
</task>

<task type="auto">
  <name>Task 2: Wire usage counts in TemplateMarketplacePage</name>
  <files>src/pages/TemplateMarketplacePage.jsx</files>
  <action>
Add usage counts data flow to marketplace page:

1. Add import for getTemplateUsageCounts (line 27, extend existing marketplaceService import):
   Add `getTemplateUsageCounts` to the import list

2. Add state for usage counts (after line 67, near favoritedIds):
   `const [usageCounts, setUsageCounts] = useState(new Map());`

3. Add useEffect to fetch usage counts when templates change (after line 171, after checkFavoritedTemplates effect):
   ```javascript
   // Fetch usage counts for grid templates
   useEffect(() => {
     if (templates.length > 0) {
       getTemplateUsageCounts(templates.map(t => t.id))
         .then(setUsageCounts)
         .catch(err => console.error('Failed to load usage counts:', err));
     }
   }, [templates]);
   ```

4. Pass usageCounts to FeaturedTemplatesRow (around line 412):
   Add `usageCounts={usageCounts}` prop

5. Pass usageCounts to TemplateGrid (around line 424):
   Add `usageCounts={usageCounts}` prop

Note: We reuse the same usageCounts Map for both components. If featured templates differ from grid templates, the Map just won't have entries for missing IDs (which defaults to 0 - correct behavior for "not used").
  </action>
  <verify>
# Verify import
grep -n "getTemplateUsageCounts" src/pages/TemplateMarketplacePage.jsx

# Verify state
grep -n "usageCounts.*useState" src/pages/TemplateMarketplacePage.jsx

# Verify props passed
grep -n "usageCounts={usageCounts}" src/pages/TemplateMarketplacePage.jsx
  </verify>
  <done>
- TemplateMarketplacePage imports getTemplateUsageCounts
- Page stores usageCounts in state as Map
- useEffect fetches counts when templates load
- usageCounts prop passed to both FeaturedTemplatesRow and TemplateGrid
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify end-to-end data flow:

```bash
# 1. Verify FeaturedTemplatesRow has usageCounts prop
grep -A2 "usageCounts" src/components/templates/FeaturedTemplatesRow.jsx

# 2. Verify marketplace page import
grep "getTemplateUsageCounts" src/pages/TemplateMarketplacePage.jsx

# 3. Verify props passed to components
grep "usageCounts={usageCounts}" src/pages/TemplateMarketplacePage.jsx

# 4. Run linter to catch any errors
npm run lint -- src/pages/TemplateMarketplacePage.jsx src/components/templates/FeaturedTemplatesRow.jsx

# 5. Start dev server and verify no console errors
npm run dev
# Navigate to /templates - should see "Used Nx" badges on any templates user has applied
```
</verification>

<success_criteria>
1. FeaturedTemplatesRow accepts usageCounts prop and passes to TemplateCard
2. TemplateMarketplacePage imports getTemplateUsageCounts service function
3. Page has usageCounts state (Map)
4. useEffect fetches counts when templates load
5. Both TemplateGrid and FeaturedTemplatesRow receive usageCounts prop
6. No lint errors
7. Templates user has applied show "Used Nx" badge in marketplace
</success_criteria>

<output>
After completion, create `.planning/phases/19-templates-intelligence/19-04-SUMMARY.md`
</output>
