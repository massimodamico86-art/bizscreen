---
phase: 19-templates-intelligence
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/131_template_ratings_suggestions.sql
  - src/services/marketplaceService.js
autonomous: true

must_haves:
  truths:
    - "User can submit a 1-5 star rating for a template"
    - "System returns aggregate rating stats (average, count)"
    - "System suggests templates based on user's scenes business_type"
    - "System returns personal usage counts for templates"
  artifacts:
    - path: "supabase/migrations/131_template_ratings_suggestions.sql"
      provides: "Ratings table, suggestion RPC, usage counts RPC"
      contains: "marketplace_template_ratings"
    - path: "src/services/marketplaceService.js"
      provides: "Rating and suggestion service functions"
      exports: ["rateTemplate", "getTemplateRatingStats", "fetchSuggestedTemplates", "fetchSimilarTemplates", "getTemplateUsageCounts"]
  key_links:
    - from: "src/services/marketplaceService.js"
      to: "supabase RPC"
      via: "rpc('upsert_template_rating')"
      pattern: "supabase\\.rpc\\('upsert_template_rating'"
    - from: "src/services/marketplaceService.js"
      to: "supabase RPC"
      via: "rpc('get_suggested_templates')"
      pattern: "supabase\\.rpc\\('get_suggested_templates'"
---

<objective>
Create database infrastructure and service layer for template ratings, suggestions, and usage analytics.

Purpose: Enable intelligent template features - users can rate templates, get industry-based suggestions, and see usage counts
Output: Migration with ratings table + 4 RPCs, service layer with 5 new functions
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/19-templates-intelligence/19-CONTEXT.md
@.planning/phases/19-templates-intelligence/19-RESEARCH.md
@supabase/migrations/129_marketplace_favorites_history.sql
@src/services/marketplaceService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ratings table and RPCs</name>
  <files>supabase/migrations/131_template_ratings_suggestions.sql</files>
  <action>
Create migration file with:

1. **marketplace_template_ratings table:**
   - id (uuid PK)
   - user_id (uuid FK profiles, ON DELETE CASCADE)
   - template_id (uuid FK template_library, ON DELETE CASCADE)
   - rating (integer CHECK 1-5)
   - created_at, updated_at (timestamptz)
   - UNIQUE constraint on (user_id, template_id)
   - Indexes on user_id, template_id

2. **RLS policies:**
   - SELECT: everyone can see ratings (for aggregate display)
   - INSERT: auth.uid() = user_id
   - UPDATE: auth.uid() = user_id
   - DELETE: auth.uid() = user_id

3. **upsert_template_rating(p_template_id uuid, p_rating integer) RPC:**
   - Validates rating 1-5
   - INSERT ... ON CONFLICT DO UPDATE
   - Returns TABLE (average_rating numeric, total_ratings bigint, user_rating integer)
   - SECURITY DEFINER, GRANT to authenticated

4. **get_template_rating_stats(p_template_id uuid) RPC:**
   - Returns average_rating, total_ratings, user_rating (null if not rated)
   - SECURITY DEFINER, GRANT to authenticated

5. **get_suggested_templates(p_limit integer DEFAULT 6) RPC:**
   - Find user's dominant industry from scenes.business_type (GROUP BY, ORDER BY COUNT DESC)
   - Return templates matching that industry, excluding already-applied (from marketplace_template_history)
   - Fallback to popular templates (ORDER BY install_count DESC) when no industry
   - Returns TABLE (id, name, thumbnail_url, industry, category_id, suggestion_reason)
   - SECURITY DEFINER, GRANT to authenticated

6. **get_template_usage_counts(p_template_ids uuid[]) RPC:**
   - Batch query for personal usage counts
   - COUNT from marketplace_template_history WHERE user_id = auth.uid()
   - Returns TABLE (template_id uuid, usage_count bigint)
   - SECURITY DEFINER, GRANT to authenticated

Follow existing migration patterns from 129_marketplace_favorites_history.sql.
  </action>
  <verify>
Run `supabase db push` and verify no errors. Check tables exist with:
`supabase db query "SELECT * FROM marketplace_template_ratings LIMIT 1"`
  </verify>
  <done>
Ratings table created with proper RLS, 4 RPCs deployed and callable
  </done>
</task>

<task type="auto">
  <name>Task 2: Add rating and suggestion functions to marketplaceService</name>
  <files>src/services/marketplaceService.js</files>
  <action>
Add to existing marketplaceService.js after the CUSTOMIZATION section:

```javascript
// ============================================================================
// RATINGS
// ============================================================================

/**
 * Submit or update a template rating
 * @param {string} templateId - Template UUID
 * @param {number} rating - Rating 1-5
 * @returns {Promise<{averageRating: number, totalRatings: number, userRating: number}>}
 */
export async function rateTemplate(templateId, rating) {
  const { data, error } = await supabase.rpc('upsert_template_rating', {
    p_template_id: templateId,
    p_rating: rating,
  });
  if (error) throw error;
  return data?.[0] || { averageRating: 0, totalRatings: 0, userRating: rating };
}

/**
 * Get rating stats for a template (including user's rating)
 * @param {string} templateId - Template UUID
 * @returns {Promise<{averageRating: number, totalRatings: number, userRating: number|null}>}
 */
export async function getTemplateRatingStats(templateId) {
  const { data, error } = await supabase.rpc('get_template_rating_stats', {
    p_template_id: templateId,
  });
  if (error) throw error;
  return data?.[0] || { averageRating: 0, totalRatings: 0, userRating: null };
}

// ============================================================================
// SUGGESTIONS
// ============================================================================

/**
 * Fetch suggested templates for current user (industry-based)
 * @param {number} [limit=6] - Max results
 * @returns {Promise<Array>} Suggested templates with suggestion_reason
 */
export async function fetchSuggestedTemplates(limit = 6) {
  const { data, error } = await supabase.rpc('get_suggested_templates', {
    p_limit: limit,
  });
  if (error) throw error;
  return data || [];
}

/**
 * Fetch similar templates (same category, for post-apply)
 * @param {string} categoryId - Category UUID
 * @param {string} excludeTemplateId - Template to exclude
 * @param {number} [limit=4] - Max results
 * @returns {Promise<Array>} Similar templates
 */
export async function fetchSimilarTemplates(categoryId, excludeTemplateId, limit = 4) {
  const { data, error } = await supabase
    .from('template_library')
    .select('id, name, thumbnail_url, category_id')
    .eq('category_id', categoryId)
    .neq('id', excludeTemplateId)
    .eq('is_active', true)
    .order('install_count', { ascending: false })
    .limit(limit);
  if (error) throw error;
  return data || [];
}

// ============================================================================
// USAGE ANALYTICS
// ============================================================================

/**
 * Batch get usage counts for templates (personal analytics)
 * @param {string[]} templateIds - Array of template UUIDs
 * @returns {Promise<Map<string, number>>} Map of templateId -> usageCount
 */
export async function getTemplateUsageCounts(templateIds) {
  if (!templateIds.length) return new Map();

  const { data, error } = await supabase.rpc('get_template_usage_counts', {
    p_template_ids: templateIds,
  });
  if (error) throw error;

  const counts = new Map();
  (data || []).forEach(row => counts.set(row.template_id, row.usage_count));
  return counts;
}
```

Note: Map snake_case DB columns to camelCase in return objects.
  </action>
  <verify>
`npm run lint` passes. Check exports with:
`grep -E "export (async )?function (rateTemplate|getTemplateRatingStats|fetchSuggestedTemplates|fetchSimilarTemplates|getTemplateUsageCounts)" src/services/marketplaceService.js`
  </verify>
  <done>
5 new service functions exported: rateTemplate, getTemplateRatingStats, fetchSuggestedTemplates, fetchSimilarTemplates, getTemplateUsageCounts
  </done>
</task>

</tasks>

<verification>
1. Migration deployed: `supabase db push` completes without errors
2. RPCs callable: Test in Supabase dashboard SQL editor
3. Service functions exported: All 5 functions exist in marketplaceService.js
4. Lint passes: `npm run lint` shows no errors in marketplaceService.js
</verification>

<success_criteria>
- Database migration creates ratings table with RLS
- 4 RPCs deployed and callable (upsert_template_rating, get_template_rating_stats, get_suggested_templates, get_template_usage_counts)
- 5 service functions ready for UI integration (rateTemplate, getTemplateRatingStats, fetchSuggestedTemplates, fetchSimilarTemplates, getTemplateUsageCounts)
</success_criteria>

<output>
After completion, create `.planning/phases/19-templates-intelligence/19-01-SUMMARY.md`
</output>
