---
phase: 19-templates-intelligence
plan: 03
type: execute
wave: 2
depends_on: ["19-01"]
files_modified:
  - src/main.jsx
  - src/components/templates/TemplateRating.jsx
  - src/components/templates/TemplatePreviewPanel.jsx
  - src/components/templates/SimilarTemplatesRow.jsx
  - src/components/templates/index.js
autonomous: true

must_haves:
  truths:
    - "User can rate template with 1-5 stars in preview panel"
    - "User sees average rating and total ratings for template"
    - "User sees 'Similar templates' after Quick Apply"
    - "Rating component is accessible with keyboard navigation"
  artifacts:
    - path: "src/components/templates/TemplateRating.jsx"
      provides: "Star rating component"
      min_lines: 40
    - path: "src/components/templates/TemplatePreviewPanel.jsx"
      provides: "Panel with rating interaction"
      contains: "TemplateRating"
    - path: "src/components/templates/SimilarTemplatesRow.jsx"
      provides: "Similar templates row for post-apply"
      min_lines: 30
  key_links:
    - from: "src/components/templates/TemplateRating.jsx"
      to: "rateTemplate"
      via: "service import"
      pattern: "rateTemplate"
    - from: "src/components/templates/SimilarTemplatesRow.jsx"
      to: "fetchSimilarTemplates"
      via: "service import"
      pattern: "fetchSimilarTemplates"
---

<objective>
Add star rating UI to preview panel and similar templates row for post-apply suggestions.

Purpose: Enable users to rate templates and discover similar templates after applying one
Output: TemplateRating component, TemplatePreviewPanel with rating, SimilarTemplatesRow component
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/19-templates-intelligence/19-CONTEXT.md
@.planning/phases/19-templates-intelligence/19-RESEARCH.md
@src/components/templates/TemplatePreviewPanel.jsx
@src/main.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @smastrom/react-rating and import CSS</name>
  <files>src/main.jsx</files>
  <action>
1. Install the rating library:
```bash
npm install @smastrom/react-rating
```

2. In src/main.jsx, add the CSS import near the top (after other CSS imports):
```javascript
import '@smastrom/react-rating/style.css';
```

This CSS import must be done once at the app entry point for the rating component to display correctly.
  </action>
  <verify>
Check package.json has @smastrom/react-rating dependency.
Check: `grep "react-rating" src/main.jsx`
  </verify>
  <done>
@smastrom/react-rating installed and CSS imported in main.jsx
  </done>
</task>

<task type="auto">
  <name>Task 2: Create TemplateRating component</name>
  <files>src/components/templates/TemplateRating.jsx</files>
  <action>
Create new component:

```javascript
/**
 * Template Rating Component
 *
 * Displays interactive star rating for templates.
 * Shows user's rating (editable) and average rating (read-only).
 *
 * @module components/templates/TemplateRating
 */

import { useState, useEffect, useCallback } from 'react';
import PropTypes from 'prop-types';
import { Rating } from '@smastrom/react-rating';
import { rateTemplate, getTemplateRatingStats } from '../../services/marketplaceService';

// Debounce timeout for rating changes
const DEBOUNCE_MS = 300;

export function TemplateRating({ templateId, onRatingChange }) {
  const [userRating, setUserRating] = useState(0);
  const [averageRating, setAverageRating] = useState(0);
  const [totalRatings, setTotalRatings] = useState(0);
  const [loading, setLoading] = useState(true);

  // Fetch initial rating stats
  useEffect(() => {
    if (!templateId) return;

    let mounted = true;
    setLoading(true);

    getTemplateRatingStats(templateId)
      .then((stats) => {
        if (mounted) {
          setUserRating(stats.user_rating || 0);
          setAverageRating(stats.average_rating || 0);
          setTotalRatings(stats.total_ratings || 0);
        }
      })
      .catch((err) => {
        console.error('Failed to fetch rating stats:', err);
      })
      .finally(() => {
        if (mounted) setLoading(false);
      });

    return () => { mounted = false; };
  }, [templateId]);

  // Debounced rating submission
  const handleRatingChange = useCallback(
    (value) => {
      // Optimistic update
      setUserRating(value);

      // Debounced API call
      const timeoutId = setTimeout(() => {
        rateTemplate(templateId, value)
          .then((result) => {
            setAverageRating(result.average_rating || result.averageRating || 0);
            setTotalRatings(result.total_ratings || result.totalRatings || 0);
            onRatingChange?.(value);
          })
          .catch((err) => {
            console.error('Failed to submit rating:', err);
            // Could revert optimistic update here if needed
          });
      }, DEBOUNCE_MS);

      // Cleanup previous timeout
      return () => clearTimeout(timeoutId);
    },
    [templateId, onRatingChange]
  );

  if (loading) {
    return (
      <div className="h-8 bg-gray-100 rounded animate-pulse" />
    );
  }

  return (
    <div className="space-y-2">
      {/* User's interactive rating */}
      <div className="flex items-center gap-3">
        <Rating
          style={{ maxWidth: 120 }}
          value={userRating}
          onChange={handleRatingChange}
          items={5}
        />
        <span className="text-sm text-gray-500">
          {userRating > 0 ? 'Your rating' : 'Rate this template'}
        </span>
      </div>

      {/* Average rating display */}
      {totalRatings > 0 && (
        <div className="flex items-center gap-2 text-sm text-gray-600">
          <Rating
            style={{ maxWidth: 80 }}
            value={averageRating}
            readOnly
          />
          <span>
            {Number(averageRating).toFixed(1)} ({totalRatings} {totalRatings === 1 ? 'rating' : 'ratings'})
          </span>
        </div>
      )}
    </div>
  );
}

TemplateRating.propTypes = {
  templateId: PropTypes.string.isRequired,
  onRatingChange: PropTypes.func,
};

export default TemplateRating;
```

Key points:
- Debounce rating changes (300ms) to prevent rapid API calls
- Optimistic UI update for user rating
- Shows "Your rating" when rated, "Rate this template" when not
- Average rating is read-only
  </action>
  <verify>
`npm run lint -- src/components/templates/TemplateRating.jsx` passes.
File exports TemplateRating component.
  </verify>
  <done>
TemplateRating component renders interactive stars with debounced submission and average display
  </done>
</task>

<task type="auto">
  <name>Task 3: Add rating to TemplatePreviewPanel and create SimilarTemplatesRow</name>
  <files>src/components/templates/TemplatePreviewPanel.jsx, src/components/templates/SimilarTemplatesRow.jsx, src/components/templates/index.js</files>
  <action>
1. **Create SimilarTemplatesRow.jsx:**

```javascript
/**
 * Similar Templates Row
 *
 * Horizontal row of similar templates shown after Quick Apply.
 * Fetches templates from same category, excluding the applied template.
 *
 * @module components/templates/SimilarTemplatesRow
 */

import { useState, useEffect } from 'react';
import PropTypes from 'prop-types';
import { fetchSimilarTemplates } from '../../services/marketplaceService';

export function SimilarTemplatesRow({ categoryId, excludeTemplateId, onTemplateClick }) {
  const [templates, setTemplates] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!categoryId) {
      setLoading(false);
      return;
    }

    let mounted = true;
    fetchSimilarTemplates(categoryId, excludeTemplateId, 4)
      .then((data) => {
        if (mounted) setTemplates(data);
      })
      .catch((err) => {
        console.error('Failed to fetch similar templates:', err);
      })
      .finally(() => {
        if (mounted) setLoading(false);
      });

    return () => { mounted = false; };
  }, [categoryId, excludeTemplateId]);

  if (loading || templates.length === 0) {
    return null;
  }

  return (
    <div className="mt-4 pt-4 border-t">
      <h4 className="text-sm font-medium text-gray-700 mb-3">
        You might also like
      </h4>
      <div className="flex gap-3 overflow-x-auto pb-2">
        {templates.map((template) => (
          <button
            key={template.id}
            onClick={() => onTemplateClick?.(template)}
            className="flex-shrink-0 w-28 text-left group"
          >
            <div className="aspect-video bg-gray-100 rounded overflow-hidden">
              {template.thumbnail_url ? (
                <img
                  src={template.thumbnail_url}
                  alt={template.name}
                  className="w-full h-full object-cover group-hover:scale-105 transition-transform"
                />
              ) : (
                <div className="w-full h-full bg-gray-200" />
              )}
            </div>
            <p className="text-xs text-gray-600 mt-1 truncate group-hover:text-blue-600">
              {template.name}
            </p>
          </button>
        ))}
      </div>
    </div>
  );
}

SimilarTemplatesRow.propTypes = {
  categoryId: PropTypes.string,
  excludeTemplateId: PropTypes.string,
  onTemplateClick: PropTypes.func,
};

export default SimilarTemplatesRow;
```

2. **Modify TemplatePreviewPanel.jsx:**

Add imports at top:
```javascript
import { TemplateRating } from './TemplateRating';
import { SimilarTemplatesRow } from './SimilarTemplatesRow';
```

Add state for showing similar templates after apply:
```javascript
const [showSimilar, setShowSimilar] = useState(false);
```

Reset showSimilar when template changes (in the existing effect or add new):
```javascript
useEffect(() => {
  setShowSimilar(false);
}, [template?.id]);
```

Modify handleApply to show similar templates after success:
```javascript
const handleApply = async () => {
  setApplying(true);
  setError(null);
  try {
    const sceneName = `${template.name} - ${format(new Date(), 'MMM d, yyyy')}`;
    const sceneId = await installTemplateAsScene(template.id, sceneName);
    setShowSimilar(true);  // NEW: Show similar templates
    onApply(sceneId);
  } catch (err) {
    console.error('Failed to apply template:', err);
    setError(err.message || 'Failed to apply template');
    setApplying(false);
  }
};
```

In the content section, after the Tags section but before the Access Warning, add:

```javascript
{/* Rating Section - per CONTEXT: rate from preview panel only */}
{detail && (
  <div>
    <h3 className="text-sm font-medium text-gray-700 mb-2">Rating</h3>
    <TemplateRating templateId={template.id} />
  </div>
)}

{/* Similar Templates - shown after apply */}
{showSimilar && detail?.category_id && (
  <SimilarTemplatesRow
    categoryId={detail.category_id}
    excludeTemplateId={template.id}
    onTemplateClick={(t) => {
      // Navigate to clicked template by triggering parent onClick behavior
      // Just close similar view and let parent handle navigation
      setShowSimilar(false);
    }}
  />
)}
```

Note: The SimilarTemplatesRow onTemplateClick currently just hides similar templates. The parent component (marketplace page) is responsible for template navigation, so clicking a similar template won't auto-navigate - it will require a second click. This is acceptable for MVP.

3. **Update index.js:**

Add exports:
```javascript
export { TemplateRating } from './TemplateRating';
export { SimilarTemplatesRow } from './SimilarTemplatesRow';
```
  </action>
  <verify>
`npm run lint -- src/components/templates/TemplatePreviewPanel.jsx src/components/templates/SimilarTemplatesRow.jsx` passes.
Check: `grep "TemplateRating\|SimilarTemplatesRow" src/components/templates/TemplatePreviewPanel.jsx`
  </verify>
  <done>
TemplatePreviewPanel shows rating section and similar templates after apply, SimilarTemplatesRow component created
  </done>
</task>

</tasks>

<verification>
1. @smastrom/react-rating installed and CSS imported in main.jsx
2. TemplateRating shows interactive stars with debounced submission
3. TemplatePreviewPanel displays Rating section when detail loaded
4. SimilarTemplatesRow appears after successful Quick Apply
5. All lint checks pass
</verification>

<success_criteria>
- @smastrom/react-rating in package.json dependencies
- CSS import in main.jsx prevents unstyled stars
- TemplateRating fetches stats on mount, submits rating with debounce
- TemplatePreviewPanel shows "Rating" section with star component
- SimilarTemplatesRow shows "You might also like" with 4 templates from same category
- All components exported from index.js
</success_criteria>

<output>
After completion, create `.planning/phases/19-templates-intelligence/19-03-SUMMARY.md`
</output>
