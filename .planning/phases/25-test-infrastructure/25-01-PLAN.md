---
phase: 25-test-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/setup.js
  - tests/mocks/loggingService.js
  - tests/unit/player/offlineService.test.js
  - tests/unit/pages/hooks/pageHooks.test.jsx
  - tests/unit/services/scheduleService.test.js
autonomous: true

must_haves:
  truths:
    - "npm test runs without circular dependency errors"
    - "offlineService tests pass (32 failures become passes)"
    - "pageHooks tests pass (missing ROTATION_MODES fixed)"
    - "scheduleService tests pass (mock chain fixed)"
  artifacts:
    - path: "tests/setup.js"
      provides: "Global loggingService auto-mock"
      contains: "vi.mock.*loggingService"
    - path: "tests/mocks/loggingService.js"
      provides: "Centralized loggingService mock module"
      exports: ["createScopedLogger", "log", "setLogContext"]
  key_links:
    - from: "tests/setup.js"
      to: "src/services/loggingService.js"
      via: "vi.mock hoisting"
      pattern: "vi.mock.*loggingService"
---

<objective>
Fix circular dependencies and bulk test failures by adding global loggingService mock to setup.js and fixing incomplete mock configurations.

Purpose: The circular dependency between loggingService.js and supabase.js causes 32+ test failures. Global mocking breaks the cycle. Additional mock fixes address remaining test failures.

Output: Tests that previously failed due to circular dependency and incomplete mocks now pass.
</objective>

<execution_context>
@/Users/massimodamico/.claude/get-shit-done/workflows/execute-plan.md
@/Users/massimodamico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/25-test-infrastructure/25-CONTEXT.md
@.planning/phases/25-test-infrastructure/25-RESEARCH.md
@tests/setup.js
@tests/mocks/supabase.js
@src/services/loggingService.js
@src/supabase.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add global loggingService mock to setup.js</name>
  <files>tests/setup.js, tests/mocks/loggingService.js</files>
  <action>
1. Create `tests/mocks/loggingService.js` with full mock implementation:
   - Export mockLogger object with trace, debug, info, warn, error, fatal as vi.fn()
   - Export createScopedLogger that returns mockLogger
   - Export log as mockLogger
   - Export setLogContext, refreshCorrelationId, getCorrelationId, getSessionId, initLogging, logTiming
   - Export default object with all named exports

2. Add vi.mock for loggingService in `tests/setup.js` BEFORE any other imports:
   - Mock path: '../src/services/loggingService.js'
   - Use vi.mock factory pattern with all exports from step 1
   - This must be at the TOP of setup.js (vi.mock is hoisted, but the mock factory runs early)

The mock breaks the circular dependency because:
- Tests load setup.js first
- vi.mock replaces loggingService module
- When supabase.js imports loggingService, it gets the mock (no circular import)

Pattern from RESEARCH.md:
```javascript
vi.mock('../src/services/loggingService.js', () => ({
  createScopedLogger: vi.fn(() => ({
    trace: vi.fn(),
    debug: vi.fn(),
    info: vi.fn(),
    warn: vi.fn(),
    error: vi.fn(),
    fatal: vi.fn(),
  })),
  // ... rest of exports
}));
```
  </action>
  <verify>
Run: `npm test -- tests/unit/player/offlineService.test.js 2>&1 | grep -E "(PASS|FAIL|pathname)"`
Should see no "pathname" errors (circular dependency fixed).
  </verify>
  <done>
Circular dependency errors ("Cannot read properties of undefined (reading 'pathname')") no longer appear in offlineService tests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix remaining test failures</name>
  <files>tests/unit/player/offlineService.test.js, tests/unit/pages/hooks/pageHooks.test.jsx, tests/unit/services/scheduleService.test.js</files>
  <action>
After Task 1 fixes circular dependency, remaining failures fall into categories:

**Category A: offlineService.test.js cache status assertions (3 tests)**
Error: `expected 'none' to be 'ok'` - test assertions don't match mock setup.
Fix: Update test setup to properly seed cache state before assertions, OR update assertions to match actual mock behavior. Check if tests are testing the right thing.

**Category B: pageHooks.test.jsx missing ROTATION_MODES (4 tests)**
Error: `No "ROTATION_MODES" export is defined on campaignService mock`
Fix: Add ROTATION_MODES constant to the campaignService mock in pageHooks.test.jsx:
```javascript
vi.mock('../../../../src/services/campaignService', async (importOriginal) => {
  const actual = await importOriginal();
  return {
    ...actual, // This brings ROTATION_MODES
    // Only override the functions that need mocking
    fetchCampaign: vi.fn(),
    // etc.
  };
});
```

**Category C: scheduleService.test.js mock chain (2 tests)**
Error: `.order is not a function` and assertion mismatches
Fix: Ensure supabase mock in scheduleService.test.js includes `.order()` in the chain and returns expected data shape.

For each failing test file:
1. Run the specific test file to see current errors
2. Identify root cause (mock setup vs assertion vs logic)
3. Fix mock setup OR fix assertions to match expected behavior
4. Verify test passes in isolation and with full suite

IMPORTANT: If any test is fundamentally broken (testing wrong thing), simplify or delete it per CONTEXT.md decision: "All tests must pass, even non-critical services (simplify if needed, no skipping)"
  </action>
  <verify>
Run: `npm test 2>&1 | tail -5`
Should show: "Test Files  X passed" with 0 failed.
  </verify>
  <done>
All 1746 tests pass. Zero failing test files.
  </done>
</task>

</tasks>

<verification>
1. `npm test` completes with 0 failures
2. No circular dependency errors in output
3. Tests run in reasonable time (under 15 seconds)
</verification>

<success_criteria>
- `npm test` shows "0 failed" in test summary
- All 20 previously failing test files now pass
- No "Cannot read properties of undefined" errors related to circular imports
</success_criteria>

<output>
After completion, create `.planning/phases/25-test-infrastructure/25-01-SUMMARY.md`
</output>
