---
phase: 15-scheduling-campaigns
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/123_campaign_schedule_entries.sql
  - src/services/scheduleService.js
  - src/components/schedules/CampaignPicker.jsx
  - src/components/schedules/index.js
  - src/pages/ScheduleEditorPage.jsx
autonomous: true

must_haves:
  truths:
    - "User can assign a schedule entry to a campaign"
    - "User can view entries grouped by campaign in schedule editor"
    - "Entry can belong to exactly one campaign (or none)"
    - "Campaign picker shows available campaigns with entry counts"
  artifacts:
    - path: "supabase/migrations/123_campaign_schedule_entries.sql"
      provides: "campaign_id FK on schedule_entries"
      contains: "ADD COLUMN campaign_id"
    - path: "src/components/schedules/CampaignPicker.jsx"
      provides: "Campaign selection dropdown"
      min_lines: 60
    - path: "src/services/scheduleService.js"
      provides: "Campaign-entry linking functions"
      exports: ["getEntriesForCampaign", "assignEntryToCampaign"]
  key_links:
    - from: "src/pages/ScheduleEditorPage.jsx"
      to: "src/components/schedules/CampaignPicker.jsx"
      via: "import and render in entry form"
      pattern: "CampaignPicker"
    - from: "src/services/scheduleService.js"
      to: "supabase.from('schedule_entries')"
      via: "campaign_id update"
      pattern: "campaign_id"
---

<objective>
Link schedule entries to campaigns for grouping and bulk management

Purpose: Users need to organize related schedule entries (e.g., "Holiday Promo") under a single campaign for easier management. The existing campaigns table already exists; this plan adds the FK relationship and UI for assignment.

Output: Migration adding campaign_id to schedule_entries, CampaignPicker component, and scheduleService enhancements
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-scheduling-campaigns/15-RESEARCH.md
@.planning/phases/15-scheduling-campaigns/15-CONTEXT.md

# Existing campaign infrastructure
@src/services/campaignService.js
@supabase/migrations/026_screen_groups_and_campaigns.sql

# Schedule editor integration point
@src/pages/ScheduleEditorPage.jsx
@src/services/scheduleService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add campaign_id FK to schedule_entries</name>
  <files>supabase/migrations/123_campaign_schedule_entries.sql</files>
  <action>
Create migration 123_campaign_schedule_entries.sql:

1. Add campaign_id column to schedule_entries:
   - UUID type, REFERENCES campaigns(id) ON DELETE SET NULL
   - NULL allowed (entry can be unassigned)

2. Create index for campaign lookups:
   - idx_schedule_entries_campaign on (campaign_id)

3. Add comment explaining the relationship:
   - Entry belongs to at most one campaign
   - Campaign deletion orphans entries (SET NULL), does not delete them

DO NOT add RLS policies - schedule_entries already has tenant-based RLS via schedules table.
  </action>
  <verify>
Run migration locally:
```bash
npx supabase db push --local
```
Verify column exists:
```bash
npx supabase db dump --local --data-only | grep -A5 "schedule_entries"
```
  </verify>
  <done>schedule_entries.campaign_id column exists with FK to campaigns</done>
</task>

<task type="auto">
  <name>Task 2: Add campaign-entry service functions</name>
  <files>src/services/scheduleService.js</files>
  <action>
Add functions to scheduleService.js (at end of file, before final export):

1. getEntriesForCampaign(campaignId):
   - Query schedule_entries WHERE campaign_id = campaignId
   - Include schedule name via join
   - Order by start_time
   - Return array (empty if none)

2. assignEntryToCampaign(entryId, campaignId):
   - Update schedule_entries SET campaign_id = campaignId
   - campaignId can be null (removes from campaign)
   - Return updated entry
   - Log with logger.info('Assigned entry to campaign', { entryId, campaignId })

3. bulkAssignEntriesToCampaign(entryIds, campaignId):
   - Update schedule_entries WHERE id IN (entryIds)
   - Return updated entries array

4. getCampaignsWithEntryCounts():
   - Query campaigns with count of schedule_entries
   - For picker dropdown display
   - Order by name

Use existing logger pattern: createScopedLogger('ScheduleService') already exists.
  </action>
  <verify>
TypeScript/lint check:
```bash
npm run lint -- --fix src/services/scheduleService.js
```
Service loads without error (import check in test file or console).
  </verify>
  <done>scheduleService exports getEntriesForCampaign, assignEntryToCampaign, bulkAssignEntriesToCampaign, getCampaignsWithEntryCounts</done>
</task>

<task type="auto">
  <name>Task 3: Create CampaignPicker component and integrate</name>
  <files>
    src/components/schedules/CampaignPicker.jsx
    src/components/schedules/index.js
    src/pages/ScheduleEditorPage.jsx
  </files>
  <action>
1. Create CampaignPicker.jsx:
   - Props: value (current campaign_id), onChange (callback with new campaign_id), disabled
   - Fetch campaigns on mount using getCampaignsWithEntryCounts()
   - Display as Select dropdown with:
     - Option: "No Campaign" (value: null)
     - Options: Campaign name + entry count badge (e.g., "Holiday Promo (5)")
   - Show campaign date range as secondary text if dates exist
   - Loading state while fetching
   - Use design system Select component pattern from existing pickers

2. Update index.js barrel export:
   - Add CampaignPicker export

3. Integrate in ScheduleEditorPage.jsx:
   - Import CampaignPicker
   - Add to entry edit modal/form (near priority field)
   - Pass entry.campaign_id as value
   - Update entry on change
   - Include campaign_id in save payload

Follow existing component patterns from FillerContentPicker.jsx for structure.
  </action>
  <verify>
Build passes:
```bash
npm run build
```
Visual verification: Open schedule editor, see campaign dropdown in entry form.
  </verify>
  <done>CampaignPicker renders in entry form, selecting campaign updates entry.campaign_id</done>
</task>

</tasks>

<verification>
After all tasks:
1. Database: `SELECT campaign_id FROM schedule_entries LIMIT 1;` returns (null or uuid)
2. Service: Import { getEntriesForCampaign } from scheduleService works
3. UI: Schedule editor shows campaign picker in entry modal
4. Integration: Selecting campaign in picker and saving entry persists campaign_id
</verification>

<success_criteria>
- schedule_entries table has campaign_id FK column
- scheduleService has 4 new campaign-entry functions
- CampaignPicker component renders campaign list with entry counts
- ScheduleEditorPage integrates CampaignPicker in entry form
- Assigning entry to campaign persists to database
</success_criteria>

<output>
After completion, create `.planning/phases/15-scheduling-campaigns/15-01-SUMMARY.md`
</output>
