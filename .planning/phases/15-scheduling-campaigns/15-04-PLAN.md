---
phase: 15-scheduling-campaigns
plan: 04
type: execute
wave: 2
depends_on: ["15-02"]
files_modified:
  - src/components/layout/Header.jsx
  - src/components/ContentPicker.jsx
  - src/pages/MediaLibraryPage.jsx
  - src/pages/ScenesPage.jsx
  - supabase/migrations/016_player_content_resolution.sql
autonomous: true

must_haves:
  truths:
    - "User can push emergency from header button"
    - "User can push emergency from content context menu"
    - "Emergency push shows duration options"
    - "Player resolves emergency content before campaigns/schedules"
    - "Emergency push triggers device refresh"
  artifacts:
    - path: "src/components/layout/Header.jsx"
      provides: "Emergency Push button in header"
      contains: "Emergency"
    - path: "src/pages/MediaLibraryPage.jsx"
      provides: "Emergency Push context menu option"
      contains: "pushEmergency"
    - path: "supabase/migrations/126_emergency_content_resolution.sql"
      provides: "Emergency check in player resolution"
      contains: "emergency_content_id"
  key_links:
    - from: "src/components/layout/Header.jsx"
      to: "src/services/emergencyService.js"
      via: "pushEmergencyContent call"
      pattern: "pushEmergencyContent"
    - from: "get_resolved_player_content"
      to: "profiles.emergency_content_id"
      via: "SQL query"
      pattern: "emergency_content_id IS NOT NULL"
---

<objective>
Complete emergency override integration with push triggers and player resolution

Purpose: Users need to push emergency content from multiple entry points (header button, content context menus). The player must check emergency state before resolving normal schedule content.

Output: Emergency button in header, context menu options on content pages, updated player content resolution RPC
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-scheduling-campaigns/15-RESEARCH.md
@.planning/phases/15-scheduling-campaigns/15-CONTEXT.md
@.planning/phases/15-scheduling-campaigns/15-02-SUMMARY.md

# Emergency service from Plan 02
@src/services/emergencyService.js

# Integration points
@src/components/layout/Header.jsx
@src/pages/MediaLibraryPage.jsx
@src/pages/ScenesPage.jsx

# Player resolution
@supabase/migrations/016_player_content_resolution.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add Emergency Push button to header</name>
  <files>src/components/layout/Header.jsx</files>
  <action>
Update Header.jsx:

1. Import:
   - useEmergency from contexts/EmergencyContext
   - pushEmergencyContent, EMERGENCY_DURATIONS from services/emergencyService
   - AlertTriangle icon from lucide-react
   - Dialog/Modal component from design system

2. Add state:
   - showEmergencyModal (boolean)
   - selectedContent (type + id)
   - selectedDuration (from EMERGENCY_DURATIONS)
   - pushing (loading state)

3. Add Emergency Push button (when no emergency active):
   - Position: In header action area (near notifications or user menu)
   - Icon: AlertTriangle
   - Color: Red/warning variant
   - Label: "Emergency Push" (or just icon on mobile)
   - onClick: open modal to select content

4. Emergency Push Modal:
   - Title: "Push Emergency Content"
   - ContentPicker or simple select to choose content (scene, media, playlist)
   - Duration dropdown using EMERGENCY_DURATIONS
   - Push button (primary red)
   - Cancel button
   - On push: call pushEmergencyContent, close modal, show success toast

5. When emergency IS active:
   - Show badge indicator on header (red dot or "EMERGENCY" text)
   - Button disabled or hidden (banner has stop button)

Note: If useEmergency is not available (outside provider), hide the button gracefully.
  </action>
  <verify>
Build passes:
```bash
npm run build
```
Visual: Header shows Emergency Push button (red) when no emergency active.
  </verify>
  <done>Emergency Push button in header opens modal for content selection</done>
</task>

<task type="auto">
  <name>Task 2: Add Emergency Push to content context menus</name>
  <files>
    src/pages/MediaLibraryPage.jsx
    src/pages/ScenesPage.jsx
  </files>
  <action>
Add "Push as Emergency" option to content context menus:

1. MediaLibraryPage.jsx:
   - Find existing context menu (likely DropdownMenu or similar)
   - Add menu item: "Push as Emergency"
   - Icon: AlertTriangle (red)
   - onClick: Show duration selector dialog, then call pushEmergencyContent('media', mediaId, duration)
   - Show loading state during push
   - Show success/error toast

2. ScenesPage.jsx:
   - Same pattern as MediaLibraryPage
   - Content type: 'scene'

3. Duration selector pattern:
   - Can be inline dropdown in context menu OR
   - Simple confirmation dialog with duration select
   - Default to first option (15 minutes) for quick emergency

4. Import emergencyService functions where needed:
   - pushEmergencyContent, EMERGENCY_DURATIONS

Note: Only show option if user has permission (check against existing permission patterns on page). Emergency push is typically owner/manager only.
  </action>
  <verify>
Build passes:
```bash
npm run build
```
Visual: Context menu on media items shows "Push as Emergency" option.
  </verify>
  <done>Content context menus have Emergency Push option with duration selector</done>
</task>

<task type="auto">
  <name>Task 3: Update player content resolution for emergency</name>
  <files>supabase/migrations/126_emergency_content_resolution.sql</files>
  <action>
Create migration 126_emergency_content_resolution.sql:

1. Modify get_resolved_player_content function:
   - IMPORTANT: First read existing function from 016_player_content_resolution.sql to understand current logic
   - Use CREATE OR REPLACE FUNCTION

2. Add emergency check at START of function (highest priority):
   ```sql
   -- Get tenant's emergency state
   SELECT emergency_content_id, emergency_content_type, emergency_started_at, emergency_duration_minutes
   INTO v_emergency
   FROM profiles
   WHERE id = v_device.tenant_id;

   -- Check if emergency is active and not expired
   IF v_emergency.emergency_content_id IS NOT NULL THEN
     -- Check duration expiry (NULL duration = indefinite)
     IF v_emergency.emergency_duration_minutes IS NULL
        OR (v_emergency.emergency_started_at + (v_emergency.emergency_duration_minutes || ' minutes')::interval) > now()
     THEN
       -- Return emergency content (bypasses all other resolution)
       RETURN jsonb_build_object(
         'content_type', v_emergency.emergency_content_type,
         'content_id', v_emergency.emergency_content_id,
         'source', 'emergency',
         'priority', 999
       );
     ELSE
       -- Emergency expired, clear it (auto-cleanup)
       UPDATE profiles
       SET emergency_content_id = NULL,
           emergency_content_type = NULL,
           emergency_started_at = NULL,
           emergency_duration_minutes = NULL
       WHERE id = v_device.tenant_id;
     END IF;
   END IF;
   ```

3. Keep existing resolution logic (campaigns > schedules > assigned) as fallback

4. Add comment: "Emergency content has highest priority (999), overrides all schedules and campaigns"

Note: The existing function likely has DECLARE/BEGIN structure. Add emergency variables to DECLARE and check block after getting device info.
  </action>
  <verify>
Run migration:
```bash
npx supabase db push --local
```
Test function exists:
```bash
npx supabase db dump --local | grep "get_resolved_player_content"
```
  </verify>
  <done>get_resolved_player_content checks emergency state first, returns emergency content with priority 999</done>
</task>

</tasks>

<verification>
After all tasks:
1. UI: Header has Emergency Push button with content/duration modal
2. UI: Context menus on scenes/media have "Push as Emergency" option
3. Database: get_resolved_player_content function includes emergency check

Integration test (manual):
1. Push emergency via header button
2. Verify banner appears
3. Call get_resolved_player_content() for a device - should return emergency content
4. Stop emergency via banner
5. Verify get_resolved_player_content() returns normal schedule content
</verification>

<success_criteria>
- Header shows Emergency Push button (when not in emergency)
- Clicking Emergency Push shows content + duration selector
- Content pages have "Push as Emergency" context menu option
- Player content resolution checks emergency state first
- Emergency content returned with source: 'emergency', priority: 999
- Expired emergency auto-clears on resolution
</success_criteria>

<output>
After completion, create `.planning/phases/15-scheduling-campaigns/15-04-SUMMARY.md`
</output>
