---
phase: 07-player-refactoring
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Player.jsx
  - src/player/components/widgets/ClockWidget.jsx
  - src/player/components/widgets/DateWidget.jsx
  - src/player/components/widgets/WeatherWidget.jsx
  - src/player/components/widgets/QRCodeWidget.jsx
  - src/player/components/widgets/index.js
autonomous: true

must_haves:
  truths:
    - "Widget components render identically to inline versions"
    - "PLR-01 gap fixed: retry uses calculateBackoff with 0-100% full jitter"
    - "All 167 Player tests still pass"
  artifacts:
    - path: "src/player/components/widgets/ClockWidget.jsx"
      provides: "Clock widget with time/date display"
      min_lines: 40
    - path: "src/player/components/widgets/DateWidget.jsx"
      provides: "Date-only widget display"
      min_lines: 20
    - path: "src/player/components/widgets/WeatherWidget.jsx"
      provides: "Weather widget with icon and temperature"
      min_lines: 60
    - path: "src/player/components/widgets/QRCodeWidget.jsx"
      provides: "QR code generation widget"
      min_lines: 30
    - path: "src/player/components/widgets/index.js"
      provides: "Barrel export for all widgets"
      exports: ["ClockWidget", "DateWidget", "WeatherWidget", "QRCodeWidget"]
  key_links:
    - from: "src/Player.jsx"
      to: "src/player/components/widgets/index.js"
      via: "import statement"
      pattern: "from.*player/components/widgets"
    - from: "src/Player.jsx"
      to: "src/services/playerService.js"
      via: "calculateBackoff import"
      pattern: "calculateBackoff.*from.*playerService"
---

<objective>
Extract widget components and fix PLR-01 retry gap

Purpose: Create foundation for Player.jsx decomposition by extracting self-contained widget components and consolidating retry logic to use calculateBackoff with full jitter (0-100%).

Output: 4 widget component files, PLR-01 gap fixed, all tests passing
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-player-refactoring/07-RESEARCH.md
@src/Player.jsx
@src/services/playerService.js
@tests/unit/player/Player.test.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create widget directory and extract widget components</name>
  <files>
    src/player/components/widgets/ClockWidget.jsx
    src/player/components/widgets/DateWidget.jsx
    src/player/components/widgets/WeatherWidget.jsx
    src/player/components/widgets/QRCodeWidget.jsx
    src/player/components/widgets/index.js
  </files>
  <action>
Create the player component directory structure:
```
src/player/
└── components/
    └── widgets/
        ├── ClockWidget.jsx
        ├── DateWidget.jsx
        ├── WeatherWidget.jsx
        ├── QRCodeWidget.jsx
        └── index.js
```

**ClockWidget.jsx** - Extract from SceneWidgetRenderer case 'clock' (lines 1434-1450):
- Props: `{ props }` where props contains textColor, size, customFontSize
- Internal state: `[time, setTime]` with 1-second interval
- Include formatTime() helper
- Include sizeMap for font sizing
- Include getFontSize() helper for custom size handling

**DateWidget.jsx** - Extract from SceneWidgetRenderer case 'date' (lines 1452-1467):
- Props: `{ props }` where props contains textColor, size, customFontSize
- Internal state: `[time, setTime]` with 1-second interval (shared logic with clock)
- Include formatDate() helper
- Include same sizeMap and getFontSize() helpers

**WeatherWidget.jsx** - Extract from SceneWidgetRenderer case 'weather' (lines 1469-1610):
- Props: `{ props, weather, weatherLoading }` - weather data is fetched by parent
- Include FallbackIcon component
- Include both 'minimal' and 'card' style variations
- Include accentColor, textColor, size handling

**QRCodeWidget.jsx** - Extract from SceneWidgetRenderer case 'qr' if it exists, or create new:
- Props: `{ props }` where props contains url, size, fgColor, bgColor
- Use QRCodeSVG from qrcode.react
- Error correction level: 'M' (medium)
- Include responsive sizing

**index.js** - Barrel export:
```javascript
export { ClockWidget } from './ClockWidget.jsx';
export { DateWidget } from './DateWidget.jsx';
export { WeatherWidget } from './WeatherWidget.jsx';
export { QRCodeWidget } from './QRCodeWidget.jsx';
```

Each widget should:
- Use useLogger hook for error logging
- Accept props matching current SceneWidgetRenderer interface
- Be self-contained (own interval timers where needed)
- Clean up intervals on unmount
  </action>
  <verify>
Files exist and have correct exports:
```bash
ls -la src/player/components/widgets/
grep -l "export" src/player/components/widgets/*.jsx
```
  </verify>
  <done>4 widget files exist with named exports, index.js barrel exports all widgets</done>
</task>

<task type="auto">
  <name>Task 2: Fix PLR-01 gap and update Player.jsx to use extracted widgets</name>
  <files>
    src/Player.jsx
  </files>
  <action>
**Fix PLR-01 gap (retry logic consolidation):**

1. Remove the local getRetryDelay function (lines 117-124):
```javascript
// DELETE THIS:
function getRetryDelay(attempt) {
  const delay = Math.min(
    RETRY_CONFIG.baseDelayMs * Math.pow(2, attempt),
    RETRY_CONFIG.maxDelayMs
  );
  return delay + Math.random() * delay * 0.25; // 0-25% jitter
}
```

2. Update retryWithBackoff function (lines 129-144) to use calculateBackoff:
```javascript
async function retryWithBackoff(fn, maxRetries = RETRY_CONFIG.maxRetries) {
  let lastError;
  for (let attempt = 0; attempt < maxRetries; attempt++) {
    try {
      return await fn();
    } catch (error) {
      lastError = error;
      if (attempt < maxRetries - 1) {
        // Use calculateBackoff from playerService (0-100% full jitter)
        const delay = calculateBackoff(attempt, RETRY_CONFIG.baseDelayMs, RETRY_CONFIG.maxDelayMs);
        retryLogger.debug('Retry attempt', { attempt: attempt + 1, maxRetries, delayMs: Math.round(delay) });
        await new Promise(resolve => setTimeout(resolve, delay));
      }
    }
  }
  throw lastError;
}
```

**Update SceneWidgetRenderer to use extracted widgets:**

1. Add import at top of file:
```javascript
import { ClockWidget, DateWidget, WeatherWidget, QRCodeWidget } from './player/components/widgets';
```

2. Update SceneWidgetRenderer switch statement to use extracted components:
```javascript
switch (widgetType) {
  case 'clock':
    return <ClockWidget props={safeProps} time={time} />;
  case 'date':
    return <DateWidget props={safeProps} time={time} />;
  case 'weather':
    return <WeatherWidget props={safeProps} weather={weather} weatherLoading={weatherLoading} />;
  case 'qr':
    return <QRCodeWidget props={safeProps} />;
  default:
    return null;
}
```

Note: Keep the time state and weather fetching logic in SceneWidgetRenderer for now, pass as props. This maintains the existing data flow while extracting UI components.

**Important:** calculateBackoff is already imported from playerService (line 39). Verify this import exists.
  </action>
  <verify>
```bash
# Verify PLR-01 fix - should NOT find getRetryDelay function
grep -n "function getRetryDelay" src/Player.jsx && echo "FAIL: getRetryDelay still exists" || echo "PASS: getRetryDelay removed"

# Verify calculateBackoff is used in retryWithBackoff
grep -A5 "async function retryWithBackoff" src/Player.jsx | grep "calculateBackoff" && echo "PASS: Using calculateBackoff" || echo "FAIL: Not using calculateBackoff"

# Verify widget import
grep "from.*player/components/widgets" src/Player.jsx && echo "PASS: Widgets imported" || echo "FAIL: Widgets not imported"

# Run tests
npm test -- --run
```
  </verify>
  <done>getRetryDelay removed, retryWithBackoff uses calculateBackoff, widgets imported and used in SceneWidgetRenderer, all 167 tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Verify and commit changes</name>
  <files>
    src/Player.jsx
    src/player/components/widgets/*.jsx
  </files>
  <action>
1. Run full test suite to verify no regressions:
```bash
npm test -- --run
```

2. Verify Player.jsx line count reduced (should be ~100 lines less):
```bash
wc -l src/Player.jsx
```

3. Verify widget exports work correctly:
```bash
node -e "import('./src/player/components/widgets/index.js').then(m => console.log(Object.keys(m)))"
```

4. Commit the changes with descriptive message covering:
- PLR-01 gap fix (retry logic consolidation)
- Widget component extraction
- Test verification
  </action>
  <verify>
All tests pass, widget files created, PLR-01 fixed
  </verify>
  <done>Changes committed with passing tests, PLR-01 gap closed, widget extraction complete</done>
</task>

</tasks>

<verification>
1. All 167 existing Player tests pass: `npm test -- --run`
2. PLR-01 gap fixed: `grep -n "calculateBackoff" src/Player.jsx` shows usage in retryWithBackoff
3. Widgets extracted: `ls src/player/components/widgets/` shows 5 files
4. No getRetryDelay: `grep "getRetryDelay" src/Player.jsx` returns nothing
</verification>

<success_criteria>
- [ ] src/player/components/widgets/ directory exists with 4 widget files + index.js
- [ ] ClockWidget, DateWidget, WeatherWidget, QRCodeWidget exported correctly
- [ ] Player.jsx imports from player/components/widgets
- [ ] getRetryDelay function removed from Player.jsx
- [ ] retryWithBackoff uses calculateBackoff (0-100% full jitter)
- [ ] All 167 Player.jsx tests pass
- [ ] Player.jsx line count reduced by ~100 lines
</success_criteria>

<output>
After completion, create `.planning/phases/07-player-refactoring/07-01-SUMMARY.md`
</output>
