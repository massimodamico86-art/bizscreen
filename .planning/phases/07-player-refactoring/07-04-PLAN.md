---
phase: 07-player-refactoring
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/playbackTrackingService.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All 1428 tests pass without errors"
    - "playbackTrackingService.trackSceneStart logs correctly without ReferenceError"
  artifacts:
    - path: "src/services/playbackTrackingService.js"
      provides: "Fixed logger.debug call at line 159"
      contains: "logger.debug.*Scene started"
  key_links:
    - from: "trackSceneStart"
      to: "logger.debug"
      via: "valid variable references"
      pattern: "sceneId.*scheduleId.*deviceContext"
---

<objective>
Fix playbackTrackingService bug causing 42 test failures

Purpose: Close Gap 2 from verification - the undefined `playlistId` and `screenId` variables in `trackSceneStart` cause ReferenceError during test execution.

Output: All tests pass, phase 7 verification gaps closed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-player-refactoring/07-VERIFICATION.md

# Root cause context
@src/services/playbackTrackingService.js (lines 125-165)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix undefined variable references in trackSceneStart</name>
  <files>src/services/playbackTrackingService.js</files>
  <action>
Fix line 159 in playbackTrackingService.js:

Current (broken):
```javascript
logger.debug('Scene started', { sceneId, playlistId, screenId });
```

The function signature is `trackSceneStart({ sceneId, scheduleId, groupId })`:
- `sceneId` is valid (from params)
- `playlistId` does NOT exist anywhere in scope - causes ReferenceError
- `screenId` does NOT exist in scope - should be `deviceContext.deviceId`

Change to:
```javascript
logger.debug('Scene started', { sceneId, scheduleId, screenId: deviceContext.deviceId });
```

This logs the same information using variables that are actually in scope:
- `sceneId` from function params
- `scheduleId` from function params (replaces non-existent playlistId)
- `deviceContext.deviceId` which is the screenId (already set to currentSceneEvent.screenId on line 149)
  </action>
  <verify>
```bash
grep -n "logger.debug.*Scene started" src/services/playbackTrackingService.js
```
Should show the fixed line with valid variable references.
  </verify>
  <done>Line 159 references only variables that exist in scope: sceneId, scheduleId, deviceContext.deviceId</done>
</task>

<task type="auto">
  <name>Task 2: Verify all tests pass</name>
  <files>tests/unit/services/playbackTrackingService.test.js</files>
  <action>
Run the full test suite to verify the fix resolves all 42 failures.

```bash
npm test
```

Expected results:
- All playbackTrackingService tests pass (no more ReferenceError)
- Total test count: 1428 tests
- Failures: 0

If any tests still fail:
1. Check if they are related to the playlistId fix
2. If different issue, document and note as pre-existing
  </action>
  <verify>
```bash
npm test 2>&1 | tail -20
```
Should show "Tests: X passed" with no failures (or only pre-existing failures unrelated to this fix).
  </verify>
  <done>Test suite passes with 0 failures related to playbackTrackingService</done>
</task>

</tasks>

<verification>
1. grep confirms logger.debug uses valid variables
2. npm test passes without ReferenceError
3. 42 failures from VERIFICATION.md are resolved
</verification>

<success_criteria>
- playbackTrackingService.js line 159 references only in-scope variables
- All 1428 tests pass (or same pass rate as before Phase 7)
- No ReferenceError in test output
</success_criteria>

<output>
After completion, create `.planning/phases/07-player-refactoring/07-04-SUMMARY.md`
</output>
