---
phase: 07-player-refactoring
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/Player.jsx
  - src/player/hooks/usePlayerContent.js
  - src/player/hooks/usePlayerHeartbeat.js
  - src/player/hooks/usePlayerCommands.js
  - src/player/hooks/index.js
autonomous: true

must_haves:
  truths:
    - "Content loading works with usePlayerContent hook"
    - "Heartbeat continues at 30-second intervals via usePlayerHeartbeat"
    - "Commands are handled correctly via usePlayerCommands"
    - "All 167 Player tests still pass"
  artifacts:
    - path: "src/player/hooks/usePlayerContent.js"
      provides: "Content loading, caching, polling, offline fallback"
      min_lines: 150
      exports: ["usePlayerContent"]
    - path: "src/player/hooks/usePlayerHeartbeat.js"
      provides: "Heartbeat, device status, screenshot capture"
      min_lines: 80
      exports: ["usePlayerHeartbeat"]
    - path: "src/player/hooks/usePlayerCommands.js"
      provides: "Command polling and execution"
      min_lines: 60
      exports: ["usePlayerCommands"]
    - path: "src/player/hooks/index.js"
      provides: "Barrel export for all hooks"
      exports: ["usePlayerContent", "usePlayerHeartbeat", "usePlayerCommands"]
  key_links:
    - from: "src/Player.jsx ViewPage"
      to: "src/player/hooks/usePlayerContent.js"
      via: "hook call"
      pattern: "usePlayerContent\\("
    - from: "src/player/hooks/usePlayerHeartbeat.js"
      to: "src/services/playerService.js"
      via: "updateDeviceStatus import"
      pattern: "updateDeviceStatus"
---

<objective>
Extract custom hooks for content, heartbeat, and commands

Purpose: Extract the complex stateful logic from ViewPage into reusable, testable custom hooks. This is the core refactoring that reduces ViewPage from ~1400 lines to ~400 lines.

Output: 3 custom hooks, ViewPage using hooks, all tests passing
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-player-refactoring/07-RESEARCH.md
@.planning/phases/07-player-refactoring/07-01-SUMMARY.md
@src/Player.jsx
@src/services/playerService.js
@tests/unit/player/Player.heartbeat.test.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract usePlayerContent hook</name>
  <files>
    src/player/hooks/usePlayerContent.js
  </files>
  <action>
Create `src/player/hooks/usePlayerContent.js` that extracts content loading logic from ViewPage.

**State to manage:**
- content (object)
- items (array)
- currentIndex (number)
- loading (boolean)
- error (string)
- connectionStatus ('connecting' | 'connected' | 'reconnecting' | 'offline')
- isOfflineMode (boolean)
- retryCount (number)

**Functions to include:**
- loadContent(screenId, useRetry) - Lines 2426-2513 from Player.jsx
- shuffleArray(array) - Lines 2416-2423 (Fisher-Yates)
- advanceToNext() - Lines 2618-2629

**Effects to include:**
- Initial load effect (lines 2521-2541)
- Polling effect with error recovery (lines 2544-2615)
- Timer for image/document duration (lines 2664-2689)

**Interface:**
```javascript
export function usePlayerContent(screenId, navigate) {
  // ... state and logic

  return {
    content,
    items,
    currentIndex,
    loading,
    error,
    connectionStatus,
    isOfflineMode,
    loadContent,
    advanceToNext,
    setContent,
    setItems,
    setCurrentIndex,
    setConnectionStatus,
  };
}
```

**Critical patterns to preserve:**
- loadContentRef pattern for avoiding dependency cycles
- shuffleArray usage when playlist.shuffle is true
- Content hash comparison for change detection
- Offline cache fallback on network failure
- Consecutive error counting for reconnection trigger

**Import required services:**
- getResolvedContent (define locally or import)
- cacheContent, getCachedContent from playerService
- createScopedLogger from loggingService
  </action>
  <verify>
```bash
# Verify file exists and has correct export
grep "export function usePlayerContent" src/player/hooks/usePlayerContent.js
# Verify key functions exist
grep -E "loadContent|shuffleArray|advanceToNext" src/player/hooks/usePlayerContent.js
```
  </verify>
  <done>usePlayerContent hook exists with content loading, caching, and polling logic</done>
</task>

<task type="auto">
  <name>Task 2: Extract usePlayerHeartbeat and usePlayerCommands hooks</name>
  <files>
    src/player/hooks/usePlayerHeartbeat.js
    src/player/hooks/usePlayerCommands.js
    src/player/hooks/index.js
  </files>
  <action>
**Create usePlayerHeartbeat.js** extracting heartbeat logic from ViewPage (lines 2206-2260):

```javascript
export function usePlayerHeartbeat(screenId, loadContentRef, contentContainerRef) {
  const logger = useLogger('usePlayerHeartbeat');
  const heartbeatRef = useRef(null);
  const screenshotInProgressRef = useRef(false);

  useEffect(() => {
    if (!screenId) return;

    const sendBeat = async () => {
      // ... heartbeat logic from lines 2210-2250
      // - updateDeviceStatus call
      // - Screenshot capture if requested
      // - Refresh status check
      // - loadContentRef.current?.() for refresh
    };

    sendBeat();
    heartbeatRef.current = setInterval(sendBeat, HEARTBEAT_INTERVAL);

    return () => {
      if (heartbeatRef.current) {
        clearInterval(heartbeatRef.current);
      }
    };
  }, [screenId]); // Note: using refs avoids dependency issues

  return { heartbeatRef };
}
```

**Create usePlayerCommands.js** extracting command handling from ViewPage (lines 2310-2359):

```javascript
export function usePlayerCommands(screenId, setContent, setItems, setCurrentIndex, navigate, logger) {
  const handleCommand = useCallback(async (command) => {
    const { commandId, commandType } = command;

    try {
      switch (commandType) {
        case 'reboot':
          await reportCommandResult(commandId, true);
          setTimeout(() => window.location.reload(), 500);
          break;

        case 'reload':
          // ... reload logic
          break;

        case 'clear_cache':
          await clearCache();
          await reportCommandResult(commandId, true);
          break;

        case 'reset':
          // ... reset logic
          break;

        default:
          logger.warn('Unknown command', { commandType });
          await reportCommandResult(commandId, false, 'Unknown command');
      }
    } catch (err) {
      logger.error('Command execution failed', { error: err });
      await reportCommandResult(commandId, false, err.message);
    }
  }, [setContent, setItems, setCurrentIndex, navigate, logger]);

  // Command polling effect could also go here if desired
  // For now, keep in ViewPage as it's simpler

  return { handleCommand };
}
```

**Create index.js barrel export:**
```javascript
export { usePlayerContent } from './usePlayerContent.js';
export { usePlayerHeartbeat } from './usePlayerHeartbeat.js';
export { usePlayerCommands } from './usePlayerCommands.js';
```

**Import requirements for hooks:**
- usePlayerHeartbeat: updateDeviceStatus, captureAndUploadScreenshot, cleanupOldScreenshots, checkDeviceRefreshStatus, clearDeviceRefreshFlag, HEARTBEAT_INTERVAL
- usePlayerCommands: reportCommandResult, clearCache, getResolvedContent
  </action>
  <verify>
```bash
# Verify hooks exist
ls src/player/hooks/
# Verify exports
grep "export function" src/player/hooks/*.js
# Verify index exports
grep "export {" src/player/hooks/index.js
```
  </verify>
  <done>usePlayerHeartbeat and usePlayerCommands hooks exist with correct exports, index.js exports all hooks</done>
</task>

<task type="auto">
  <name>Task 3: Update ViewPage to use extracted hooks</name>
  <files>
    src/Player.jsx
  </files>
  <action>
**Update ViewPage component to use the extracted hooks:**

1. Add import at top of file:
```javascript
import { usePlayerContent, usePlayerHeartbeat, usePlayerCommands } from './player/hooks';
```

2. In ViewPage component, replace the extracted state and logic with hook calls:

```javascript
function ViewPage() {
  const navigate = useNavigate();
  const logger = useLogger('ViewPage');
  const screenId = localStorage.getItem(STORAGE_KEYS.screenId);

  // Content hook - manages all content state and loading
  const {
    content,
    items,
    currentIndex,
    loading,
    error,
    connectionStatus,
    isOfflineMode,
    loadContent,
    advanceToNext,
    setContent,
    setItems,
    setCurrentIndex,
  } = usePlayerContent(screenId, navigate);

  // Refs needed by other hooks
  const loadContentRef = useRef(null);
  const contentContainerRef = useRef(null);

  // Keep loadContentRef updated
  useEffect(() => {
    loadContentRef.current = loadContent;
  }, [loadContent]);

  // Heartbeat hook - handles device status updates
  usePlayerHeartbeat(screenId, loadContentRef, contentContainerRef);

  // Commands hook - handles device commands
  const { handleCommand } = usePlayerCommands(
    screenId,
    setContent,
    setItems,
    setCurrentIndex,
    navigate,
    logger
  );

  // Keep remaining ViewPage-specific logic:
  // - Kiosk mode state and handlers (lines 2361-2413)
  // - Stuck detection effect (lines 2263-2307)
  // - Video tracking effects (lines 2632-2661, 2691-2694)
  // - All render logic

  // ... rest of ViewPage
}
```

**What stays in ViewPage:**
- Kiosk mode state: kioskMode, showKioskExit, kioskPasswordInput, kioskPasswordError
- Kiosk handlers: handleKioskExit, keyboard handlers
- Stuck detection effect (uses videoRef which is local)
- Refs: videoRef, timerRef, contentContainerRef, etc.
- All rendering logic (loading, error, content display)

**What is removed from ViewPage (now in hooks):**
- content, items, currentIndex, loading, error state
- connectionStatus, isOfflineMode, retryCount state
- loadContent function and its effect
- Polling effect
- Heartbeat effect
- handleCommand callback

**Verify:**
- The hook calls should provide the same interface as the removed state
- No functionality changes, just code organization
  </action>
  <verify>
```bash
# Verify hooks are imported
grep "from.*player/hooks" src/Player.jsx

# Verify hooks are called
grep -E "usePlayerContent|usePlayerHeartbeat|usePlayerCommands" src/Player.jsx

# Run full test suite
npm test -- --run

# Check line count reduced significantly
wc -l src/Player.jsx
```
  </verify>
  <done>ViewPage uses all 3 extracted hooks, all 167 tests pass, Player.jsx significantly smaller</done>
</task>

</tasks>

<verification>
1. All 167 existing Player tests pass: `npm test -- --run`
2. Hooks exist: `ls src/player/hooks/` shows 4 files (3 hooks + index)
3. Hooks imported and used: `grep "usePlayer" src/Player.jsx`
4. Player.jsx line count ~500 lines reduced (target: under 3000 lines now)
</verification>

<success_criteria>
- [ ] src/player/hooks/ directory exists with 3 hook files + index.js
- [ ] usePlayerContent manages content, items, loading, error, offline state
- [ ] usePlayerHeartbeat handles 30-second heartbeat intervals
- [ ] usePlayerCommands handles reload, reboot, clear_cache, reset commands
- [ ] ViewPage imports and uses all 3 hooks
- [ ] All 167 Player.jsx tests pass
- [ ] Player.jsx line count reduced by ~500 lines
</success_criteria>

<output>
After completion, create `.planning/phases/07-player-refactoring/07-02-SUMMARY.md`
</output>
