---
phase: 18-templates-discovery
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/130_starter_packs.sql
  - src/services/marketplaceService.js
  - src/components/templates/StarterPacksRow.jsx
  - src/components/templates/StarterPackCard.jsx
  - src/components/templates/index.js
  - src/pages/TemplateMarketplacePage.jsx
autonomous: true

must_haves:
  truths:
    - "User can see starter packs row above Featured templates"
    - "User can click pack to expand and see contained templates"
    - "User can select multiple templates from expanded pack with checkboxes"
    - "User can click 'Apply Selected' to create scenes from selected templates"
    - "Pack expansion is inline (no page navigation)"
  artifacts:
    - path: "supabase/migrations/130_starter_packs.sql"
      provides: "Database tables for starter packs"
      contains: "starter_packs"
    - path: "src/components/templates/StarterPacksRow.jsx"
      provides: "Row displaying starter packs above Featured"
      min_lines: 30
    - path: "src/components/templates/StarterPackCard.jsx"
      provides: "Expandable pack card with template selection"
      min_lines: 80
  key_links:
    - from: "src/pages/TemplateMarketplacePage.jsx"
      to: "marketplaceService"
      via: "fetchStarterPacks call"
      pattern: "fetchStarterPacks"
    - from: "src/components/templates/StarterPackCard.jsx"
      to: "installTemplateAsScene"
      via: "Apply Selected handler"
      pattern: "installTemplateAsScene"
---

<objective>
Starter packs feature allowing users to browse and apply curated template collections.

Purpose: Help new users get started quickly with pre-selected template bundles organized by use case (e.g., "Restaurant Starter", "Retail Essentials").
Output: Database schema for packs, service functions, expandable pack card UI, integration with marketplace page
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-templates-discovery/18-CONTEXT.md
@.planning/phases/18-templates-discovery/18-RESEARCH.md
@src/services/marketplaceService.js
@src/components/templates/FeaturedTemplatesRow.jsx
@src/pages/TemplateMarketplacePage.jsx
@supabase/migrations/080_template_marketplace.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create starter packs database tables</name>
  <files>supabase/migrations/130_starter_packs.sql</files>
  <action>
Create migration with:

1. **starter_packs table:**
```sql
CREATE TABLE IF NOT EXISTS starter_packs (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  name text NOT NULL,
  description text,
  thumbnail_url text,
  industry text,
  sort_order integer DEFAULT 0,
  is_active boolean DEFAULT true,
  is_featured boolean DEFAULT false,
  created_at timestamptz NOT NULL DEFAULT now(),
  updated_at timestamptz NOT NULL DEFAULT now()
);

CREATE INDEX IF NOT EXISTS idx_starter_packs_active ON starter_packs(is_active) WHERE is_active = true;
CREATE INDEX IF NOT EXISTS idx_starter_packs_featured ON starter_packs(is_featured) WHERE is_featured = true;
CREATE INDEX IF NOT EXISTS idx_starter_packs_sort ON starter_packs(sort_order);
```

2. **starter_pack_templates junction table:**
```sql
CREATE TABLE IF NOT EXISTS starter_pack_templates (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  pack_id uuid NOT NULL REFERENCES starter_packs(id) ON DELETE CASCADE,
  template_id uuid NOT NULL REFERENCES template_library(id) ON DELETE CASCADE,
  position integer DEFAULT 0,
  UNIQUE(pack_id, template_id)
);

CREATE INDEX IF NOT EXISTS idx_starter_pack_templates_pack ON starter_pack_templates(pack_id);
```

3. **RLS policies:**
```sql
ALTER TABLE starter_packs ENABLE ROW LEVEL SECURITY;
ALTER TABLE starter_pack_templates ENABLE ROW LEVEL SECURITY;

-- SELECT: Everyone can view active packs
CREATE POLICY "starter_packs_select" ON starter_packs
  FOR SELECT USING (is_active = true);

-- SELECT: Everyone can view pack-template associations
CREATE POLICY "starter_pack_templates_select" ON starter_pack_templates
  FOR SELECT USING (true);

-- Admin policies for insert/update/delete (permissive for now)
CREATE POLICY "starter_packs_admin" ON starter_packs
  FOR ALL USING (true);

CREATE POLICY "starter_pack_templates_admin" ON starter_pack_templates
  FOR ALL USING (true);
```

4. **RPC: get_starter_packs()**
```sql
CREATE OR REPLACE FUNCTION get_starter_packs()
RETURNS TABLE (
  id uuid,
  name text,
  description text,
  thumbnail_url text,
  industry text,
  template_count bigint,
  templates jsonb
)
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  RETURN QUERY
  SELECT
    sp.id,
    sp.name,
    sp.description,
    sp.thumbnail_url,
    sp.industry,
    (SELECT COUNT(*) FROM starter_pack_templates WHERE pack_id = sp.id) as template_count,
    (
      SELECT jsonb_agg(
        jsonb_build_object(
          'id', tl.id,
          'name', tl.name,
          'thumbnail_url', tl.thumbnail_url,
          'description', tl.description,
          'license', tl.license
        ) ORDER BY spt.position
      )
      FROM starter_pack_templates spt
      JOIN template_library tl ON tl.id = spt.template_id
      WHERE spt.pack_id = sp.id AND tl.is_active = true
    ) as templates
  FROM starter_packs sp
  WHERE sp.is_active = true
  ORDER BY sp.is_featured DESC, sp.sort_order, sp.name;
END;
$$;

GRANT EXECUTE ON FUNCTION get_starter_packs() TO authenticated;
```

5. **Seed sample packs (optional, for testing):**
```sql
-- Restaurant Starter Pack
INSERT INTO starter_packs (name, description, thumbnail_url, industry, sort_order, is_featured)
VALUES (
  'Restaurant Starter',
  'Everything you need for a restaurant display - menu boards, daily specials, and promotions.',
  NULL,
  'restaurant',
  1,
  true
) ON CONFLICT DO NOTHING;

-- Retail Starter Pack
INSERT INTO starter_packs (name, description, thumbnail_url, industry, sort_order, is_featured)
VALUES (
  'Retail Essentials',
  'Product showcases, sale announcements, and store information displays.',
  NULL,
  'retail',
  2,
  true
) ON CONFLICT DO NOTHING;
```

6. **Updated_at trigger:**
```sql
DROP TRIGGER IF EXISTS trigger_starter_packs_updated_at ON starter_packs;
CREATE TRIGGER trigger_starter_packs_updated_at
  BEFORE UPDATE ON starter_packs
  FOR EACH ROW
  EXECUTE FUNCTION update_template_library_updated_at();
```
  </action>
  <verify>
Run migration
Check tables exist: starter_packs, starter_pack_templates
Check RPC exists: get_starter_packs()
  </verify>
  <done>
Starter packs database schema created with tables, RLS, and RPC
  </done>
</task>

<task type="auto">
  <name>Task 2: Add starter packs service functions and create UI components</name>
  <files>src/services/marketplaceService.js, src/components/templates/StarterPacksRow.jsx, src/components/templates/StarterPackCard.jsx, src/components/templates/index.js</files>
  <action>
**Add to marketplaceService.js:**

```javascript
// ============================================================================
// STARTER PACKS
// ============================================================================

/**
 * Fetch all active starter packs with their templates
 * @returns {Promise<Array>} Starter packs with embedded template arrays
 */
export async function fetchStarterPacks() {
  const { data, error } = await supabase.rpc('get_starter_packs');
  if (error) throw error;
  return (data || []).map(pack => ({
    ...pack,
    templates: pack.templates || [],
  }));
}
```

**Create StarterPackCard.jsx:**

Expandable card showing pack with inline template grid when expanded.

```jsx
import { useState } from 'react';
import PropTypes from 'prop-types';
import { motion, AnimatePresence } from 'framer-motion';
import { Package, ChevronDown, Check, Loader2 } from 'lucide-react';
import { TemplateCard } from './TemplateGrid';

export function StarterPackCard({
  pack,
  onApplySelected,
  isApplying = false,
}) {
  const [isExpanded, setIsExpanded] = useState(false);
  const [selectedIds, setSelectedIds] = useState(new Set());

  const handleToggleExpand = () => {
    setIsExpanded(!isExpanded);
    // Reset selection when collapsing
    if (isExpanded) {
      setSelectedIds(new Set());
    }
  };

  const handleToggleSelect = (templateId) => {
    setSelectedIds((prev) => {
      const next = new Set(prev);
      if (next.has(templateId)) {
        next.delete(templateId);
      } else {
        next.add(templateId);
      }
      return next;
    });
  };

  const handleSelectAll = () => {
    if (selectedIds.size === pack.templates.length) {
      setSelectedIds(new Set());
    } else {
      setSelectedIds(new Set(pack.templates.map(t => t.id)));
    }
  };

  const handleApply = () => {
    const selectedTemplates = pack.templates.filter(t => selectedIds.has(t.id));
    onApplySelected(pack, selectedTemplates);
  };

  return (
    <div className="border border-gray-200 rounded-lg overflow-hidden bg-white">
      {/* Pack Header - Clickable */}
      <button
        onClick={handleToggleExpand}
        className="w-full flex items-center gap-4 p-4 hover:bg-gray-50 transition-colors text-left"
      >
        {/* Pack Icon/Thumbnail */}
        <div className="w-16 h-16 flex-shrink-0 rounded-lg bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center">
          {pack.thumbnail_url ? (
            <img src={pack.thumbnail_url} alt="" className="w-full h-full object-cover rounded-lg" />
          ) : (
            <Package size={28} className="text-white" />
          )}
        </div>

        {/* Pack Info */}
        <div className="flex-1 min-w-0">
          <h3 className="font-semibold text-gray-900">{pack.name}</h3>
          <p className="text-sm text-gray-500 line-clamp-1">{pack.description}</p>
          <p className="text-xs text-gray-400 mt-1">{pack.template_count} templates</p>
        </div>

        {/* Expand Chevron */}
        <ChevronDown
          size={20}
          className={`text-gray-400 transition-transform ${isExpanded ? 'rotate-180' : ''}`}
        />
      </button>

      {/* Expanded Template Grid */}
      <AnimatePresence>
        {isExpanded && (
          <motion.div
            initial={{ height: 0, opacity: 0 }}
            animate={{ height: 'auto', opacity: 1 }}
            exit={{ height: 0, opacity: 0 }}
            transition={{ duration: 0.2 }}
            className="overflow-hidden"
          >
            <div className="border-t bg-gray-50 p-4">
              {/* Selection Controls */}
              <div className="flex items-center justify-between mb-4">
                <button
                  onClick={handleSelectAll}
                  className="text-sm text-blue-600 hover:text-blue-800"
                >
                  {selectedIds.size === pack.templates.length ? 'Deselect All' : 'Select All'}
                </button>
                <span className="text-sm text-gray-500">
                  {selectedIds.size} of {pack.templates.length} selected
                </span>
              </div>

              {/* Template Grid with Checkboxes */}
              <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3">
                {pack.templates.map((template) => (
                  <div key={template.id} className="relative">
                    {/* Checkbox Overlay */}
                    <button
                      onClick={() => handleToggleSelect(template.id)}
                      className={`absolute top-2 left-2 z-10 w-6 h-6 rounded-md border-2 flex items-center justify-center transition-colors ${
                        selectedIds.has(template.id)
                          ? 'bg-blue-600 border-blue-600 text-white'
                          : 'bg-white/80 border-gray-300 hover:border-blue-400'
                      }`}
                    >
                      {selectedIds.has(template.id) && <Check size={14} />}
                    </button>

                    {/* Template Card (compact, no Quick Apply) */}
                    <div
                      className={`cursor-pointer transition-opacity ${
                        selectedIds.has(template.id) ? 'ring-2 ring-blue-500 rounded-lg' : ''
                      }`}
                      onClick={() => handleToggleSelect(template.id)}
                    >
                      <div className="bg-white rounded-lg overflow-hidden border border-gray-200">
                        <div className="aspect-video bg-gray-100">
                          {template.thumbnail_url ? (
                            <img
                              src={template.thumbnail_url}
                              alt={template.name}
                              className="w-full h-full object-cover"
                            />
                          ) : (
                            <div className="w-full h-full flex items-center justify-center text-gray-300">
                              <Package size={24} />
                            </div>
                          )}
                        </div>
                        <div className="p-2">
                          <p className="text-sm font-medium text-gray-900 truncate">{template.name}</p>
                        </div>
                      </div>
                    </div>
                  </div>
                ))}
              </div>

              {/* Apply Button */}
              <div className="mt-4 flex justify-end">
                <button
                  onClick={handleApply}
                  disabled={selectedIds.size === 0 || isApplying}
                  className="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
                >
                  {isApplying ? (
                    <>
                      <Loader2 size={16} className="animate-spin" />
                      Applying...
                    </>
                  ) : (
                    <>
                      Apply Selected ({selectedIds.size})
                    </>
                  )}
                </button>
              </div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}

StarterPackCard.propTypes = {
  pack: PropTypes.shape({
    id: PropTypes.string.isRequired,
    name: PropTypes.string.isRequired,
    description: PropTypes.string,
    thumbnail_url: PropTypes.string,
    template_count: PropTypes.number,
    templates: PropTypes.arrayOf(
      PropTypes.shape({
        id: PropTypes.string.isRequired,
        name: PropTypes.string.isRequired,
        thumbnail_url: PropTypes.string,
      })
    ),
  }).isRequired,
  onApplySelected: PropTypes.func.isRequired,
  isApplying: PropTypes.bool,
};

export default StarterPackCard;
```

**Create StarterPacksRow.jsx:**

```jsx
import PropTypes from 'prop-types';
import { StarterPackCard } from './StarterPackCard';

export function StarterPacksRow({
  packs = [],
  onApplySelected,
  applyingPackId = null,
}) {
  if (packs.length === 0) return null;

  return (
    <section className="mb-8">
      <h2 className="text-lg font-semibold text-gray-900 mb-4">Starter Packs</h2>
      <div className="space-y-4">
        {packs.map((pack) => (
          <StarterPackCard
            key={pack.id}
            pack={pack}
            onApplySelected={onApplySelected}
            isApplying={applyingPackId === pack.id}
          />
        ))}
      </div>
    </section>
  );
}

StarterPacksRow.propTypes = {
  packs: PropTypes.arrayOf(
    PropTypes.shape({
      id: PropTypes.string.isRequired,
      name: PropTypes.string.isRequired,
    })
  ),
  onApplySelected: PropTypes.func.isRequired,
  applyingPackId: PropTypes.string,
};

export default StarterPacksRow;
```

**Update index.js:**
```jsx
export { StarterPacksRow } from './StarterPacksRow';
export { StarterPackCard } from './StarterPackCard';
```
  </action>
  <verify>
Components render without errors
Pack card expands/collapses with animation
Checkbox selection works
  </verify>
  <done>
Service function and UI components created for starter packs
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate starter packs into marketplace page</name>
  <files>src/pages/TemplateMarketplacePage.jsx</files>
  <action>
**Update TemplateMarketplacePage.jsx:**

1. Import new components and service:
```jsx
import {
  // ... existing imports ...
  fetchStarterPacks,
} from '../services/marketplaceService';

import {
  TemplateSidebar,
  FeaturedTemplatesRow,
  TemplateGrid,
  TemplatePreviewPanel,
  StarterPacksRow,
} from '../components/templates';
```

2. Add state for starter packs:
```jsx
const [starterPacks, setStarterPacks] = useState([]);
const [applyingPackId, setApplyingPackId] = useState(null);
```

3. Load starter packs on mount:
```jsx
// Load starter packs
useEffect(() => {
  fetchStarterPacks()
    .then(setStarterPacks)
    .catch(err => console.error('Failed to load starter packs:', err));
}, []);
```

4. Add handler for applying selected templates from pack:
```jsx
const handleApplyPackTemplates = async (pack, selectedTemplates) => {
  if (selectedTemplates.length === 0) return;

  setApplyingPackId(pack.id);
  try {
    // Apply templates sequentially (could be parallel but keep simple)
    let lastSceneId = null;
    for (const template of selectedTemplates) {
      const sceneName = `${template.name} - ${format(new Date(), 'MMM d, yyyy')}`;
      lastSceneId = await installTemplateAsScene(template.id, sceneName);
    }
    // Navigate to the last created scene (or show success message)
    if (lastSceneId) {
      navigate(`/scene-editor/${lastSceneId}`);
    }
  } catch (error) {
    console.error('Failed to apply pack templates:', error);
  } finally {
    setApplyingPackId(null);
  }
};
```

5. Add StarterPacksRow above FeaturedTemplatesRow (only when no filters active):
```jsx
{/* Content when not loading */}
{!loading && (
  <>
    {/* Starter Packs Row (only when no filters active) */}
    {!hasActiveFilters && starterPacks.length > 0 && (
      <StarterPacksRow
        packs={starterPacks}
        onApplySelected={handleApplyPackTemplates}
        applyingPackId={applyingPackId}
      />
    )}

    {/* Featured Templates Row (only when no filters active) */}
    {!hasActiveFilters && featuredTemplates.length > 0 && (
      <FeaturedTemplatesRow
        templates={featuredTemplates}
        onTemplateClick={handleTemplateClick}
        onQuickApply={handleQuickApply}
        applyingId={applyingId}
      />
    )}

    {/* Template Grid */}
    {/* ... existing grid code ... */}
  </>
)}
```
  </action>
  <verify>
Starter Packs row appears above Featured Templates
Expanding pack shows template grid
Selecting templates and clicking Apply creates scenes
Navigation to editor works after apply
Packs row hidden when filters active
  </verify>
  <done>
Starter packs fully integrated into marketplace page
  </done>
</task>

</tasks>

<verification>
1. Starter packs row appears at top of marketplace (above Featured)
2. Clicking pack expands to show contained templates
3. Checkboxes allow multi-select
4. "Apply Selected" creates scenes for all selected templates
5. Pack row hidden when search/filters active
6. Expansion animation is smooth
7. Selection count updates correctly
</verification>

<success_criteria>
- [ ] starter_packs table created with RLS
- [ ] starter_pack_templates junction table created
- [ ] get_starter_packs RPC returns packs with templates
- [ ] fetchStarterPacks service function works
- [ ] StarterPackCard expands/collapses with animation
- [ ] Template selection with checkboxes works
- [ ] Apply Selected creates multiple scenes
- [ ] StarterPacksRow appears above Featured row
- [ ] Row hidden when filters active
</success_criteria>

<output>
After completion, create `.planning/phases/18-templates-discovery/18-03-SUMMARY.md`
</output>
