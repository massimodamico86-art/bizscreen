---
phase: 18-templates-discovery
plan: 02
type: execute
wave: 2
depends_on: ["18-01"]
files_modified:
  - src/components/templates/SidebarRecentsSection.jsx
  - src/components/templates/SidebarFavoritesSection.jsx
  - src/components/templates/TemplateSidebar.jsx
  - src/components/templates/index.js
  - src/pages/TemplateMarketplacePage.jsx
autonomous: true

must_haves:
  truths:
    - "User can see recently used templates in sidebar section"
    - "User can see favorited templates in sidebar section"
    - "Clicking template in sidebar opens preview or triggers Quick Apply"
    - "Sections collapse/expand with animation"
    - "Empty sections are hidden or show helpful message"
  artifacts:
    - path: "src/components/templates/SidebarRecentsSection.jsx"
      provides: "Collapsible recent templates section"
      min_lines: 40
    - path: "src/components/templates/SidebarFavoritesSection.jsx"
      provides: "Collapsible favorites section"
      min_lines: 40
    - path: "src/components/templates/TemplateSidebar.jsx"
      provides: "Updated sidebar with Recents and Favorites sections"
      min_lines: 100
  key_links:
    - from: "src/pages/TemplateMarketplacePage.jsx"
      to: "marketplaceService"
      via: "useEffect fetching favorites/recents"
      pattern: "fetch(RecentMarketplace|MarketplaceFavorite)"
    - from: "src/components/templates/TemplateSidebar.jsx"
      to: "SidebarRecentsSection"
      via: "component composition"
      pattern: "SidebarRecentsSection"
---

<objective>
Sidebar sections for recent and favorite marketplace templates.

Purpose: Allow users to quickly access their recently used and favorited templates from the sidebar without scrolling through the full grid.
Output: Two new sidebar section components, updated TemplateSidebar, wired marketplace page
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-templates-discovery/18-CONTEXT.md
@.planning/phases/18-templates-discovery/18-RESEARCH.md
@.planning/phases/18-templates-discovery/18-01-SUMMARY.md
@src/components/templates/TemplateSidebar.jsx
@src/pages/TemplateMarketplacePage.jsx
@src/services/marketplaceService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SidebarRecentsSection and SidebarFavoritesSection components</name>
  <files>src/components/templates/SidebarRecentsSection.jsx, src/components/templates/SidebarFavoritesSection.jsx</files>
  <action>
**Create SidebarRecentsSection.jsx:**

Compact collapsible section showing recently used templates.

```jsx
import { useState } from 'react';
import PropTypes from 'prop-types';
import { motion, AnimatePresence } from 'framer-motion';
import { Clock, ChevronDown, Layout } from 'lucide-react';

export function SidebarRecentsSection({
  templates = [],
  maxItems = 5,
  onTemplateClick,
}) {
  const [expanded, setExpanded] = useState(true);

  // Don't render if no recent templates
  if (templates.length === 0) return null;

  const displayedTemplates = templates.slice(0, maxItems);

  return (
    <div className="border-b border-gray-200 pb-4 mb-4">
      {/* Section Header */}
      <button
        onClick={() => setExpanded(!expanded)}
        className="flex items-center justify-between w-full px-3 py-2 text-left"
      >
        <span className="flex items-center gap-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">
          <Clock size={14} />
          Recent
        </span>
        <ChevronDown
          size={16}
          className={`text-gray-400 transition-transform ${expanded ? 'rotate-180' : ''}`}
        />
      </button>

      {/* Collapsible Content */}
      <AnimatePresence initial={false}>
        {expanded && (
          <motion.div
            initial={{ height: 0, opacity: 0 }}
            animate={{ height: 'auto', opacity: 1 }}
            exit={{ height: 0, opacity: 0 }}
            transition={{ duration: 0.2 }}
            className="overflow-hidden"
          >
            <div className="space-y-1 px-2">
              {displayedTemplates.map((template) => (
                <button
                  key={template.id}
                  onClick={() => onTemplateClick(template)}
                  className="w-full flex items-center gap-2 p-2 rounded-md hover:bg-gray-50 text-left group transition-colors"
                >
                  {/* Thumbnail */}
                  <div className="w-10 h-6 flex-shrink-0 rounded overflow-hidden bg-gray-100">
                    {template.thumbnail_url ? (
                      <img
                        src={template.thumbnail_url}
                        alt=""
                        className="w-full h-full object-cover"
                      />
                    ) : (
                      <div className="w-full h-full flex items-center justify-center">
                        <Layout size={12} className="text-gray-300" />
                      </div>
                    )}
                  </div>
                  {/* Name */}
                  <span className="text-sm text-gray-700 truncate group-hover:text-gray-900">
                    {template.name}
                  </span>
                </button>
              ))}
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}

SidebarRecentsSection.propTypes = {
  templates: PropTypes.arrayOf(
    PropTypes.shape({
      id: PropTypes.string.isRequired,
      name: PropTypes.string.isRequired,
      thumbnail_url: PropTypes.string,
    })
  ),
  maxItems: PropTypes.number,
  onTemplateClick: PropTypes.func.isRequired,
};

export default SidebarRecentsSection;
```

**Create SidebarFavoritesSection.jsx:**

Same pattern but with Heart icon and "Favorites" label:

```jsx
import { useState } from 'react';
import PropTypes from 'prop-types';
import { motion, AnimatePresence } from 'framer-motion';
import { Heart, ChevronDown, Layout } from 'lucide-react';

export function SidebarFavoritesSection({
  templates = [],
  maxItems = 5,
  onTemplateClick,
}) {
  const [expanded, setExpanded] = useState(true);

  // Don't render if no favorites
  if (templates.length === 0) return null;

  const displayedTemplates = templates.slice(0, maxItems);

  return (
    <div className="border-b border-gray-200 pb-4 mb-4">
      {/* Section Header */}
      <button
        onClick={() => setExpanded(!expanded)}
        className="flex items-center justify-between w-full px-3 py-2 text-left"
      >
        <span className="flex items-center gap-2 text-xs font-semibold text-gray-500 uppercase tracking-wider">
          <Heart size={14} />
          Favorites
        </span>
        <ChevronDown
          size={16}
          className={`text-gray-400 transition-transform ${expanded ? 'rotate-180' : ''}`}
        />
      </button>

      {/* Collapsible Content */}
      <AnimatePresence initial={false}>
        {expanded && (
          <motion.div
            initial={{ height: 0, opacity: 0 }}
            animate={{ height: 'auto', opacity: 1 }}
            exit={{ height: 0, opacity: 0 }}
            transition={{ duration: 0.2 }}
            className="overflow-hidden"
          >
            <div className="space-y-1 px-2">
              {displayedTemplates.map((template) => (
                <button
                  key={template.id}
                  onClick={() => onTemplateClick(template)}
                  className="w-full flex items-center gap-2 p-2 rounded-md hover:bg-gray-50 text-left group transition-colors"
                >
                  {/* Thumbnail */}
                  <div className="w-10 h-6 flex-shrink-0 rounded overflow-hidden bg-gray-100">
                    {template.thumbnail_url ? (
                      <img
                        src={template.thumbnail_url}
                        alt=""
                        className="w-full h-full object-cover"
                      />
                    ) : (
                      <div className="w-full h-full flex items-center justify-center">
                        <Layout size={12} className="text-gray-300" />
                      </div>
                    )}
                  </div>
                  {/* Name */}
                  <span className="text-sm text-gray-700 truncate group-hover:text-gray-900">
                    {template.name}
                  </span>
                </button>
              ))}
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}

SidebarFavoritesSection.propTypes = {
  templates: PropTypes.arrayOf(
    PropTypes.shape({
      id: PropTypes.string.isRequired,
      name: PropTypes.string.isRequired,
      thumbnail_url: PropTypes.string,
    })
  ),
  maxItems: PropTypes.number,
  onTemplateClick: PropTypes.func.isRequired,
};

export default SidebarFavoritesSection;
```
  </action>
  <verify>
Files created with correct structure
Components render without errors when imported
Animation works on expand/collapse
  </verify>
  <done>
Both section components created with collapsible animation and compact template list
  </done>
</task>

<task type="auto">
  <name>Task 2: Update TemplateSidebar to include Recents and Favorites sections</name>
  <files>src/components/templates/TemplateSidebar.jsx, src/components/templates/index.js</files>
  <action>
**Update TemplateSidebar.jsx:**

1. Add new props:
   - recentTemplates (array)
   - favoriteTemplates (array)
   - onSidebarTemplateClick (function)

2. Import the new section components

3. Add sections at the top of the sidebar (before Categories):
```jsx
{/* Recents Section */}
<SidebarRecentsSection
  templates={recentTemplates}
  onTemplateClick={onSidebarTemplateClick}
/>

{/* Favorites Section */}
<SidebarFavoritesSection
  templates={favoriteTemplates}
  onTemplateClick={onSidebarTemplateClick}
/>

{/* Categories Section (existing) */}
<div className="space-y-1">
  <h4 className="text-xs font-semibold text-gray-500 uppercase tracking-wider px-3 mb-2">
    Categories
  </h4>
  {/* ... existing category buttons ... */}
</div>
```

4. Update PropTypes to include new props:
```jsx
TemplateSidebar.propTypes = {
  categories: PropTypes.arrayOf(...),
  selectedCategory: PropTypes.string,
  selectedOrientation: PropTypes.oneOf(['landscape', 'portrait', null]),
  onFilterChange: PropTypes.func.isRequired,
  recentTemplates: PropTypes.array,
  favoriteTemplates: PropTypes.array,
  onSidebarTemplateClick: PropTypes.func,
};
```

5. Default props for backwards compatibility:
```jsx
TemplateSidebar.defaultProps = {
  recentTemplates: [],
  favoriteTemplates: [],
  onSidebarTemplateClick: () => {},
};
```

**Update index.js:**
Add exports for new components:
```jsx
export { SidebarRecentsSection } from './SidebarRecentsSection';
export { SidebarFavoritesSection } from './SidebarFavoritesSection';
```
  </action>
  <verify>
TemplateSidebar renders with sections when provided data
Sections hidden when arrays are empty
No PropType warnings
  </verify>
  <done>
TemplateSidebar includes Recents and Favorites sections at top, maintains backward compatibility
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire sidebar sections to marketplace page</name>
  <files>src/pages/TemplateMarketplacePage.jsx</files>
  <action>
**Update TemplateMarketplacePage.jsx:**

1. Import new service functions:
```jsx
import {
  fetchMarketplaceTemplates,
  fetchFeaturedTemplates,
  fetchCategories,
  installTemplateAsScene,
  fetchMarketplaceFavorites,
  fetchRecentMarketplaceTemplates,
  toggleMarketplaceFavorite,
  checkFavoritedTemplates,
} from '../services/marketplaceService';
```

2. Add state for recents, favorites, and favorited IDs:
```jsx
const [recentTemplates, setRecentTemplates] = useState([]);
const [favoriteTemplates, setFavoriteTemplates] = useState([]);
const [favoritedIds, setFavoritedIds] = useState(new Set());
```

3. Add useEffect to load recents and favorites on mount:
```jsx
// Load recents and favorites
useEffect(() => {
  fetchRecentMarketplaceTemplates(5)
    .then(setRecentTemplates)
    .catch(err => console.error('Failed to load recent templates:', err));

  fetchMarketplaceFavorites(10)
    .then((favorites) => {
      setFavoriteTemplates(favorites);
      setFavoritedIds(new Set(favorites.map(f => f.id)));
    })
    .catch(err => console.error('Failed to load favorites:', err));
}, []);
```

4. Also check favorited status for grid templates when templates load:
```jsx
// After loading templates, check which are favorited
useEffect(() => {
  if (templates.length > 0) {
    checkFavoritedTemplates(templates.map(t => t.id))
      .then(setFavoritedIds)
      .catch(err => console.error('Failed to check favorites:', err));
  }
}, [templates]);
```

5. Add favorite toggle handler:
```jsx
const handleToggleFavorite = async (templateId, shouldBeFavorited) => {
  // Optimistic update
  setFavoritedIds((prev) => {
    const next = new Set(prev);
    if (shouldBeFavorited) {
      next.add(templateId);
    } else {
      next.delete(templateId);
    }
    return next;
  });

  try {
    const isFavorited = await toggleMarketplaceFavorite(templateId);
    // Refresh favorites list
    const favorites = await fetchMarketplaceFavorites(10);
    setFavoriteTemplates(favorites);
    setFavoritedIds(new Set(favorites.map(f => f.id)));
  } catch (error) {
    console.error('Failed to toggle favorite:', error);
    // Revert optimistic update
    setFavoritedIds((prev) => {
      const next = new Set(prev);
      if (shouldBeFavorited) {
        next.delete(templateId);
      } else {
        next.add(templateId);
      }
      return next;
    });
  }
};
```

6. Update TemplateSidebar props:
```jsx
<TemplateSidebar
  categories={categories}
  selectedCategory={categoryId || null}
  selectedOrientation={orientation || null}
  onFilterChange={updateFilters}
  recentTemplates={recentTemplates}
  favoriteTemplates={favoriteTemplates}
  onSidebarTemplateClick={handleTemplateClick}
/>
```

7. Update TemplateGrid and FeaturedTemplatesRow props:
```jsx
<FeaturedTemplatesRow
  templates={featuredTemplates}
  onTemplateClick={handleTemplateClick}
  onQuickApply={handleQuickApply}
  applyingId={applyingId}
  favoriteIds={favoritedIds}
  onToggleFavorite={handleToggleFavorite}
/>

<TemplateGrid
  templates={templates}
  onTemplateClick={handleTemplateClick}
  onQuickApply={handleQuickApply}
  applyingId={applyingId}
  favoriteIds={favoritedIds}
  onToggleFavorite={handleToggleFavorite}
/>
```

8. Refresh recents after successful Quick Apply:
In handleQuickApply, after navigate, refresh isn't needed since user leaves page.
But for panel apply, add refresh after handleApplySuccess:
```jsx
const handleApplySuccess = async (sceneId) => {
  setSelectedTemplate(null);
  // Refresh recents (will show on next visit)
  fetchRecentMarketplaceTemplates(5).then(setRecentTemplates);
  navigate(`/scene-editor/${sceneId}`);
};
```
  </action>
  <verify>
Page loads with Recent and Favorites sections in sidebar
Heart icons reflect favorited state
Clicking heart toggles favorite and updates sidebar
Applying template updates recents on next load
  </verify>
  <done>
Marketplace page fully wired with favorites/recents state, sidebar shows sections, grid shows heart icons
  </done>
</task>

</tasks>

<verification>
1. Sidebar shows "Recent" section when user has recent templates
2. Sidebar shows "Favorites" section when user has favorites
3. Clicking template in sidebar opens preview panel
4. Sections collapse/expand with smooth animation
5. Empty sections are hidden
6. Heart icons in grid sync with sidebar favorites
7. Favoriting/unfavoriting updates both grid and sidebar
</verification>

<success_criteria>
- [ ] SidebarRecentsSection component created and exported
- [ ] SidebarFavoritesSection component created and exported
- [ ] TemplateSidebar includes both sections
- [ ] Sections hidden when empty
- [ ] Collapse/expand animation works
- [ ] TemplateMarketplacePage fetches and passes data
- [ ] Favoriting from grid updates sidebar
- [ ] Clicking sidebar template opens preview
</success_criteria>

<output>
After completion, create `.planning/phases/18-templates-discovery/18-02-SUMMARY.md`
</output>
