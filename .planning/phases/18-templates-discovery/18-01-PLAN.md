---
phase: 18-templates-discovery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/129_marketplace_favorites_history.sql
  - src/services/marketplaceService.js
  - src/components/templates/TemplateCard.jsx
  - src/components/templates/TemplateGrid.jsx
  - src/components/templates/index.js
autonomous: true

must_haves:
  truths:
    - "User can favorite a marketplace template by clicking heart icon"
    - "Heart icon fills red when template is favorited"
    - "Favoriting persists across page refresh"
    - "Recent templates are recorded when user applies a template"
  artifacts:
    - path: "supabase/migrations/129_marketplace_favorites_history.sql"
      provides: "Database tables and RPCs for marketplace favorites/history"
      contains: "marketplace_template_favorites"
    - path: "src/services/marketplaceService.js"
      provides: "Frontend service functions for favorites/history"
      exports: ["toggleMarketplaceFavorite", "fetchMarketplaceFavorites", "fetchRecentMarketplaceTemplates", "recordMarketplaceUsage"]
    - path: "src/components/templates/TemplateCard.jsx"
      provides: "Template card with favorite heart icon"
      min_lines: 80
  key_links:
    - from: "src/components/templates/TemplateCard.jsx"
      to: "marketplaceService"
      via: "onToggleFavorite prop callback"
      pattern: "onToggleFavorite"
    - from: "src/services/marketplaceService.js"
      to: "supabase.rpc"
      via: "RPC calls for favorites/history"
      pattern: "supabase\\.rpc\\('(toggle|get)_marketplace"
---

<objective>
Database and service layer for marketplace template favorites and usage history.

Purpose: Enable tracking which marketplace templates users have favorited and recently used. This data powers the sidebar sections in Plan 02.
Output: Migration file with tables/RPCs, extended marketplaceService.js, TemplateCard with heart icon
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-templates-discovery/18-CONTEXT.md
@.planning/phases/18-templates-discovery/18-RESEARCH.md
@src/services/marketplaceService.js
@src/components/templates/TemplateGrid.jsx
@supabase/migrations/080_template_marketplace.sql
@supabase/migrations/112_template_favorites_history.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create marketplace favorites and history database tables</name>
  <files>supabase/migrations/129_marketplace_favorites_history.sql</files>
  <action>
Create migration with:

1. **marketplace_template_favorites table:**
   - id (uuid, PK)
   - user_id (uuid, FK to profiles, ON DELETE CASCADE)
   - template_id (uuid, FK to template_library, ON DELETE CASCADE)
   - created_at (timestamptz)
   - UNIQUE constraint on (user_id, template_id)
   - Indexes on user_id and template_id
   - RLS enabled: users can only view/insert/delete their own favorites

2. **marketplace_template_history table:**
   - id (uuid, PK)
   - user_id (uuid, FK to profiles, ON DELETE CASCADE)
   - template_id (uuid, FK to template_library, ON DELETE CASCADE)
   - applied_at (timestamptz, default now())
   - Index on (user_id, applied_at DESC) for efficient recent queries
   - RLS enabled: users can only view/insert their own history

3. **RPC: toggle_marketplace_favorite(p_template_id uuid)**
   - SECURITY DEFINER
   - If favorite exists, delete it and return false
   - If favorite doesn't exist, insert it and return true
   - Handles unique constraint gracefully

4. **RPC: get_marketplace_favorites(p_limit int DEFAULT 10)**
   - Returns template_library rows joined with favorite metadata
   - Ordered by favorited_at DESC
   - Returns full template data (id, name, thumbnail_url, etc.)

5. **RPC: get_recent_marketplace_templates(p_limit int DEFAULT 5)**
   - Returns distinct template_library rows from history
   - Deduplicated by template_id, most recent first
   - Returns full template data

Note: These tables are for template_library (marketplace), NOT content_templates (existing system).
  </action>
  <verify>
Run: `npx supabase db push --local` (or appropriate migration command)
Check tables exist: marketplace_template_favorites, marketplace_template_history
Check RPCs exist: toggle_marketplace_favorite, get_marketplace_favorites, get_recent_marketplace_templates
  </verify>
  <done>
Database tables and RPCs created, migration runs without error
  </done>
</task>

<task type="auto">
  <name>Task 2: Extend marketplaceService with favorites and history functions</name>
  <files>src/services/marketplaceService.js</files>
  <action>
Add new section to marketplaceService.js after existing functions:

```javascript
// ============================================================================
// FAVORITES AND HISTORY
// ============================================================================

/**
 * Toggle favorite status for a marketplace template
 * @param {string} templateId - Template UUID
 * @returns {Promise<boolean>} New favorite status (true = favorited, false = unfavorited)
 */
export async function toggleMarketplaceFavorite(templateId) {
  const { data, error } = await supabase.rpc('toggle_marketplace_favorite', {
    p_template_id: templateId,
  });
  if (error) throw error;
  return data;
}

/**
 * Fetch user's favorite marketplace templates
 * @param {number} [limit=10] - Max results
 * @returns {Promise<Array>} Favorited templates
 */
export async function fetchMarketplaceFavorites(limit = 10) {
  const { data, error } = await supabase.rpc('get_marketplace_favorites', {
    p_limit: limit,
  });
  if (error) throw error;
  return data || [];
}

/**
 * Fetch user's recently used marketplace templates
 * @param {number} [limit=5] - Max results
 * @returns {Promise<Array>} Recent templates (deduplicated)
 */
export async function fetchRecentMarketplaceTemplates(limit = 5) {
  const { data, error } = await supabase.rpc('get_recent_marketplace_templates', {
    p_limit: limit,
  });
  if (error) throw error;
  return data || [];
}

/**
 * Record template usage in history
 * @param {string} templateId - Template UUID
 */
export async function recordMarketplaceUsage(templateId) {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return; // Silently fail for anonymous

  const { error } = await supabase
    .from('marketplace_template_history')
    .insert({ user_id: user.id, template_id: templateId });

  if (error) {
    console.error('Failed to record template usage:', error);
    // Don't throw - this is non-critical
  }
}

/**
 * Check if templates are favorited (batch check)
 * @param {string[]} templateIds - Array of template UUIDs
 * @returns {Promise<Set<string>>} Set of favorited template IDs
 */
export async function checkFavoritedTemplates(templateIds) {
  if (!templateIds.length) return new Set();

  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return new Set();

  const { data, error } = await supabase
    .from('marketplace_template_favorites')
    .select('template_id')
    .eq('user_id', user.id)
    .in('template_id', templateIds);

  if (error) throw error;
  return new Set((data || []).map(f => f.template_id));
}
```

Also update installTemplateAsScene to record usage:
- After successful clone, call recordMarketplaceUsage(templateId)
- This ensures recents are updated on Quick Apply
  </action>
  <verify>
Check that marketplaceService.js exports:
- toggleMarketplaceFavorite
- fetchMarketplaceFavorites
- fetchRecentMarketplaceTemplates
- recordMarketplaceUsage
- checkFavoritedTemplates

Verify no TypeScript/ESLint errors
  </verify>
  <done>
Service functions exported and callable, installTemplateAsScene records usage
  </done>
</task>

<task type="auto">
  <name>Task 3: Add favorite heart icon to TemplateCard</name>
  <files>src/components/templates/TemplateCard.jsx, src/components/templates/TemplateGrid.jsx, src/components/templates/index.js</files>
  <action>
**Update TemplateCard in TemplateGrid.jsx:**

1. Add Heart icon import from lucide-react

2. Add props to TemplateCard:
   - isFavorited (boolean, default false)
   - onToggleFavorite (function, optional)

3. Add heart button in top-right corner of card:
```jsx
{/* Heart icon - always visible in corner */}
{onToggleFavorite && (
  <button
    onClick={handleFavoriteClick}
    className="absolute top-2 right-2 z-10 p-1.5 rounded-full bg-white/80 hover:bg-white shadow-sm transition-colors"
    aria-label={isFavorited ? 'Remove from favorites' : 'Add to favorites'}
  >
    <Heart
      size={18}
      className={isFavorited ? 'fill-red-500 text-red-500' : 'text-gray-400 hover:text-gray-600'}
    />
  </button>
)}
```

4. Add click handler that stops propagation:
```jsx
const handleFavoriteClick = (e) => {
  e.stopPropagation();
  if (onToggleFavorite) {
    onToggleFavorite(template.id, !isFavorited);
  }
};
```

**Update TemplateGrid:**
- Add favoriteIds prop (Set of template IDs that are favorited)
- Add onToggleFavorite prop (callback)
- Pass isFavorited={favoriteIds?.has(template.id)} to each TemplateCard
- Pass onToggleFavorite to each TemplateCard

**Update PropTypes:**
- TemplateCard: Add isFavorited (bool), onToggleFavorite (func)
- TemplateGrid: Add favoriteIds (instanceOf Set), onToggleFavorite (func)

**Update index.js exports if needed**
  </action>
  <verify>
Visual check: Heart icon appears on TemplateCard
Click heart: Should toggle fill color
Check PropTypes: No console warnings
  </verify>
  <done>
TemplateCard has heart icon, clicking toggles visual state, parent receives callback
  </done>
</task>

</tasks>

<verification>
1. Database migration runs without errors
2. New tables visible in Supabase dashboard
3. RPCs callable from service layer
4. Heart icon renders on template cards
5. Clicking heart triggers callback with correct parameters
6. No console errors or PropType warnings
</verification>

<success_criteria>
- [ ] marketplace_template_favorites table exists with RLS
- [ ] marketplace_template_history table exists with RLS
- [ ] toggle_marketplace_favorite RPC works correctly
- [ ] get_marketplace_favorites RPC returns template data
- [ ] get_recent_marketplace_templates RPC returns deduplicated history
- [ ] marketplaceService exports all new functions
- [ ] installTemplateAsScene records usage
- [ ] TemplateCard shows heart icon with toggle behavior
- [ ] TemplateGrid passes favorite state to cards
</success_criteria>

<output>
After completion, create `.planning/phases/18-templates-discovery/18-01-SUMMARY.md`
</output>
