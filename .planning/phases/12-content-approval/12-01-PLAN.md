---
phase: 12-content-approval
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/122_scenes_approval_columns.sql
  - src/services/approvalService.js
  - src/services/permissionsService.js
autonomous: true

must_haves:
  truths:
    - "Scenes table has same approval columns as playlists"
    - "approvalService supports 'scene' resource type"
    - "requiresApproval() returns true for editors/viewers, false for owners/managers"
  artifacts:
    - path: "supabase/migrations/122_scenes_approval_columns.sql"
      provides: "Approval columns on scenes table"
      contains: "ALTER TABLE scenes"
    - path: "src/services/approvalService.js"
      provides: "Scene support in RESOURCE_TYPES and getTableName"
      contains: "scene: 'scenes'"
    - path: "src/services/permissionsService.js"
      provides: "requiresApproval helper function"
      exports: ["requiresApproval"]
  key_links:
    - from: "src/services/approvalService.js"
      to: "supabase scenes table"
      via: "getTableName('scene') returns 'scenes'"
      pattern: "scene.*scenes"
---

<objective>
Add approval infrastructure for scenes and role-based approval detection.

Purpose: Scenes need approval columns (like playlists/layouts) and the system needs to know when a user requires approval based on their role (editors/viewers need it, owners/managers don't).

Output: Migration for scenes table, extended approvalService supporting scenes, and requiresApproval() helper in permissionsService.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-content-approval/12-RESEARCH.md

# Existing infrastructure patterns
@src/services/approvalService.js
@src/services/permissionsService.js
@supabase/migrations/027_content_approvals_and_previews.sql
@supabase/migrations/067_create_scenes_and_onboarding.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create migration for scenes approval columns</name>
  <files>supabase/migrations/122_scenes_approval_columns.sql</files>
  <action>
Create migration 122 adding approval columns to scenes table, matching the pattern from migration 027:

```sql
-- Migration 122: Add approval columns to scenes table
-- Extends content approval system to include scenes

-- Add approval columns to scenes (matching playlists/layouts/campaigns pattern)
ALTER TABLE scenes
ADD COLUMN IF NOT EXISTS approval_status TEXT NOT NULL DEFAULT 'draft'
  CHECK (approval_status IN ('draft', 'in_review', 'approved', 'rejected')),
ADD COLUMN IF NOT EXISTS approval_requested_by UUID REFERENCES profiles(id) ON DELETE SET NULL,
ADD COLUMN IF NOT EXISTS approval_decided_by UUID REFERENCES profiles(id) ON DELETE SET NULL,
ADD COLUMN IF NOT EXISTS approval_requested_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS approval_decided_at TIMESTAMPTZ,
ADD COLUMN IF NOT EXISTS approval_comment TEXT;

-- Create index for approval queries
CREATE INDEX IF NOT EXISTS idx_scenes_approval_status ON scenes(tenant_id, approval_status);

-- Update review_requests resource_type check to include 'scene'
ALTER TABLE review_requests
DROP CONSTRAINT IF EXISTS review_requests_resource_type_check;

ALTER TABLE review_requests
ADD CONSTRAINT review_requests_resource_type_check
CHECK (resource_type IN ('playlist', 'layout', 'campaign', 'scene'));

-- Update preview_links resource_type check to include 'scene'
ALTER TABLE preview_links
DROP CONSTRAINT IF EXISTS preview_links_resource_type_check;

ALTER TABLE preview_links
ADD CONSTRAINT preview_links_resource_type_check
CHECK (resource_type IN ('playlist', 'layout', 'campaign', 'scene'));
```

Include DO block at end for migration completion notice.
  </action>
  <verify>File exists with ALTER TABLE scenes and CHECK constraints including 'scene'</verify>
  <done>scenes table has approval columns matching playlists/layouts/campaigns pattern</done>
</task>

<task type="auto">
  <name>Task 2: Extend approvalService to support scenes</name>
  <files>src/services/approvalService.js</files>
  <action>
Update approvalService.js:

1. Add 'SCENE' to RESOURCE_TYPES constant:
```javascript
export const RESOURCE_TYPES = {
  PLAYLIST: 'playlist',
  LAYOUT: 'layout',
  CAMPAIGN: 'campaign',
  SCENE: 'scene'
};
```

2. Update getTableName function to include scene mapping:
```javascript
function getTableName(resourceType) {
  const tableMap = {
    playlist: 'playlists',
    layout: 'layouts',
    campaign: 'campaigns',
    scene: 'scenes'
  };
  return tableMap[resourceType];
}
```

3. Update v_review_requests_with_details query in fetchOpenReviews and fetchReviews (if they query directly instead of using the view) to include scene name lookup. Check if view is used - if so, view update happens in database migration, not here.

Note: The existing functions (requestApproval, approveReview, rejectReview, etc.) use getTableName dynamically, so they will automatically work with scenes once getTableName is updated.
  </action>
  <verify>grep for "scene: 'scenes'" and "SCENE: 'scene'" in approvalService.js</verify>
  <done>approvalService supports scenes resource type alongside playlists/layouts/campaigns</done>
</task>

<task type="auto">
  <name>Task 3: Add requiresApproval helper to permissionsService</name>
  <files>src/services/permissionsService.js</files>
  <action>
Add requiresApproval function to permissionsService.js:

```javascript
/**
 * Check if the current user requires content approval before publishing
 * Editors and viewers require approval; owners and managers can publish directly
 * @returns {Promise<boolean>} True if user needs approval, false if can publish directly
 */
export async function requiresApproval() {
  // Super admins and admins never need approval
  const profileRole = await getProfileRole();
  if (profileRole === 'super_admin' || profileRole === 'admin') return false;

  const memberRole = await getCurrentMemberRole();
  // Owners and managers can publish directly
  if (['owner', 'manager'].includes(memberRole)) return false;
  // Editors and viewers require approval
  // Also require approval if no role (not a member)
  return true;
}

/**
 * Check if the current user can approve/reject content
 * Only owners and managers can approve
 * @returns {Promise<boolean>}
 */
export async function canApproveContent() {
  // Super admins and admins can always approve
  const profileRole = await getProfileRole();
  if (profileRole === 'super_admin' || profileRole === 'admin') return true;

  return isAtLeastManager();
}
```

Add both to the default export object:
```javascript
export default {
  // ... existing exports
  requiresApproval,
  canApproveContent,
};
```
  </action>
  <verify>grep for "requiresApproval" and "canApproveContent" in permissionsService.js shows both functions exist and are exported</verify>
  <done>permissionsService exports requiresApproval() and canApproveContent() helpers</done>
</task>

</tasks>

<verification>
1. Migration file 122 exists with correct ALTER TABLE statements
2. approvalService.js RESOURCE_TYPES includes SCENE
3. approvalService.js getTableName maps 'scene' to 'scenes'
4. permissionsService.js exports requiresApproval and canApproveContent
</verification>

<success_criteria>
- Migration 122 created with scenes approval columns
- approvalService supports 'scene' resource type
- requiresApproval() function returns true for editors/viewers, false for owners/managers
- canApproveContent() function returns true for owners/managers, false for others
</success_criteria>

<output>
After completion, create `.planning/phases/12-content-approval/12-01-SUMMARY.md`
</output>
