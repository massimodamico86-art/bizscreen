---
phase: 12-content-approval
plan: 06
type: execute
wave: 3
depends_on: ["12-01", "12-02"]
files_modified:
  - src/services/approvalService.js
  - src/pages/ReviewInboxPage.jsx
autonomous: true

must_haves:
  truths:
    - "Submitting content sends email notification to approvers"
    - "Approving content sends email notification to creator"
    - "Rejecting content sends email with required feedback"
    - "Rejection requires comment (UI enforces)"
  artifacts:
    - path: "src/services/approvalService.js"
      provides: "Email notification integration in request/approve/reject"
      contains: "sendApprovalRequestEmail"
    - path: "src/pages/ReviewInboxPage.jsx"
      provides: "Rejection modal requires feedback input"
      contains: "required"
  key_links:
    - from: "src/services/approvalService.js"
      to: "src/services/emailService.js"
      via: "sendApprovalRequestEmail and sendApprovalDecisionEmail calls"
      pattern: "sendApproval.*Email"
---

<objective>
Wire email notifications to approval workflow: requests AND decisions.

Purpose: APR-05 requires email notifications for BOTH approval requests (when content is submitted) AND decisions (when approved/rejected). Per user decision, rejection requires written feedback so creators always know why.

Output: requestApproval sends email to approvers; approve/reject functions send email to creator; ReviewInboxPage enforces feedback for rejection.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-content-approval/12-RESEARCH.md
@.planning/phases/12-content-approval/12-01-SUMMARY.md
@.planning/phases/12-content-approval/12-02-SUMMARY.md

# Existing approval and email services
@src/services/approvalService.js
@src/services/emailService.js
@src/pages/ReviewInboxPage.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add email notification to requestApproval</name>
  <files>src/services/approvalService.js</files>
  <action>
Update requestApproval function in approvalService.js to send email notification to approvers:

1. Add import at top of file:
```javascript
import { sendApprovalRequestEmail, sendApprovalDecisionEmail } from './emailService.js';
```

2. Update requestApproval function to send email after creating review request:

Find the requestApproval function and add email notification after successful creation:

```javascript
export async function requestApproval({ resourceType, resourceId, title, message }) {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error('User must be authenticated');

  // Get submitter's name
  const { data: submitterProfile } = await supabase
    .from('profiles')
    .select('full_name, email')
    .eq('id', user.id)
    .single();

  // Create the review request
  const { data: review, error } = await supabase
    .from('review_requests')
    .insert({
      resource_type: resourceType,
      resource_id: resourceId,
      title,
      message,
      requested_by: user.id,
      status: REVIEW_STATUS.OPEN,
    })
    .select()
    .single();

  if (error) throw error;

  // Update resource approval status to in_review
  const tableName = getTableName(resourceType);
  await supabase
    .from(tableName)
    .update({ approval_status: APPROVAL_STATUS.IN_REVIEW })
    .eq('id', resourceId);

  // Get approvers (owners/managers) to notify
  const { data: approvers } = await supabase
    .from('profiles')
    .select('id, email, full_name')
    .eq('tenant_id', user.user_metadata?.tenant_id)
    .in('role', ['owner', 'manager']);

  // Send email notification to each approver (async, don't block)
  if (approvers?.length > 0) {
    const reviewUrl = `${window.location.origin}/review-inbox?reviewId=${review.id}`;

    for (const approver of approvers) {
      if (approver.email) {
        sendApprovalRequestEmail({
          to: approver.email,
          contentName: title || 'Content',
          contentType: resourceType,
          submitterName: submitterProfile?.full_name || 'A team member',
          reviewUrl,
          message: message || undefined,
        }).catch(err => {
          // Log but don't fail the submission
          console.error('Failed to send approval request email:', err);
        });
      }
    }
  }

  return review;
}
```

Note: Emails are sent asynchronously (fire and forget) so they don't block the approval request. Errors are logged but don't fail the operation. The approvers query filters by tenant_id and role to find owners/managers who can approve.
  </action>
  <verify>grep for "sendApprovalRequestEmail" in approvalService.js requestApproval function</verify>
  <done>Submitting content sends email notification to approvers (APR-05)</done>
</task>

<task type="auto">
  <name>Task 2: Add email notification to approveReview</name>
  <files>src/services/approvalService.js</files>
  <action>
Update approveReview function to send email notification:

```javascript
export async function approveReview(reviewId, { comment = '' } = {}) {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error('User must be authenticated');

  // Get the review to find resource info
  const { data: review, error: fetchError } = await supabase
    .from('review_requests')
    .select('*, requested_by_profile:profiles!review_requests_requested_by_fkey(email, full_name)')
    .eq('id', reviewId)
    .single();

  if (fetchError) throw fetchError;

  // Get reviewer's name
  const { data: reviewerProfile } = await supabase
    .from('profiles')
    .select('full_name')
    .eq('id', user.id)
    .single();

  // Update review status
  const { data: updatedReview, error: reviewError } = await supabase
    .from('review_requests')
    .update({
      status: REVIEW_STATUS.APPROVED,
      decided_by: user.id,
      decided_at: new Date().toISOString(),
      decision_comment: comment
    })
    .eq('id', reviewId)
    .select()
    .single();

  if (reviewError) throw reviewError;

  // Update resource approval status
  const tableName = getTableName(review.resource_type);
  await supabase
    .from(tableName)
    .update({
      approval_status: APPROVAL_STATUS.APPROVED,
      approval_decided_by: user.id,
      approval_decided_at: new Date().toISOString(),
      approval_comment: comment
    })
    .eq('id', review.resource_id);

  // Send email notification to creator (async, don't block)
  if (review.requested_by_profile?.email) {
    const contentUrl = `${window.location.origin}/${review.resource_type}s/${review.resource_id}`;
    sendApprovalDecisionEmail({
      to: review.requested_by_profile.email,
      contentName: review.title || 'Content',
      contentType: review.resource_type,
      decision: 'approved',
      reviewerName: reviewerProfile?.full_name || 'A reviewer',
      feedback: comment || undefined,
      contentUrl,
    }).catch(err => {
      // Log but don't fail the approval
      console.error('Failed to send approval email:', err);
    });
  }

  return updatedReview;
}
```

Note: The email is sent asynchronously (fire and forget) so it doesn't block the approval. Errors are logged but don't fail the operation.

The select query needs to be updated to join with profiles to get the creator's email. Use the foreign key relationship: `requested_by_profile:profiles!review_requests_requested_by_fkey(email, full_name)`.
  </action>
  <verify>grep for "sendApprovalDecisionEmail" in approvalService.js approveReview function</verify>
  <done>Approving review sends email notification to content creator</done>
</task>

<task type="auto">
  <name>Task 3: Add email notification to rejectReview</name>
  <files>src/services/approvalService.js</files>
  <action>
Update rejectReview function to send email notification with feedback:

```javascript
export async function rejectReview(reviewId, { comment = '' } = {}) {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error('User must be authenticated');

  if (!comment) throw new Error('A comment is required when rejecting');

  // Get the review with creator info
  const { data: review, error: fetchError } = await supabase
    .from('review_requests')
    .select('*, requested_by_profile:profiles!review_requests_requested_by_fkey(email, full_name)')
    .eq('id', reviewId)
    .single();

  if (fetchError) throw fetchError;

  // Get reviewer's name
  const { data: reviewerProfile } = await supabase
    .from('profiles')
    .select('full_name')
    .eq('id', user.id)
    .single();

  // Update review status
  const { data: updatedReview, error: reviewError } = await supabase
    .from('review_requests')
    .update({
      status: REVIEW_STATUS.REJECTED,
      decided_by: user.id,
      decided_at: new Date().toISOString(),
      decision_comment: comment
    })
    .eq('id', reviewId)
    .select()
    .single();

  if (reviewError) throw reviewError;

  // Update resource approval status
  const tableName = getTableName(review.resource_type);
  await supabase
    .from(tableName)
    .update({
      approval_status: APPROVAL_STATUS.REJECTED,
      approval_decided_by: user.id,
      approval_decided_at: new Date().toISOString(),
      approval_comment: comment
    })
    .eq('id', review.resource_id);

  // Send email notification to creator with feedback (async, don't block)
  if (review.requested_by_profile?.email) {
    const contentUrl = `${window.location.origin}/${review.resource_type}s/${review.resource_id}/edit`;
    sendApprovalDecisionEmail({
      to: review.requested_by_profile.email,
      contentName: review.title || 'Content',
      contentType: review.resource_type,
      decision: 'rejected',
      reviewerName: reviewerProfile?.full_name || 'A reviewer',
      feedback: comment, // Always included for rejection
      contentUrl,
    }).catch(err => {
      console.error('Failed to send rejection email:', err);
    });
  }

  return updatedReview;
}
```
  </action>
  <verify>grep for "sendApprovalDecisionEmail" with decision: 'rejected' in rejectReview function</verify>
  <done>Rejecting review sends email notification with required feedback</done>
</task>

<task type="auto">
  <name>Task 4: Enforce feedback requirement in ReviewInboxPage</name>
  <files>src/pages/ReviewInboxPage.jsx</files>
  <action>
Update ReviewInboxPage.jsx to enforce feedback requirement for rejection:

1. Find the rejection modal/dialog section (likely showDecisionModal === 'reject' or similar).

2. Ensure the comment textarea is required for rejection:

```jsx
{showDecisionModal === 'reject' && (
  <Modal open onClose={() => setShowDecisionModal(null)}>
    <ModalHeader>
      <ModalTitle>Reject Content</ModalTitle>
    </ModalHeader>
    <ModalContent>
      <p className="text-gray-600 mb-4">
        Please provide feedback explaining why this content needs revision.
        The creator will see this feedback.
      </p>
      <textarea
        value={decisionComment}
        onChange={(e) => setDecisionComment(e.target.value)}
        placeholder="Feedback is required for rejection..."
        className="w-full h-32 p-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
        required
      />
      {!decisionComment.trim() && (
        <p className="text-sm text-red-500 mt-2">
          Feedback is required when rejecting content.
        </p>
      )}
    </ModalContent>
    <ModalFooter>
      <Button variant="ghost" onClick={() => setShowDecisionModal(null)}>
        Cancel
      </Button>
      <Button
        variant="danger"
        onClick={handleDecision}
        disabled={submittingDecision || !decisionComment.trim()}
      >
        {submittingDecision ? (
          <Loader2 className="w-4 h-4 animate-spin" />
        ) : (
          'Reject'
        )}
      </Button>
    </ModalFooter>
  </Modal>
)}
```

Key changes:
- Add helper text explaining feedback requirement
- Add validation message when empty
- Disable Reject button when comment is empty: `disabled={submittingDecision || !decisionComment.trim()}`

For approval modal, feedback is optional - no changes needed there (button can remain enabled with empty comment).

Look at the existing modal structure and preserve the pattern while adding the validation.
  </action>
  <verify>grep for "disabled.*decisionComment" or "required" in ReviewInboxPage rejection modal</verify>
  <done>Rejection requires written feedback, UI prevents empty rejection</done>
</task>

</tasks>

<verification>
1. approvalService imports sendApprovalRequestEmail and sendApprovalDecisionEmail
2. requestApproval sends email to approvers with content details
3. approveReview sends email with decision='approved'
4. rejectReview sends email with decision='rejected' and feedback
5. ReviewInboxPage rejection modal disables submit when comment empty
6. Validation message shown for empty rejection feedback
</verification>

<success_criteria>
- Submitting content sends notification email to approvers (APR-05)
- Approving content sends notification email to creator (APR-05)
- Rejecting content sends notification email with feedback (APR-05)
- Rejection modal requires feedback (cannot submit with empty comment)
- Approval feedback is optional (can approve with or without comment)
</success_criteria>

<output>
After completion, create `.planning/phases/12-content-approval/12-06-SUMMARY.md`
</output>
