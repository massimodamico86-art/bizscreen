---
phase: 12-content-approval
plan: 03
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/pages/hooks/usePlaylistEditor.js
  - src/services/playlistService.js
autonomous: true

must_haves:
  truths:
    - "Saving playlist auto-submits for approval when user role requires it"
    - "No duplicate review requests created for same content"
    - "Owners/managers save without triggering approval flow"
  artifacts:
    - path: "src/pages/hooks/usePlaylistEditor.js"
      provides: "Auto-submit integration in handleSavePlaylist"
      contains: "requiresApproval"
    - path: "src/services/playlistService.js"
      provides: "savePlaylistWithApproval function"
      exports: ["savePlaylistWithApproval"]
  key_links:
    - from: "src/pages/hooks/usePlaylistEditor.js"
      to: "src/services/playlistService.js"
      via: "savePlaylistWithApproval call"
      pattern: "savePlaylistWithApproval"
    - from: "src/services/playlistService.js"
      to: "src/services/approvalService.js"
      via: "requestApproval call"
      pattern: "requestApproval"
---

<objective>
Integrate auto-submit for approval into playlist save workflow.

Purpose: Per user decision, saving content automatically submits it for approval when the user's role requires it. This plan adds that behavior to playlists - the pattern will be reused for scenes in Plan 04.

Output: savePlaylistWithApproval function and updated usePlaylistEditor hook that auto-submits when requiresApproval() returns true.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-content-approval/12-RESEARCH.md
@.planning/phases/12-content-approval/12-01-SUMMARY.md

# Existing patterns
@src/pages/hooks/usePlaylistEditor.js
@src/services/playlistService.js
@src/services/approvalService.js
@src/services/permissionsService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add savePlaylistWithApproval to playlistService</name>
  <files>src/services/playlistService.js</files>
  <action>
Add savePlaylistWithApproval function to playlistService.js:

1. Import required functions:
```javascript
import { requiresApproval } from './permissionsService.js';
import { requestApproval, getOpenReviewForResource, APPROVAL_STATUS } from './approvalService.js';
```

2. Add the new function:
```javascript
/**
 * Save playlist and auto-submit for approval if user role requires it
 * @param {string} playlistId - Playlist ID
 * @param {Object} updates - Playlist updates
 * @param {string} playlistName - Playlist name (for review request title)
 * @returns {Promise<{playlist: Object, submittedForApproval: boolean, existingReview: Object|null}>}
 */
export async function savePlaylistWithApproval(playlistId, updates, playlistName) {
  // Save the playlist first
  const playlist = await updatePlaylist(playlistId, updates);

  // Check if user requires approval
  const needsApproval = await requiresApproval();

  if (!needsApproval) {
    // Owner/manager - save only, no approval needed
    return { playlist, submittedForApproval: false, existingReview: null };
  }

  // Check for existing open review (avoid duplicates - Pitfall #3 from RESEARCH.md)
  const existingReview = await getOpenReviewForResource('playlist', playlistId);

  if (existingReview) {
    // Already has open review - don't create another
    return { playlist, submittedForApproval: false, existingReview };
  }

  // Auto-submit for approval
  await requestApproval({
    resourceType: 'playlist',
    resourceId: playlistId,
    title: `Review playlist: ${playlistName}`,
    message: '', // Auto-submit has no message
  });

  return { playlist, submittedForApproval: true, existingReview: null };
}
```

3. Export the function if not using default export, or add to default export if used.
  </action>
  <verify>grep for "savePlaylistWithApproval" and "requiresApproval" imports in playlistService.js</verify>
  <done>savePlaylistWithApproval saves and conditionally submits for approval</done>
</task>

<task type="auto">
  <name>Task 2: Update usePlaylistEditor to use auto-submit</name>
  <files>src/pages/hooks/usePlaylistEditor.js</files>
  <action>
Update usePlaylistEditor.js to use the new auto-submit flow:

1. Add import:
```javascript
import { savePlaylistWithApproval } from '../../services/playlistService.js';
```

2. Update handleSavePlaylist to use savePlaylistWithApproval:

Find the existing handleSavePlaylist function and update it to:

```javascript
const handleSavePlaylist = useCallback(async () => {
  if (!playlist) return;

  try {
    setSaving(true);

    // Build the updates object (preserve existing logic for building updates)
    const updates = {
      name: playlist.name,
      description: playlist.description,
      shuffle: playlist.shuffle,
      loop: playlist.loop,
      default_duration: playlist.default_duration,
      // ... any other fields being saved
    };

    // Use savePlaylistWithApproval for auto-submit behavior
    const { playlist: savedPlaylist, submittedForApproval, existingReview } = await savePlaylistWithApproval(
      playlistId,
      updates,
      playlist.name
    );

    // Refresh playlist state
    await fetchPlaylist();

    // Update current review state if submitted
    if (submittedForApproval) {
      const review = await getOpenReviewForResource('playlist', playlistId);
      setCurrentReview(review);
      showToast?.('Saved and submitted for approval');
    } else if (existingReview) {
      setCurrentReview(existingReview);
      showToast?.('Saved (already pending approval)');
    } else {
      showToast?.('Playlist saved');
    }

  } catch (error) {
    logger.error('Error saving playlist', { error, playlistId });
    showToast?.(error.message || 'Error saving playlist', 'error');
  } finally {
    setSaving(false);
  }
}, [playlist, playlistId, fetchPlaylist, showToast]);
```

Note: The existing handleSavePlaylist may have different structure. Preserve the existing update-building logic and just change how the save is called to use savePlaylistWithApproval. Keep existing error handling, loading states, and toast messages but update them to reflect approval status.

Important: Look at the existing implementation first. The key change is:
- Replace direct updatePlaylist/savePlaylist call with savePlaylistWithApproval
- Add appropriate toast message based on submittedForApproval result
  </action>
  <verify>grep for "savePlaylistWithApproval" and "submittedForApproval" in usePlaylistEditor.js</verify>
  <done>Playlist save auto-submits for approval when user role requires it</done>
</task>

<task type="auto">
  <name>Task 3: Handle re-approval on edit of approved content</name>
  <files>src/pages/hooks/usePlaylistEditor.js</files>
  <action>
Per user decision: editing approved content triggers re-approval.

Update handleSavePlaylist (or savePlaylistWithApproval) to handle the case where content is already approved:

In playlistService.js, update savePlaylistWithApproval to handle re-approval:

```javascript
export async function savePlaylistWithApproval(playlistId, updates, playlistName) {
  // Get current approval status before saving
  const { data: currentPlaylist } = await supabase
    .from('playlists')
    .select('approval_status')
    .eq('id', playlistId)
    .single();

  // Save the playlist
  const playlist = await updatePlaylist(playlistId, updates);

  // Check if user requires approval
  const needsApproval = await requiresApproval();

  if (!needsApproval) {
    // Owner/manager - save only, no approval needed
    return { playlist, submittedForApproval: false, existingReview: null };
  }

  // If content was approved and is being edited, reset to draft and create new review
  if (currentPlaylist?.approval_status === APPROVAL_STATUS.APPROVED) {
    // Reset to draft
    await supabase
      .from('playlists')
      .update({ approval_status: APPROVAL_STATUS.DRAFT })
      .eq('id', playlistId);

    // Submit for re-approval
    await requestApproval({
      resourceType: 'playlist',
      resourceId: playlistId,
      title: `Re-review playlist: ${playlistName}`,
      message: 'Content was edited after approval.',
    });

    return { playlist, submittedForApproval: true, existingReview: null, wasResubmission: true };
  }

  // Check for existing open review (avoid duplicates)
  const existingReview = await getOpenReviewForResource('playlist', playlistId);

  if (existingReview) {
    return { playlist, submittedForApproval: false, existingReview };
  }

  // Auto-submit for approval
  await requestApproval({
    resourceType: 'playlist',
    resourceId: playlistId,
    title: `Review playlist: ${playlistName}`,
    message: '',
  });

  return { playlist, submittedForApproval: true, existingReview: null };
}
```

Update the toast messages in usePlaylistEditor to handle wasResubmission:
```javascript
if (result.wasResubmission) {
  showToast?.('Saved and resubmitted for approval');
} else if (result.submittedForApproval) {
  showToast?.('Saved and submitted for approval');
} else if (result.existingReview) {
  showToast?.('Saved (already pending approval)');
} else {
  showToast?.('Playlist saved');
}
```
  </action>
  <verify>grep for "wasResubmission" or "Re-review" or "APPROVED" check in playlistService.js</verify>
  <done>Editing approved playlist resets status and triggers re-approval</done>
</task>

</tasks>

<verification>
1. savePlaylistWithApproval function exists in playlistService.js
2. usePlaylistEditor imports and calls savePlaylistWithApproval
3. Toast messages indicate approval status (submitted/pending/saved)
4. Editing approved content triggers re-approval flow
</verification>

<success_criteria>
- Saving playlist as editor/viewer auto-submits for approval
- Saving playlist as owner/manager does NOT submit for approval
- No duplicate review requests created
- Editing approved playlist resets to draft and resubmits
- Toast messages clearly indicate approval status
</success_criteria>

<output>
After completion, create `.planning/phases/12-content-approval/12-03-SUMMARY.md`
</output>
