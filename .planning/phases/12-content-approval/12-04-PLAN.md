---
phase: 12-content-approval
plan: 04
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - src/services/sceneService.js
  - src/pages/SceneEditorPage.jsx
autonomous: true

must_haves:
  truths:
    - "Saving scene auto-submits for approval when user role requires it"
    - "SceneEditorPage save handler uses approval-aware function"
    - "Owners/managers save scenes without triggering approval flow"
  artifacts:
    - path: "src/services/sceneService.js"
      provides: "saveSceneWithApproval function"
      exports: ["saveSceneWithApproval"]
    - path: "src/pages/SceneEditorPage.jsx"
      provides: "Scene save with approval integration"
      contains: "saveSceneWithApproval"
  key_links:
    - from: "src/pages/SceneEditorPage.jsx"
      to: "src/services/sceneService.js"
      via: "saveSceneWithApproval call"
      pattern: "saveSceneWithApproval"
    - from: "src/services/sceneService.js"
      to: "src/services/approvalService.js"
      via: "requestApproval call"
      pattern: "requestApproval"
---

<objective>
Integrate auto-submit for approval into scene save workflow.

Purpose: Same as Plan 03 but for scenes. Saving a scene automatically submits it for approval when the user's role requires it.

Output: saveSceneWithApproval function and updated SceneEditorPage that auto-submits when requiresApproval() returns true.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/12-content-approval/12-RESEARCH.md
@.planning/phases/12-content-approval/12-01-SUMMARY.md
@.planning/phases/12-content-approval/12-03-SUMMARY.md

# Existing patterns
@src/services/sceneService.js
@src/pages/SceneEditorPage.jsx
@src/services/approvalService.js
@src/services/permissionsService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add saveSceneWithApproval to sceneService</name>
  <files>src/services/sceneService.js</files>
  <action>
Add saveSceneWithApproval function to sceneService.js following the pattern from playlistService:

1. Import required functions at top of file:
```javascript
import { requiresApproval } from './permissionsService.js';
import { requestApproval, getOpenReviewForResource, APPROVAL_STATUS } from './approvalService.js';
```

2. Add the new function:
```javascript
/**
 * Save scene and auto-submit for approval if user role requires it
 * @param {string} sceneId - Scene ID
 * @param {Object} updates - Scene updates
 * @param {string} sceneName - Scene name (for review request title)
 * @returns {Promise<{scene: Object, submittedForApproval: boolean, existingReview: Object|null, wasResubmission?: boolean}>}
 */
export async function saveSceneWithApproval(sceneId, updates, sceneName) {
  // Get current approval status before saving
  const { data: currentScene } = await supabase
    .from('scenes')
    .select('approval_status')
    .eq('id', sceneId)
    .single();

  // Save the scene
  const scene = await updateScene(sceneId, updates);

  // Check if user requires approval
  const needsApproval = await requiresApproval();

  if (!needsApproval) {
    // Owner/manager - save only, no approval needed
    return { scene, submittedForApproval: false, existingReview: null };
  }

  // If content was approved and is being edited, reset to draft and create new review
  if (currentScene?.approval_status === APPROVAL_STATUS.APPROVED) {
    // Reset to draft
    await supabase
      .from('scenes')
      .update({ approval_status: APPROVAL_STATUS.DRAFT })
      .eq('id', sceneId);

    // Submit for re-approval
    await requestApproval({
      resourceType: 'scene',
      resourceId: sceneId,
      title: `Re-review scene: ${sceneName}`,
      message: 'Content was edited after approval.',
    });

    return { scene, submittedForApproval: true, existingReview: null, wasResubmission: true };
  }

  // Check for existing open review (avoid duplicates)
  const existingReview = await getOpenReviewForResource('scene', sceneId);

  if (existingReview) {
    return { scene, submittedForApproval: false, existingReview };
  }

  // Auto-submit for approval
  await requestApproval({
    resourceType: 'scene',
    resourceId: sceneId,
    title: `Review scene: ${sceneName}`,
    message: '',
  });

  return { scene, submittedForApproval: true, existingReview: null };
}
```
  </action>
  <verify>grep for "saveSceneWithApproval" and "requiresApproval" imports in sceneService.js</verify>
  <done>saveSceneWithApproval saves and conditionally submits scenes for approval</done>
</task>

<task type="auto">
  <name>Task 2: Update SceneEditorPage save handler</name>
  <files>src/pages/SceneEditorPage.jsx</files>
  <action>
First, read the existing SceneEditorPage.jsx to understand its save handler structure.

Then update to use saveSceneWithApproval:

1. Add import:
```javascript
import { saveSceneWithApproval } from '../services/sceneService.js';
```

2. Find the existing save handler (likely called handleSave or similar) and update it to:

```javascript
const handleSave = async () => {
  if (!scene || saving) return;

  try {
    setSaving(true);

    // Build updates object (preserve existing logic)
    const updates = {
      name: scene.name,
      business_type: scene.business_type,
      layout_id: scene.layout_id,
      primary_playlist_id: scene.primary_playlist_id,
      secondary_playlist_id: scene.secondary_playlist_id,
      settings: scene.settings,
      // ... any other fields
    };

    // Use saveSceneWithApproval for auto-submit behavior
    const result = await saveSceneWithApproval(sceneId, updates, scene.name);

    // Show appropriate toast based on approval status
    if (result.wasResubmission) {
      showToast?.('Saved and resubmitted for approval');
    } else if (result.submittedForApproval) {
      showToast?.('Saved and submitted for approval');
    } else if (result.existingReview) {
      showToast?.('Saved (already pending approval)');
    } else {
      showToast?.('Scene saved');
    }

    // Refresh scene data if needed
    // await fetchScene(); // if this pattern exists

  } catch (error) {
    logger.error('Error saving scene', { error, sceneId });
    showToast?.(error.message || 'Error saving scene', 'error');
  } finally {
    setSaving(false);
  }
};
```

Important: The existing save handler may have different structure. Key changes:
- Replace direct updateScene call with saveSceneWithApproval
- Add conditional toast messages based on result
- Keep existing error handling and loading state management

If using useLogger hook, add it:
```javascript
import { useLogger } from '../hooks/useLogger.js';
// In component:
const logger = useLogger('SceneEditorPage');
```
  </action>
  <verify>grep for "saveSceneWithApproval" and "submittedForApproval" in SceneEditorPage.jsx</verify>
  <done>SceneEditorPage save handler integrates with approval workflow</done>
</task>

<task type="auto">
  <name>Task 3: Add approval status display to SceneEditorPage</name>
  <files>src/pages/SceneEditorPage.jsx</files>
  <action>
Add approval status indicator to SceneEditorPage header/toolbar:

1. Import approval status config:
```javascript
import { getApprovalStatusConfig, getOpenReviewForResource } from '../services/approvalService.js';
```

2. Add state for current review:
```javascript
const [currentReview, setCurrentReview] = useState(null);
```

3. Load current review on scene load:
```javascript
useEffect(() => {
  if (scene?.id) {
    getOpenReviewForResource('scene', scene.id)
      .then(setCurrentReview)
      .catch(err => logger.warn('Error fetching scene review', { error: err }));
  }
}, [scene?.id]);
```

4. Display approval status badge in the header area (near save button):
```jsx
{scene?.approval_status && scene.approval_status !== 'draft' && (
  <Badge
    variant={getApprovalStatusConfig(scene.approval_status).variant}
    className="ml-2"
  >
    {getApprovalStatusConfig(scene.approval_status).label}
  </Badge>
)}
```

If scene doesn't have approval_status field yet (before migration runs), add fallback:
```jsx
{scene?.approval_status && (
  // badge code
)}
```
  </action>
  <verify>grep for "approval_status" and "getApprovalStatusConfig" in SceneEditorPage.jsx</verify>
  <done>Scene approval status visible in editor UI</done>
</task>

</tasks>

<verification>
1. saveSceneWithApproval function exists in sceneService.js
2. SceneEditorPage imports and uses saveSceneWithApproval
3. Approval status badge displays in SceneEditorPage
4. Toast messages indicate approval state after save
</verification>

<success_criteria>
- Saving scene as editor/viewer auto-submits for approval (APR-01)
- Saving scene as owner/manager does NOT submit for approval
- No duplicate review requests for scenes
- Editing approved scene resets to draft and resubmits
- Scene approval status visible in editor
</success_criteria>

<output>
After completion, create `.planning/phases/12-content-approval/12-04-SUMMARY.md`
</output>
