---
phase: 17-templates-core
plan: 03
type: execute
wave: 3
depends_on: ["17-02"]
files_modified:
  - src/components/templates/TemplatePreviewPanel.jsx
  - src/components/templates/index.js
  - src/pages/TemplateMarketplacePage.jsx
autonomous: true

must_haves:
  truths:
    - "User can preview template in full-size side panel before applying"
    - "Preview panel slides in from right while grid remains visible"
    - "User can apply template with one click from preview panel"
    - "Applied template creates scene and redirects to editor immediately"
  artifacts:
    - path: "src/components/templates/TemplatePreviewPanel.jsx"
      provides: "Right slide-in preview panel with template details and apply button"
      exports: ["TemplatePreviewPanel"]
    - path: "src/pages/TemplateMarketplacePage.jsx"
      provides: "Page integration with preview panel instead of modal"
      contains: "TemplatePreviewPanel"
  key_links:
    - from: "src/components/templates/TemplatePreviewPanel.jsx"
      to: "framer-motion drawer.right"
      via: "motion.div with drawer animation"
      pattern: "drawer\\.right|motion\\.div"
    - from: "src/components/templates/TemplatePreviewPanel.jsx"
      to: "installTemplateAsScene"
      via: "Apply button click handler"
      pattern: "installTemplateAsScene"
    - from: "src/pages/TemplateMarketplacePage.jsx"
      to: "TemplatePreviewPanel"
      via: "selectedTemplate state and panel rendering"
      pattern: "TemplatePreviewPanel.*selectedTemplate"
---

<objective>
Create right slide-in preview panel that replaces the existing modal, allowing users to preview template details while keeping the grid visible for comparison.

Purpose: Deliver TMPL-03 (preview) and TMPL-04 (one-click apply) requirements with side panel UX per CONTEXT decisions (grid stays visible, preserves browsing context).

Output: TemplatePreviewPanel component with smooth animation and Apply flow integrated into marketplace page.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-templates-core/17-CONTEXT.md
@.planning/phases/17-templates-core/17-RESEARCH.md
@.planning/phases/17-templates-core/17-02-SUMMARY.md
@src/components/TemplatePreviewModal.jsx
@src/design-system/motion.js
@src/components/ScreenDetailDrawer.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TemplatePreviewPanel component</name>
  <files>src/components/templates/TemplatePreviewPanel.jsx</files>
  <action>
Create TemplatePreviewPanel.jsx as right slide-in panel (adapt from TemplatePreviewModal and ScreenDetailDrawer patterns):

1. Imports:
   - import { useState, useEffect } from 'react';
   - import { motion, AnimatePresence } from 'framer-motion';
   - import { X, Loader2, AlertCircle } from 'lucide-react';
   - import { drawer } from '../../design-system/motion';
   - import { fetchTemplateDetail, installTemplateAsScene, LICENSE_LABELS } from '../../services/marketplaceService';
   - import { format } from 'date-fns';

2. Props:
   - template (object) - the selected template (basic info)
   - onClose (function) - close panel
   - onApply (function) - callback after successful apply with sceneId

3. State:
   - detail (object) - full template details from fetchTemplateDetail
   - loading (boolean) - loading detail
   - applying (boolean) - applying template
   - error (string) - error message

4. Load template detail on mount/template change:
   - useEffect with fetchTemplateDetail(template.id)
   - Handle loading and error states

5. Panel structure (fixed right, w-[480px] max-w-full):
   - Backdrop: motion.div fixed inset-0 bg-black/30 z-30, click to close
   - Panel: motion.div with {...drawer.right}, fixed inset-y-0 right-0 w-[480px] bg-white shadow-xl z-40 flex flex-col

6. Panel header:
   - Template name (text-lg font-semibold)
   - License badge (use LICENSE_LABELS colors)
   - Close button (X icon)

7. Panel content (flex-1 overflow-y-auto):
   - Large preview image (aspect-video) - use preview_url or thumbnail_url
   - Description section
   - Details: Category, Slides count, Install count
   - Tags if present
   - Access warning if !detail.canAccess (upgrade required)

8. Panel footer (p-4 border-t):
   - Apply button: full-width, blue-600, "Apply Template"
   - If !canAccess: "Upgrade to Access" button (purple-600, links to /account/plan)
   - Show loading spinner when applying

9. Apply handler:
   ```javascript
   const handleApply = async () => {
     setApplying(true);
     try {
       const sceneName = `${template.name} - ${format(new Date(), 'MMM d, yyyy')}`;
       const sceneId = await installTemplateAsScene(template.id, sceneName);
       onApply(sceneId);
     } catch (err) {
       setError(err.message || 'Failed to apply template');
       setApplying(false);
     }
   };
   ```

10. Escape key handler to close panel
  </action>
  <verify>Panel slides in from right with animation; shows template details; Apply button creates scene</verify>
  <done>TemplatePreviewPanel displays template details with Apply flow in animated side panel</done>
</task>

<task type="auto">
  <name>Task 2: Integrate panel into marketplace page</name>
  <files>src/components/templates/index.js, src/pages/TemplateMarketplacePage.jsx</files>
  <action>
1. Update index.js exports:
   - Add: export { TemplatePreviewPanel } from './TemplatePreviewPanel';

2. Update TemplateMarketplacePage.jsx:
   a. Import TemplatePreviewPanel:
      - Update import to include: TemplatePreviewPanel
      - Remove TemplatePreviewModal import

   b. Replace modal state with panel state:
      - Keep selectedTemplate state
      - Remove previewOpen state (use selectedTemplate truthy check)

   c. Update template click handler:
      - handleTemplateClick sets selectedTemplate
      - No previewOpen needed

   d. Update Apply success handler:
      ```javascript
      const handleApplySuccess = (sceneId) => {
        setSelectedTemplate(null);
        navigate(`/scene-editor/${sceneId}`);
      };
      ```

   e. Replace modal JSX with panel:
      ```jsx
      <AnimatePresence>
        {selectedTemplate && (
          <TemplatePreviewPanel
            template={selectedTemplate}
            onClose={() => setSelectedTemplate(null)}
            onApply={handleApplySuccess}
          />
        )}
      </AnimatePresence>
      ```

   f. Update grid/featured onTemplateClick:
      - Pass onTemplateClick={handleTemplateClick} (sets selectedTemplate)

3. Panel behavior per CONTEXT:
   - When clicking another template while panel open: swap content in place
   - This happens naturally when selectedTemplate changes (panel re-renders with new template)

4. Remove or deprecate TemplatePreviewModal usage:
   - Can leave TemplatePreviewModal.jsx file but remove import from marketplace page
  </action>
  <verify>Click template opens side panel; Apply creates scene and redirects; clicking another template swaps panel content</verify>
  <done>Marketplace page uses slide-in panel for preview instead of modal</done>
</task>

</tasks>

<verification>
- npm run dev - click any template, panel slides in from right
- Grid remains visible behind panel (with backdrop)
- Panel shows template details: image, description, category, slides
- Apply button creates scene with "Template Name - Jan 25, 2026" naming
- After apply, redirects to /scene-editor/{sceneId}
- Click backdrop or X to close panel
- Click another template while panel open: content swaps smoothly
- Escape key closes panel
</verification>

<success_criteria>
1. User can preview template in full-size side panel (TMPL-03)
2. Grid stays visible while panel is open (per CONTEXT)
3. User can apply template with one click from panel (TMPL-04)
4. Applied template creates scene with auto-naming and redirects immediately
5. Panel uses smooth slide animation (drawer.right)
6. Clicking another template swaps content without close/reopen
</success_criteria>

<output>
After completion, create `.planning/phases/17-templates-core/17-03-SUMMARY.md`
</output>
