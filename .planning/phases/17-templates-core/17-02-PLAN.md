---
phase: 17-templates-core
plan: 02
type: execute
wave: 2
depends_on: ["17-01"]
files_modified:
  - src/pages/TemplateMarketplacePage.jsx
autonomous: true

must_haves:
  truths:
    - "User can browse templates organized by category via persistent sidebar"
    - "User can search templates by name and description with live filtering"
    - "User can see featured templates prominently at top of page"
    - "User can filter templates by orientation (landscape/portrait)"
  artifacts:
    - path: "src/pages/TemplateMarketplacePage.jsx"
      provides: "Restructured marketplace page with sidebar, search, featured row, grid"
      min_lines: 200
  key_links:
    - from: "src/pages/TemplateMarketplacePage.jsx"
      to: "marketplaceService"
      via: "fetchMarketplaceTemplates and fetchFeaturedTemplates calls"
      pattern: "fetchMarketplaceTemplates|fetchFeaturedTemplates"
    - from: "src/pages/TemplateMarketplacePage.jsx"
      to: "URL params"
      via: "useSearchParams for category, orientation, search"
      pattern: "searchParams\\.get.*category|orientation|q"
    - from: "src/pages/TemplateMarketplacePage.jsx"
      to: "TemplateSidebar component"
      via: "onFilterChange callback"
      pattern: "TemplateSidebar.*onFilterChange"
---

<objective>
Restructure TemplateMarketplacePage with new component architecture: prominent search bar, persistent category sidebar, featured templates row, and responsive template grid.

Purpose: Deliver TMPL-01 (category browsing), TMPL-02 (search), TMPL-05 (featured templates), TMPL-06 (orientation filter) requirements with e-commerce style UX per CONTEXT decisions.

Output: Enhanced marketplace page with full browse/search/filter functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-templates-core/17-CONTEXT.md
@.planning/phases/17-templates-core/17-RESEARCH.md
@.planning/phases/17-templates-core/17-01-SUMMARY.md
@src/pages/TemplateMarketplacePage.jsx
@src/services/marketplaceService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restructure page layout with sidebar and main content</name>
  <files>src/pages/TemplateMarketplacePage.jsx</files>
  <action>
Refactor TemplateMarketplacePage layout structure:

1. Import new components:
   - import { TemplateSidebar, FeaturedTemplatesRow, TemplateGrid } from '../components/templates';
   - import { fetchFeaturedTemplates } from '../services/marketplaceService'; (if not already)

2. Add state for featured templates:
   - const [featuredTemplates, setFeaturedTemplates] = useState([]);
   - Fetch featured in useEffect: fetchFeaturedTemplates(6).then(setFeaturedTemplates)

3. Add orientation to URL params handling:
   - const orientation = searchParams.get('orientation') || '';
   - Pass to fetchMarketplaceTemplates call (note: may need client-side filter if RPC doesn't support)
   - If client-side: filter templates by metadata.orientation

4. Restructure JSX layout:
   - Keep PageLayout wrapper with updated description
   - Top: Full-width search bar (prominent, outside the flex container)
   - Below: flex container with sidebar + main content
   - Sidebar: Use TemplateSidebar component
   - Main: Featured row (if featuredTemplates.length > 0 and no filters active), then TemplateGrid

5. Replace existing inline filters with TemplateSidebar:
   - Pass categories, selectedCategory (categoryId), selectedOrientation (orientation), onFilterChange
   - onFilterChange updates URL params

6. Replace existing grid with components:
   - FeaturedTemplatesRow when: featuredTemplates exist AND no search/category/orientation filters
   - TemplateGrid for main results
   - Keep loading skeletons and empty state

7. Debounced search (already exists but move to prominent position):
   - Move search input to top of page (above flex layout)
   - Larger input: w-full max-w-2xl mx-auto mb-6
   - Placeholder: "Search templates..."
  </action>
  <verify>Page renders with search at top, sidebar on left, featured row and grid in main area</verify>
  <done>Marketplace page restructured with sidebar layout and prominent search</done>
</task>

<task type="auto">
  <name>Task 2: Wire filter state and template click handlers</name>
  <files>src/pages/TemplateMarketplacePage.jsx</files>
  <action>
Complete the filter and interaction wiring:

1. Create updateFilters function (update existing if present):
   ```javascript
   const updateFilters = useCallback((updates) => {
     const newParams = new URLSearchParams(searchParams);
     Object.entries(updates).forEach(([key, value]) => {
       if (value) newParams.set(key, value);
       else newParams.delete(key);
     });
     setSearchParams(newParams);
   }, [searchParams, setSearchParams]);
   ```

2. Wire TemplateSidebar:
   - onFilterChange={(updates) => updateFilters(updates)}
   - This handles both category and orientation changes

3. Add Quick Apply handler for grid:
   ```javascript
   const [applyingId, setApplyingId] = useState(null);

   const handleQuickApply = async (template) => {
     setApplyingId(template.id);
     try {
       const sceneName = `${template.name} - ${format(new Date(), 'MMM d, yyyy')}`;
       const sceneId = await installTemplateAsScene(template.id, sceneName);
       navigate(`/scene-editor/${sceneId}`);
     } catch (error) {
       // Show error toast if available, otherwise console
       console.error('Failed to apply template:', error);
       setApplyingId(null);
     }
   };
   ```
   - Import format from 'date-fns'
   - Import installTemplateAsScene from marketplaceService

4. Pass to grid components:
   - FeaturedTemplatesRow: onTemplateClick, onQuickApply={handleQuickApply}, applyingId
   - TemplateGrid: same props

5. Update loadTemplates to use orientation:
   - Filter client-side if RPC doesn't support: templates.filter(t => !orientation || t.metadata?.orientation === orientation)

6. Clear filters link:
   - Show "Clear all filters" when any filter active
   - onClick={() => setSearchParams(new URLSearchParams())}
  </action>
  <verify>Category filter updates URL and grid; orientation filter works; Quick Apply creates scene and navigates</verify>
  <done>Filters wired to URL params, Quick Apply creates scenes with auto-naming</done>
</task>

</tasks>

<verification>
- npm run dev - page loads without errors
- Category sidebar visible on left, clicking category updates URL and filters grid
- Orientation checkboxes filter templates
- Search bar at top, typing filters templates (debounced)
- Featured templates row shows when no filters active
- Quick Apply on hover creates scene and navigates to editor
- Clear filters link appears when filters active
</verification>

<success_criteria>
1. User can browse templates by clicking categories in sidebar (TMPL-01)
2. User can search templates with live debounced filtering (TMPL-02)
3. Featured templates appear prominently at top when unfiltered (TMPL-05)
4. Orientation filter works via checkboxes (TMPL-06)
5. Quick Apply creates scene with "Template Name - Date" format and redirects
</success_criteria>

<output>
After completion, create `.planning/phases/17-templates-core/17-02-SUMMARY.md`
</output>
