---
phase: 24-player-restructure
plan: 02
type: execute
wave: 2
depends_on: ["24-01"]
files_modified:
  - src/player/pages/ViewPage.jsx
  - src/player/pages/index.js
  - src/Player.jsx
autonomous: true

must_haves:
  truths:
    - "Player.jsx is under 100 lines and only handles routing"
    - "ViewPage can be imported from player/pages"
    - "Player /view route renders ViewPage correctly"
    - "Player /player route renders PairPage correctly"
    - "All player functionality works identically to before"
  artifacts:
    - path: "src/player/pages/ViewPage.jsx"
      provides: "Main player view component"
      exports: ["ViewPage"]
      min_lines: 900
    - path: "src/player/pages/index.js"
      provides: "Barrel export for pages"
      contains: "ViewPage"
    - path: "src/Player.jsx"
      provides: "Routing-only entry point"
      max_lines: 100
  key_links:
    - from: "src/Player.jsx"
      to: "src/player/pages/ViewPage.jsx"
      via: "import and Route"
      pattern: "import.*ViewPage.*from.*player/pages"
    - from: "src/player/pages/ViewPage.jsx"
      to: "src/player/hooks"
      via: "hook imports"
      pattern: "import.*useStuckDetection.*from.*hooks"
---

<objective>
Extract ViewPage component from Player.jsx to its own file and reduce Player.jsx to routing-only concern.

Purpose: Complete PLAY-01 (under 1000 lines - actually targeting under 100), PLAY-05 (directory structure with pages/). This is the main extraction that achieves the phase goal.

Output:
- New `player/pages/` directory with ViewPage.jsx
- Player.jsx reduced to ~40-50 lines (routing only)
</objective>

<execution_context>
@/Users/massimodamico/.claude/get-shit-done/workflows/execute-plan.md
@/Users/massimodamico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-player-restructure/24-RESEARCH.md
@.planning/phases/24-player-restructure/24-01-SUMMARY.md
@src/Player.jsx
@src/player/hooks/index.js
@src/player/components/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pages directory and ViewPage component</name>
  <files>src/player/pages/ViewPage.jsx, src/player/pages/index.js</files>
  <action>
Create the `player/pages/` directory and extract ViewPage from Player.jsx.

**Step 1: Create directory**
```bash
mkdir -p src/player/pages
```

**Step 2: Create ViewPage.jsx**
Extract the ViewPage function (lines 137-1252 from Player.jsx) into `src/player/pages/ViewPage.jsx`.

The file should:

1. Include all necessary imports at the top:
   - React hooks (useEffect, useState, useRef)
   - react-router-dom (useNavigate)
   - supabase client
   - analytics service
   - All service imports currently in Player.jsx (deviceSyncService, playerService, screenshotService, offlineService, playbackTrackingService, realtimeService, loggingService)
   - All component imports from `../components` (SceneRenderer, LayoutRenderer, AppRenderer, PinEntry)
   - All hook imports from `../hooks` (usePlayerContent, usePlayerHeartbeat, usePlayerCommands, useKioskMode, usePlayerPlayback, useTapSequence, useStuckDetection)

2. Include the constants and utility functions that ViewPage needs:
   - STORAGE_KEYS object
   - PLAYER_VERSION constant
   - STUCK_DETECTION can be removed (now in useStuckDetection hook)
   - RETRY_CONFIG and retryWithBackoff function

3. Replace the inline stuck detection useEffect (lines 392-437) with the new useStuckDetection hook:
   ```javascript
   // Replace the stuck detection useEffect with:
   useStuckDetection({
     videoRef,
     lastVideoTimeRef,
     lastActivityRef,
     onVideoStuck: () => {
       logger.warn('Video stuck detected, attempting recovery...');
       try {
         videoRef.current.currentTime = 0;
         videoRef.current.play().catch(err => logger.error('Video play failed', { error: err }));
       } catch (err) {
         logger.error('Video recovery failed', { error: err });
         advanceToNextRef.current?.();
       }
     },
     onPageStuck: () => {
       logger.warn('Player inactive for too long, reloading...');
       window.location.reload();
     },
   });
   ```

4. Remove the `stuckDetectionRef` and the stuck detection useEffect entirely - they're replaced by the hook.

5. Export ViewPage as a named export:
   ```javascript
   export function ViewPage() { ... }
   ```

**Step 3: Create index.js barrel export**
Create `src/player/pages/index.js`:
```javascript
export { ViewPage } from './ViewPage.jsx';
```

**Important:** Keep the exact same component logic and JSX. This is a pure extraction, not a refactor of behavior.
  </action>
  <verify>
```bash
ls src/player/pages/
wc -l src/player/pages/ViewPage.jsx
grep "export.*ViewPage" src/player/pages/ViewPage.jsx
```
  </verify>
  <done>
- `player/pages/` directory exists
- ViewPage.jsx exists with ~1100 lines
- ViewPage is exported as named export
- index.js barrel export exists
- useStuckDetection hook is used instead of inline effect
  </done>
</task>

<task type="auto">
  <name>Task 2: Slim down Player.jsx to routing only</name>
  <files>src/Player.jsx</files>
  <action>
Reduce Player.jsx to be a pure routing component.

The new Player.jsx should only contain:

1. Minimal imports:
   ```javascript
   import { Routes, Route, Navigate } from 'react-router-dom';
   import { PairPage } from './player/components/PairPage';
   import { ViewPage } from './player/pages/ViewPage';
   ```

2. The router component (only the last ~10 lines of current file):
   ```javascript
   /**
    * Main Player component with routing
    */
   export default function Player() {
     return (
       <Routes>
         <Route path="/" element={<PairPage />} />
         <Route path="/view" element={<ViewPage />} />
         <Route path="*" element={<Navigate to="/player" replace />} />
       </Routes>
     );
   }
   ```

3. Optional: Brief comment header explaining this is the player entry point

**Remove everything else:**
- All other imports (they moved to ViewPage.jsx)
- STORAGE_KEYS (moved to ViewPage.jsx)
- PLAYER_VERSION (moved to ViewPage.jsx)
- STUCK_DETECTION (moved to useStuckDetection hook)
- RETRY_CONFIG and retryWithBackoff (moved to ViewPage.jsx)
- The entire ViewPage function (moved to player/pages/)
- The retryLogger (moved to ViewPage.jsx)

Target: ~20-40 lines total.
  </action>
  <verify>
```bash
wc -l src/Player.jsx
cat src/Player.jsx
```
Player.jsx should be under 50 lines and only contain routing logic.
  </verify>
  <done>
- Player.jsx is under 50 lines
- Only contains Routes and imports for PairPage and ViewPage
- No business logic, no hooks, no state
- Still exports default Player component
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify full player functionality</name>
  <files>-</files>
  <action>
Verify the restructured player works correctly.

1. **Build verification:**
   ```bash
   npm run build 2>&1 | tail -10
   ```
   Build should succeed without errors.

2. **Import verification:**
   ```bash
   # Verify ViewPage imports work
   grep -n "from.*player/pages" src/Player.jsx

   # Verify hook imports in ViewPage
   grep -n "useStuckDetection" src/player/pages/ViewPage.jsx
   ```

3. **Line count verification:**
   ```bash
   wc -l src/Player.jsx
   # Should be under 50 lines

   wc -l src/player/pages/ViewPage.jsx
   # Should be ~1000-1100 lines
   ```

4. **Run tests if they exist:**
   ```bash
   npm test -- --run 2>&1 | tail -20
   ```
   All existing tests should pass.

5. **Verify file structure:**
   ```bash
   ls -la src/player/pages/
   ls -la src/player/hooks/
   ```
  </action>
  <verify>
```bash
npm run build && echo "BUILD SUCCESS"
wc -l src/Player.jsx src/player/pages/ViewPage.jsx
```
  </verify>
  <done>
- Build succeeds
- Player.jsx under 50 lines
- ViewPage.jsx ~1000-1100 lines
- All imports resolve correctly
- Tests pass (if any exist)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **Line count check (PLAY-01):**
   ```bash
   wc -l src/Player.jsx
   ```
   Must be under 100 lines (target: ~40).

2. **Directory structure check (PLAY-05):**
   ```bash
   ls -la src/player/pages/
   ```
   Contains ViewPage.jsx and index.js.

3. **Hook usage check (PLAY-03):**
   ```bash
   grep "useStuckDetection" src/player/pages/ViewPage.jsx
   ```
   Hook is imported and used.

4. **Build check:**
   ```bash
   npm run build
   ```
   Builds without errors.

5. **Player routes check:**
   ```bash
   grep -A10 "export default function Player" src/Player.jsx
   ```
   Shows routing only.
</verification>

<success_criteria>
- [ ] `src/player/pages/` directory exists
- [ ] `src/player/pages/ViewPage.jsx` exists (~1000-1100 lines)
- [ ] `src/player/pages/index.js` exports ViewPage
- [ ] `src/Player.jsx` is under 50 lines
- [ ] Player.jsx only contains routing logic
- [ ] ViewPage uses useStuckDetection hook
- [ ] `npm run build` succeeds
- [ ] All player routes work (verified by build)
</success_criteria>

<output>
After completion, create `.planning/phases/24-player-restructure/24-02-SUMMARY.md`
</output>
