---
phase: 24-player-restructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/player/hooks/useStuckDetection.js
  - src/player/hooks/index.js
autonomous: true

must_haves:
  truths:
    - "useStuckDetection hook can be imported from player/hooks"
    - "Hook detects video stalls after 30 seconds without progress"
    - "Hook detects page inactivity after 5 minutes"
    - "Hook calls onVideoStuck callback when video is stuck"
    - "Hook calls onPageStuck callback when page is inactive"
  artifacts:
    - path: "src/player/hooks/useStuckDetection.js"
      provides: "Video and page stuck detection hook"
      exports: ["useStuckDetection"]
      min_lines: 50
    - path: "src/player/hooks/index.js"
      provides: "Barrel export including new hook"
      contains: "useStuckDetection"
  key_links:
    - from: "src/player/hooks/useStuckDetection.js"
      to: "useLogger"
      via: "import for logging"
      pattern: "import.*useLogger"
---

<objective>
Extract stuck detection logic from Player.jsx into a reusable, testable hook.

Purpose: Enable the stuck detection logic (video stall and page inactivity monitoring) to be tested in isolation and reused. This is the first step toward reducing Player.jsx line count and completing PLAY-03.

Output: A new `useStuckDetection` hook exported from `player/hooks/`, ready for use by ViewPage.
</objective>

<execution_context>
@/Users/massimodamico/.claude/get-shit-done/workflows/execute-plan.md
@/Users/massimodamico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/24-player-restructure/24-RESEARCH.md
@src/Player.jsx (lines 88-93 for STUCK_DETECTION constants, lines 392-437 for stuck detection useEffect)
@src/player/hooks/useKioskMode.js (reference for hook patterns in this codebase)
@src/player/hooks/index.js (barrel export to update)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useStuckDetection hook</name>
  <files>src/player/hooks/useStuckDetection.js</files>
  <action>
Create a new hook file that extracts the stuck detection logic currently inline in Player.jsx (lines 392-437).

The hook should:
1. Accept configuration object with refs and callbacks:
   - `videoRef` - ref to video element
   - `lastVideoTimeRef` - ref tracking last known video time
   - `lastActivityRef` - ref tracking last activity timestamp
   - `onVideoStuck` - callback when video is stuck (optional)
   - `onPageStuck` - callback when page is inactive too long (optional)

2. Include constants at module level (from Player.jsx lines 88-93):
   - `maxVideoStallMs: 30000` (30 seconds)
   - `maxNoActivityMs: 300000` (5 minutes)
   - `checkIntervalMs: 10000` (10 seconds)

3. Implement the checking logic in useEffect:
   - Check if video is playing but currentTime hasn't changed
   - If video stuck for > maxVideoStallMs, call onVideoStuck
   - If no activity for > maxNoActivityMs, call onPageStuck
   - Update lastVideoTimeRef and lastActivityRef when video progresses

4. Use `useLogger('useStuckDetection')` for logging (follow existing hook patterns)

5. Clean up interval on unmount

Do NOT include the `window.location.reload()` or video restart logic - those are actions the consumer decides. The hook only detects and notifies.

Export the hook as named export.
  </action>
  <verify>
File exists and exports useStuckDetection:
```bash
grep -n "export.*useStuckDetection" src/player/hooks/useStuckDetection.js
```
  </verify>
  <done>
useStuckDetection.js exists with:
- STUCK_DETECTION constants defined
- Hook accepting refs and callbacks
- useEffect with interval checking logic
- Cleanup on unmount
- Named export
  </done>
</task>

<task type="auto">
  <name>Task 2: Update hooks barrel export</name>
  <files>src/player/hooks/index.js</files>
  <action>
Add useStuckDetection to the barrel export in `player/hooks/index.js`.

Add the import and re-export following the existing pattern in the file:
```javascript
export { useStuckDetection } from './useStuckDetection.js';
```

Keep alphabetical order if the file is organized that way, otherwise add at the end.
  </action>
  <verify>
```bash
grep -n "useStuckDetection" src/player/hooks/index.js
```
  </verify>
  <done>
index.js exports useStuckDetection alongside existing hooks (usePlayerContent, useKioskMode, etc.)
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify hook is importable</name>
  <files>-</files>
  <action>
Run a quick verification that the hook can be imported without errors:

1. Run the existing test suite to ensure no regressions:
   ```bash
   npm test -- --run player/hooks
   ```
   (If no tests exist for hooks, that's OK - just verify no import errors)

2. Verify the file structure is correct:
   ```bash
   ls -la src/player/hooks/
   ```

3. Check that imports resolve correctly by running the dev build briefly:
   ```bash
   npm run build 2>&1 | grep -i error | head -5
   ```
   (A clean build confirms no import issues)
  </action>
  <verify>
```bash
npm run build 2>&1 | tail -5
```
Build succeeds without errors related to useStuckDetection.
  </verify>
  <done>
- Hook file exists in correct location
- Barrel export updated
- Build succeeds
- No import errors
  </done>
</task>

</tasks>

<verification>
After all tasks complete:

1. **File structure check:**
   ```bash
   ls src/player/hooks/useStuckDetection.js
   ```
   File exists.

2. **Export check:**
   ```bash
   grep "useStuckDetection" src/player/hooks/index.js
   ```
   Hook is exported.

3. **Build check:**
   ```bash
   npm run build
   ```
   Builds without errors.

4. **Hook API check:**
   ```bash
   grep -A5 "export function useStuckDetection" src/player/hooks/useStuckDetection.js
   ```
   Shows hook accepting refs and callbacks.
</verification>

<success_criteria>
- [ ] `src/player/hooks/useStuckDetection.js` exists (~60-80 lines)
- [ ] Hook exports named function `useStuckDetection`
- [ ] Hook accepts `{ videoRef, lastVideoTimeRef, lastActivityRef, onVideoStuck, onPageStuck }`
- [ ] Hook uses useEffect with interval
- [ ] Hook cleans up interval on unmount
- [ ] `src/player/hooks/index.js` re-exports useStuckDetection
- [ ] `npm run build` succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/24-player-restructure/24-01-SUMMARY.md`
</output>
