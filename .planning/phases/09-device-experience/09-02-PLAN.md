---
phase: 09-device-experience
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/player/hooks/useTapSequence.js
  - src/player/hooks/index.js
autonomous: true

must_haves:
  truths:
    - "5 consecutive taps within 2-second timeout triggers callback"
    - "Tap sequence resets if timeout exceeded between taps"
    - "No visual feedback during tap sequence"
  artifacts:
    - path: "src/player/hooks/useTapSequence.js"
      provides: "Hidden tap gesture detection hook"
      exports: ["useTapSequence"]
      min_lines: 40
    - path: "src/player/hooks/index.js"
      provides: "Barrel export for player hooks"
      contains: "useTapSequence"
  key_links:
    - from: "useTapSequence.js"
      to: "React refs"
      via: "useRef for count and timestamp"
      pattern: "useRef"
---

<objective>
Create useTapSequence hook for hidden kiosk exit trigger

Purpose: Enable 5-tap hidden exit mechanism with no visual feedback for security
Output: Reusable hook that tracks consecutive taps with timeout reset
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-device-experience/09-CONTEXT.md
@.planning/phases/09-device-experience/09-RESEARCH.md
@src/player/hooks/index.js
@src/player/hooks/useKioskMode.js (existing hook pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useTapSequence hook</name>
  <files>src/player/hooks/useTapSequence.js</files>
  <action>
Create new file implementing hidden tap gesture detection:

```javascript
/**
 * useTapSequence - Hidden tap gesture detection hook
 *
 * Tracks consecutive taps within a timeout window. Used for the hidden
 * kiosk exit trigger (5 taps in bottom-right corner with no visual feedback).
 *
 * Design decisions:
 * - Uses refs instead of state to avoid re-renders (no visual feedback)
 * - Timeout resets on each tap (not cumulative)
 * - Callback only fires once sequence completes
 *
 * @module player/hooks/useTapSequence
 */

import { useRef, useCallback } from 'react';

/**
 * Hook for detecting a sequence of consecutive taps
 *
 * @param {Object} options - Configuration options
 * @param {number} options.requiredTaps - Number of taps to trigger (default: 5)
 * @param {number} options.timeoutMs - Max time between taps in ms (default: 2000)
 * @param {Function} options.onTrigger - Callback when sequence completes
 * @returns {Object} { handleTap } - Attach to onClick/onTouchEnd
 *
 * @example
 * const { handleTap } = useTapSequence({
 *   requiredTaps: 5,
 *   timeoutMs: 2000,
 *   onTrigger: () => setShowPinEntry(true)
 * });
 *
 * <div onClick={handleTap} onTouchEnd={handleTap} />
 */
export function useTapSequence({
  requiredTaps = 5,
  timeoutMs = 2000,
  onTrigger
} = {}) {
  // Use refs to avoid re-renders (no visual feedback during sequence)
  const tapCountRef = useRef(0);
  const lastTapTimeRef = useRef(0);

  const handleTap = useCallback((event) => {
    // Prevent double-firing on touch devices (both onClick and onTouchEnd)
    if (event.type === 'touchend') {
      event.preventDefault();
    }

    const now = Date.now();
    const timeSinceLastTap = now - lastTapTimeRef.current;

    // Reset if timeout exceeded between taps
    if (timeSinceLastTap > timeoutMs) {
      tapCountRef.current = 0;
    }

    // Record this tap
    lastTapTimeRef.current = now;
    tapCountRef.current += 1;

    // Check if sequence complete
    if (tapCountRef.current >= requiredTaps) {
      // Reset for next sequence
      tapCountRef.current = 0;
      lastTapTimeRef.current = 0;

      // Fire callback
      onTrigger?.();
    }
  }, [requiredTaps, timeoutMs, onTrigger]);

  // Expose reset function for edge cases (component unmount, etc.)
  const reset = useCallback(() => {
    tapCountRef.current = 0;
    lastTapTimeRef.current = 0;
  }, []);

  return {
    handleTap,
    reset
  };
}

export default useTapSequence;
```

Key design decisions:
- Uses refs (not state) to avoid re-renders - important for "no visual feedback" requirement
- Handles both onClick and onTouchEnd with preventDefault to avoid double-firing
- Timeout is between consecutive taps, not total time for all taps
- Returns reset function for cleanup/edge cases
  </action>
  <verify>File exists with useTapSequence export: grep -n "export function useTapSequence" src/player/hooks/useTapSequence.js</verify>
  <done>useTapSequence hook created with 5-tap detection, 2-second timeout, and no visual feedback</done>
</task>

<task type="auto">
  <name>Task 2: Export useTapSequence from barrel</name>
  <files>src/player/hooks/index.js</files>
  <action>
Add useTapSequence to the barrel export file:

Add import and export:
```javascript
export { useTapSequence } from './useTapSequence.js';
```

The file should now export all 6 hooks:
- usePlayerContent
- usePlayerHeartbeat
- usePlayerCommands
- useKioskMode
- usePlayerPlayback
- useTapSequence (new)
  </action>
  <verify>grep -n "useTapSequence" src/player/hooks/index.js shows export</verify>
  <done>useTapSequence exported from player hooks barrel</done>
</task>

</tasks>

<verification>
1. Hook file exists: `ls src/player/hooks/useTapSequence.js`
2. Hook exported: `grep "useTapSequence" src/player/hooks/index.js`
3. Uses refs not state: `grep -c "useRef" src/player/hooks/useTapSequence.js` returns 2
4. Has JSDoc: `grep "@param" src/player/hooks/useTapSequence.js | wc -l` returns 3+
5. Build passes: `npm run build`
</verification>

<success_criteria>
- [ ] useTapSequence.js created with proper JSDoc documentation
- [ ] Hook uses useRef for tap count and last tap time (no visual feedback)
- [ ] Hook accepts requiredTaps, timeoutMs, onTrigger parameters
- [ ] Hook handles both onClick and onTouchEnd events
- [ ] Hook exported from src/player/hooks/index.js
- [ ] Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/09-device-experience/09-02-SUMMARY.md`
</output>
