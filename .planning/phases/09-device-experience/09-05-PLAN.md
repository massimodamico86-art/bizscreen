---
phase: 09-device-experience
plan: 05
type: execute
wave: 2
depends_on: ["09-01", "09-04"]
files_modified:
  - src/pages/PairDevicePage.jsx
  - src/router/AppRouter.jsx
  - src/services/screenService.js
autonomous: true

must_haves:
  truths:
    - "Admin can scan QR and see screen selection"
    - "Admin can pair device to existing screen or create new"
    - "Route /pair/:deviceId is protected (requires auth)"
  artifacts:
    - path: "src/pages/PairDevicePage.jsx"
      provides: "Admin pairing completion page"
      exports: ["PairDevicePage"]
      min_lines: 100
    - path: "src/router/AppRouter.jsx"
      provides: "Route for /pair/:deviceId"
      contains: "/pair/"
  key_links:
    - from: "PairDevicePage.jsx"
      to: "screenService"
      via: "pairDeviceToScreen function"
      pattern: "pairDeviceToScreen"
    - from: "AppRouter.jsx"
      to: "PairDevicePage"
      via: "Route element"
      pattern: "PairDevicePage"
---

<objective>
Create admin pairing page and routing for QR-based device pairing

Purpose: Allow admin to complete pairing after scanning QR code on device
Output: Protected route at /pair/:deviceId with screen selection UI
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-device-experience/09-CONTEXT.md
@.planning/phases/09-device-experience/09-RESEARCH.md
@src/router/AppRouter.jsx (routing structure)
@src/services/screenService.js
@src/pages/ScreensPage.jsx (screen listing pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pairDeviceToScreen function to screenService</name>
  <files>src/services/screenService.js</files>
  <action>
Add function to pair a device ID to a screen:

```javascript
/**
 * Pair a device to a screen using the device's unique ID
 * This is called when admin scans QR code and selects a screen
 *
 * @param {string} deviceId - Device UUID from QR code
 * @param {string} screenId - Screen UUID to pair with
 * @param {string} pin - Optional 4-digit kiosk PIN to set during pairing
 * @returns {Promise<Object>} Paired screen data
 */
export async function pairDeviceToScreen(deviceId, screenId, pin = null) {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error('User must be authenticated');

  // Update screen with device ID and mark as paired
  const updateData = {
    device_id: deviceId,
    is_paired: true,
    paired_at: new Date().toISOString(),
    last_seen_at: new Date().toISOString(),
  };

  const { data, error } = await supabase
    .from('tv_devices')
    .update(updateData)
    .eq('id', screenId)
    .eq('owner_id', user.id)
    .select(`
      *,
      assigned_playlist:playlists(id, name),
      assigned_layout:layouts(id, name)
    `)
    .single();

  if (error) throw error;

  // Set device PIN if provided
  if (pin && pin.length === 4) {
    await setDeviceKioskPin(screenId, pin);
  }

  logActivity(
    ACTIONS.SCREEN_PAIRED,
    RESOURCE_TYPES.SCREEN,
    screenId,
    data.device_name
  );

  return data;
}

/**
 * Create a new screen and pair it to a device in one operation
 *
 * @param {string} deviceId - Device UUID from QR code
 * @param {string} name - Name for the new screen
 * @param {string} pin - Optional 4-digit kiosk PIN
 * @returns {Promise<Object>} Created and paired screen data
 */
export async function createAndPairScreen(deviceId, name, pin = null) {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error('User must be authenticated');

  const otpCode = generateOtpCode();

  const { data, error } = await supabase
    .from('tv_devices')
    .insert({
      owner_id: user.id,
      device_name: name,
      otp_code: otpCode,
      device_id: deviceId,
      is_paired: true,
      paired_at: new Date().toISOString(),
      last_seen_at: new Date().toISOString(),
    })
    .select(`
      *,
      assigned_playlist:playlists(id, name),
      assigned_layout:layouts(id, name)
    `)
    .single();

  if (error) throw error;

  // Set device PIN if provided
  if (pin && pin.length === 4) {
    await setDeviceKioskPin(data.id, pin);
  }

  logActivity(
    ACTIONS.SCREEN_CREATED,
    RESOURCE_TYPES.SCREEN,
    data.id,
    data.device_name
  );

  return data;
}

/**
 * Check if a device ID is already paired
 * @param {string} deviceId - Device UUID
 * @returns {Promise<Object|null>} Screen data if paired, null if not
 */
export async function getScreenByDeviceId(deviceId) {
  const { data, error } = await supabase
    .from('tv_devices')
    .select(`
      *,
      assigned_playlist:playlists(id, name),
      assigned_layout:layouts(id, name)
    `)
    .eq('device_id', deviceId)
    .single();

  if (error && error.code !== 'PGRST116') throw error; // PGRST116 = no rows
  return data || null;
}
```

Also add `device_id` to the screen data returned by `getScreens` if not already present.

Note: ACTIONS.SCREEN_PAIRED may need to be added to the ACTIONS object if not already present.
  </action>
  <verify>grep -n "pairDeviceToScreen\|createAndPairScreen\|getScreenByDeviceId" src/services/screenService.js shows all 3 functions</verify>
  <done>screenService exports pairDeviceToScreen, createAndPairScreen, getScreenByDeviceId functions</done>
</task>

<task type="auto">
  <name>Task 2: Create PairDevicePage component</name>
  <files>src/pages/PairDevicePage.jsx</files>
  <action>
Create new page component for admin to complete pairing:

```javascript
/**
 * PairDevicePage - Admin page to complete device pairing
 *
 * Accessed when admin scans QR code from device.
 * Shows list of existing screens or option to create new.
 * Completes pairing when admin selects a screen.
 *
 * @module pages/PairDevicePage
 */

import { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import { Monitor, Plus, Check, Loader2, AlertCircle } from 'lucide-react';
import {
  getScreens,
  pairDeviceToScreen,
  createAndPairScreen,
  getScreenByDeviceId,
} from '../services/screenService';
import { useLogger } from '../hooks/useLogger';

export default function PairDevicePage() {
  const { deviceId } = useParams();
  const navigate = useNavigate();
  const logger = useLogger('PairDevicePage');

  const [screens, setScreens] = useState([]);
  const [loading, setLoading] = useState(true);
  const [pairing, setPairing] = useState(false);
  const [error, setError] = useState('');
  const [success, setSuccess] = useState(false);
  const [alreadyPaired, setAlreadyPaired] = useState(null);

  // New screen form
  const [showCreateForm, setShowCreateForm] = useState(false);
  const [newScreenName, setNewScreenName] = useState('');
  const [kioskPin, setKioskPin] = useState('');

  // Load screens and check if device already paired
  useEffect(() => {
    async function loadData() {
      try {
        // Check if already paired
        const existingScreen = await getScreenByDeviceId(deviceId);
        if (existingScreen) {
          setAlreadyPaired(existingScreen);
          setLoading(false);
          return;
        }

        // Load available screens (unpaired only)
        const allScreens = await getScreens();
        const unpairedScreens = allScreens.filter(s => !s.is_paired);
        setScreens(unpairedScreens);
      } catch (err) {
        logger.error('Failed to load screens', { error: err });
        setError('Failed to load screens. Please try again.');
      } finally {
        setLoading(false);
      }
    }

    if (deviceId) {
      loadData();
    }
  }, [deviceId, logger]);

  // Handle pairing to existing screen
  const handlePairToScreen = async (screenId) => {
    setPairing(true);
    setError('');

    try {
      await pairDeviceToScreen(deviceId, screenId, kioskPin || null);
      setSuccess(true);
      setTimeout(() => navigate('/app/screens'), 2000);
    } catch (err) {
      logger.error('Pairing failed', { error: err, deviceId, screenId });
      setError('Pairing failed. Please try again.');
      setPairing(false);
    }
  };

  // Handle creating new screen and pairing
  const handleCreateAndPair = async (e) => {
    e.preventDefault();
    if (!newScreenName.trim()) {
      setError('Please enter a screen name');
      return;
    }

    setPairing(true);
    setError('');

    try {
      await createAndPairScreen(deviceId, newScreenName.trim(), kioskPin || null);
      setSuccess(true);
      setTimeout(() => navigate('/app/screens'), 2000);
    } catch (err) {
      logger.error('Create and pair failed', { error: err, deviceId, name: newScreenName });
      setError('Failed to create screen. Please try again.');
      setPairing(false);
    }
  };

  // Already paired state
  if (alreadyPaired) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-xl shadow-lg p-8 max-w-md w-full text-center">
          <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <Check className="w-8 h-8 text-green-600" />
          </div>
          <h2 className="text-xl font-semibold text-gray-900 mb-2">
            Device Already Paired
          </h2>
          <p className="text-gray-600 mb-4">
            This device is already paired to <strong>{alreadyPaired.device_name}</strong>
          </p>
          <button
            onClick={() => navigate('/app/screens')}
            className="w-full py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700"
          >
            Go to Screens
          </button>
        </div>
      </div>
    );
  }

  // Success state
  if (success) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
        <div className="bg-white rounded-xl shadow-lg p-8 max-w-md w-full text-center">
          <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <Check className="w-8 h-8 text-green-600" />
          </div>
          <h2 className="text-xl font-semibold text-gray-900 mb-2">
            Pairing Successful!
          </h2>
          <p className="text-gray-600">
            The device will start displaying content shortly.
          </p>
          <p className="text-sm text-gray-500 mt-4">
            Redirecting to screens...
          </p>
        </div>
      </div>
    );
  }

  // Loading state
  if (loading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <Loader2 className="w-8 h-8 text-blue-600 animate-spin" />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 py-8 px-4">
      <div className="max-w-2xl mx-auto">
        {/* Header */}
        <div className="text-center mb-8">
          <div className="w-16 h-16 bg-blue-100 rounded-xl flex items-center justify-center mx-auto mb-4">
            <Monitor className="w-8 h-8 text-blue-600" />
          </div>
          <h1 className="text-2xl font-bold text-gray-900 mb-2">
            Pair Device
          </h1>
          <p className="text-gray-600">
            Select a screen or create a new one to pair this device
          </p>
          <p className="text-sm text-gray-400 mt-1 font-mono">
            Device: {deviceId.slice(0, 8)}...
          </p>
        </div>

        {/* Error */}
        {error && (
          <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-center gap-3">
            <AlertCircle className="w-5 h-5 text-red-600 flex-shrink-0" />
            <p className="text-red-700">{error}</p>
          </div>
        )}

        {/* Optional PIN */}
        <div className="bg-white rounded-lg shadow-sm p-4 mb-6">
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Kiosk PIN (optional)
          </label>
          <input
            type="text"
            inputMode="numeric"
            pattern="[0-9]*"
            maxLength={4}
            value={kioskPin}
            onChange={(e) => setKioskPin(e.target.value.replace(/\D/g, ''))}
            placeholder="4-digit PIN"
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
          <p className="text-xs text-gray-500 mt-1">
            Set a PIN to enable kiosk exit on this device
          </p>
        </div>

        {/* Create New Screen */}
        <div className="bg-white rounded-lg shadow-sm mb-4">
          {showCreateForm ? (
            <form onSubmit={handleCreateAndPair} className="p-4">
              <input
                type="text"
                value={newScreenName}
                onChange={(e) => setNewScreenName(e.target.value)}
                placeholder="Enter screen name"
                autoFocus
                className="w-full px-4 py-3 border border-gray-300 rounded-lg mb-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
              />
              <div className="flex gap-3">
                <button
                  type="button"
                  onClick={() => setShowCreateForm(false)}
                  disabled={pairing}
                  className="flex-1 py-3 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50"
                >
                  Cancel
                </button>
                <button
                  type="submit"
                  disabled={pairing || !newScreenName.trim()}
                  className="flex-1 py-3 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                >
                  {pairing ? <Loader2 className="w-5 h-5 animate-spin" /> : null}
                  Create & Pair
                </button>
              </div>
            </form>
          ) : (
            <button
              onClick={() => setShowCreateForm(true)}
              disabled={pairing}
              className="w-full p-4 flex items-center gap-4 text-left hover:bg-gray-50 transition-colors"
            >
              <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center flex-shrink-0">
                <Plus className="w-6 h-6 text-blue-600" />
              </div>
              <div>
                <p className="font-medium text-gray-900">Create New Screen</p>
                <p className="text-sm text-gray-500">Add a new screen and pair this device</p>
              </div>
            </button>
          )}
        </div>

        {/* Existing Screens */}
        {screens.length > 0 && (
          <>
            <p className="text-sm font-medium text-gray-500 mb-2 px-1">
              Or select an existing screen:
            </p>
            <div className="bg-white rounded-lg shadow-sm divide-y divide-gray-100">
              {screens.map((screen) => (
                <button
                  key={screen.id}
                  onClick={() => handlePairToScreen(screen.id)}
                  disabled={pairing}
                  className="w-full p-4 flex items-center gap-4 text-left hover:bg-gray-50 transition-colors disabled:opacity-50"
                >
                  <div className="w-12 h-12 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0">
                    <Monitor className="w-6 h-6 text-gray-600" />
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="font-medium text-gray-900 truncate">{screen.device_name}</p>
                    <p className="text-sm text-gray-500">
                      {screen.assigned_playlist?.name || screen.assigned_layout?.name || 'No content assigned'}
                    </p>
                  </div>
                  {pairing ? (
                    <Loader2 className="w-5 h-5 text-blue-600 animate-spin" />
                  ) : null}
                </button>
              ))}
            </div>
          </>
        )}

        {screens.length === 0 && !showCreateForm && (
          <p className="text-center text-gray-500 py-8">
            No unpaired screens available. Create a new one above.
          </p>
        )}
      </div>
    </div>
  );
}
```
  </action>
  <verify>File exists: ls src/pages/PairDevicePage.jsx</verify>
  <done>PairDevicePage created with screen selection, create new option, and optional PIN setting</done>
</task>

<task type="auto">
  <name>Task 3: Add /pair/:deviceId route to AppRouter</name>
  <files>src/router/AppRouter.jsx</files>
  <action>
1. Add lazy import for PairDevicePage at the top with other page imports:
```javascript
const PairDevicePage = lazy(() => import('../pages/PairDevicePage'));
```

2. Add protected route for /pair/:deviceId between auth routes and app routes:
```javascript
{/* Device Pairing Route (protected - requires auth) */}
<Route
  path="/pair/:deviceId"
  element={
    <RequireAuth>
      <Suspense fallback={<LoadingSpinner />}>
        <PairDevicePage />
      </Suspense>
    </RequireAuth>
  }
/>
```

Place this after the auth routes and before the /app/* routes section.
  </action>
  <verify>grep -n "/pair/:deviceId\|PairDevicePage" src/router/AppRouter.jsx shows both import and route</verify>
  <done>AppRouter has protected /pair/:deviceId route pointing to PairDevicePage</done>
</task>

</tasks>

<verification>
1. screenService has pairing functions: `grep -c "pairDeviceToScreen\|createAndPairScreen" src/services/screenService.js` returns 2+
2. PairDevicePage exists: `ls src/pages/PairDevicePage.jsx`
3. Route added: `grep "/pair/:deviceId" src/router/AppRouter.jsx`
4. Route is protected: `grep -A5 "/pair/:deviceId" src/router/AppRouter.jsx | grep RequireAuth`
5. Build passes: `npm run build`
</verification>

<success_criteria>
- [ ] screenService exports pairDeviceToScreen, createAndPairScreen, getScreenByDeviceId
- [ ] PairDevicePage.jsx created with screen selection and create new form
- [ ] PairDevicePage handles optional kiosk PIN during pairing
- [ ] /pair/:deviceId route added to AppRouter
- [ ] Route is protected with RequireAuth
- [ ] Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/09-device-experience/09-05-SUMMARY.md`
</output>
