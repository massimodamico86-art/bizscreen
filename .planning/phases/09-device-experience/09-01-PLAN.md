---
phase: 09-device-experience
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/117_device_experience.sql
  - src/services/playerService.js
  - src/services/screenService.js
autonomous: true

must_haves:
  truths:
    - "Device can store PIN hash locally for offline validation"
    - "Master PIN from tenant profile can be fetched for device"
    - "PIN hashing uses SHA-256 (existing pattern)"
  artifacts:
    - path: "supabase/migrations/117_device_experience.sql"
      provides: "Database schema for PIN storage"
      contains: "kiosk_pin_hash"
    - path: "src/services/playerService.js"
      provides: "PIN hash and validation functions"
      exports: ["hashPin", "cacheKioskPinHash", "validatePinOffline"]
    - path: "src/services/screenService.js"
      provides: "Master PIN management functions"
      exports: ["setMasterKioskPin", "getMasterKioskPin"]
  key_links:
    - from: "playerService.js"
      to: "localStorage"
      via: "kiosk_pin_hash storage"
      pattern: "localStorage\\.(set|get)Item.*kiosk_pin"
    - from: "migration"
      to: "profiles table"
      via: "master_kiosk_pin_hash column"
      pattern: "ALTER TABLE.*profiles"
---

<objective>
Create database schema and service functions for PIN-based kiosk exit

Purpose: Enable offline PIN validation by storing hashed PINs both in database (sync) and localStorage (offline)
Output: Migration file with PIN columns and RPC, extended playerService and screenService with PIN functions
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-device-experience/09-CONTEXT.md
@.planning/phases/09-device-experience/09-RESEARCH.md
@src/services/playerService.js (lines 540-603 - existing hash functions)
@src/services/screenService.js
@supabase/migrations/029_device_commands_and_offline_mode.sql (existing kiosk columns)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for PIN storage</name>
  <files>supabase/migrations/117_device_experience.sql</files>
  <action>
Create migration file with:

1. Add PIN columns to tv_devices table:
```sql
ALTER TABLE public.tv_devices
ADD COLUMN IF NOT EXISTS kiosk_pin_hash TEXT,
ADD COLUMN IF NOT EXISTS kiosk_pin_set_at TIMESTAMPTZ;
```

2. Add master PIN columns to profiles table:
```sql
ALTER TABLE public.profiles
ADD COLUMN IF NOT EXISTS master_kiosk_pin_hash TEXT,
ADD COLUMN IF NOT EXISTS master_kiosk_pin_set_at TIMESTAMPTZ;
```

3. Create RPC function to get both device and master PIN hashes for a device:
```sql
CREATE OR REPLACE FUNCTION get_device_kiosk_pins(p_device_id UUID)
RETURNS JSONB
LANGUAGE sql
SECURITY DEFINER
AS $$
  SELECT jsonb_build_object(
    'device_pin_hash', td.kiosk_pin_hash,
    'master_pin_hash', p.master_kiosk_pin_hash
  )
  FROM tv_devices td
  LEFT JOIN profiles p ON p.id = td.owner_id
  WHERE td.id = p_device_id;
$$;
```

4. Create RPC to set device PIN (during pairing):
```sql
CREATE OR REPLACE FUNCTION set_device_kiosk_pin(p_device_id UUID, p_pin_hash TEXT)
RETURNS VOID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  UPDATE tv_devices
  SET kiosk_pin_hash = p_pin_hash,
      kiosk_pin_set_at = NOW()
  WHERE id = p_device_id
    AND owner_id = auth.uid();
END;
$$;
```

5. Create RPC to set master PIN (for tenant):
```sql
CREATE OR REPLACE FUNCTION set_master_kiosk_pin(p_pin_hash TEXT)
RETURNS VOID
LANGUAGE plpgsql
SECURITY DEFINER
AS $$
BEGIN
  UPDATE profiles
  SET master_kiosk_pin_hash = p_pin_hash,
      master_kiosk_pin_set_at = NOW()
  WHERE id = auth.uid();
END;
$$;
```

6. Grant permissions:
```sql
GRANT EXECUTE ON FUNCTION get_device_kiosk_pins(UUID) TO authenticated;
GRANT EXECUTE ON FUNCTION set_device_kiosk_pin(UUID, TEXT) TO authenticated;
GRANT EXECUTE ON FUNCTION set_master_kiosk_pin(TEXT) TO authenticated;
```

Add comments explaining each function's purpose.
  </action>
  <verify>File exists at supabase/migrations/117_device_experience.sql with ALTER TABLE and CREATE FUNCTION statements</verify>
  <done>Migration file contains PIN columns for tv_devices and profiles, plus RPC functions for get/set operations</done>
</task>

<task type="auto">
  <name>Task 2: Add PIN functions to playerService</name>
  <files>src/services/playerService.js</files>
  <action>
Add new functions near existing hashPassword (around line 550). Reuse the existing hashPassword function internally.

1. Export a generic PIN hash function (4-digit PIN):
```javascript
/**
 * Hash a 4-digit PIN using SHA-256
 * @param {string} pin - 4-digit PIN
 * @returns {Promise<string>} Hex-encoded hash
 */
export async function hashPin(pin) {
  // Reuse existing hashPassword internally
  return hashPassword(pin);
}
```

2. Cache PIN hash for offline validation (stores both device and master PIN):
```javascript
/**
 * Cache device and master PIN hashes for offline kiosk exit
 * Call this after fetching content or on heartbeat
 * @param {string|null} devicePinHash - Device-specific PIN hash
 * @param {string|null} masterPinHash - Tenant master PIN hash
 */
export function cacheKioskPinHashes(devicePinHash, masterPinHash) {
  if (devicePinHash) {
    localStorage.setItem('kiosk_device_pin_hash', devicePinHash);
  }
  if (masterPinHash) {
    localStorage.setItem('kiosk_master_pin_hash', masterPinHash);
  }
  logger.debug('[PlayerService] Cached kiosk PIN hashes for offline use');
}
```

3. Validate PIN offline (checks both device and master PIN):
```javascript
/**
 * Validate PIN against cached hashes (works offline)
 * Accepts either device PIN or master PIN
 * @param {string} inputPin - PIN attempt (4 digits)
 * @returns {Promise<boolean>} True if PIN matches either hash
 */
export async function validatePinOffline(inputPin) {
  const deviceHash = localStorage.getItem('kiosk_device_pin_hash');
  const masterHash = localStorage.getItem('kiosk_master_pin_hash');

  if (!deviceHash && !masterHash) {
    logger.warn('[PlayerService] No cached PIN hashes for offline validation');
    return false;
  }

  try {
    const inputHash = await hashPassword(inputPin);

    // Accept either device PIN or master PIN
    if (deviceHash && inputHash === deviceHash) {
      logger.debug('[PlayerService] Device PIN validated offline');
      return true;
    }
    if (masterHash && inputHash === masterHash) {
      logger.debug('[PlayerService] Master PIN validated offline');
      return true;
    }

    return false;
  } catch (error) {
    logger.error('[PlayerService] PIN validation failed', { error: error.message });
    return false;
  }
}
```

4. Add export for hashPin, cacheKioskPinHashes, validatePinOffline.
  </action>
  <verify>grep -n "hashPin\|cacheKioskPinHashes\|validatePinOffline" src/services/playerService.js shows new exports</verify>
  <done>playerService exports hashPin, cacheKioskPinHashes, validatePinOffline functions</done>
</task>

<task type="auto">
  <name>Task 3: Add master PIN functions to screenService</name>
  <files>src/services/screenService.js</files>
  <action>
Add functions for managing tenant-level master PIN:

1. Set master PIN for tenant (admin use):
```javascript
/**
 * Set master kiosk PIN for all devices in tenant
 * @param {string} pin - 4-digit PIN (will be hashed)
 * @returns {Promise<boolean>} Success
 */
export async function setMasterKioskPin(pin) {
  const { hashPin } = await import('./playerService.js');
  const pinHash = await hashPin(pin);

  const { error } = await supabase.rpc('set_master_kiosk_pin', {
    p_pin_hash: pinHash
  });

  if (error) {
    logger.error('Failed to set master PIN', { error: error.message });
    throw error;
  }

  logger.info('Master kiosk PIN updated');
  return true;
}
```

2. Get master PIN hash (for display status only - not the actual PIN):
```javascript
/**
 * Check if master kiosk PIN is set for tenant
 * @returns {Promise<{ isSet: boolean, setAt: string|null }>}
 */
export async function getMasterPinStatus() {
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) throw new Error('User must be authenticated');

  const { data, error } = await supabase
    .from('profiles')
    .select('master_kiosk_pin_hash, master_kiosk_pin_set_at')
    .eq('id', user.id)
    .single();

  if (error) throw error;

  return {
    isSet: !!data?.master_kiosk_pin_hash,
    setAt: data?.master_kiosk_pin_set_at
  };
}
```

3. Set device-specific PIN during screen creation or configuration:
```javascript
/**
 * Set kiosk PIN for a specific device
 * @param {string} deviceId - Device UUID
 * @param {string} pin - 4-digit PIN (will be hashed)
 * @returns {Promise<boolean>} Success
 */
export async function setDeviceKioskPin(deviceId, pin) {
  const { hashPin } = await import('./playerService.js');
  const pinHash = await hashPin(pin);

  const { error } = await supabase.rpc('set_device_kiosk_pin', {
    p_device_id: deviceId,
    p_pin_hash: pinHash
  });

  if (error) {
    logger.error('Failed to set device PIN', { error: error.message, deviceId });
    throw error;
  }

  logger.info('Device kiosk PIN updated', { deviceId });
  return true;
}
```

Import logger at top if not already present:
```javascript
import { createScopedLogger } from './loggingService.js';
const logger = createScopedLogger('screenService');
```
  </action>
  <verify>grep -n "setMasterKioskPin\|getMasterPinStatus\|setDeviceKioskPin" src/services/screenService.js shows new exports</verify>
  <done>screenService exports setMasterKioskPin, getMasterPinStatus, setDeviceKioskPin functions</done>
</task>

</tasks>

<verification>
1. Migration file exists: `ls supabase/migrations/117_device_experience.sql`
2. playerService has PIN functions: `grep -c "export.*function.*Pin" src/services/playerService.js` returns 3+
3. screenService has PIN functions: `grep -c "export.*function.*Pin" src/services/screenService.js` returns 3
4. Build passes: `npm run build` completes without errors
</verification>

<success_criteria>
- [ ] Migration 117 adds kiosk_pin_hash to tv_devices and master_kiosk_pin_hash to profiles
- [ ] RPC functions created for get/set PIN operations
- [ ] playerService exports hashPin, cacheKioskPinHashes, validatePinOffline
- [ ] screenService exports setMasterKioskPin, getMasterPinStatus, setDeviceKioskPin
- [ ] Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/09-device-experience/09-01-SUMMARY.md`
</output>
