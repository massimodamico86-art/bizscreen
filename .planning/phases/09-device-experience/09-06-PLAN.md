---
phase: 09-device-experience
plan: 06
type: execute
wave: 2
depends_on: ["09-01", "09-02", "09-03", "09-04"]
files_modified:
  - src/Player.jsx
  - src/player/hooks/useKioskMode.js
autonomous: true

must_haves:
  truths:
    - "Unpaired player shows QR pairing screen instead of OTP entry"
    - "5-tap in bottom-right corner shows PIN entry"
    - "PIN validated offline using cached hashes"
    - "Device polls for pairing completion and auto-transitions"
  artifacts:
    - path: "src/Player.jsx"
      provides: "Integrated QR pairing and PIN exit"
      contains: "PairingScreen"
    - path: "src/player/hooks/useKioskMode.js"
      provides: "Extended with PIN validation"
      contains: "validatePinOffline"
  key_links:
    - from: "Player.jsx"
      to: "PairingScreen"
      via: "component import and render"
      pattern: "PairingScreen"
    - from: "Player.jsx"
      to: "useTapSequence"
      via: "hook import and usage"
      pattern: "useTapSequence"
    - from: "useKioskMode.js"
      to: "validatePinOffline"
      via: "PIN validation function"
      pattern: "validatePinOffline"
---

<objective>
Integrate QR pairing and PIN exit into Player.jsx

Purpose: Connect all Phase 9 components into the player for field technician experience
Output: Player shows QR for pairing, 5-tap triggers PIN exit, offline PIN validation works
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-device-experience/09-CONTEXT.md
@.planning/phases/09-device-experience/09-RESEARCH.md
@src/Player.jsx
@src/player/hooks/useKioskMode.js
@src/player/hooks/useTapSequence.js (from 09-02)
@src/player/components/PinEntry.jsx (from 09-03)
@src/player/components/PairingScreen.jsx (from 09-04)
@src/services/playerService.js (validatePinOffline from 09-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update useKioskMode to support PIN validation</name>
  <files>src/player/hooks/useKioskMode.js</files>
  <action>
Update the useKioskMode hook to support PIN-based exit alongside password:

1. Add import for PIN validation:
```javascript
import {
  isFullscreen,
  enterFullscreen,
  exitFullscreen,
  validateKioskPassword,
  validatePinOffline,
} from '../../services/playerService';
```

2. Add state for PIN entry mode:
```javascript
const [showPinEntry, setShowPinEntry] = useState(false);
```

3. Add PIN validation handler (alongside existing password handler):
```javascript
// Handle kiosk exit with PIN (new method)
const handlePinExit = useCallback(async (pin) => {
  try {
    const isValid = await validatePinOffline(pin);
    if (!isValid) {
      return false; // Let PinEntry component handle error display
    }

    // Exit kiosk mode
    setKioskMode(false);
    setShowPinEntry(false);
    localStorage.setItem(STORAGE_KEYS.kioskMode, 'false');
    exitFullscreen().catch((err) =>
      logger.warn('Failed to exit fullscreen', { error: err })
    );
    logger.info('Exited kiosk mode via PIN');
    return true;
  } catch (err) {
    logger.error('PIN validation error', { error: err });
    return false;
  }
}, [logger]);

// Show PIN entry (called by tap sequence trigger)
const showPinEntryDialog = useCallback(() => {
  setShowPinEntry(true);
}, []);

// Dismiss PIN entry
const dismissPinEntry = useCallback(() => {
  setShowPinEntry(false);
}, []);
```

4. Update return object to include new exports:
```javascript
return {
  kioskMode,
  showKioskExit,
  showPinEntry,          // new
  kioskPasswordInput,
  kioskPasswordError,
  setKioskPasswordInput,
  handleKioskExit,
  handlePinExit,         // new
  cancelKioskExit,
  showPinEntryDialog,    // new
  dismissPinEntry,       // new
  initKioskMode,
};
```
  </action>
  <verify>grep -n "showPinEntry\|handlePinExit\|validatePinOffline" src/player/hooks/useKioskMode.js shows all additions</verify>
  <done>useKioskMode extended with PIN entry state and validation handler</done>
</task>

<task type="auto">
  <name>Task 2: Update PairPage to use QR pairing screen</name>
  <files>src/Player.jsx</files>
  <action>
Update the PairPage component in Player.jsx:

1. Add imports at top of file:
```javascript
import { PairingScreen } from './player/components/PairingScreen';
```

2. Add state for pairing mode in PairPage function:
```javascript
const [useQrPairing, setUseQrPairing] = useState(true);
```

3. Add polling for pairing completion:
```javascript
// Poll for pairing completion when using QR mode
useEffect(() => {
  if (!useQrPairing) return;

  const deviceId = localStorage.getItem('player_device_id');
  if (!deviceId) return;

  const pollInterval = setInterval(async () => {
    try {
      // Check if this device has been paired by querying with device_id
      const { data, error } = await supabase
        .from('tv_devices')
        .select('id')
        .eq('device_id', deviceId)
        .eq('is_paired', true)
        .single();

      if (data && !error) {
        // Device paired! Store screen ID and navigate
        localStorage.setItem(STORAGE_KEYS.screenId, data.id);
        clearInterval(pollInterval);
        navigate('/player/view', { replace: true });
      }
    } catch (err) {
      // Ignore errors, just keep polling
    }
  }, 3000); // Poll every 3 seconds

  return () => clearInterval(pollInterval);
}, [useQrPairing, navigate]);
```

4. Update the render to conditionally show QR or OTP:
```javascript
// At the start of PairPage's return statement:
if (useQrPairing) {
  return (
    <PairingScreen
      onFallbackToOtp={() => setUseQrPairing(false)}
    />
  );
}

// Rest of existing OTP form UI...
```

5. Add a button to switch back to QR mode in the existing OTP UI:
After the existing form, add:
```javascript
{!useQrPairing && (
  <button
    onClick={() => setUseQrPairing(true)}
    style={{
      background: 'transparent',
      border: 'none',
      color: '#64748b',
      fontSize: '0.875rem',
      cursor: 'pointer',
      marginTop: '1rem',
      textDecoration: 'underline',
    }}
  >
    Use QR code instead
  </button>
)}
```
  </action>
  <verify>grep -n "PairingScreen\|useQrPairing\|player_device_id" src/Player.jsx shows all additions</verify>
  <done>PairPage shows QR pairing by default with fallback to OTP entry</done>
</task>

<task type="auto">
  <name>Task 3: Add hidden tap trigger and PIN entry to ViewPage</name>
  <files>src/Player.jsx</files>
  <action>
Update the ViewPage component in Player.jsx:

1. Add imports at top of file (with existing imports):
```javascript
import { useTapSequence } from './player/hooks';
import { PinEntry } from './player/components/PinEntry';
import { cacheKioskPinHashes } from './services/playerService';
```

2. In ViewPage, destructure new exports from useKioskMode:
```javascript
const {
  kioskMode,
  showKioskExit,
  showPinEntry,          // new
  kioskPasswordInput,
  kioskPasswordError,
  setKioskPasswordInput,
  handleKioskExit,
  handlePinExit,         // new
  cancelKioskExit,
  showPinEntryDialog,    // new
  dismissPinEntry,       // new
} = useKioskMode();
```

3. Add tap sequence hook:
```javascript
// Hidden tap trigger for kiosk exit (5 taps in bottom-right corner)
const { handleTap: handleExitTap } = useTapSequence({
  requiredTaps: 5,
  timeoutMs: 2000,
  onTrigger: showPinEntryDialog,
});
```

4. Cache PIN hashes when content loads (add to content loading effect or heartbeat):
In the useEffect that handles content loading, after successfully loading content, add:
```javascript
// Cache PIN hashes for offline kiosk exit
if (data.devicePinHash || data.masterPinHash) {
  cacheKioskPinHashes(data.devicePinHash, data.masterPinHash);
}
```

Note: The RPC will need to return these hashes. For now, we'll fetch them separately on heartbeat.
Add a new effect to fetch and cache PIN hashes:
```javascript
// Fetch and cache PIN hashes for offline kiosk exit
useEffect(() => {
  if (!screenId || !kioskMode) return;

  const fetchPinHashes = async () => {
    try {
      const { data, error } = await supabase.rpc('get_device_kiosk_pins', {
        p_device_id: screenId
      });
      if (data && !error) {
        cacheKioskPinHashes(data.device_pin_hash, data.master_pin_hash);
      }
    } catch (err) {
      logger.debug('PIN hash fetch failed (offline?)', { error: err });
    }
  };

  fetchPinHashes();
  // Re-fetch on heartbeat interval
  const interval = setInterval(fetchPinHashes, HEARTBEAT_INTERVAL);
  return () => clearInterval(interval);
}, [screenId, kioskMode, logger]);
```

5. Add hidden tap zone in the render (inside the main content container, at the end):
```javascript
{/* Hidden tap zone for kiosk exit (bottom-right corner) */}
{kioskMode && (
  <div
    onClick={handleExitTap}
    onTouchEnd={handleExitTap}
    style={{
      position: 'absolute',
      bottom: 0,
      right: 0,
      width: '100px',
      height: '100px',
      zIndex: 100,
      // Invisible - no background, border, or visual feedback
    }}
    aria-hidden="true"
  />
)}
```

6. Add PIN entry overlay (after kiosk exit dialog, before closing div):
```javascript
{/* PIN entry (triggered by 5-tap) */}
{showPinEntry && (
  <PinEntry
    onValidate={handlePinExit}
    onDismiss={dismissPinEntry}
    onSuccess={() => {
      // Kiosk exit already handled in handlePinExit
    }}
  />
)}
```
  </action>
  <verify>grep -n "handleExitTap\|showPinEntry\|PinEntry\|cacheKioskPinHashes" src/Player.jsx shows all additions</verify>
  <done>ViewPage has hidden 5-tap trigger, PIN entry modal, and PIN hash caching</done>
</task>

</tasks>

<verification>
1. useKioskMode has PIN support: `grep "showPinEntry\|handlePinExit" src/player/hooks/useKioskMode.js`
2. PairPage uses QR: `grep "PairingScreen\|useQrPairing" src/Player.jsx`
3. ViewPage has tap trigger: `grep "handleExitTap\|useTapSequence" src/Player.jsx`
4. PIN entry integrated: `grep "PinEntry\|showPinEntry" src/Player.jsx`
5. PIN caching: `grep "cacheKioskPinHashes" src/Player.jsx`
6. Build passes: `npm run build`
</verification>

<success_criteria>
- [ ] useKioskMode exports showPinEntry, handlePinExit, showPinEntryDialog, dismissPinEntry
- [ ] PairPage shows PairingScreen (QR) by default
- [ ] PairPage polls for pairing completion and auto-navigates
- [ ] PairPage has fallback to OTP entry
- [ ] ViewPage has 100x100px invisible tap zone in bottom-right
- [ ] 5-tap sequence triggers PIN entry overlay
- [ ] PIN hashes cached on content load/heartbeat for offline validation
- [ ] Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/09-device-experience/09-06-SUMMARY.md`
</output>
