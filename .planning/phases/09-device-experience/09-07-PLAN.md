---
phase: 09-device-experience
plan: 07
type: execute
wave: 3
depends_on: ["09-01", "09-05", "09-06"]
files_modified:
  - src/pages/ScreensPage.jsx
  - src/pages/components/ScreensComponents.jsx
autonomous: true

must_haves:
  truths:
    - "Admin can set/update master kiosk PIN for tenant"
    - "Master PIN status (set/not set) visible in settings"
    - "PIN is 4 digits only"
  artifacts:
    - path: "src/pages/ScreensPage.jsx"
      provides: "Master PIN management UI"
      contains: "masterPinModal"
  key_links:
    - from: "ScreensPage.jsx"
      to: "setMasterKioskPin"
      via: "service function call"
      pattern: "setMasterKioskPin"
---

<objective>
Add master kiosk PIN management to ScreensPage

Purpose: Allow admin to set tenant-level master PIN that works on all devices
Output: Settings button/modal in ScreensPage for master PIN configuration
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-device-experience/09-CONTEXT.md
@.planning/phases/09-device-experience/09-RESEARCH.md
@src/pages/ScreensPage.jsx
@src/services/screenService.js (setMasterKioskPin, getMasterPinStatus from 09-01)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add master PIN modal to ScreensPage</name>
  <files>src/pages/ScreensPage.jsx</files>
  <action>
Add master PIN management functionality to ScreensPage:

1. Add imports at top:
```javascript
import { setMasterKioskPin, getMasterPinStatus } from '../services/screenService';
import { Key } from 'lucide-react'; // For PIN icon
```

2. Add state for master PIN modal:
```javascript
// Master PIN management
const [showMasterPinModal, setShowMasterPinModal] = useState(false);
const [masterPinInput, setMasterPinInput] = useState('');
const [masterPinConfirm, setMasterPinConfirm] = useState('');
const [masterPinStatus, setMasterPinStatus] = useState({ isSet: false, setAt: null });
const [masterPinError, setMasterPinError] = useState('');
const [masterPinSaving, setMasterPinSaving] = useState(false);
```

3. Add effect to load master PIN status:
```javascript
// Load master PIN status
useEffect(() => {
  async function loadPinStatus() {
    try {
      const status = await getMasterPinStatus();
      setMasterPinStatus(status);
    } catch (err) {
      logger.debug('Failed to load PIN status', { error: err });
    }
  }
  loadPinStatus();
}, [logger]);
```

4. Add handler for saving master PIN:
```javascript
const handleSaveMasterPin = async () => {
  // Validate
  if (masterPinInput.length !== 4 || !/^\d{4}$/.test(masterPinInput)) {
    setMasterPinError('PIN must be exactly 4 digits');
    return;
  }
  if (masterPinInput !== masterPinConfirm) {
    setMasterPinError('PINs do not match');
    return;
  }

  setMasterPinError('');
  setMasterPinSaving(true);

  try {
    await setMasterKioskPin(masterPinInput);
    setMasterPinStatus({ isSet: true, setAt: new Date().toISOString() });
    setShowMasterPinModal(false);
    setMasterPinInput('');
    setMasterPinConfirm('');
    // Show success toast if available
  } catch (err) {
    setMasterPinError('Failed to save PIN. Please try again.');
    logger.error('Failed to save master PIN', { error: err });
  } finally {
    setMasterPinSaving(false);
  }
};
```

5. Add button to open master PIN modal in the page header/toolbar area (near the "Add Screen" button):
```javascript
<button
  onClick={() => setShowMasterPinModal(true)}
  className="flex items-center gap-2 px-4 py-2 text-gray-700 bg-gray-100 hover:bg-gray-200 rounded-lg transition-colors"
>
  <Key className="w-4 h-4" />
  <span className="hidden sm:inline">Master PIN</span>
  {masterPinStatus.isSet && (
    <span className="w-2 h-2 bg-green-500 rounded-full" title="PIN is set" />
  )}
</button>
```

6. Add master PIN modal at end of component (before closing fragment):
```javascript
{/* Master PIN Modal */}
{showMasterPinModal && (
  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
    <div className="bg-white rounded-xl shadow-xl max-w-md w-full p-6">
      <h2 className="text-lg font-semibold text-gray-900 mb-1">
        Master Kiosk PIN
      </h2>
      <p className="text-sm text-gray-600 mb-4">
        Set a master PIN that works on all devices in your organization.
        This allows admins to exit kiosk mode on any device.
      </p>

      {masterPinStatus.isSet && (
        <div className="mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">
          <p className="text-sm text-green-700">
            Master PIN is set.
            {masterPinStatus.setAt && (
              <span className="text-green-600 ml-1">
                Last updated: {new Date(masterPinStatus.setAt).toLocaleDateString()}
              </span>
            )}
          </p>
        </div>
      )}

      <div className="space-y-4">
        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            {masterPinStatus.isSet ? 'New PIN' : 'PIN'} (4 digits)
          </label>
          <input
            type="text"
            inputMode="numeric"
            pattern="[0-9]*"
            maxLength={4}
            value={masterPinInput}
            onChange={(e) => setMasterPinInput(e.target.value.replace(/\D/g, ''))}
            placeholder="Enter 4-digit PIN"
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        <div>
          <label className="block text-sm font-medium text-gray-700 mb-1">
            Confirm PIN
          </label>
          <input
            type="text"
            inputMode="numeric"
            pattern="[0-9]*"
            maxLength={4}
            value={masterPinConfirm}
            onChange={(e) => setMasterPinConfirm(e.target.value.replace(/\D/g, ''))}
            placeholder="Confirm 4-digit PIN"
            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
          />
        </div>

        {masterPinError && (
          <p className="text-sm text-red-600">{masterPinError}</p>
        )}
      </div>

      <div className="flex gap-3 mt-6">
        <button
          onClick={() => {
            setShowMasterPinModal(false);
            setMasterPinInput('');
            setMasterPinConfirm('');
            setMasterPinError('');
          }}
          className="flex-1 py-2 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50"
        >
          Cancel
        </button>
        <button
          onClick={handleSaveMasterPin}
          disabled={masterPinSaving || masterPinInput.length !== 4}
          className="flex-1 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed"
        >
          {masterPinSaving ? 'Saving...' : 'Save PIN'}
        </button>
      </div>
    </div>
  </div>
)}
```
  </action>
  <verify>grep -n "showMasterPinModal\|setMasterKioskPin\|getMasterPinStatus" src/pages/ScreensPage.jsx shows all additions</verify>
  <done>ScreensPage has Master PIN button and modal for setting tenant-level kiosk PIN</done>
</task>

</tasks>

<verification>
1. Master PIN imports: `grep "setMasterKioskPin\|getMasterPinStatus" src/pages/ScreensPage.jsx`
2. Modal state: `grep "showMasterPinModal" src/pages/ScreensPage.jsx`
3. Save handler: `grep "handleSaveMasterPin" src/pages/ScreensPage.jsx`
4. PIN validation (4 digits): `grep "4.*digit\|length !== 4" src/pages/ScreensPage.jsx`
5. Build passes: `npm run build`
</verification>

<success_criteria>
- [ ] ScreensPage imports setMasterKioskPin and getMasterPinStatus from screenService
- [ ] Master PIN button visible in toolbar
- [ ] Button shows green indicator when PIN is set
- [ ] Modal has PIN input (4 digits only) and confirm input
- [ ] Modal shows current PIN status (set date)
- [ ] PIN validation requires 4 digits and matching confirmation
- [ ] Save calls setMasterKioskPin and updates local status
- [ ] Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/09-device-experience/09-07-SUMMARY.md`
</output>
