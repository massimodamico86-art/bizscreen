---
phase: 21-multi-language-advanced
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/134_translation_workflow.sql
  - src/services/languageService.js
  - src/services/translationService.js
autonomous: true

must_haves:
  truths:
    - "Scenes have translation_status column with draft/review/approved values"
    - "Screen groups have display_language column for group-level language"
    - "Dashboard RPC returns scenes with their translation variants and statuses"
    - "Bulk status update RPC changes status for multiple scenes atomically"
  artifacts:
    - path: "supabase/migrations/134_translation_workflow.sql"
      provides: "Schema changes for workflow and group language"
      contains: "translation_status"
    - path: "src/services/translationService.js"
      provides: "Dashboard queries and bulk operations"
      exports: ["fetchTranslationDashboard", "bulkUpdateStatus"]
    - path: "src/services/languageService.js"
      provides: "Extended language operations"
      contains: "getLanguageForLocation"
  key_links:
    - from: "src/services/translationService.js"
      to: "get_translation_dashboard RPC"
      via: "supabase.rpc call"
      pattern: "supabase\\.rpc.*get_translation_dashboard"
    - from: "src/services/translationService.js"
      to: "bulk_update_translation_status RPC"
      via: "supabase.rpc call"
      pattern: "supabase\\.rpc.*bulk_update_translation_status"
---

<objective>
Create database schema and service layer for translation workflow tracking, group-level language assignment, and bulk dashboard operations.

Purpose: Enable tracking translation status per scene variant and prepare database infrastructure for group language inheritance and translation dashboard.
Output: Database migration with new columns/RPCs, translationService.js with dashboard methods
</objective>

<execution_context>
@/Users/massimodamico/.claude/get-shit-done/workflows/execute-plan.md
@/Users/massimodamico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-multi-language-advanced/21-CONTEXT.md
@.planning/phases/21-multi-language-advanced/21-RESEARCH.md
@.planning/phases/20-multi-language-core/20-01-SUMMARY.md
@supabase/migrations/132_multi_language_scenes.sql
@supabase/migrations/133_language_player_integration.sql
@src/services/languageService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create database migration for workflow and group language</name>
  <files>supabase/migrations/134_translation_workflow.sql</files>
  <action>
Create migration 134_translation_workflow.sql with:

1. Add translation_status column to scenes:
```sql
ALTER TABLE scenes
ADD COLUMN IF NOT EXISTS translation_status text NOT NULL DEFAULT 'draft'
CHECK (translation_status IN ('draft', 'review', 'approved'));
```

2. Add index for dashboard filtering:
```sql
CREATE INDEX IF NOT EXISTS idx_scenes_translation_status
ON scenes(tenant_id, translation_status)
WHERE language_group_id IS NOT NULL;
```

3. Add display_language and location columns to screen_groups:
```sql
ALTER TABLE screen_groups
ADD COLUMN IF NOT EXISTS display_language text DEFAULT NULL;

ALTER TABLE screen_groups
ADD COLUMN IF NOT EXISTS location text DEFAULT NULL;

COMMENT ON COLUMN screen_groups.location IS
'Country/region code for location-based language auto-assignment';
```

4. Create get_translation_dashboard RPC that returns scenes with their variants:
- Join scenes with scene_language_groups
- Aggregate variants with json_build_object for each variant (id, code, status, name)
- Filter by p_status_filter and p_language_filter parameters (both nullable)
- Return: scene_id, scene_name, language_group_id, default_language, variants (jsonb array), variant_count, has_incomplete (bool_or of non-approved)
- Use SECURITY DEFINER with auth.uid() for tenant filtering
- Include scenes without language groups (standalone scenes) with empty variants array

5. Create bulk_update_translation_status RPC:
- Parameters: p_scene_ids uuid[], p_new_status text
- Validate status is in ('draft', 'review', 'approved')
- Update scenes SET translation_status, updated_at where id = ANY(p_scene_ids) and tenant_id = auth.uid()
- Return count of updated rows
- Use SECURITY DEFINER

6. Add comments explaining the columns and RPCs

Reference migration 132 for scene_language_groups join pattern and 133 for RPC patterns.
  </action>
  <verify>
Migration file exists with:
- translation_status column definition
- screen_groups display_language column
- screen_groups location column
- get_translation_dashboard function
- bulk_update_translation_status function
  </verify>
  <done>Migration creates workflow schema and dashboard RPCs</done>
</task>

<task type="auto">
  <name>Task 2: Create translationService.js with dashboard methods</name>
  <files>src/services/translationService.js</files>
  <action>
Create new src/services/translationService.js with:

1. Import dependencies:
```javascript
import { supabase } from '../supabase';
import { createScopedLogger } from './loggingService';

const logger = createScopedLogger('TranslationService');
```

2. fetchTranslationDashboard(filters = {}):
- Accept filters object with optional status, languageCode
- Call supabase.rpc('get_translation_dashboard', { p_status_filter, p_language_filter })
- Return data array or throw error
- Log debug with filter parameters

3. bulkUpdateStatus(sceneIds, newStatus):
- Validate newStatus is in ['draft', 'review', 'approved']
- Call supabase.rpc('bulk_update_translation_status', { p_scene_ids, p_new_status })
- Return count from data
- Log info with count and new status

4. Export all functions

Follow pattern from languageService.js for structured logging and error handling.
  </action>
  <verify>grep -q "fetchTranslationDashboard" src/services/translationService.js && grep -q "bulkUpdateStatus" src/services/translationService.js</verify>
  <done>translationService.js exports dashboard query and bulk update functions</done>
</task>

<task type="auto">
  <name>Task 3: Add location-to-language mapping to languageService.js</name>
  <files>src/services/languageService.js</files>
  <action>
Extend src/services/languageService.js with:

1. Add LOCATION_LANGUAGE_MAP constant:
```javascript
// Maps country/region codes to primary language
// Used for auto-assigning language based on device location
const LOCATION_LANGUAGE_MAP = {
  'US': 'en',
  'GB': 'en',
  'CA': 'en',
  'AU': 'en',
  'ES': 'es',
  'MX': 'es',
  'AR': 'es',
  'FR': 'fr',
  'DE': 'de',
  'AT': 'de',
  'CH': 'de', // Swiss German default
  'IT': 'it',
  'PT': 'pt',
  'BR': 'pt',
  'JP': 'ja',
  'CN': 'zh',
  'TW': 'zh',
  'KR': 'ko',
  'NL': 'nl',
  'PL': 'pl',
  'RU': 'ru',
};
```

2. Add getLanguageForLocation(locationCode):
- Lookup locationCode (uppercase) in LOCATION_LANGUAGE_MAP
- Return matching language code or 'en' as default fallback
- Log debug with location and resolved language

3. Add getAvailableLocations():
- Return array of { code, name } for all locations in the map
- Use Intl.DisplayNames to get localized country names

4. Export the new functions and LOCATION_LANGUAGE_MAP constant

This supports LANG-08 (auto-assign language based on location) and the group settings UI.
  </action>
  <verify>grep -q "LOCATION_LANGUAGE_MAP" src/services/languageService.js && grep -q "getLanguageForLocation" src/services/languageService.js</verify>
  <done>languageService.js exports location-to-language mapping and lookup function</done>
</task>

</tasks>

<verification>
1. Migration file exists: `ls supabase/migrations/134_translation_workflow.sql`
2. translationService.js exports correct functions: `grep -E "export (async )?function" src/services/translationService.js`
3. languageService.js has location mapping: `grep "LOCATION_LANGUAGE_MAP" src/services/languageService.js`
4. All files have no syntax errors (imports work): `node -c src/services/translationService.js` (if applicable)
</verification>

<success_criteria>
- Database migration creates translation_status column, display_language column, and location column
- Dashboard RPC returns scenes with aggregated variant information
- Bulk update RPC atomically updates multiple scene statuses
- translationService.js provides dashboard query and bulk update methods
- languageService.js provides location-to-language mapping
</success_criteria>

<output>
After completion, create `.planning/phases/21-multi-language-advanced/21-01-SUMMARY.md`
</output>
