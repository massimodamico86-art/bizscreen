---
phase: 21-multi-language-advanced
plan: 02
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - src/components/screens/ScreenGroupSettingsTab.jsx
  - src/pages/ScreenGroupDetailPage.jsx
  - supabase/migrations/135_group_language_inheritance.sql
  - src/services/screenGroupService.js
autonomous: true

must_haves:
  truths:
    - "User can configure display language for a screen group in settings tab"
    - "Devices in group inherit language from group when device has no override"
    - "User can set device location which auto-maps to language"
    - "Player content resolution uses group language as fallback"
  artifacts:
    - path: "src/components/screens/ScreenGroupSettingsTab.jsx"
      provides: "Settings tab component with language and location config"
      min_lines: 100
    - path: "supabase/migrations/135_group_language_inheritance.sql"
      provides: "Updated player resolution with group inheritance"
      contains: "screen_groups"
    - path: "src/services/screenGroupService.js"
      provides: "Group language update methods"
      contains: "updateGroupLanguage"
  key_links:
    - from: "src/components/screens/ScreenGroupSettingsTab.jsx"
      to: "screenGroupService.js"
      via: "updateGroupLanguage call"
      pattern: "updateGroupLanguage"
    - from: "supabase/migrations/135_group_language_inheritance.sql"
      to: "get_resolved_player_content"
      via: "COALESCE with group language"
      pattern: "screen_groups.*display_language"
---

<objective>
Implement group-level language assignment with device inheritance and location-based auto-mapping.

Purpose: Enable admins to set a language for an entire screen group, with devices automatically inheriting that language. Supports LANG-07 (group assignment) and LANG-08 (auto-assignment via location).
Output: Group settings tab with language configuration, updated player resolution
</objective>

<execution_context>
@/Users/massimodamico/.claude/get-shit-done/workflows/execute-plan.md
@/Users/massimodamico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-multi-language-advanced/21-CONTEXT.md
@.planning/phases/21-multi-language-advanced/21-RESEARCH.md
@.planning/phases/21-multi-language-advanced/21-01-SUMMARY.md
@src/pages/ScreenGroupDetailPage.jsx
@src/services/screenGroupService.js
@supabase/migrations/133_language_player_integration.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ScreenGroupSettingsTab component</name>
  <files>src/components/screens/ScreenGroupSettingsTab.jsx</files>
  <action>
Create new src/components/screens/ScreenGroupSettingsTab.jsx:

1. Import dependencies:
```javascript
import React, { useState, useEffect } from 'react';
import { Card, Button, Select, Label } from '../../design-system';
import { Globe, MapPin, Save } from 'lucide-react';
import { getSupportedLanguages, getAvailableLocations, getLanguageForLocation } from '../../services/languageService';
import { updateGroupLanguage } from '../../services/screenGroupService';
```

2. Component props: { group, onUpdate, showToast }

3. State:
- displayLanguage (from group.display_language or '')
- location (from group.location or '')
- saving (boolean)

4. UI layout (following design system patterns):
- Card with header "Language Settings"
- Section: "Group Language"
  - Dropdown of supported languages with "None (use device language)" as first option
  - Help text: "All devices in this group will display content in this language"
- Section: "Location-Based Auto-Assignment"
  - Location dropdown from getAvailableLocations()
  - When location changes, show suggested language via getLanguageForLocation()
  - Button: "Apply Location Language" that sets displayLanguage from location
  - Help text: "Set device location to automatically determine display language"
- Save button that calls updateGroupLanguage with { display_language, location }

5. On save success:
- Call onUpdate() to refresh parent
- Show success toast

Per CONTEXT.md: Strict inheritance - devices in group always use group's language, no device-level override displayed here.
  </action>
  <verify>test -f src/components/screens/ScreenGroupSettingsTab.jsx && grep -q "displayLanguage" src/components/screens/ScreenGroupSettingsTab.jsx</verify>
  <done>ScreenGroupSettingsTab component allows configuring group language and location</done>
</task>

<task type="auto">
  <name>Task 2: Integrate settings tab into ScreenGroupDetailPage</name>
  <files>src/pages/ScreenGroupDetailPage.jsx, src/services/screenGroupService.js</files>
  <action>
1. Update src/pages/ScreenGroupDetailPage.jsx:
- Import ScreenGroupSettingsTab from '../components/screens/ScreenGroupSettingsTab'
- Add "Settings" tab to the existing tab navigation (after Devices tab)
- Render ScreenGroupSettingsTab when Settings tab is active
- Pass group, onUpdate (refetch), and showToast props

2. Update src/services/screenGroupService.js:
- Add updateGroupLanguage(groupId, settings) function that handles both display_language and location in a single settings object:
```javascript
export async function updateGroupLanguage(groupId, settings) {
  logger.debug('Updating group language settings', { groupId, settings });

  const { data, error } = await supabase
    .from('screen_groups')
    .update({
      display_language: settings.display_language || null,
      location: settings.location || null,
      updated_at: new Date().toISOString(),
    })
    .eq('id', groupId)
    .select()
    .single();

  if (error) throw error;
  return data;
}
```

Reference existing patterns in screenGroupService.js for update operations.
  </action>
  <verify>grep -q "ScreenGroupSettingsTab" src/pages/ScreenGroupDetailPage.jsx && grep -q "updateGroupLanguage" src/services/screenGroupService.js</verify>
  <done>Settings tab integrated into screen group detail page with update service method</done>
</task>

<task type="auto">
  <name>Task 3: Update player content resolution for group inheritance</name>
  <files>supabase/migrations/135_group_language_inheritance.sql</files>
  <action>
Create migration 135_group_language_inheritance.sql:

Note: The location column was already added in migration 134 (Plan 21-01). This migration only updates the player resolution logic.

1. Update get_resolved_player_content to use group language as fallback:
Find the existing language resolution line and update:
```sql
-- Previous: v_device_language := COALESCE(v_device.display_language, 'en');
-- New: Include group fallback
v_device_language := COALESCE(
  v_device.display_language,
  (SELECT sg.display_language FROM screen_groups sg WHERE sg.id = v_device.screen_group_id),
  'en'
);
```

2. Add comment explaining the inheritance chain:
```sql
-- Language resolution order:
-- 1. Device-level display_language (if set)
-- 2. Group-level display_language (if device is in a group with language set)
-- 3. Default 'en'
```

This implements CONTEXT.md decision: "Strict inheritance â€” devices in group always use group's language, no override"
Note: Per CONTEXT.md, devices in groups use group language. The "no override" means UI doesn't show device language when in group, not that DB prevents it.
  </action>
  <verify>grep -q "screen_groups.*display_language" supabase/migrations/135_group_language_inheritance.sql</verify>
  <done>Player content resolution includes group language inheritance chain</done>
</task>

</tasks>

<verification>
1. Settings tab file exists: `ls src/components/screens/ScreenGroupSettingsTab.jsx`
2. Tab integrated in detail page: `grep -c "ScreenGroupSettingsTab" src/pages/ScreenGroupDetailPage.jsx` returns >= 1
3. Service method exists: `grep "updateGroupLanguage" src/services/screenGroupService.js`
4. Migration includes group inheritance: `grep "screen_groups" supabase/migrations/135_group_language_inheritance.sql`
</verification>

<success_criteria>
- User can navigate to screen group detail page and see Settings tab
- Settings tab shows language dropdown and location configuration
- Selecting location shows suggested language with apply button
- Saving updates both display_language and location on screen_groups
- Player content resolution uses group language when device language is not set
</success_criteria>

<output>
After completion, create `.planning/phases/21-multi-language-advanced/21-02-SUMMARY.md`
</output>
