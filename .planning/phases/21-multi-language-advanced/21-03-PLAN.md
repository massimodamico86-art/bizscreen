---
phase: 21-multi-language-advanced
plan: 03
type: execute
wave: 2
depends_on: ["21-01"]
files_modified:
  - src/pages/TranslationDashboardPage.jsx
  - src/components/translations/TranslationFilters.jsx
  - src/components/translations/BulkActionsBar.jsx
  - src/components/translations/AiSuggestionPanel.jsx
  - src/services/translationService.js
  - _api-disabled/translations/suggest.js
  - src/App.jsx
autonomous: true

must_haves:
  truths:
    - "User can view all scenes with translation status in bulk dashboard"
    - "User can filter dashboard by status and language"
    - "User can select multiple scenes and bulk update their translation status"
    - "User can trigger AI translation suggestions for a scene"
    - "AI suggestions appear in side panel for user to copy/edit"
  artifacts:
    - path: "src/pages/TranslationDashboardPage.jsx"
      provides: "Main translation dashboard page"
      min_lines: 150
    - path: "src/components/translations/BulkActionsBar.jsx"
      provides: "Toolbar for bulk status updates"
      contains: "bulkUpdateStatus"
    - path: "src/components/translations/AiSuggestionPanel.jsx"
      provides: "Side panel for AI translation suggestions"
      contains: "getAiTranslationSuggestion"
    - path: "_api-disabled/translations/suggest.js"
      provides: "API route for Claude translation"
      contains: "anthropic"
  key_links:
    - from: "src/pages/TranslationDashboardPage.jsx"
      to: "translationService.js"
      via: "fetchTranslationDashboard call"
      pattern: "fetchTranslationDashboard"
    - from: "src/components/translations/BulkActionsBar.jsx"
      to: "translationService.js"
      via: "bulkUpdateStatus call"
      pattern: "bulkUpdateStatus"
    - from: "src/components/translations/AiSuggestionPanel.jsx"
      to: "_api-disabled/translations/suggest.js"
      via: "fetch POST"
      pattern: "fetch.*translations/suggest"
---

<objective>
Build the translation dashboard UI with filtering, bulk actions, and AI translation suggestions panel.

Purpose: Enable content managers to view all content needing translation, track workflow status, update statuses in bulk, and get AI-assisted translation suggestions. Fulfills LANG-06, LANG-09, LANG-10.
Output: TranslationDashboardPage with filters, bulk actions, and AI suggestion panel
</objective>

<execution_context>
@/Users/massimodamico/.claude/get-shit-done/workflows/execute-plan.md
@/Users/massimodamico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/21-multi-language-advanced/21-CONTEXT.md
@.planning/phases/21-multi-language-advanced/21-RESEARCH.md
@.planning/phases/21-multi-language-advanced/21-01-SUMMARY.md
@src/pages/ScreenGroupsPage.jsx
@src/services/translationService.js
@src/services/languageService.js
@_api-disabled/ai/generate-tags.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TranslationDashboardPage and filter components</name>
  <files>src/pages/TranslationDashboardPage.jsx, src/components/translations/TranslationFilters.jsx</files>
  <action>
1. Create src/components/translations/TranslationFilters.jsx:
```javascript
import React from 'react';
import { Select, Label } from '../../design-system';
import { Filter } from 'lucide-react';
import { getSupportedLanguages } from '../../services/languageService';

const STATUS_OPTIONS = [
  { value: '', label: 'All Statuses' },
  { value: 'draft', label: 'Draft' },
  { value: 'review', label: 'In Review' },
  { value: 'approved', label: 'Approved' },
];

export default function TranslationFilters({ filters, onChange }) {
  const languages = getSupportedLanguages();

  return (
    <div className="flex gap-4 items-end">
      <div>
        <Label>Status</Label>
        <Select
          value={filters.status}
          onChange={(e) => onChange({ ...filters, status: e.target.value })}
          options={STATUS_OPTIONS}
        />
      </div>
      <div>
        <Label>Language</Label>
        <Select
          value={filters.languageCode}
          onChange={(e) => onChange({ ...filters, languageCode: e.target.value })}
          options={[
            { value: '', label: 'All Languages' },
            ...languages.map(l => ({ value: l.code, label: l.name }))
          ]}
        />
      </div>
    </div>
  );
}
```

2. Create src/pages/TranslationDashboardPage.jsx:
- Import: PageLayout, PageHeader, PageContent, Card, Button, Checkbox from design-system
- Import: Globe, Check, Clock, AlertCircle from lucide-react
- Import: fetchTranslationDashboard from translationService
- Import: TranslationFilters, BulkActionsBar, AiSuggestionPanel

State:
- scenes: array from fetchTranslationDashboard
- loading: boolean
- selected: array of scene IDs
- filters: { status: '', languageCode: '' }
- showAiPanel: boolean
- aiTargetScene: scene object or null

STATUS_CONFIG for styling:
```javascript
const STATUS_CONFIG = {
  draft: { label: 'Draft', icon: Clock, color: 'text-gray-500 bg-gray-100' },
  review: { label: 'In Review', icon: AlertCircle, color: 'text-yellow-600 bg-yellow-50' },
  approved: { label: 'Approved', icon: Check, color: 'text-green-600 bg-green-50' },
};
```

Layout (following ScreenGroupsPage patterns):
- PageHeader with title "Translation Dashboard", subtitle with scene count
- TranslationFilters component
- BulkActionsBar (shown when selected.length > 0)
- Table with columns: checkbox, Scene Name, Languages (pills with status icons), Actions
- Each row:
  - Checkbox tied to selected state
  - Scene name
  - Language pills showing status color per variant
  - "Translate" button (opens AI panel)
- AiSuggestionPanel as slide-over when showAiPanel is true

useEffect to fetch scenes when filters change.

Per CONTEXT.md: "Organize by scene — each row is a scene, columns show language status"
  </action>
  <verify>test -f src/pages/TranslationDashboardPage.jsx && test -f src/components/translations/TranslationFilters.jsx</verify>
  <done>TranslationDashboardPage renders scene list with filters and status visualization</done>
</task>

<task type="auto">
  <name>Task 2: Create BulkActionsBar and wire bulk status updates</name>
  <files>src/components/translations/BulkActionsBar.jsx, src/services/translationService.js</files>
  <action>
1. Create src/components/translations/BulkActionsBar.jsx:
```javascript
import React, { useState } from 'react';
import { Button, Select } from '../../design-system';
import { CheckCircle, XCircle } from 'lucide-react';
import { bulkUpdateStatus } from '../../services/translationService';

export default function BulkActionsBar({ selectedIds, onComplete, showToast }) {
  const [updating, setUpdating] = useState(false);
  const [targetStatus, setTargetStatus] = useState('review');

  const handleBulkUpdate = async () => {
    if (selectedIds.length === 0) return;
    setUpdating(true);
    try {
      const count = await bulkUpdateStatus(selectedIds, targetStatus);
      showToast(`Updated ${count} scene(s) to ${targetStatus}`, 'success');
      onComplete();
    } catch (error) {
      showToast('Failed to update status: ' + error.message, 'error');
    } finally {
      setUpdating(false);
    }
  };

  return (
    <div className="flex items-center gap-4 p-3 bg-blue-50 rounded-lg">
      <span className="text-sm font-medium">
        {selectedIds.length} selected
      </span>
      <div className="flex-1" />
      <Select
        value={targetStatus}
        onChange={(e) => setTargetStatus(e.target.value)}
        options={[
          { value: 'draft', label: 'Set to Draft' },
          { value: 'review', label: 'Set to Review' },
          { value: 'approved', label: 'Set to Approved' },
        ]}
        className="w-40"
      />
      <Button
        onClick={handleBulkUpdate}
        disabled={updating || selectedIds.length === 0}
        variant="primary"
        size="sm"
      >
        {updating ? 'Updating...' : 'Update Status'}
      </Button>
    </div>
  );
}
```

2. Ensure src/services/translationService.js has proper error handling in bulkUpdateStatus (from 21-01):
- Verify it logs the operation
- Verify it propagates errors properly for toast display

Per CONTEXT.md: "Bulk actions: both translate selected AND status change actions"
The "translate selected" creates variants via existing languageService methods; status change uses bulkUpdateStatus.
  </action>
  <verify>test -f src/components/translations/BulkActionsBar.jsx && grep -q "bulkUpdateStatus" src/components/translations/BulkActionsBar.jsx</verify>
  <done>BulkActionsBar allows selecting target status and applying to multiple scenes</done>
</task>

<task type="auto">
  <name>Task 3: Create AI suggestion panel and API route</name>
  <files>src/components/translations/AiSuggestionPanel.jsx, _api-disabled/translations/suggest.js, src/services/translationService.js</files>
  <action>
1. Create _api-disabled/translations/suggest.js (Vercel serverless function pattern - follows existing `_api-disabled/ai/generate.js`).
Note: The file goes in `_api-disabled/` folder following project convention. When enabled, Vercel serves it at `/api/translations/suggest`. Reference `_api-disabled/ai/generate-tags.js` for Anthropic SDK usage pattern:
```javascript
import Anthropic from '@anthropic-ai/sdk';
import { createClient } from '@supabase/supabase-js';

const anthropic = new Anthropic({
  apiKey: process.env.ANTHROPIC_API_KEY,
});

export default async function handler(req, res) {
  if (req.method !== 'POST') {
    return res.status(405).json({ error: 'Method not allowed' });
  }

  try {
    const { sourceSceneId, targetLanguage } = req.body;

    // Get source scene
    const supabase = createClient(
      process.env.NEXT_PUBLIC_SUPABASE_URL,
      process.env.SUPABASE_SERVICE_ROLE_KEY
    );

    const { data: scene, error: sceneError } = await supabase
      .from('scenes')
      .select('name, settings')
      .eq('id', sourceSceneId)
      .single();

    if (sceneError || !scene) {
      return res.status(404).json({ error: 'Scene not found' });
    }

    // Extract translatable text from scene settings
    const textsToTranslate = extractTranslatableTexts(scene);

    // Get language name for better prompt
    const languageNames = {
      es: 'Spanish', fr: 'French', de: 'German', it: 'Italian',
      pt: 'Portuguese', ja: 'Japanese', zh: 'Chinese', ko: 'Korean',
      nl: 'Dutch', pl: 'Polish', ru: 'Russian'
    };
    const langName = languageNames[targetLanguage] || targetLanguage;

    // Call Claude for translations
    const message = await anthropic.messages.create({
      model: 'claude-3-haiku-20240307',
      max_tokens: 2000,
      messages: [{
        role: 'user',
        content: `Translate the following digital signage content to ${langName}.
Return ONLY valid JSON with the same structure. Preserve any {{placeholder}} variables exactly.

${JSON.stringify(textsToTranslate, null, 2)}`
      }],
    });

    const responseText = message.content[0]?.text || '{}';
    // Extract JSON from response (handle markdown code blocks)
    const jsonMatch = responseText.match(/```json\n?([\s\S]*?)\n?```/) ||
                      responseText.match(/\{[\s\S]*\}/);
    const translations = JSON.parse(jsonMatch?.[1] || jsonMatch?.[0] || '{}');

    return res.status(200).json({
      sourceLanguage: 'en',
      targetLanguage,
      translations,
    });
  } catch (error) {
    console.error('Translation suggestion error:', error);
    return res.status(500).json({ error: 'Failed to generate translation' });
  }
}

function extractTranslatableTexts(scene) {
  const result = { name: scene.name };

  // Extract text from Polotno scene settings
  if (scene.settings?.pages) {
    result.texts = [];
    for (const page of scene.settings.pages) {
      for (const element of (page.children || [])) {
        if (element.type === 'text' && element.text) {
          result.texts.push(element.text);
        }
      }
    }
  }

  return result;
}
```

2. Add getAiTranslationSuggestion to src/services/translationService.js:
```javascript
export async function getAiTranslationSuggestion(sourceSceneId, targetLanguage) {
  logger.debug('Requesting AI translation suggestion', { sourceSceneId, targetLanguage });

  const response = await fetch('/api/translations/suggest', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ sourceSceneId, targetLanguage }),
  });

  if (!response.ok) {
    const error = await response.json();
    throw new Error(error.error || 'Failed to get translation suggestion');
  }

  return response.json();
}
```

3. Create src/components/translations/AiSuggestionPanel.jsx:
- Slide-over panel (right side, 480px width, bg-black/30 backdrop)
- Props: { scene, isOpen, onClose, showToast }
- State: targetLanguage, suggestions (null initially), loading
- Header: "AI Translation Suggestions" with close button
- Language dropdown to select target language
- "Generate Suggestions" button (calls getAiTranslationSuggestion)
- When suggestions loaded:
  - Display source text → translated text for each item
  - "Copy" button next to each translation
  - "Copy All" button to copy all translations
- Per CONTEXT.md: "AI suggestions appear in side panel — user copies/edits into scene"
- Loading state while waiting for AI response
- Error handling with toast

Use framer-motion AnimatePresence for slide animation (following TemplatePreviewPanel pattern).
  </action>
  <verify>test -f _api-disabled/translations/suggest.js && test -f src/components/translations/AiSuggestionPanel.jsx && grep -q "getAiTranslationSuggestion" src/services/translationService.js</verify>
  <done>AI suggestion panel fetches translations from Claude and displays for user to copy</done>
</task>

<task type="auto">
  <name>Task 4: Wire route and add tests coverage</name>
  <files>src/App.jsx</files>
  <action>
1. Update src/App.jsx to add route for TranslationDashboardPage:
- Import TranslationDashboardPage from './pages/TranslationDashboardPage'
- Add route: `<Route path="/translations" element={<TranslationDashboardPage showToast={showToast} />} />`
- Place after other content management routes (scenes, playlists, etc.)

2. Add sidebar navigation link if applicable:
- Look for sidebar/navigation component (likely in App.jsx or a Layout component)
- Add "Translations" link to content management section with Globe icon

Per TECH-04: Test coverage will be added in a gap closure plan if verification identifies gaps.
The primary focus here is wiring the UI for user testing.
  </action>
  <verify>grep -q "TranslationDashboardPage" src/App.jsx && grep -q "/translations" src/App.jsx</verify>
  <done>TranslationDashboardPage accessible via /translations route</done>
</task>

</tasks>

<verification>
1. All component files exist:
   - `ls src/pages/TranslationDashboardPage.jsx`
   - `ls src/components/translations/TranslationFilters.jsx`
   - `ls src/components/translations/BulkActionsBar.jsx`
   - `ls src/components/translations/AiSuggestionPanel.jsx`
2. API route exists: `ls _api-disabled/translations/suggest.js`
3. Route wired: `grep "/translations" src/App.jsx`
4. Service exports AI function: `grep "getAiTranslationSuggestion" src/services/translationService.js`
</verification>

<success_criteria>
- User can navigate to /translations and see dashboard with all scenes
- Dashboard shows scene name and language status pills for each variant
- User can filter by status (draft/review/approved) and language
- User can select multiple scenes and bulk update their status
- User can click Translate on a scene to open AI panel
- AI panel shows language dropdown and generates suggestions via Claude
- User can copy individual or all translations from panel
</success_criteria>

<output>
After completion, create `.planning/phases/21-multi-language-advanced/21-03-SUMMARY.md`
</output>
