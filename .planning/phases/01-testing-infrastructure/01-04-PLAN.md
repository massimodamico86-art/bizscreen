---
phase: 01-testing-infrastructure
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/unit/services/scheduleService.test.js
  - tests/unit/player/offlineService.test.js
autonomous: true

must_haves:
  truths:
    - "Extended scheduleService tests execute and pass"
    - "Extended offlineService tests execute and pass"
    - "Schedule CRUD operations have test coverage"
    - "Offline service cache operations have test coverage"
  artifacts:
    - path: "tests/unit/services/scheduleService.test.js"
      provides: "Extended scheduleService unit tests"
      min_lines: 300
    - path: "tests/unit/player/offlineService.test.js"
      provides: "Extended offlineService unit tests"
      min_lines: 400
  key_links:
    - from: "tests/unit/services/scheduleService.test.js"
      to: "src/services/scheduleService.js"
      via: "import"
      pattern: "import.*scheduleService"
    - from: "tests/unit/player/offlineService.test.js"
      to: "src/player/offlineService.js"
      via: "import"
      pattern: "import.*offlineService"
---

<objective>
Expand unit tests for critical service functions: scheduleService and offlineService.

Purpose: These services are foundational for player behavior. scheduleService determines what content plays when; offlineService ensures content availability during network outages. Both need comprehensive test coverage before Phase 7 refactoring.

Output: Extended test files with comprehensive coverage of critical paths.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-testing-infrastructure/01-RESEARCH.md

# Existing tests to extend
@tests/unit/services/scheduleService.test.js
@tests/unit/player/offlineService.test.js

# Services under test
@src/services/scheduleService.js
@src/player/offlineService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand scheduleService tests</name>
  <files>tests/unit/services/scheduleService.test.js</files>
  <action>
Extend the existing scheduleService.test.js with additional test coverage.

Current coverage (from existing file):
- DAYS_OF_WEEK constant
- TARGET_TYPES constant
- formatDaysOfWeek()
- formatTime()
- formatTimeRange()
- API function exports

Additional tests needed:
```
describe('scheduleService - Extended Coverage')
  describe('Schedule CRUD operations')
    describe('fetchSchedules')
      it('returns schedules for current user')
      it('handles empty schedule list')
      it('handles database errors gracefully')

    describe('createSchedule')
      it('creates schedule with required fields')
      it('validates schedule name is not empty')
      it('logs activity on successful creation')

    describe('updateSchedule')
      it('updates schedule properties')
      it('validates schedule exists before update')
      it('logs activity on successful update')

    describe('deleteSchedule')
      it('deletes schedule by ID')
      it('logs activity on successful deletion')
      it('handles non-existent schedule')

  describe('Schedule entry operations')
    describe('createScheduleEntry')
      it('creates entry with time range')
      it('creates entry with days of week')
      it('validates entry has target content')

    describe('updateScheduleEntry')
      it('updates entry time range')
      it('updates entry days of week')

    describe('deleteScheduleEntry')
      it('removes entry from schedule')

  describe('Schedule conflict detection')
    it('detects overlapping time ranges on same day')
    it('allows non-overlapping entries')
    it('handles entries spanning midnight')

  describe('Device/group assignment')
    describe('assignScheduleToDevice')
      it('assigns schedule to device')
      it('validates device ID is provided')
      it('validates schedule ID is provided')

    describe('assignScheduleToGroup')
      it('assigns schedule to screen group')
      it('validates group ID is provided')
```

Mock Supabase to return controlled responses.
Focus on behavior verification, not implementation details.

IMPORTANT: Extend the existing file, do not replace it. Add new describe blocks.
  </action>
  <verify>
Run `npm test -- tests/unit/services/scheduleService.test.js` - all tests pass.
  </verify>
  <done>
scheduleService tests extended with CRUD and assignment coverage.
  </done>
</task>

<task type="auto">
  <name>Task 2: Expand offlineService tests</name>
  <files>tests/unit/player/offlineService.test.js</files>
  <action>
Extend the existing offlineService.test.js with additional test coverage.

Current coverage (from existing file):
- isOnline()
- getOfflineMode() / setOfflineMode()
- addOfflineListener()
- recordHeartbeatSuccess() / recordHeartbeatFailure()
- queueHeartbeat() / queuePlaybackEvent() / queueError()
- getCacheStatus()
- getOfflineServiceInfo()
- fetchAndCacheScene() error case
- syncPendingEvents()
- getSceneForPlayback()
- checkSceneNeedsUpdate()
- getMediaUrl()

Additional tests needed:
```
describe('offlineService - Extended Coverage')
  describe('Scene caching operations')
    describe('fetchAndCacheScene')
      it('fetches scene from server and caches it')
      it('updates cache with fresh data')
      it('handles fetch errors without crashing')

    describe('getSceneForPlayback')
      it('returns cached scene when available')
      it('returns null when cache is empty')
      it('falls back to online fetch when cache miss and online')

    describe('checkSceneNeedsUpdate')
      it('returns false when cached hash matches')
      it('returns true when cached hash differs')
      it('returns true when scene not in cache')

  describe('Media URL resolution')
    describe('getMediaUrl')
      it('returns original URL when online')
      it('returns cached blob URL when offline')
      it('returns original URL if not cached when offline')

  describe('Service worker integration')
    describe('registerServiceWorker')
      it('registers service worker successfully')
      it('handles registration failure gracefully')

    describe('postToServiceWorker')
      it('sends message to active service worker')
      it('handles missing service worker gracefully')

  describe('Offline detection')
    describe('initOfflineDetection')
      it('sets up window online/offline event listeners')
      it('updates offline mode on network change')

    describe('recordHeartbeatFailure - extended')
      it('enters offline mode after threshold exceeded')
      it('tracks time since last successful heartbeat')

  describe('Event sync operations')
    describe('syncPendingEvents - success cases')
      it('syncs queued heartbeats to server')
      it('syncs queued playback events to server')
      it('syncs queued errors to server')
      it('marks events as synced after successful upload')

    describe('syncPendingEvents - error handling')
      it('retains events on sync failure')
      it('handles partial sync failure')
```

Mock dependencies:
- cacheService (already mocked in existing file)
- supabase (already mocked)
- navigator.onLine
- window.addEventListener

IMPORTANT: Extend the existing file, do not replace it.
  </action>
  <verify>
Run `npm test -- tests/unit/player/offlineService.test.js` - all tests pass.
  </verify>
  <done>
offlineService tests extended with caching and sync coverage.
  </done>
</task>

</tasks>

<verification>
```bash
# Run both service test files
npm test -- tests/unit/services/scheduleService.test.js tests/unit/player/offlineService.test.js

# Check line counts to verify expansion
wc -l tests/unit/services/scheduleService.test.js tests/unit/player/offlineService.test.js
```

Expected: Both test files pass with expanded coverage. scheduleService.test.js > 300 lines, offlineService.test.js > 400 lines.
</verification>

<success_criteria>
1. `npm test` passes for both service test files
2. scheduleService has CRUD operation tests
3. scheduleService has device/group assignment tests
4. offlineService has scene caching tests
5. offlineService has event sync tests
</success_criteria>

<output>
After completion, create `.planning/phases/01-testing-infrastructure/01-04-SUMMARY.md`
</output>
