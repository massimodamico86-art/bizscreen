---
phase: 01-testing-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/unit/player/Player.offline.test.jsx
  - tests/mocks/supabase.js
autonomous: true

must_haves:
  truths:
    - "Offline mode transition tests execute and pass with npm test"
    - "Network drop triggers switch to cached content in test"
    - "Reconnection restores online mode and fetches fresh content"
    - "Extended offline playback continues without errors"
  artifacts:
    - path: "tests/unit/player/Player.offline.test.jsx"
      provides: "Offline mode transition characterization tests"
      min_lines: 150
    - path: "tests/mocks/supabase.js"
      provides: "Centralized Supabase mock for player tests"
      exports: ["createMockSupabase", "mockRpc", "mockAuth"]
  key_links:
    - from: "tests/unit/player/Player.offline.test.jsx"
      to: "src/Player.jsx"
      via: "import and render"
      pattern: "import.*Player"
    - from: "tests/unit/player/Player.offline.test.jsx"
      to: "tests/mocks/supabase.js"
      via: "vi.mock"
      pattern: "vi\\.mock.*supabase"
---

<objective>
Create characterization tests for Player.jsx offline mode transitions.

Purpose: Capture and verify the player's behavior when network connectivity changes - this is critical for digital signage where screens must continue displaying content during network outages.

Output: Test file covering offline transitions with passing tests that verify correctness.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-testing-infrastructure/01-RESEARCH.md

# Existing test patterns to follow
@tests/setup.js
@tests/utils/mocks.js
@tests/unit/player/offlineService.test.js

# Component under test
@src/Player.jsx (lines 2023-2126, 2406-2494 - offline/cache logic)
@src/services/playerService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create centralized Supabase mock for Player tests</name>
  <files>tests/mocks/supabase.js</files>
  <action>
Create a centralized Supabase mock module specifically for Player component tests.

The mock must support:
1. `supabase.rpc()` calls for:
   - `get_resolved_player_content` - returns content payload
   - `get_resolved_player_content_by_otp` - returns content with screenId
   - `player_heartbeat` - returns success
   - `get_pending_device_command` - returns null or command object

2. Configurable responses - allow tests to set different return values
3. Error simulation - ability to make calls fail
4. Call tracking - record what RPC calls were made

Pattern to follow from existing tests/utils/mocks.js but extend for RPC support.

Export:
- `createMockSupabase()` - creates fresh mock instance
- `mockRpc(rpcName, response)` - configure RPC response
- `mockRpcError(rpcName, error)` - configure RPC to throw
- `getLastRpcCall(rpcName)` - get last call args for verification

Do NOT mock browser APIs here - those go in test setup.
  </action>
  <verify>
Import the mock in a test file and verify:
- `vi.mock('../../../src/supabase', () => mockModule)` works
- RPC calls can be configured and tracked
  </verify>
  <done>
Supabase mock module exists with RPC support for all Player.jsx RPC calls.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create offline mode transition tests</name>
  <files>tests/unit/player/Player.offline.test.jsx</files>
  <action>
Create characterization tests for Player.jsx offline behavior.

Test structure:
```
describe('Player.jsx - Offline Mode Transitions')
  describe('Network drop handling')
    it('switches to cached content when getResolvedContent fails')
    it('sets connectionStatus to "offline" on network failure')
    it('sets isOfflineMode to true when using cached content')
    it('displays offline watermark when in offline mode')

  describe('Cached content playback')
    it('loads content from IndexedDB cache when server unreachable')
    it('continues playlist rotation with cached items')
    it('preserves playlist shuffle state in offline mode')

  describe('Reconnection behavior')
    it('attempts reconnection with exponential backoff')
    it('clears offline mode when server responds successfully')
    it('fetches fresh content on successful reconnection')
    it('updates content hash after reconnection')

  describe('Extended offline operation')
    it('runs for extended periods without degradation')
    it('handles content rotation through multiple cycles')
```

Key behaviors to verify (from src/Player.jsx lines 2406-2494):
1. When `getResolvedContent()` throws, fall back to `getCachedContent()`
2. When cached content exists, set `connectionStatus: 'offline'` and `isOfflineMode: true`
3. When reconnecting, use `retryWithBackoff()` with exponential delays
4. After successful reconnect, set `connectionStatus: 'connected'` and `isOfflineMode: false`

Mock setup requirements:
- Mock `src/supabase` to control RPC responses
- Mock `src/services/playerService` for cache functions
- Mock `navigator.onLine` for network status
- Use vi.useFakeTimers() for timing-based tests
- Wrap component in MemoryRouter

Important: Test the BEHAVIOR not implementation details. Verify observable state changes.
  </action>
  <verify>
Run `npm test -- tests/unit/player/Player.offline.test.jsx` - all tests pass.
  </verify>
  <done>
Offline mode transition tests exist and pass, verifying:
- Network failure triggers cache fallback
- Offline indicators display correctly
- Reconnection works with backoff
- Extended offline playback functions
  </done>
</task>

</tasks>

<verification>
```bash
# Run offline tests specifically
npm test -- tests/unit/player/Player.offline.test.jsx

# Verify coverage of offline paths
npm run test:coverage -- --reporter=text tests/unit/player/Player.offline.test.jsx
```

Expected: All offline transition tests pass, covering the loadContent catch block and cache fallback logic.
</verification>

<success_criteria>
1. `npm test` includes Player.offline.test.jsx and passes
2. Tests verify player switches to cached content when network drops
3. Tests verify offline mode indicators (isOfflineMode, connectionStatus)
4. Tests verify reconnection with exponential backoff
5. Tests run in isolation without external dependencies
</success_criteria>

<output>
After completion, create `.planning/phases/01-testing-infrastructure/01-01-SUMMARY.md`
</output>
