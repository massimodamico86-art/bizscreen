---
phase: 01-testing-infrastructure
plan: 05
type: execute
wave: 2
depends_on: ["01-01", "01-02", "01-03", "01-04"]
files_modified:
  - tests/unit/player/Player.test.jsx
  - vitest.config.js
autonomous: true

must_haves:
  truths:
    - "npm test runs all Player tests without failures"
    - "Coverage report shows Player.jsx tested paths"
    - "All phase 1 success criteria tests exist"
  artifacts:
    - path: "tests/unit/player/Player.test.jsx"
      provides: "Main Player.jsx test entry point aggregating all characterization tests"
      min_lines: 50
  key_links:
    - from: "tests/unit/player/Player.test.jsx"
      to: "tests/unit/player/Player.offline.test.jsx"
      via: "import or vitest discovery"
      pattern: "Player\\.offline"
    - from: "tests/unit/player/Player.test.jsx"
      to: "tests/unit/player/Player.sync.test.jsx"
      via: "import or vitest discovery"
      pattern: "Player\\.sync"
    - from: "tests/unit/player/Player.test.jsx"
      to: "tests/unit/player/Player.heartbeat.test.jsx"
      via: "import or vitest discovery"
      pattern: "Player\\.heartbeat"
---

<objective>
Create main Player test file and verify all Phase 1 tests work together.

Purpose: Ensure the complete test suite runs successfully, all Phase 1 success criteria are covered, and provide a single entry point for Player.jsx characterization tests.

Output: Main test file and verified passing test suite covering all success criteria.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-testing-infrastructure/01-RESEARCH.md

# Tests created in previous plans
@tests/unit/player/Player.offline.test.jsx
@tests/unit/player/Player.sync.test.jsx
@tests/unit/player/Player.heartbeat.test.jsx
@tests/unit/services/scheduleService.test.js
@tests/unit/player/offlineService.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create main Player.test.jsx entry point</name>
  <files>tests/unit/player/Player.test.jsx</files>
  <action>
Create a main test file that serves as the entry point for Player.jsx characterization tests.

This file should:
1. Import and re-export the test suites (or reference them for documentation)
2. Include basic smoke tests for Player component
3. Document the test coverage strategy

Content:
```javascript
/**
 * Player.jsx Characterization Tests
 *
 * Test suite covering Player.jsx behavior for safe refactoring.
 *
 * Test files:
 * - Player.offline.test.jsx  - Offline mode transitions (TEST-01)
 * - Player.sync.test.jsx     - Content sync flow (TEST-02)
 * - Player.heartbeat.test.jsx - Heartbeat/reconnection (TEST-03)
 *
 * Related service tests:
 * - scheduleService.test.js  - Schedule operations (TEST-04)
 * - offlineService.test.js   - Offline service functions (TEST-04)
 *
 * Run all Player tests:
 *   npm test -- tests/unit/player/
 *
 * Run with coverage:
 *   npm run test:coverage -- --reporter=text tests/unit/player/
 */

import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';
import { render, screen } from '@testing-library/react';
import { MemoryRouter } from 'react-router-dom';

// Mock all external dependencies
vi.mock('../../../src/supabase', () => ({
  supabase: {
    rpc: vi.fn().mockResolvedValue({ data: null, error: null }),
    // ... other mocks
  }
}));

vi.mock('../../../src/services/playerService', () => ({
  // ... mocks
}));

// Import component after mocks
import Player from '../../../src/Player';

describe('Player.jsx - Smoke Tests', () => {
  beforeEach(() => {
    vi.clearAllMocks();
    localStorage.clear();
  });

  it('renders without crashing', () => {
    // Basic render test
  });

  it('redirects to pairing page when no screenId stored', () => {
    // Verify navigation behavior
  });

  it('shows loading state initially', () => {
    // Verify loading indicator
  });
});

describe('Player.jsx - Phase 1 Success Criteria Coverage', () => {
  it('TEST-01: Offline mode transition tests exist', () => {
    // This test documents that Player.offline.test.jsx covers TEST-01
    expect(true).toBe(true); // Placeholder - actual tests in separate file
  });

  it('TEST-02: Content sync flow tests exist', () => {
    // This test documents that Player.sync.test.jsx covers TEST-02
    expect(true).toBe(true);
  });

  it('TEST-03: Heartbeat/reconnection tests exist', () => {
    // This test documents that Player.heartbeat.test.jsx covers TEST-03
    expect(true).toBe(true);
  });

  it('TEST-04: Service function tests exist', () => {
    // This test documents that scheduleService.test.js and offlineService.test.js cover TEST-04
    expect(true).toBe(true);
  });
});
```

The smoke tests provide basic sanity checks. The success criteria section serves as documentation linking tests to requirements.
  </action>
  <verify>
Run `npm test -- tests/unit/player/Player.test.jsx` - all tests pass.
  </verify>
  <done>
Main Player.test.jsx exists with smoke tests and success criteria documentation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify complete test suite and update coverage config</name>
  <files>vitest.config.js</files>
  <action>
Run the complete test suite and verify all tests pass. Then update coverage thresholds.

Steps:
1. Run all Player tests: `npm test -- tests/unit/player/`
2. Run service tests: `npm test -- tests/unit/services/scheduleService.test.js tests/unit/player/offlineService.test.js`
3. Run full test suite: `npm test`
4. Check coverage: `npm run test:coverage`

If all tests pass, update vitest.config.js coverage thresholds:
- Keep global thresholds at 0 (other code not yet tested)
- Add file-specific thresholds for Player.jsx if Vitest supports it

Review coverage report to identify:
- Which Player.jsx code paths are covered
- Any critical paths still untested

If any tests fail, fix them before proceeding.

Document coverage metrics in the summary.
  </action>
  <verify>
Run `npm test` - all tests pass (0 failures).
Run `npm run test:coverage` - coverage report generated.
  </verify>
  <done>
Complete test suite runs successfully. Coverage metrics documented.
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify Phase 1 Success Criteria</name>
  <files>None (verification only)</files>
  <action>
Verify each Phase 1 success criterion is met by running specific test commands.

Success Criteria from ROADMAP.md:
1. "Running `npm test` executes Player.jsx characterization tests without failures"
   - Run: `npm test -- tests/unit/player/`
   - Expected: 0 failures

2. "Offline mode transition test verifies player switches to cached content when network drops"
   - Run: `npm test -- tests/unit/player/Player.offline.test.jsx`
   - Expected: Test for "switches to cached content when getResolvedContent fails" passes

3. "Content sync test verifies player receives and renders updated playlist from server"
   - Run: `npm test -- tests/unit/player/Player.sync.test.jsx`
   - Expected: Test for "updates content when hash changes" passes

4. "Heartbeat test verifies player reconnects after connection loss"
   - Run: `npm test -- tests/unit/player/Player.heartbeat.test.jsx`
   - Expected: Test for "attempts reconnection with exponential backoff" passes

5. "Critical service functions (scheduleService, offlineService) have unit test coverage"
   - Run: `npm test -- tests/unit/services/scheduleService.test.js tests/unit/player/offlineService.test.js`
   - Expected: 0 failures

Document the verification results.
  </action>
  <verify>
All 5 success criteria verified with passing tests.
  </verify>
  <done>
Phase 1 success criteria verified and documented.
  </done>
</task>

</tasks>

<verification>
```bash
# Full test suite
npm test

# Player-specific tests
npm test -- tests/unit/player/

# Coverage report
npm run test:coverage -- tests/unit/player/

# Verify specific criteria tests exist
grep -l "switches to cached content" tests/unit/player/*.test.jsx
grep -l "updates content when hash changes" tests/unit/player/*.test.jsx
grep -l "reconnects after connection loss\|exponential backoff" tests/unit/player/*.test.jsx
```

Expected: All commands succeed, grep finds matching test descriptions.
</verification>

<success_criteria>
1. `npm test` executes all Player characterization tests without failures
2. Coverage report shows Player.jsx paths tested
3. Each Phase 1 success criterion has a corresponding test
4. Test suite completes in reasonable time (< 30 seconds)
5. No flaky tests (run 3 times, same results)
</success_criteria>

<output>
After completion, create `.planning/phases/01-testing-infrastructure/01-05-SUMMARY.md`
</output>
