---
phase: 01-testing-infrastructure
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/unit/player/Player.heartbeat.test.jsx
autonomous: true

must_haves:
  truths:
    - "Heartbeat tests execute and pass with npm test"
    - "Test verifies player reconnects after connection loss"
    - "Test verifies heartbeat sends at 30-second intervals"
    - "Test verifies device status update during heartbeat"
  artifacts:
    - path: "tests/unit/player/Player.heartbeat.test.jsx"
      provides: "Heartbeat/reconnection characterization tests"
      min_lines: 100
  key_links:
    - from: "tests/unit/player/Player.heartbeat.test.jsx"
      to: "src/Player.jsx"
      via: "import and render"
      pattern: "import.*Player"
---

<objective>
Create characterization tests for Player.jsx heartbeat and reconnection behavior.

Purpose: Verify the player maintains connection to the server via heartbeats and properly recovers from connection failures. This is critical for monitoring device health and ensuring screens recover automatically from network issues.

Output: Test file covering heartbeat/reconnection with passing tests that verify correctness.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-testing-infrastructure/01-RESEARCH.md

# Existing test patterns
@tests/setup.js
@tests/utils/mocks.js

# Component under test - heartbeat logic
@src/Player.jsx (lines 2184-2241 - heartbeat effect)
@src/services/playerService.js (HEARTBEAT_INTERVAL, updateDeviceStatus)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create heartbeat mechanism tests</name>
  <files>tests/unit/player/Player.heartbeat.test.jsx</files>
  <action>
Create characterization tests for Player.jsx heartbeat behavior.

Test structure:
```
describe('Player.jsx - Heartbeat Mechanism')
  describe('Heartbeat interval')
    it('sends heartbeat immediately on mount')
    it('sends heartbeat every 30 seconds (HEARTBEAT_INTERVAL)')
    it('includes player version in heartbeat')
    it('includes content hash in heartbeat')

  describe('Device status updates')
    it('calls updateDeviceStatus with screenId and version')
    it('updates lastActivityRef on successful heartbeat')
    it('handles screenshot request from server')

  describe('Refresh status checking')
    it('checks refresh status after successful heartbeat')
    it('reloads content when needs_refresh is true')
    it('clears refresh flag after reloading')
    it('continues heartbeat even if refresh check fails')

  describe('Heartbeat cleanup')
    it('clears heartbeat interval on unmount')
    it('stops heartbeats when screen is unpaired')
```

Key behaviors to verify (from src/Player.jsx lines 2184-2241):
1. Heartbeat interval: 30000ms (HEARTBEAT_INTERVAL from playerService)
2. sendBeat calls: updateDeviceStatus(screenId, PLAYER_VERSION, contentHash)
3. After heartbeat: checkDeviceRefreshStatus(screenId)
4. If needs_refresh: loadContentRef.current?.(screenId, false)
5. Cleanup: clearInterval(heartbeatRef.current)

Mock setup:
- Mock `src/services/playerService` for updateDeviceStatus
- Mock `src/services/deviceSyncService` for checkDeviceRefreshStatus, clearDeviceRefreshFlag
- Use vi.useFakeTimers()
- vi.advanceTimersByTimeAsync(30000) to trigger heartbeat

HEARTBEAT_INTERVAL is exported from playerService (30000ms).

Test that heartbeat:
1. Fires on schedule
2. Updates device status
3. Triggers content refresh when flagged
  </action>
  <verify>
Run `npm test -- tests/unit/player/Player.heartbeat.test.jsx` - all tests pass.
  </verify>
  <done>
Heartbeat mechanism tests exist and pass, verifying interval and status updates.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create reconnection behavior tests</name>
  <files>tests/unit/player/Player.heartbeat.test.jsx</files>
  <action>
Add reconnection tests to the heartbeat test file.

Additional test cases:
```
describe('Player.jsx - Reconnection Behavior')
  describe('Error tracking')
    it('tracks consecutive polling errors')
    it('sets status to reconnecting after 3 consecutive errors')
    it('resets error count on successful poll')

  describe('Reconnection attempts')
    it('calls loadContent with retry flag after threshold')
    it('uses exponential backoff for retries')
    it('sets status to offline if reconnection fails')
    it('restores connected status on successful reconnection')

  describe('Connection status transitions')
    it('status: connecting -> connected on initial load')
    it('status: connected -> reconnecting on repeated errors')
    it('status: reconnecting -> offline on failed reconnection')
    it('status: offline -> connected on successful reconnection')
```

Key behaviors (from src/Player.jsx lines 2524-2596):
1. MAX_CONSECUTIVE_ERRORS = 3
2. After 3 errors: setConnectionStatus('reconnecting')
3. Call loadContent(screenId, true) for retry with backoff
4. If reconnect fails: setConnectionStatus('offline')
5. If reconnect succeeds: error count reset to 0

Backoff logic (lines 111-138):
- retryWithBackoff(fn, maxRetries=5)
- getRetryDelay(attempt) = min(baseDelay * 2^attempt, maxDelay) + jitter
- baseDelayMs: 2000, maxDelayMs: 60000

Test the state machine transitions, not just individual calls.
  </action>
  <verify>
Run `npm test -- tests/unit/player/Player.heartbeat.test.jsx` - all tests pass including reconnection tests.
  </verify>
  <done>
Heartbeat and reconnection tests exist and pass, verifying:
- 30-second heartbeat interval
- Reconnection after connection loss
- Connection status state machine
  </done>
</task>

</tasks>

<verification>
```bash
# Run heartbeat tests
npm test -- tests/unit/player/Player.heartbeat.test.jsx

# Check for proper interval testing
grep -c "advanceTimers" tests/unit/player/Player.heartbeat.test.jsx
```

Expected: All heartbeat and reconnection tests pass, using fake timers for intervals.
</verification>

<success_criteria>
1. `npm test` includes Player.heartbeat.test.jsx and passes
2. Tests verify heartbeat fires every 30 seconds
3. Tests verify reconnection after connection loss
4. Tests verify connection status transitions
5. Tests use fake timers properly (no real delays)
</success_criteria>

<output>
After completion, create `.planning/phases/01-testing-infrastructure/01-03-SUMMARY.md`
</output>
