---
phase: 04-logging-migration
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/services/authService.js
  - src/services/mfaService.js
  - src/services/sessionService.js
  - src/services/securityService.js
  - src/services/passwordService.js
  - src/services/rateLimitService.js
  - src/services/billingService.js
  - src/services/gdprService.js
  - src/services/tenantService.js
  - src/services/permissionsService.js
  - src/services/playerService.js
  - src/services/playerAnalyticsService.js
  - src/services/playbackTrackingService.js
  - src/services/deviceSyncService.js
  - src/services/screenTelemetryService.js
  - src/services/deviceScreenshotService.js
autonomous: true

must_haves:
  truths:
    - "Auth services use structured logger with appropriate log levels"
    - "Sensitive operations (login, MFA, billing) log with correlation IDs"
    - "No PII appears in auth/security service logs"
    - "Player services log with scoped logger for debugging"
  artifacts:
    - path: "src/services/authService.js"
      provides: "Auth operations with structured logging"
      contains: "createScopedLogger"
    - path: "src/services/playerService.js"
      provides: "Player operations with structured logging"
      contains: "createScopedLogger"
  key_links:
    - from: "src/services/authService.js"
      to: "src/services/loggingService.js"
      via: "import createScopedLogger"
      pattern: "import.*loggingService"
    - from: "src/services/playerService.js"
      to: "src/services/loggingService.js"
      via: "import createScopedLogger"
      pattern: "import.*loggingService"
---

<objective>
Migrate high-priority services (auth, security, player) to structured logging.

Purpose: These services handle sensitive data and critical operations. Migrating them first ensures PII is redacted from day one and provides the best debugging value with correlation IDs. This is the first batch of the migration (16 services, ~150 console calls).

Output: Auth, security, and player services use createScopedLogger with appropriate log levels.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-logging-migration/04-RESEARCH.md
@.planning/phases/04-logging-migration/04-01-SUMMARY.md
@src/services/loggingService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify logging infrastructure and imports</name>
  <files>
    src/services/loggingService.js
  </files>
  <action>
Before migrating services, verify the logging infrastructure from Plan 01 is working:

1. Verify loggingService.js exports:
   ```bash
   grep -E "export (const|function|{)" src/services/loggingService.js
   ```
   Expected exports: log, createScopedLogger, getCorrelationId, setLogContext

2. Test import works from a service file location:
   ```bash
   node -e "import('./src/services/loggingService.js').then(m => console.log('Exports:', Object.keys(m)))"
   ```

3. Verify createScopedLogger returns a logger with expected methods:
   ```bash
   node -e "import('./src/services/loggingService.js').then(m => { const l = m.createScopedLogger('Test'); console.log('Logger methods:', Object.keys(l)); })"
   ```
   Expected: debug, info, warn, error (at minimum)

4. If any verification fails, check 04-01-SUMMARY.md for what was implemented and ensure exports are correct.

This is a quick sanity check to catch import issues early before modifying 16 files.
  </action>
  <verify>
1. `grep "createScopedLogger" src/services/loggingService.js` shows the export
2. `node -e "import('./src/services/loggingService.js').then(m => console.log(typeof m.createScopedLogger))"` outputs "function"
  </verify>
  <done>Logging infrastructure verified: createScopedLogger is exported and functional</done>
</task>

<task type="auto">
  <name>Task 2: Migrate auth and security services</name>
  <files>
    src/services/authService.js
    src/services/mfaService.js
    src/services/sessionService.js
    src/services/securityService.js
    src/services/passwordService.js
    src/services/rateLimitService.js
  </files>
  <action>
For each file in this batch (auth/security related - ~50 console calls total):

1. Add import at top of file:
   ```js
   import { createScopedLogger } from './loggingService.js';
   const logger = createScopedLogger('ServiceName');
   ```
   Use service name matching file (e.g., 'AuthService', 'MfaService', etc.)

2. Replace console calls with appropriate log levels:
   - console.error -> logger.error (keep for actual errors)
   - console.warn -> logger.warn (keep for warnings)
   - console.log with error context -> logger.error
   - console.log with success context -> logger.info
   - console.log for debugging -> logger.debug
   - console.log for verbose tracing -> logger.debug (or remove if truly unnecessary)

3. Restructure log calls to use structured data:
   BEFORE: console.log('User logged in:', userId)
   AFTER:  logger.info('User logged in', { userId })

   BEFORE: console.error('Auth failed:', error)
   AFTER:  logger.error('Auth failed', { error })

   BEFORE: console.log('MFA verified for', email)
   AFTER:  logger.info('MFA verified', { email }) // PII auto-redacted

4. For error objects, pass as { error: err } to get stack trace handling.

5. Remove any truly redundant logs (e.g., "entering function X") unless they provide debugging value.

Security note: PII like email is auto-redacted by loggingService. No need to manually redact.
  </action>
  <verify>
1. `grep -c "console\." src/services/authService.js` should return 0
2. `grep -c "console\." src/services/mfaService.js` should return 0
3. Repeat for all files in this task
4. `npm run build` should succeed
  </verify>
  <done>Auth and security services (6 files) have zero console.log calls, use structured logger</done>
</task>

<task type="auto">
  <name>Task 3: Migrate player and telemetry services</name>
  <files>
    src/services/playerService.js
    src/services/playerAnalyticsService.js
    src/services/playbackTrackingService.js
    src/services/deviceSyncService.js
    src/services/screenTelemetryService.js
    src/services/deviceScreenshotService.js
  </files>
  <action>
For each file in this batch (player/device related - ~75 console calls total):

1. Add import at top:
   ```js
   import { createScopedLogger } from './loggingService.js';
   const logger = createScopedLogger('ServiceName');
   ```

2. Apply same transformation rules as Task 2.

3. Special considerations for player services:
   - These may run in offline contexts
   - Use logger.debug for frequent operations (heartbeat, telemetry)
   - Use logger.info for state changes (connected, disconnected)
   - Use logger.warn for recoverable issues (retry, cache fallback)
   - Use logger.error for failures that affect playback

4. For playerService.js specifically (22 calls - largest in this batch):
   - Group related logs logically
   - Ensure screen ID is included in log data for filtering
   - Example: logger.info('Heartbeat sent', { screenId, status })
  </action>
  <verify>
1. `grep -c "console\." src/services/playerService.js` should return 0
2. `grep -c "console\." src/services/playerAnalyticsService.js` should return 0
3. Repeat for all files in this task
4. `npm run build` should succeed
  </verify>
  <done>Player and telemetry services (6 files) have zero console.log calls, use structured logger</done>
</task>

<task type="auto">
  <name>Task 4: Migrate billing, GDPR, and tenant services</name>
  <files>
    src/services/billingService.js
    src/services/gdprService.js
    src/services/tenantService.js
    src/services/permissionsService.js
  </files>
  <action>
For each file in this batch (~25 console calls total):

1. Add import and create scoped logger as before.

2. Apply transformation rules:
   - billingService: Be extra careful with PII (customer data)
     - Use logger.info for successful operations
     - Use logger.warn for payment issues
     - Use logger.error for failures

   - gdprService: Critical for compliance
     - Log all data access/deletion requests at info level
     - Include request IDs for audit trail

   - tenantService: Multi-tenant operations
     - Always include tenantId in log data
     - Use logger.debug for routine operations

   - permissionsService: Security-sensitive
     - Log permission checks at debug level (high volume)
     - Log permission changes at info level

3. Ensure error objects are properly structured: { error: err }
  </action>
  <verify>
1. `grep -c "console\." src/services/billingService.js` should return 0
2. `grep -c "console\." src/services/gdprService.js` should return 0
3. `grep -c "console\." src/services/tenantService.js` should return 0
4. `grep -c "console\." src/services/permissionsService.js` should return 0
5. `npm run build` should succeed
  </verify>
  <done>Billing, GDPR, tenant, and permissions services have zero console.log calls</done>
</task>

</tasks>

<verification>
1. All 16 service files have zero console.log/error/warn calls (except inside loggingService.js itself)
2. All services import createScopedLogger from loggingService
3. `npm run build` succeeds
4. `npm run lint` runs without new errors (warnings expected in unmigrated files)
5. Quick manual test: Trigger an auth action and verify structured log appears in console
</verification>

<success_criteria>
- 16 high-priority service files migrated to structured logging
- Zero console.log calls in migrated files
- All migrated files import from loggingService.js
- Log levels applied consistently (error for failures, warn for issues, info for events, debug for tracing)
- Build and lint pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-logging-migration/04-03-SUMMARY.md`
</output>
