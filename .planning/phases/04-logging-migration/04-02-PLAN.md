---
phase: 04-logging-migration
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - eslint.config.js
  - vite.config.js
  - package.json
autonomous: true

must_haves:
  truths:
    - "ESLint warns on console.log usage in source files"
    - "Production builds strip console.log calls via Terser"
    - "Test files are exempt from no-console rule"
    - "console.warn and console.error are allowed (for graceful degradation)"
  artifacts:
    - path: "eslint.config.js"
      provides: "ESLint flat config with no-console rule"
      contains: "no-console"
    - path: "vite.config.js"
      provides: "Terser config for production console removal"
      contains: "drop_console"
    - path: "package.json"
      provides: "terser dev dependency"
      contains: "terser"
  key_links:
    - from: "vite.config.js"
      to: "terser"
      via: "build.minify and terserOptions"
      pattern: "minify.*terser"
---

<objective>
Configure build-time enforcement to prevent console.log regression after migration.

Purpose: Establish guardrails that will catch any new console.log calls and strip remaining ones from production builds. This runs in parallel with infrastructure enhancement (Plan 01) since they don't share files.

Output: ESLint config with no-console rule, Vite config with Terser console stripping, terser installed.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-logging-migration/04-RESEARCH.md
@vite.config.js
@package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ESLint flat config with no-console rule</name>
  <files>eslint.config.js</files>
  <action>
Create eslint.config.js using the flat config format (ESLint 9+). The project already has eslint 9.36.0 and supporting plugins installed.

```js
import js from '@eslint/js';
import globals from 'globals';
import reactHooks from 'eslint-plugin-react-hooks';
import reactRefresh from 'eslint-plugin-react-refresh';

export default [
  // Ignore patterns
  { ignores: ['dist/**', 'node_modules/**', 'coverage/**', 'perf-reports/**'] },

  // Base config for all JS/JSX files
  {
    files: ['**/*.{js,jsx}'],
    languageOptions: {
      ecmaVersion: 2024,
      sourceType: 'module',
      globals: {
        ...globals.browser,
        ...globals.es2024,
      },
    },
    plugins: {
      'react-hooks': reactHooks,
      'react-refresh': reactRefresh,
    },
    rules: {
      ...js.configs.recommended.rules,
      ...reactHooks.configs.recommended.rules,
      'react-refresh/only-export-components': ['warn', { allowConstantExport: true }],

      // Console rule - warn for now (will become error after migration)
      'no-console': ['warn', {
        allow: ['warn', 'error']
      }],
    },
  },

  // Relaxed rules for test files
  {
    files: ['**/*.test.{js,jsx}', '**/*.spec.{js,jsx}', 'tests/**/*.{js,jsx}'],
    rules: {
      'no-console': 'off',
    },
  },

  // Relaxed rules for config files
  {
    files: ['vite.config.js', 'vitest.config.js', 'playwright.config.js', 'tailwind.config.js', 'postcss.config.js'],
    languageOptions: {
      globals: {
        ...globals.node,
      },
    },
    rules: {
      'no-console': 'off',
    },
  },

  // Scripts can use console
  {
    files: ['scripts/**/*.{js,cjs}', 'load-tests/**/*.js'],
    languageOptions: {
      globals: {
        ...globals.node,
      },
    },
    rules: {
      'no-console': 'off',
    },
  },
];
```

Note: Rule is 'warn' initially. After migration completes, Plan 06 will change to 'error'.
  </action>
  <verify>
Run: `npm run lint -- --max-warnings=0 2>&1 | head -20`
Should see console.log warnings from src/ files (expected - we haven't migrated yet).
Verify test files don't trigger warnings.
  </verify>
  <done>ESLint config exists with no-console rule, warns on console.log in source files</done>
</task>

<task type="auto">
  <name>Task 2: Configure Vite with Terser for production console removal</name>
  <files>vite.config.js, package.json</files>
  <action>
1. First, install terser as dev dependency:
   ```bash
   npm install terser --save-dev
   ```

2. Update vite.config.js to add Terser configuration for production builds:
   - Add minify: 'terser' to build options
   - Add terserOptions with drop_console and drop_debugger
   - Keep pure_funcs as backup for specific functions

The build section should look like:
```js
build: {
  // Use terser for console removal (esbuild doesn't support drop_console)
  minify: 'terser',
  terserOptions: {
    compress: {
      drop_console: true,      // Remove all console.* calls
      drop_debugger: true,     // Remove debugger statements
      pure_funcs: ['console.log', 'console.debug', 'console.trace'],
    },
    format: {
      comments: false,         // Remove comments in production
    },
  },
  // Existing config below...
  chunkSizeWarningLimit: 600,
  rollupOptions: {
    // ... existing rollupOptions
  },
},
```

Important: Keep all existing build configuration (chunkSizeWarningLimit, rollupOptions with manualChunks). We're adding to it, not replacing.
  </action>
  <verify>
1. Run `npm run build` - should complete without errors
2. Check dist/ output: `grep -r "console.log" dist/*.js | head -5`
   Should return empty (console.log stripped from production build)
3. Check package.json: `grep terser package.json` should show it in devDependencies
  </verify>
  <done>Production builds strip console.log calls, terser installed</done>
</task>

</tasks>

<verification>
1. `npm run lint` runs without errors (warnings are expected for now)
2. `npm run build` completes successfully
3. Production bundle contains no console.log calls
4. Test files are exempt from no-console rule
5. console.warn and console.error are allowed everywhere
</verification>

<success_criteria>
- eslint.config.js exists with no-console rule
- vite.config.js has Terser config with drop_console: true
- terser is in package.json devDependencies
- `npm run lint` shows warnings for console.log in src/
- `npm run build` produces bundle without console.log
</success_criteria>

<output>
After completion, create `.planning/phases/04-logging-migration/04-02-SUMMARY.md`
</output>
