---
phase: 04-logging-migration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/utils/pii.js
  - src/utils/safeStringify.js
  - src/hooks/useLogger.js
  - src/services/loggingService.js
autonomous: true

must_haves:
  truths:
    - "PII patterns (email, phone, credit card, SSN) are detected and redacted"
    - "Circular references in logged objects don't crash the logger"
    - "React components can use useLogger hook for scoped logging"
    - "Correlation IDs propagate through all log entries"
  artifacts:
    - path: "src/utils/pii.js"
      provides: "PII detection and redaction utilities"
      exports: ["redactPII", "redactObject", "PII_PATTERNS"]
    - path: "src/utils/safeStringify.js"
      provides: "Circular-safe JSON serialization"
      exports: ["safeStringify"]
    - path: "src/hooks/useLogger.js"
      provides: "React hook for component-scoped logging"
      exports: ["useLogger"]
    - path: "src/services/loggingService.js"
      provides: "Enhanced structured logger with PII redaction"
      exports: ["log", "createScopedLogger", "getCorrelationId"]
  key_links:
    - from: "src/services/loggingService.js"
      to: "src/utils/pii.js"
      via: "import redactObject, redactPII"
      pattern: "import.*from.*pii"
    - from: "src/services/loggingService.js"
      to: "src/utils/safeStringify.js"
      via: "import safeStringify"
      pattern: "import.*safeStringify"
    - from: "src/hooks/useLogger.js"
      to: "src/services/loggingService.js"
      via: "import createScopedLogger"
      pattern: "import.*createScopedLogger"
---

<objective>
Enhance logging infrastructure with PII redaction, safe serialization, and React integration.

Purpose: Establish the foundation for structured logging migration. The existing loggingService.js already has correlation IDs, log levels, and batching - this plan adds the missing pieces: PII redaction, circular reference handling, and a React hook for components.

Output: Enhanced loggingService.js with pii.js, safeStringify.js utilities, and useLogger.js hook ready for migration.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-logging-migration/04-RESEARCH.md
@src/services/loggingService.js
@src/utils/errorTracking.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create PII redaction utilities</name>
  <files>src/utils/pii.js</files>
  <action>
Create src/utils/pii.js with PII detection and redaction:

1. Define PII_PATTERNS constant with regex patterns for:
   - email: Standard email pattern
   - phone: US/international phone formats
   - creditCard: 16-digit card numbers (with optional separators)
   - ssn: XXX-XX-XXXX format

2. Export redactPII(text, options) function:
   - If text is not a string, return unchanged
   - Replace each pattern match with [TYPE_REDACTED] (e.g., [EMAIL_REDACTED])
   - Accept options.patterns to override default patterns

3. Export redactObject(obj, options) function:
   - If not an object, return unchanged
   - Define sensitiveKeys: ['password', 'token', 'secret', 'key', 'authorization', 'credential', 'apiKey', 'accessToken', 'refreshToken']
   - Recursively process object:
     - If key contains any sensitiveKey (case-insensitive), replace value with '[REDACTED]'
     - If value is string, apply redactPII
     - If value is object/array, recurse
   - Handle arrays properly
   - Return new object (don't mutate input)

Reference existing pattern in src/utils/errorTracking.js beforeSend for email redaction.
  </action>
  <verify>
Create a quick test in Node REPL or add console.log test:
```js
import { redactPII, redactObject } from './src/utils/pii.js';
console.log(redactPII('Contact: user@example.com')); // Should show [EMAIL_REDACTED]
console.log(redactObject({ email: 'test@test.com', password: 'secret123' }));
// Should show { email: '[EMAIL_REDACTED]', password: '[REDACTED]' }
```
  </verify>
  <done>PII redaction utilities work correctly on strings and nested objects</done>
</task>

<task type="auto">
  <name>Task 2: Create safe stringify utility</name>
  <files>src/utils/safeStringify.js</files>
  <action>
Create src/utils/safeStringify.js to handle circular references:

1. Export safeStringify(obj, replacer = null, space = 2) function:
   - Use WeakSet to track seen objects
   - Create circularReplacer function that:
     - Checks if value is object and not null
     - If already in seen set, return '[Circular]'
     - Otherwise add to seen set
     - Special handling for Error objects: return { name, message, stack (first 5 lines) }
     - Special handling for DOM nodes: return '[DOMNode]' or similar
     - Apply custom replacer if provided
   - Wrap JSON.stringify in try/catch
   - On error, return JSON.stringify({ error: 'Failed to stringify', type: typeof obj })

2. Handle edge cases:
   - undefined values (JSON.stringify drops them - document this behavior)
   - Functions (return '[Function]')
   - Symbols (return '[Symbol]')
   - BigInt (return value.toString() + 'n')
  </action>
  <verify>
Test with circular reference:
```js
import { safeStringify } from './src/utils/safeStringify.js';
const obj = { a: 1 };
obj.self = obj;
console.log(safeStringify(obj)); // Should show { "a": 1, "self": "[Circular]" }
const err = new Error('test');
console.log(safeStringify({ error: err })); // Should show error object with name, message, stack
```
  </verify>
  <done>safeStringify handles circular references, Errors, and special types without throwing</done>
</task>

<task type="auto">
  <name>Task 3: Create useLogger React hook and enhance loggingService</name>
  <files>src/hooks/useLogger.js, src/services/loggingService.js</files>
  <action>
1. Create src/hooks/useLogger.js:
   - Import useMemo from 'react'
   - Import createScopedLogger from '../services/loggingService'
   - Export useLogger(componentName) hook:
     - Return useMemo(() => createScopedLogger(componentName), [componentName])
   - Add JSDoc explaining this provides component-scoped logging with stable reference

2. Enhance src/services/loggingService.js:
   - Add imports at top:
     ```js
     import { redactObject, redactPII } from '../utils/pii.js';
     import { safeStringify } from '../utils/safeStringify.js';
     ```
   - Modify createLogEntry function:
     - Apply redactPII to message parameter
     - Apply redactObject to rest (data without error)
     - Apply redactPII to error.message if error exists
   - Modify formatForConsole (if needed) to use safeStringify for data
   - Add export for getCorrelationId if not already exported (it is)
   - Keep all existing functionality intact (batching, sampling, levels, etc.)

Note: The existing loggingService.js is well-designed. We're enhancing, not replacing.
  </action>
  <verify>
1. Check imports resolve: `npm run build` should not fail on missing imports
2. Test enhanced logging:
```js
import { log, createScopedLogger } from './src/services/loggingService.js';
log.info('User logged in', { email: 'user@test.com', password: 'secret' });
// Console should show redacted values
```
  </verify>
  <done>useLogger hook exists and loggingService.js applies PII redaction to all log entries</done>
</task>

</tasks>

<verification>
1. All three utility files exist and export expected functions
2. `npm run build` completes without errors
3. Import chain works: loggingService -> pii.js, safeStringify.js
4. Manual test: log.info with email shows [EMAIL_REDACTED]
5. Manual test: logging object with circular reference doesn't crash
</verification>

<success_criteria>
- src/utils/pii.js exports redactPII, redactObject, PII_PATTERNS
- src/utils/safeStringify.js exports safeStringify
- src/hooks/useLogger.js exports useLogger hook
- loggingService.js imports and uses pii.js and safeStringify.js
- PII is automatically redacted in all log output
- Circular references are safely handled
</success_criteria>

<output>
After completion, create `.planning/phases/04-logging-migration/04-01-SUMMARY.md`
</output>
