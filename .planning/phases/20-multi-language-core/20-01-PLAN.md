---
phase: 20-multi-language-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/132_multi_language_scenes.sql
  - src/services/languageService.js
autonomous: true

must_haves:
  truths:
    - "Database supports language variants linked by group ID"
    - "RPC resolves correct scene variant based on device language"
    - "Fallback returns default language when translation missing"
  artifacts:
    - path: "supabase/migrations/132_multi_language_scenes.sql"
      provides: "scene_language_groups table, language columns, RPC"
      contains: "scene_language_groups"
    - path: "src/services/languageService.js"
      provides: "Language variant CRUD operations"
      exports: ["createLanguageVariant", "fetchLanguageVariants", "getAvailableLanguagesForScene"]
  key_links:
    - from: "src/services/languageService.js"
      to: "supabase RPC"
      via: "supabase.rpc calls"
      pattern: "supabase\\.rpc"
---

<objective>
Create the database schema and service layer for multi-language scene support.

Purpose: Foundation for all language variant features - without this schema and service, no other language features can work.
Output: Migration file with tables/RPC, languageService.js with variant CRUD functions.
</objective>

<execution_context>
@/Users/massimodamico/.claude/get-shit-done/workflows/execute-plan.md
@/Users/massimodamico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-multi-language-core/20-CONTEXT.md
@.planning/phases/20-multi-language-core/20-RESEARCH.md
@src/services/sceneService.js
@src/i18n/i18nConfig.js
@supabase/migrations/041_internationalization_locale_preferences.sql
@supabase/migrations/069_scene_slides_and_design_json.sql
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create multi-language database migration</name>
  <files>supabase/migrations/132_multi_language_scenes.sql</files>
  <action>
Create migration 132_multi_language_scenes.sql with:

1. **scene_language_groups table:**
   - id (uuid PK DEFAULT gen_random_uuid())
   - tenant_id (uuid NOT NULL FK -> profiles ON DELETE CASCADE)
   - default_language (text NOT NULL DEFAULT 'en')
   - created_at, updated_at timestamps
   - RLS enabled with tenant-based policies

2. **scenes table alterations:**
   - ADD COLUMN language_group_id uuid REFERENCES scene_language_groups(id) ON DELETE SET NULL
   - ADD COLUMN language_code text DEFAULT NULL
   - ADD CONSTRAINT scenes_language_code_valid CHECK (language_code IS NULL OR is_valid_locale(language_code))
   - CREATE INDEX idx_scenes_language_group ON scenes(language_group_id) WHERE language_group_id IS NOT NULL
   - CREATE INDEX idx_scenes_language_code ON scenes(language_code) WHERE language_code IS NOT NULL

3. **tv_devices table alteration:**
   - ADD COLUMN display_language text NOT NULL DEFAULT 'en'
   - ADD CONSTRAINT tv_devices_display_language_valid CHECK (is_valid_locale(display_language))

4. **RPC function get_scene_for_device_language:**
   - Parameters: p_scene_id uuid, p_device_language text DEFAULT 'en'
   - Returns: uuid (the resolved scene ID)
   - Logic:
     a. Get scene's language_group_id
     b. If no group, return original scene ID
     c. Try to find variant matching device language
     d. If not found, get default_language variant from group
     e. COALESCE fallback to original scene (never return NULL)
   - SECURITY DEFINER for tenant context

5. **RLS policies for scene_language_groups:**
   - SELECT/INSERT/UPDATE/DELETE based on tenant_id = auth.uid() OR is_super_admin()

Use existing patterns from migrations 041 (is_valid_locale) and 069 (scene_slides RLS).
  </action>
  <verify>
Run: `supabase db reset` or `supabase migration up` succeeds without errors.
Check: Tables and columns exist via `\d scenes` and `\d tv_devices` in psql.
Check: RPC exists via `\df get_scene_for_device_language`.
  </verify>
  <done>
Migration applies cleanly. scene_language_groups table exists. scenes has language_group_id and language_code columns. tv_devices has display_language column. RPC get_scene_for_device_language exists and handles fallback correctly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create languageService.js</name>
  <files>src/services/languageService.js</files>
  <action>
Create src/services/languageService.js with:

1. **Imports:**
   - supabase from '../supabase'
   - SUPPORTED_LOCALES from '../i18n/i18nConfig'
   - createScopedLogger from './loggingService'

2. **createLanguageGroup(tenantId, defaultLanguage = 'en'):**
   - Insert into scene_language_groups
   - Return created group

3. **createLanguageVariant(originalSceneId, languageCode):**
   - Fetch original scene with slides (use sceneService pattern)
   - If no language_group_id, create one and update original scene
   - Create new scene with:
     - Same tenant_id, layout_id, primary_playlist_id, etc.
     - name: `${original.name} (${languageCode.toUpperCase()})`
     - language_group_id: the group ID
     - language_code: the new language code
   - Copy slides from original (per CONTEXT.md - copy original content)
   - Return new variant scene

4. **fetchLanguageVariants(sceneId):**
   - Get scene's language_group_id
   - If no group, return array with just original (id, language_code: 'en', is_default: true)
   - Query all scenes in the group ordered by language_code
   - Return array of { id, name, language_code }

5. **getAvailableLanguagesForScene(sceneId):**
   - Call fetchLanguageVariants
   - Map to just language codes
   - Return array of codes

6. **resolveSceneForDevice(sceneId, deviceLanguage):**
   - Call RPC get_scene_for_device_language
   - Return resolved scene ID

7. **getLanguageDisplayInfo(code):**
   - Find in SUPPORTED_LOCALES
   - Return { code, name, nativeName } or { code, name: code.toUpperCase(), nativeName: code.toUpperCase() }

8. **LANGUAGE_COLORS constant:**
   - Map of language codes to Tailwind color classes (for badges)
   - en: 'bg-blue-50 text-blue-700', es: 'bg-orange-50 text-orange-700', etc.

Export all functions as named exports plus default object.
  </action>
  <verify>
Run: `npm run lint src/services/languageService.js` passes.
Check: File imports resolve correctly.
Manual test: Import in browser console and call getLanguageDisplayInfo('es').
  </verify>
  <done>
languageService.js exists with all functions. createLanguageVariant copies slides. fetchLanguageVariants returns variants in group. resolveSceneForDevice calls RPC correctly. LANGUAGE_COLORS exported.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add copySlides helper to sceneDesignService</name>
  <files>src/services/sceneDesignService.js</files>
  <action>
Add a helper function to src/services/sceneDesignService.js (or languageService if circular import):

**copySlides(sourceSceneId, targetSceneId):**
- Fetch all slides for source scene (ordered by position)
- Insert copies for target scene with:
  - New IDs (let DB generate)
  - scene_id: targetSceneId
  - Same position, title, kind, design_json, duration_seconds
- Return created slides

This supports the variant creation flow where we copy the original's slides.

Use existing fetchSlidesForScene and createSlide patterns from sceneDesignService.
  </action>
  <verify>
Run: `npm run lint src/services/sceneDesignService.js` passes.
Check: copySlides is exported.
  </verify>
  <done>
copySlides function exists and is exported. Can copy all slides from one scene to another.
  </done>
</task>

</tasks>

<verification>
1. Database migration applies: `supabase db reset` completes without errors
2. Schema correct: scenes has language_group_id, language_code; tv_devices has display_language
3. RPC works: Can call get_scene_for_device_language and get valid scene ID
4. Service imports: `import { createLanguageVariant } from './services/languageService'` works
5. All functions exist and have correct signatures
</verification>

<success_criteria>
- Migration 132_multi_language_scenes.sql applies cleanly
- scene_language_groups table exists with RLS
- scenes table has language_group_id and language_code columns
- tv_devices table has display_language column with valid default
- RPC get_scene_for_device_language handles fallback (never returns NULL)
- languageService.js exports all required functions
- copySlides helper enables variant creation with content
</success_criteria>

<output>
After completion, create `.planning/phases/20-multi-language-core/20-01-SUMMARY.md`
</output>
