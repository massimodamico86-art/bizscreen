---
phase: 20-multi-language-core
plan: 03
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - src/components/scene-editor/EditorLanguageSwitcher.jsx
  - src/pages/SceneEditorPage.jsx
  - src/components/scenes/AddLanguageModal.jsx
autonomous: true

must_haves:
  truths:
    - "User can switch between language versions in the editor"
    - "User can create a new language variant of a scene"
    - "Switching languages loads the correct variant's slides"
    - "Unsaved changes prompt before language switch"
  artifacts:
    - path: "src/components/scene-editor/EditorLanguageSwitcher.jsx"
      provides: "Language dropdown for editor top bar"
      exports: ["EditorLanguageSwitcher"]
    - path: "src/components/scenes/AddLanguageModal.jsx"
      provides: "Modal for creating language variants"
      exports: ["AddLanguageModal"]
    - path: "src/pages/SceneEditorPage.jsx"
      provides: "Editor with language switcher integration"
      contains: "EditorLanguageSwitcher"
  key_links:
    - from: "src/pages/SceneEditorPage.jsx"
      to: "src/services/languageService.js"
      via: "fetchLanguageVariants call"
      pattern: "fetchLanguageVariants"
    - from: "src/components/scenes/AddLanguageModal.jsx"
      to: "src/services/languageService.js"
      via: "createLanguageVariant call"
      pattern: "createLanguageVariant"
---

<objective>
Add language switching and variant creation to the CMS editor.

Purpose: Users need to switch between language versions when editing (LANG-04) and create new language variants (LANG-01).
Output: EditorLanguageSwitcher dropdown, AddLanguageModal, editor integration.
</objective>

<execution_context>
@/Users/massimodamico/.claude/get-shit-done/workflows/execute-plan.md
@/Users/massimodamico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-multi-language-core/20-CONTEXT.md
@.planning/phases/20-multi-language-core/20-RESEARCH.md
@.planning/phases/20-multi-language-core/20-01-SUMMARY.md
@src/pages/SceneEditorPage.jsx
@src/i18n/i18nConfig.js
@src/services/languageService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create EditorLanguageSwitcher component</name>
  <files>src/components/scene-editor/EditorLanguageSwitcher.jsx</files>
  <action>
Create src/components/scene-editor/EditorLanguageSwitcher.jsx:

```jsx
/**
 * EditorLanguageSwitcher
 *
 * Dropdown selector for switching between language variants in the editor.
 * Per CONTEXT.md: Dropdown (not tabs), shows native names only.
 */
import { useState } from 'react';
import { Globe, Plus, ChevronDown } from 'lucide-react';
import { getLanguageDisplayInfo } from '../../services/languageService';
import { SUPPORTED_LOCALES } from '../../i18n/i18nConfig';

export function EditorLanguageSwitcher({
  currentLanguage,
  availableVariants, // Array of { id, name, language_code }
  onLanguageChange,
  onAddLanguage,
  hasUnsavedChanges,
  disabled = false,
}) {
  const [isOpen, setIsOpen] = useState(false);

  const handleSelect = async (variant) => {
    if (variant.language_code === currentLanguage) {
      setIsOpen(false);
      return;
    }

    if (hasUnsavedChanges) {
      const proceed = window.confirm(
        'You have unsaved changes. Discard and switch language?'
      );
      if (!proceed) {
        setIsOpen(false);
        return;
      }
    }

    onLanguageChange(variant);
    setIsOpen(false);
  };

  const currentInfo = getLanguageDisplayInfo(currentLanguage);

  // Languages not yet added
  const availableCodes = availableVariants.map(v => v.language_code);
  const addableLanguages = SUPPORTED_LOCALES.filter(
    l => !availableCodes.includes(l.code)
  );

  return (
    <div className="relative">
      <button
        onClick={() => !disabled && setIsOpen(!isOpen)}
        disabled={disabled}
        className="flex items-center gap-2 px-3 py-1.5 text-sm border border-gray-300 rounded-md hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
      >
        <Globe className="w-4 h-4 text-gray-400" />
        <span>{currentInfo.nativeName}</span>
        <ChevronDown className="w-4 h-4 text-gray-400" />
      </button>

      {isOpen && (
        <>
          {/* Backdrop */}
          <div
            className="fixed inset-0 z-10"
            onClick={() => setIsOpen(false)}
          />

          {/* Dropdown */}
          <div className="absolute top-full left-0 mt-1 w-48 bg-white border border-gray-200 rounded-md shadow-lg z-20">
            {/* Existing variants */}
            <div className="py-1">
              {availableVariants.map((variant) => (
                <button
                  key={variant.id}
                  onClick={() => handleSelect(variant)}
                  className={`w-full text-left px-4 py-2 text-sm hover:bg-gray-100 ${
                    variant.language_code === currentLanguage
                      ? 'bg-blue-50 text-blue-700 font-medium'
                      : 'text-gray-700'
                  }`}
                >
                  {getLanguageDisplayInfo(variant.language_code).nativeName}
                </button>
              ))}
            </div>

            {/* Add new language */}
            {addableLanguages.length > 0 && (
              <>
                <div className="border-t border-gray-100" />
                <button
                  onClick={() => {
                    setIsOpen(false);
                    onAddLanguage();
                  }}
                  className="w-full text-left px-4 py-2 text-sm text-blue-600 hover:bg-blue-50 flex items-center gap-2"
                >
                  <Plus className="w-4 h-4" />
                  Add Language...
                </button>
              </>
            )}
          </div>
        </>
      )}
    </div>
  );
}

export default EditorLanguageSwitcher;
```

Key features:
- Shows current language's native name (per CONTEXT.md)
- Lists all existing variants
- "Add Language..." option opens modal
- Unsaved changes check before switching (per CONTEXT.md)
  </action>
  <verify>
Run: `npm run lint src/components/scene-editor/EditorLanguageSwitcher.jsx` passes.
  </verify>
  <done>
EditorLanguageSwitcher component exists with dropdown, variant selection, and "Add Language" option.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AddLanguageModal for variant creation</name>
  <files>src/components/scenes/AddLanguageModal.jsx</files>
  <action>
Create src/components/scenes/AddLanguageModal.jsx:

```jsx
/**
 * AddLanguageModal
 *
 * Modal for creating a new language variant of a scene.
 * Per CONTEXT.md: User picks from fixed list of common languages.
 */
import { useState } from 'react';
import { Globe, Loader2 } from 'lucide-react';
import { Modal, ModalHeader, ModalTitle, ModalContent, ModalFooter } from '../../design-system';
import { Button } from '../../design-system';
import { SUPPORTED_LOCALES } from '../../i18n/i18nConfig';
import { createLanguageVariant } from '../../services/languageService';

export function AddLanguageModal({
  isOpen,
  onClose,
  sceneId,
  existingLanguages = [], // codes already in use
  onVariantCreated, // callback with new variant { id, language_code }
}) {
  const [selectedLanguage, setSelectedLanguage] = useState('');
  const [isCreating, setIsCreating] = useState(false);
  const [error, setError] = useState(null);

  // Filter out already-used languages
  const availableLanguages = SUPPORTED_LOCALES.filter(
    l => !existingLanguages.includes(l.code)
  );

  const handleCreate = async () => {
    if (!selectedLanguage) return;

    setIsCreating(true);
    setError(null);

    try {
      const newVariant = await createLanguageVariant(sceneId, selectedLanguage);
      onVariantCreated({
        id: newVariant.id,
        name: newVariant.name,
        language_code: selectedLanguage,
      });
      onClose();
    } catch (err) {
      setError(err.message || 'Failed to create language variant');
    } finally {
      setIsCreating(false);
    }
  };

  const handleClose = () => {
    if (!isCreating) {
      setSelectedLanguage('');
      setError(null);
      onClose();
    }
  };

  if (!isOpen) return null;

  return (
    <Modal isOpen={isOpen} onClose={handleClose}>
      <ModalHeader>
        <ModalTitle>Add Language Variant</ModalTitle>
      </ModalHeader>

      <ModalContent>
        <p className="text-sm text-gray-600 mb-4">
          Create a new language version of this scene. The content will be copied from the original for you to translate.
        </p>

        {availableLanguages.length === 0 ? (
          <p className="text-sm text-gray-500 italic">
            All supported languages have been added.
          </p>
        ) : (
          <div className="space-y-3">
            <label className="block text-sm font-medium text-gray-700">
              Select Language
            </label>
            <div className="grid grid-cols-2 gap-2">
              {availableLanguages.map((lang) => (
                <button
                  key={lang.code}
                  onClick={() => setSelectedLanguage(lang.code)}
                  className={`p-3 text-left border rounded-lg transition-colors ${
                    selectedLanguage === lang.code
                      ? 'border-blue-500 bg-blue-50 text-blue-700'
                      : 'border-gray-200 hover:border-gray-300'
                  }`}
                >
                  <div className="font-medium">{lang.nativeName}</div>
                  <div className="text-xs text-gray-500">{lang.name}</div>
                </button>
              ))}
            </div>
          </div>
        )}

        {error && (
          <p className="mt-4 text-sm text-red-600">{error}</p>
        )}
      </ModalContent>

      <ModalFooter>
        <Button variant="secondary" onClick={handleClose} disabled={isCreating}>
          Cancel
        </Button>
        <Button
          variant="primary"
          onClick={handleCreate}
          disabled={!selectedLanguage || isCreating}
        >
          {isCreating ? (
            <>
              <Loader2 className="w-4 h-4 mr-2 animate-spin" />
              Creating...
            </>
          ) : (
            <>
              <Globe className="w-4 h-4 mr-2" />
              Create Variant
            </>
          )}
        </Button>
      </ModalFooter>
    </Modal>
  );
}

export default AddLanguageModal;
```

Key features:
- Shows only languages not already added
- Grid selection of language tiles (name + native name)
- Calls createLanguageVariant from languageService
- Returns new variant to parent for navigation
  </action>
  <verify>
Run: `npm run lint src/components/scenes/AddLanguageModal.jsx` passes.
  </verify>
  <done>
AddLanguageModal component exists with language selection grid and createLanguageVariant integration.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate language switcher into SceneEditorPage</name>
  <files>src/pages/SceneEditorPage.jsx</files>
  <action>
Update src/pages/SceneEditorPage.jsx to add language switching:

1. **Add imports at top:**
```jsx
import EditorLanguageSwitcher from '../components/scene-editor/EditorLanguageSwitcher';
import AddLanguageModal from '../components/scenes/AddLanguageModal';
import { fetchLanguageVariants } from '../services/languageService';
```

2. **Add state for language variants:**
```jsx
// Language variants state
const [languageVariants, setLanguageVariants] = useState([]);
const [currentLanguageCode, setCurrentLanguageCode] = useState('en');
const [showAddLanguageModal, setShowAddLanguageModal] = useState(false);
```

3. **Load variants when scene loads (in loadSceneData or useEffect):**
```jsx
// After fetching scene, fetch language variants
const variants = await fetchLanguageVariants(sceneId);
setLanguageVariants(variants);
// Set current language from scene's language_code or default to 'en'
setCurrentLanguageCode(scene.language_code || 'en');
```

4. **Add language change handler:**
```jsx
const handleLanguageChange = (variant) => {
  // Navigate to the variant's scene
  // This reloads the editor with the different scene
  if (onNavigate) {
    onNavigate('scene-editor', { sceneId: variant.id });
  }
};
```

5. **Add variant created handler:**
```jsx
const handleVariantCreated = (newVariant) => {
  // Refresh variants list and navigate to new variant
  setLanguageVariants(prev => [...prev, newVariant]);
  if (onNavigate) {
    onNavigate('scene-editor', { sceneId: newVariant.id });
  }
};
```

6. **Add EditorLanguageSwitcher to top bar (near save button):**
Find the top bar JSX (likely has ArrowLeft back button, scene name, Save button) and add:
```jsx
{/* Language Switcher - after scene name, before save */}
{languageVariants.length > 0 && (
  <EditorLanguageSwitcher
    currentLanguage={currentLanguageCode}
    availableVariants={languageVariants}
    onLanguageChange={handleLanguageChange}
    onAddLanguage={() => setShowAddLanguageModal(true)}
    hasUnsavedChanges={saveStatus === 'unsaved'}
    disabled={loading}
  />
)}
```

7. **Add AddLanguageModal at component end:**
```jsx
<AddLanguageModal
  isOpen={showAddLanguageModal}
  onClose={() => setShowAddLanguageModal(false)}
  sceneId={sceneId}
  existingLanguages={languageVariants.map(v => v.language_code)}
  onVariantCreated={handleVariantCreated}
/>
```

8. **If scene has no language_code yet, treat as English:**
When creating the initial variant, the original scene becomes the English version. This happens automatically in createLanguageVariant.
  </action>
  <verify>
Run: `npm run lint src/pages/SceneEditorPage.jsx` passes.
Manual test:
1. Open scene editor for a scene - see language dropdown in top bar
2. Click "Add Language..." - modal opens with available languages
3. Create Spanish variant - editor reloads with new Spanish scene
4. Switch back to English - editor loads original scene
5. Make unsaved change, try to switch - get confirmation prompt
  </verify>
  <done>
SceneEditorPage has language switcher in top bar. Can switch between variants. Can create new variants via modal. Unsaved changes prompt works.
  </done>
</task>

</tasks>

<verification>
1. EditorLanguageSwitcher shows current language and dropdown with variants
2. Clicking variant navigates to that scene (loads different content)
3. "Add Language..." opens AddLanguageModal
4. Creating variant creates new scene with copied content
5. New variant appears in dropdown immediately
6. Unsaved changes show confirmation before switch
</verification>

<success_criteria>
- User can create language variants of scenes (LANG-01)
- User can switch between language versions in editor (LANG-04)
- Switching loads correct variant's slides
- Unsaved changes prompt before switching (per CONTEXT.md)
- System falls back gracefully (LANG-03 via RPC in 20-01)
</success_criteria>

<output>
After completion, create `.planning/phases/20-multi-language-core/20-03-SUMMARY.md`
</output>
