---
phase: 20-multi-language-core
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - src/services/screenService.js
  - src/pages/ScreenDetailPage.jsx
  - src/components/scenes/LanguageBadges.jsx
  - src/pages/ScenesPage.jsx
autonomous: true

must_haves:
  truths:
    - "User can set display language on individual device"
    - "Device refreshes content when language changes"
    - "Scene cards show language badges indicating available translations"
    - "Badges hidden when scene has only default language"
  artifacts:
    - path: "src/components/scenes/LanguageBadges.jsx"
      provides: "Language indicator badge component"
      exports: ["LanguageBadges"]
    - path: "src/pages/ScreenDetailPage.jsx"
      provides: "Device settings with language dropdown"
      contains: "display_language"
    - path: "src/pages/ScenesPage.jsx"
      provides: "Scene cards with language badges"
      contains: "LanguageBadges"
  key_links:
    - from: "src/pages/ScreenDetailPage.jsx"
      to: "src/services/screenService.js"
      via: "updateScreen call"
      pattern: "updateScreen.*display_language"
    - from: "src/pages/ScenesPage.jsx"
      to: "src/components/scenes/LanguageBadges.jsx"
      via: "component import"
      pattern: "import.*LanguageBadges"
---

<objective>
Add device language assignment and language badges on scene cards.

Purpose: Users need to assign display languages to devices (LANG-02) and see which scenes have translations available (LANG-05).
Output: Device settings dropdown, LanguageBadges component, badges on ScenesPage.
</objective>

<execution_context>
@/Users/massimodamico/.claude/get-shit-done/workflows/execute-plan.md
@/Users/massimodamico/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/20-multi-language-core/20-CONTEXT.md
@.planning/phases/20-multi-language-core/20-RESEARCH.md
@.planning/phases/20-multi-language-core/20-01-SUMMARY.md
@src/services/screenService.js
@src/pages/ScenesPage.jsx
@src/i18n/i18nConfig.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add display_language to screenService and device settings</name>
  <files>src/services/screenService.js, src/pages/ScreenDetailPage.jsx</files>
  <action>
**screenService.js updates:**
1. Add 'display_language' to the allowedFields array in updateScreen function
2. Add display_language to the select query in getScreen and fetchScreens
3. Create new function updateDeviceLanguage(deviceId, languageCode):
   - Update tv_devices set display_language = languageCode, needs_refresh = true
   - The needs_refresh=true triggers player to fetch new content (per 15-02 pattern)
   - Return updated device

**ScreenDetailPage.jsx updates:**
Find the device settings section (likely a form or settings panel) and add:
1. Import SUPPORTED_LOCALES from '../i18n/i18nConfig'
2. Import Globe icon from lucide-react
3. Add a "Display Language" dropdown field:
   - Label: "Display Language"
   - Select with options from SUPPORTED_LOCALES (show nativeName)
   - Current value from device.display_language (default 'en')
   - onChange: call updateDeviceLanguage or updateScreen
4. Add helper text: "Content will display in this language when available"

Follow existing form field patterns in the page. Use the design-system FormField and Select if available, otherwise match existing dropdown styling.
  </action>
  <verify>
Run: `npm run lint src/services/screenService.js src/pages/ScreenDetailPage.jsx` passes.
Manual test: Navigate to a device's detail/settings page, see Display Language dropdown, change it, verify device needs_refresh is set.
  </verify>
  <done>
Device detail page shows Display Language dropdown. Changing language updates tv_devices.display_language and sets needs_refresh=true. screenService includes display_language in queries.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create LanguageBadges component and add to ScenesPage</name>
  <files>src/components/scenes/LanguageBadges.jsx, src/pages/ScenesPage.jsx</files>
  <action>
**Create src/components/scenes/LanguageBadges.jsx:**
```jsx
/**
 * LanguageBadges
 *
 * Displays language code chips for available translations.
 * Per CONTEXT.md: Hide when only default language exists.
 */
import { LANGUAGE_COLORS } from '../../services/languageService';

export function LanguageBadges({ languages, showDefault = false }) {
  // Per CONTEXT.md: hide badge when only default language
  if (!languages || languages.length === 0) return null;
  if (languages.length === 1 && languages[0] === 'en' && !showDefault) {
    return null;
  }

  return (
    <div className="flex flex-wrap gap-1">
      {languages.map((code) => (
        <span
          key={code}
          className={`
            inline-flex items-center px-1.5 py-0.5 text-xs font-medium rounded
            ${LANGUAGE_COLORS[code] || 'bg-gray-100 text-gray-700'}
          `}
        >
          {code.toUpperCase()}
        </span>
      ))}
    </div>
  );
}

export default LanguageBadges;
```

**Update ScenesPage.jsx:**
1. Import LanguageBadges from '../components/scenes/LanguageBadges'
2. Import getAvailableLanguagesForScene from '../services/languageService'
3. In the data fetching (fetchScenesWithDeviceCounts), also fetch language info:
   - After fetching scenes, batch fetch available languages for each
   - Create a Map of sceneId -> languages array
   - Store in state (e.g., scenesLanguages)
4. In SceneCard component, add LanguageBadges:
   - Below the business type badge (in the header area) or below scene name
   - Pass languages={scenesLanguages.get(scene.id) || []}
   - Position: after the "Not published" / "X screens" badge

Note: For efficiency, could create an RPC to batch-fetch languages for multiple scenes, but for MVP can fetch per-scene. If performance issue, create RPC in gap closure.
  </action>
  <verify>
Run: `npm run lint src/components/scenes/LanguageBadges.jsx src/pages/ScenesPage.jsx` passes.
Manual test:
1. Create a scene with no variants - no language badges shown
2. Create a scene with ES variant - [EN] [ES] badges appear on card
  </verify>
  <done>
LanguageBadges component exists. ScenesPage imports and uses it. Badges show only when scene has 2+ language variants. Single-language scenes show no badge.
  </done>
</task>

</tasks>

<verification>
1. Device settings shows Display Language dropdown with all supported languages
2. Changing device language sets needs_refresh=true (query tv_devices to verify)
3. LanguageBadges component renders correctly with multiple languages
4. LanguageBadges hides when scene has only English
5. ScenesPage shows language badges on scene cards
</verification>

<success_criteria>
- User can select display language in device settings (LANG-02)
- Device needs_refresh flag triggers content reload on language change
- LanguageBadges.jsx component works standalone
- Scene cards display [EN] [ES] style badges (LANG-05)
- Badges hidden for single-language (English only) scenes
</success_criteria>

<output>
After completion, create `.planning/phases/20-multi-language-core/20-02-SUMMARY.md`
</output>
