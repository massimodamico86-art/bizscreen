---
phase: 05-critical-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/layoutTemplateService.js
  - src/components/templates/SaveAsTemplateModal.jsx
  - src/pages/LayoutEditorPage.jsx
autonomous: true

must_haves:
  truths:
    - "User can click 'Save as Template' button in layout editor toolbar"
    - "Modal captures template name, category, and description"
    - "Saved template appears in template library with correct metadata"
    - "Template is private to user's tenant (not global)"
  artifacts:
    - path: "src/services/layoutTemplateService.js"
      provides: "createTemplateFromLayout function"
      exports: ["createTemplateFromLayout"]
    - path: "src/components/templates/SaveAsTemplateModal.jsx"
      provides: "Modal for template metadata capture"
      exports: ["SaveAsTemplateModal"]
    - path: "src/pages/LayoutEditorPage.jsx"
      provides: "Save as Template button in toolbar"
      contains: "SaveAsTemplateModal"
  key_links:
    - from: "src/pages/LayoutEditorPage.jsx"
      to: "src/services/layoutTemplateService.js"
      via: "createTemplateFromLayout import and call"
      pattern: "createTemplateFromLayout"
    - from: "src/components/templates/SaveAsTemplateModal.jsx"
      to: "design-system Modal"
      via: "Modal component import"
      pattern: "Modal.*from.*design-system"
---

<objective>
Implement "Save Layout as Template" feature (FIX-02)

Purpose: Allow users to save their custom layouts as reusable templates for the template library.
Output: Working end-to-end flow from toolbar button to template appearing in library.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-critical-fixes/05-CONTEXT.md
@.planning/phases/05-critical-fixes/05-RESEARCH.md
@src/services/layoutTemplateService.js
@src/pages/LayoutEditorPage.jsx
@src/design-system/components/Modal.jsx
@src/design-system/components/FormElements.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement createTemplateFromLayout service function</name>
  <files>src/services/layoutTemplateService.js</files>
  <action>
Replace the stub `createTemplateFromLayout()` function with a working implementation.

Pattern to follow (from `cloneTemplateToLayoutFallback`):
1. Fetch the source layout with zones: `supabase.from('layouts').select('*, layout_zones (*)')`
2. Get user's tenant_id from profile: `supabase.from('profiles').select('tenant_id').eq('id', layout.owner_id)`
3. Map layout fields to template schema:
   - `tenant_id`: From profile (NOT null - user templates are private)
   - `name`: From options.name or `${layout.name} Template`
   - `description`: From options.description or layout.description
   - `category`: From options.category or 'General'
   - `orientation`: Map aspect_ratio using: {'16:9': '16_9', '9:16': '9_16', '1:1': 'square'}
   - `width`, `height`: From layout
   - `background_color`: From layout.background_color
   - `background_image_url`: From layout.background_image
   - `data`: From layout.data (JSONB with elements)
   - `thumbnail_url`: null initially (placeholder)
   - `is_active`: true
   - `use_count`: 0

4. Insert into layout_templates table
5. Return the created template

Use `createScopedLogger('layoutTemplateService')` for logging (Phase 4 pattern).
Handle zones: If layout.data is empty but layout_zones exist, convert zones to data format.
  </action>
  <verify>
Import and call the function in browser console or write a quick test:
```javascript
// In browser console after login:
import { createTemplateFromLayout } from './services/layoutTemplateService.js';
// Should not throw "not implemented" error
```
  </verify>
  <done>
createTemplateFromLayout() accepts layoutId and options, creates a template in layout_templates table with tenant_id set, returns the created template object.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SaveAsTemplateModal component</name>
  <files>src/components/templates/SaveAsTemplateModal.jsx</files>
  <action>
Create a new modal component for capturing template metadata.

Use design-system components:
```jsx
import { Modal, ModalHeader, ModalTitle, ModalDescription, ModalContent, ModalFooter } from '../../design-system';
import { FormField, Input, Textarea, Select } from '../../design-system';
import { Button } from '../../design-system';
```

Component props:
- `open`: boolean - modal visibility
- `onClose`: function - close handler
- `onSave`: function(templateData) - save handler, receives { name, category, description }
- `layout`: object - the layout being saved (for default name)
- `loading`: boolean - saving state

Form fields:
1. **Name** (required): Input, default to `${layout.name} Template`
2. **Category**: Select with options from SIDEBAR_CATEGORIES in LayoutsPage:
   - General, Holidays, Restaurant, Retail, Corporate, Entertainment, Fashion, Fitness
3. **Description** (optional): Textarea, default to layout.description

Footer: Cancel button (secondary variant), Save Template button (primary, disabled when loading or name empty)

Use useState for form state. Handle form submission with validation (name required).
  </action>
  <verify>
```bash
# Component file exists and has correct imports
grep -l "Modal" /Users/massimodamico/bizscreen/src/components/templates/SaveAsTemplateModal.jsx
grep "FormField" /Users/massimodamico/bizscreen/src/components/templates/SaveAsTemplateModal.jsx
```
  </verify>
  <done>
SaveAsTemplateModal.jsx exists in src/components/templates/, exports SaveAsTemplateModal component, uses design-system Modal and FormElements, captures name/category/description.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add Save as Template button to LayoutEditorPage</name>
  <files>src/pages/LayoutEditorPage.jsx</files>
  <action>
Integrate the SaveAsTemplateModal into LayoutEditorPage toolbar.

1. Add imports at top:
   ```jsx
   import { BookTemplate } from 'lucide-react';
   import { createTemplateFromLayout } from '../services/layoutTemplateService';
   import { SaveAsTemplateModal } from '../components/templates/SaveAsTemplateModal';
   ```

2. Add state for modal:
   ```jsx
   const [showSaveTemplateModal, setShowSaveTemplateModal] = useState(false);
   const [savingTemplate, setSavingTemplate] = useState(false);
   ```

3. Add handler:
   ```jsx
   const handleSaveAsTemplate = async (templateData) => {
     try {
       setSavingTemplate(true);
       await createTemplateFromLayout(layoutId, templateData);
       showToast?.('Layout saved as template');
       setShowSaveTemplateModal(false);
     } catch (error) {
       logger.error('Failed to save as template', { layoutId, error });
       showToast?.('Error saving template: ' + error.message, 'error');
     } finally {
       setSavingTemplate(false);
     }
   };
   ```

4. Add button in toolbar (after Preview Link button, before Request Approval):
   ```jsx
   <Button variant="outline" onClick={() => setShowSaveTemplateModal(true)}>
     <BookTemplate size={18} />
     Save as Template
   </Button>
   ```

5. Add modal before closing </div>:
   ```jsx
   <SaveAsTemplateModal
     open={showSaveTemplateModal}
     onClose={() => setShowSaveTemplateModal(false)}
     onSave={handleSaveAsTemplate}
     layout={layout}
     loading={savingTemplate}
   />
   ```
  </action>
  <verify>
```bash
# Check imports and usage
grep "SaveAsTemplateModal" /Users/massimodamico/bizscreen/src/pages/LayoutEditorPage.jsx
grep "createTemplateFromLayout" /Users/massimodamico/bizscreen/src/pages/LayoutEditorPage.jsx
grep "showSaveTemplateModal" /Users/massimodamico/bizscreen/src/pages/LayoutEditorPage.jsx
```
  </verify>
  <done>
LayoutEditorPage has "Save as Template" button in toolbar, clicking opens SaveAsTemplateModal, form submission calls createTemplateFromLayout and shows success/error toast.
  </done>
</task>

</tasks>

<verification>
1. Open a layout in the editor
2. Click "Save as Template" button in toolbar
3. Modal opens with form fields (name, category, description)
4. Fill in name and click "Save Template"
5. Success toast appears
6. Navigate to Layouts/Templates page
7. New template appears in list with correct name and category
</verification>

<success_criteria>
- [ ] createTemplateFromLayout() works without "not implemented" error
- [ ] Template created has tenant_id set (not null/global)
- [ ] Template appears in template library after creation
- [ ] Modal validates that name is required
- [ ] Error states display toast messages
</success_criteria>

<output>
After completion, create `.planning/phases/05-critical-fixes/05-01-SUMMARY.md`
</output>
