---
phase: 05-critical-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/services/emailService.js
  - src/services/notificationDispatcherService.js
  - .env.example
autonomous: true
user_setup:
  - service: resend
    why: "Email notification delivery"
    env_vars:
      - name: VITE_RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"
    dashboard_config:
      - task: "Verify sending domain (optional for production)"
        location: "Resend Dashboard -> Domains -> Add Domain"

must_haves:
  truths:
    - "Email notifications send via Resend API (not stub)"
    - "Notification record updated with email_sent_at after successful send"
    - "Failed emails are logged with error details"
    - "VITE_RESEND_API_KEY documented in .env.example"
  artifacts:
    - path: "src/services/emailService.js"
      provides: "Resend email integration"
      exports: ["sendAlertEmail"]
    - path: "src/services/notificationDispatcherService.js"
      provides: "Updated sendEmailNotification with real sending"
      exports: ["sendEmailNotification"]
    - path: ".env.example"
      provides: "VITE_RESEND_API_KEY documentation"
      contains: "VITE_RESEND_API_KEY"
  key_links:
    - from: "src/services/notificationDispatcherService.js"
      to: "src/services/emailService.js"
      via: "sendAlertEmail import and call"
      pattern: "sendAlertEmail"
    - from: "src/services/emailService.js"
      to: "Resend API"
      via: "resend SDK emails.send"
      pattern: "resend\\.emails\\.send"
---

<objective>
Implement email notifications via Resend (FIX-05)

Purpose: Replace stubbed email notification with real email delivery for alerts.
Output: Working email sending via Resend API, documented env var, proper error handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-critical-fixes/05-CONTEXT.md
@.planning/phases/05-critical-fixes/05-RESEARCH.md
@src/services/notificationDispatcherService.js
@.env.example
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install Resend package and create emailService</name>
  <files>src/services/emailService.js</files>
  <action>
1. Install the Resend package:
   ```bash
   npm install resend
   ```

2. Create src/services/emailService.js with Resend integration:

```javascript
/**
 * Email Service
 *
 * Handles email sending via Resend API.
 * Used for alert notifications and transactional emails.
 */

import { Resend } from 'resend';
import { createScopedLogger } from './loggingService.js';

const logger = createScopedLogger('emailService');

// Initialize Resend client (null if no API key)
const resend = import.meta.env.VITE_RESEND_API_KEY
  ? new Resend(import.meta.env.VITE_RESEND_API_KEY)
  : null;

/**
 * Send an alert notification email
 *
 * @param {Object} options Email options
 * @param {string} options.to Recipient email address
 * @param {string} options.subject Email subject
 * @param {string} options.title Alert title
 * @param {string} options.message Alert message
 * @param {string} options.severity Alert severity (info, warning, critical)
 * @param {string} options.actionUrl URL for "View Details" button
 * @returns {Promise<{success: boolean, messageId?: string, error?: string}>}
 */
export async function sendAlertEmail({ to, subject, title, message, severity, actionUrl }) {
  if (!resend) {
    logger.warn('Email not sent - VITE_RESEND_API_KEY not configured');
    return { success: false, error: 'Email service not configured' };
  }

  try {
    const html = buildAlertEmailHtml({ title, message, severity, actionUrl });

    const { data, error } = await resend.emails.send({
      from: 'BizScreen Alerts <alerts@bizscreen.com>',
      to: [to],
      subject,
      html,
    });

    if (error) {
      logger.error('Resend API error', { error, to });
      return { success: false, error: error.message };
    }

    logger.info('Email sent successfully', { messageId: data.id, to });
    return { success: true, messageId: data.id };
  } catch (error) {
    logger.error('Failed to send email', { error: error.message, to });
    return { success: false, error: error.message };
  }
}

/**
 * Build HTML for alert notification email
 */
function buildAlertEmailHtml({ title, message, severity, actionUrl }) {
  const severityColors = {
    info: { bg: '#dbeafe', text: '#1e40af', label: 'Info' },
    warning: { bg: '#fef3c7', text: '#92400e', label: 'Warning' },
    critical: { bg: '#fee2e2', text: '#991b1b', label: 'Critical' },
  };

  const colors = severityColors[severity] || severityColors.info;

  return `
<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 0; background-color: #f9fafb;">
  <table width="100%" cellpadding="0" cellspacing="0" style="max-width: 600px; margin: 0 auto; padding: 20px;">
    <tr>
      <td style="background-color: white; border-radius: 12px; padding: 32px; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
        <!-- Logo -->
        <div style="text-align: center; margin-bottom: 24px;">
          <span style="font-size: 24px; font-weight: 700; color: #f97316;">BizScreen</span>
        </div>

        <!-- Severity Badge -->
        <div style="text-align: center; margin-bottom: 16px;">
          <span style="display: inline-block; padding: 4px 12px; border-radius: 9999px; font-size: 12px; font-weight: 600; background-color: ${colors.bg}; color: ${colors.text};">
            ${colors.label}
          </span>
        </div>

        <!-- Title -->
        <h1 style="color: #111827; font-size: 20px; font-weight: 600; text-align: center; margin: 0 0 16px 0;">
          ${escapeHtml(title)}
        </h1>

        <!-- Message -->
        <p style="color: #6b7280; font-size: 16px; line-height: 1.6; text-align: center; margin: 0 0 24px 0;">
          ${escapeHtml(message)}
        </p>

        <!-- CTA Button -->
        ${actionUrl ? `
        <div style="text-align: center; margin-bottom: 24px;">
          <a href="${escapeHtml(actionUrl)}" style="display: inline-block; background-color: #f97316; color: white; padding: 12px 24px; border-radius: 8px; text-decoration: none; font-weight: 500; font-size: 14px;">
            View Details
          </a>
        </div>
        ` : ''}

        <!-- Footer -->
        <div style="border-top: 1px solid #e5e7eb; padding-top: 16px; margin-top: 24px;">
          <p style="color: #9ca3af; font-size: 12px; text-align: center; margin: 0;">
            You're receiving this because you have alert notifications enabled in BizScreen.
          </p>
        </div>
      </td>
    </tr>
  </table>
</body>
</html>
  `.trim();
}

/**
 * Escape HTML special characters
 */
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;',
  };
  return String(text).replace(/[&<>"']/g, (char) => map[char]);
}

export default { sendAlertEmail };
```
  </action>
  <verify>
```bash
# Check Resend is installed
grep "resend" /Users/massimodamico/bizscreen/package.json

# Check emailService exists with correct exports
grep -l "sendAlertEmail" /Users/massimodamico/bizscreen/src/services/emailService.js
```
  </verify>
  <done>
Resend package installed, emailService.js created with sendAlertEmail function, HTML template built inline, proper error handling with logging.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update sendEmailNotification to use Resend</name>
  <files>src/services/notificationDispatcherService.js</files>
  <action>
Update the stubbed `sendEmailNotification()` function to actually send emails via emailService.

1. Add import at top of file:
   ```javascript
   import { sendAlertEmail } from './emailService.js';
   ```

2. Replace the existing `sendEmailNotification()` function (around line 359-380):

```javascript
/**
 * Send email notification via Resend
 *
 * @param {Object} notification The notification record from database
 * @returns {Promise<boolean>} Success status
 */
export async function sendEmailNotification(notification) {
  try {
    // Get recipient email
    const { data: authData } = await supabase.auth.admin
      ? await supabase.rpc('get_user_email', { user_id: notification.user_id })
      : { data: null };

    // Fallback: try to get email from profile or notification context
    let recipientEmail = authData?.email;
    if (!recipientEmail) {
      // For client-side context, we may need to fetch user differently
      const { data: profile } = await supabase
        .from('profiles')
        .select('email')
        .eq('id', notification.user_id)
        .single();
      recipientEmail = profile?.email;
    }

    if (!recipientEmail) {
      logger.warn('No email found for user', { userId: notification.user_id });
      return false;
    }

    // Build action URL
    const baseUrl = import.meta.env.VITE_APP_URL || window.location.origin;
    const actionUrl = notification.action_url
      ? `${baseUrl}${notification.action_url}`
      : `${baseUrl}/alerts`;

    // Send via Resend
    const result = await sendAlertEmail({
      to: recipientEmail,
      subject: `[BizScreen Alert] ${notification.title}`,
      title: notification.title,
      message: notification.message,
      severity: notification.severity || 'info',
      actionUrl,
    });

    if (result.success) {
      // Update notification record with sent timestamp
      const { error: updateError } = await supabase
        .from('notifications')
        .update({ email_sent_at: new Date().toISOString() })
        .eq('id', notification.id);

      if (updateError) {
        logger.error('Failed to update email_sent_at', { notificationId: notification.id, error: updateError });
      }

      logger.info('Email notification sent', { notificationId: notification.id, to: recipientEmail });
      return true;
    } else {
      logger.error('Email send failed', { notificationId: notification.id, error: result.error });
      return false;
    }
  } catch (error) {
    logger.error('Error sending email notification', { notificationId: notification.id, error: error.message });
    return false;
  }
}
```

Note: The existing stub only marked `email_sent_at` without sending. The new version actually sends via Resend then updates the timestamp on success.
  </action>
  <verify>
```bash
# Check import added
grep "sendAlertEmail" /Users/massimodamico/bizscreen/src/services/notificationDispatcherService.js

# Verify stub replacement (should NOT have "In production, this would call" comment)
grep -c "In production, this would call" /Users/massimodamico/bizscreen/src/services/notificationDispatcherService.js || echo "Stub removed - good"
```
  </verify>
  <done>
sendEmailNotification() fetches user email, calls sendAlertEmail from emailService, updates email_sent_at on success, logs errors properly.
  </done>
</task>

<task type="auto">
  <name>Task 3: Document VITE_RESEND_API_KEY in .env.example</name>
  <files>.env.example</files>
  <action>
Add Resend API key documentation to .env.example. Insert after the ANTHROPIC_API_KEY section (around line 166):

```bash
# ============================================
# RESEND EMAIL API (REQUIRED FOR NOTIFICATIONS)
# ============================================
# Used for sending email notifications (alerts, status updates)
# Get your API key:
# 1. Sign up at https://resend.com/
# 2. Go to API Keys section
# 3. Create a new API key
# 4. For production: verify your sending domain in Resend Dashboard

VITE_RESEND_API_KEY=your_resend_api_key

# Example:
# VITE_RESEND_API_KEY=re_123456789...

# Note: Emails are sent from alerts@bizscreen.com by default
# For production, configure and verify your domain in Resend

```
  </action>
  <verify>
```bash
# Check env var documented
grep "VITE_RESEND_API_KEY" /Users/massimodamico/bizscreen/.env.example
grep "resend.com" /Users/massimodamico/bizscreen/.env.example
```
  </verify>
  <done>
.env.example contains VITE_RESEND_API_KEY with setup instructions, example value, and production notes.
  </done>
</task>

</tasks>

<verification>
1. Confirm Resend package in package.json
2. Set VITE_RESEND_API_KEY in local .env (get test key from Resend)
3. Trigger an alert that would send email notification:
   - Device goes offline (if testable)
   - Or manually call sendEmailNotification with a test notification object
4. Check email is received
5. Check notification record has email_sent_at populated
6. If API key not set, verify graceful fallback (warning logged, no crash)
</verification>

<success_criteria>
- [ ] Resend package installed and in package.json
- [ ] emailService.js exists with sendAlertEmail function
- [ ] notificationDispatcherService.js imports and uses emailService
- [ ] Stub comment "In production, this would call" removed
- [ ] .env.example documents VITE_RESEND_API_KEY
- [ ] Email sends successfully when API key is configured
- [ ] Graceful fallback when API key is missing (logs warning, returns false)
</success_criteria>

<output>
After completion, create `.planning/phases/05-critical-fixes/05-02-SUMMARY.md`
</output>
