---
phase: 10-analytics
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - supabase/migrations/118_content_analytics_rpcs.sql
autonomous: true

must_haves:
  truths:
    - "Database can calculate average view duration for a content item"
    - "Database can calculate completion rate for content"
    - "Database can return content performance list sorted by total view time"
    - "Database can return viewing heatmap data (7x24 grid)"
  artifacts:
    - path: "supabase/migrations/118_content_analytics_rpcs.sql"
      provides: "Content analytics RPC functions"
      contains: "get_content_metrics"
  key_links:
    - from: "get_content_metrics"
      to: "playback_events"
      via: "JOIN with duration aggregation"
      pattern: "SUM.*duration_seconds"
    - from: "get_viewing_heatmap"
      to: "playback_events"
      via: "EXTRACT DOW and HOUR grouping"
      pattern: "EXTRACT.*DOW|HOUR"
---

<objective>
Create database RPCs for content-specific analytics: view duration, completion rate, performance ranking, and viewing patterns heatmap.

Purpose: Provide server-side aggregation foundation for Phase 10 analytics requirements (ANA-01 through ANA-04).
Output: Migration 118 with 3 new RPC functions that the service layer will call.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-analytics/10-RESEARCH.md

@supabase/migrations/079_playback_analytics.sql
@supabase/migrations/099_enhanced_playback_analytics.sql
@src/services/contentAnalyticsService.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create get_content_metrics RPC</name>
  <files>supabase/migrations/118_content_analytics_rpcs.sql</files>
  <action>
Create migration file with RPC function `get_content_metrics`:

Parameters:
- p_tenant_id UUID
- p_content_id UUID
- p_content_type TEXT ('scene', 'media', 'playlist')
- p_from_ts TIMESTAMPTZ
- p_to_ts TIMESTAMPTZ

Returns:
- avg_view_duration_seconds NUMERIC
- completion_rate NUMERIC (calculated as: actual_duration / scheduled_duration * 100)
- total_views BIGINT
- last_viewed_at TIMESTAMPTZ
- total_view_time_seconds BIGINT

For completion rate calculation:
- Join playback_events with the appropriate content source based on p_content_type
- For 'scene': use scenes.default_duration or a reasonable default (30 seconds)
- For 'media': use the media item's duration from media_assets
- For 'playlist': use sum of item durations from playlist_items
- If no scheduled duration available, use actual duration (100% completion)

Key implementation notes:
- Filter by content_type using item_type column or scene_id/media_id/playlist_id fields
- Use COALESCE for null handling
- Include SECURITY DEFINER
- Grant EXECUTE to authenticated role

Pattern follows existing get_scene_playback_summary from migration 079.
  </action>
  <verify>Check SQL syntax: `cat supabase/migrations/118_content_analytics_rpcs.sql | head -80`</verify>
  <done>RPC function get_content_metrics exists with correct parameter signature and return type</done>
</task>

<task type="auto">
  <name>Task 2: Create get_content_performance_list RPC</name>
  <files>supabase/migrations/118_content_analytics_rpcs.sql</files>
  <action>
Add RPC function `get_content_performance_list` to the migration file:

Parameters:
- p_tenant_id UUID
- p_from_ts TIMESTAMPTZ
- p_to_ts TIMESTAMPTZ
- p_limit INT DEFAULT 20

Returns table:
- content_id UUID
- content_type TEXT
- content_name TEXT
- total_view_time_seconds BIGINT
- avg_view_duration_seconds NUMERIC
- total_views BIGINT
- completion_rate NUMERIC
- device_count BIGINT
- last_viewed_at TIMESTAMPTZ

Implementation:
- UNION scenes, media, and playlists with their playback stats
- Sort by total_view_time_seconds DESC
- Limit to p_limit rows
- Include content name from respective tables (scenes.name, media_assets.name, playlists.name)

Use CTE pattern for clarity:
1. scene_stats CTE - aggregate scene playback
2. media_stats CTE - aggregate media playback (if media_id tracked)
3. playlist_stats CTE - aggregate playlist playback
4. UNION ALL and sort

Include SECURITY DEFINER and grant to authenticated.
  </action>
  <verify>Check function exists: `grep -A 30 'get_content_performance_list' supabase/migrations/118_content_analytics_rpcs.sql`</verify>
  <done>RPC function get_content_performance_list returns content sorted by total view time</done>
</task>

<task type="auto">
  <name>Task 3: Create get_viewing_heatmap RPC</name>
  <files>supabase/migrations/118_content_analytics_rpcs.sql</files>
  <action>
Add RPC function `get_viewing_heatmap` to the migration file:

Parameters:
- p_tenant_id UUID
- p_from_ts TIMESTAMPTZ
- p_to_ts TIMESTAMPTZ
- p_timezone TEXT DEFAULT 'UTC'

Returns table:
- day_of_week INT (0=Sunday, 6=Saturday)
- hour_of_day INT (0-23)
- view_count BIGINT
- total_duration_seconds BIGINT

Critical implementation (per RESEARCH.md pitfall #2):
- Generate FULL 7x24 grid using generate_series
- LEFT JOIN actual data to fill zeros for empty cells
- Use AT TIME ZONE for proper timezone handling

SQL pattern:
```sql
WITH hourly_stats AS (
  SELECT
    EXTRACT(DOW FROM pe.started_at AT TIME ZONE p_timezone)::INT as dow,
    EXTRACT(HOUR FROM pe.started_at AT TIME ZONE p_timezone)::INT as hour,
    COUNT(*)::BIGINT as views,
    COALESCE(SUM(pe.duration_seconds), 0)::BIGINT as duration
  FROM public.playback_events pe
  WHERE pe.tenant_id = p_tenant_id
    AND pe.started_at >= p_from_ts
    AND pe.started_at <= p_to_ts
    AND pe.duration_seconds > 0
  GROUP BY dow, hour
)
SELECT
  d.dow as day_of_week,
  h.hour as hour_of_day,
  COALESCE(hs.views, 0)::BIGINT as view_count,
  COALESCE(hs.duration, 0)::BIGINT as total_duration_seconds
FROM generate_series(0, 6) d(dow)
CROSS JOIN generate_series(0, 23) h(hour)
LEFT JOIN hourly_stats hs ON hs.dow = d.dow AND hs.hour = h.hour
ORDER BY d.dow, h.hour;
```

Include SECURITY DEFINER and grant to authenticated.

Add final COMMENT ON FUNCTION and RAISE NOTICE for migration completion.
  </action>
  <verify>Check heatmap returns 168 rows (7x24): `grep -c 'generate_series' supabase/migrations/118_content_analytics_rpcs.sql` should show at least 2</verify>
  <done>RPC function get_viewing_heatmap returns full 7x24 grid with zeros for empty cells</done>
</task>

</tasks>

<verification>
- [ ] Migration file 118_content_analytics_rpcs.sql exists
- [ ] Contains 3 RPC functions: get_content_metrics, get_content_performance_list, get_viewing_heatmap
- [ ] All functions have SECURITY DEFINER
- [ ] All functions grant EXECUTE to authenticated
- [ ] get_viewing_heatmap uses generate_series for full grid
- [ ] Completion rate calculation includes join with scheduled duration source
</verification>

<success_criteria>
1. Migration file is syntactically correct SQL
2. Functions follow existing patterns from migration 079/099
3. Heatmap generates complete 7x24 grid (168 cells)
4. Completion rate joins with content source for scheduled duration
</success_criteria>

<output>
After completion, create `.planning/phases/10-analytics/10-01-SUMMARY.md`
</output>
