---
phase: 10-analytics
plan: 08
type: execute
wave: 4
depends_on: ["10-05", "10-06", "10-07"]
files_modified:
  - tests/unit/contentAnalyticsService.test.js
autonomous: true

must_haves:
  truths:
    - "Service functions are tested for correct RPC calls"
    - "Error handling is verified"
    - "Default values returned for empty results"
  artifacts:
    - path: "tests/unit/contentAnalyticsService.test.js"
      provides: "Unit tests for Phase 10 service functions"
      min_lines: 80
  key_links:
    - from: "contentAnalyticsService.test.js"
      to: "contentAnalyticsService"
      via: "import and mock"
      pattern: "getContentMetrics|getViewingHeatmap"
---

<objective>
Create unit tests for the Phase 10 analytics service functions and perform final verification.

Purpose: Ensure service layer functions correctly call RPCs and handle errors.
Output: Test file with coverage for getContentMetrics, getContentPerformanceList, getViewingHeatmap.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-analytics/10-02-SUMMARY.md

@src/services/contentAnalyticsService.js
@tests/unit/playbackTrackingService.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create contentAnalyticsService tests</name>
  <files>tests/unit/contentAnalyticsService.test.js</files>
  <action>
Create test file following existing test patterns:

```javascript
/**
 * Content Analytics Service Tests
 *
 * Unit tests for Phase 10 analytics service functions:
 * - getContentMetrics
 * - getContentPerformanceList
 * - getViewingHeatmap
 */

import { describe, it, expect, vi, beforeEach, afterEach } from 'vitest';

// Mock supabase
vi.mock('../../src/supabase', () => ({
  supabase: {
    rpc: vi.fn(),
  },
}));

// Mock tenantService
vi.mock('../../src/services/tenantService', () => ({
  getEffectiveOwnerId: vi.fn().mockResolvedValue('test-tenant-id'),
}));

import { supabase } from '../../src/supabase';
import { getEffectiveOwnerId } from '../../src/services/tenantService';
import {
  getContentMetrics,
  getContentPerformanceList,
  getViewingHeatmap,
  getDateRange,
  formatDuration,
  formatRelativeTime,
} from '../../src/services/contentAnalyticsService';

describe('Content Analytics Service', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  describe('getContentMetrics', () => {
    it('calls get_content_metrics RPC with correct parameters', async () => {
      const mockData = [{
        avg_view_duration_seconds: 120,
        completion_rate: 85,
        total_views: 50,
        last_viewed_at: '2026-01-24T10:00:00Z',
        total_view_time_seconds: 6000,
      }];

      supabase.rpc.mockResolvedValue({ data: mockData, error: null });

      const result = await getContentMetrics('scene-123', 'scene', '7d');

      expect(supabase.rpc).toHaveBeenCalledWith('get_content_metrics', expect.objectContaining({
        p_tenant_id: 'test-tenant-id',
        p_content_id: 'scene-123',
        p_content_type: 'scene',
      }));
      expect(result.avg_view_duration_seconds).toBe(120);
      expect(result.completion_rate).toBe(85);
    });

    it('returns defaults when no data', async () => {
      supabase.rpc.mockResolvedValue({ data: [], error: null });

      const result = await getContentMetrics('scene-123', 'scene');

      expect(result.avg_view_duration_seconds).toBe(0);
      expect(result.completion_rate).toBe(0);
      expect(result.total_views).toBe(0);
    });

    it('throws on RPC error', async () => {
      supabase.rpc.mockResolvedValue({ data: null, error: new Error('RPC failed') });

      await expect(getContentMetrics('scene-123', 'scene')).rejects.toThrow('RPC failed');
    });

    it('throws when no tenant context', async () => {
      getEffectiveOwnerId.mockResolvedValueOnce(null);

      await expect(getContentMetrics('scene-123', 'scene')).rejects.toThrow('No tenant context');
    });
  });

  describe('getContentPerformanceList', () => {
    it('calls get_content_performance_list RPC', async () => {
      const mockData = [
        { content_id: '1', content_name: 'Scene A', total_view_time_seconds: 5000 },
        { content_id: '2', content_name: 'Scene B', total_view_time_seconds: 3000 },
      ];

      supabase.rpc.mockResolvedValue({ data: mockData, error: null });

      const result = await getContentPerformanceList('7d', 20);

      expect(supabase.rpc).toHaveBeenCalledWith('get_content_performance_list', expect.objectContaining({
        p_tenant_id: 'test-tenant-id',
        p_limit: 20,
      }));
      expect(result).toHaveLength(2);
      expect(result[0].content_name).toBe('Scene A');
    });

    it('returns empty array when no data', async () => {
      supabase.rpc.mockResolvedValue({ data: null, error: null });

      const result = await getContentPerformanceList();

      expect(result).toEqual([]);
    });
  });

  describe('getViewingHeatmap', () => {
    it('calls get_viewing_heatmap RPC with timezone', async () => {
      const mockData = [
        { day_of_week: 0, hour_of_day: 9, view_count: 10, total_duration_seconds: 600 },
        { day_of_week: 0, hour_of_day: 10, view_count: 15, total_duration_seconds: 900 },
      ];

      supabase.rpc.mockResolvedValue({ data: mockData, error: null });

      const result = await getViewingHeatmap('7d', 'America/New_York');

      expect(supabase.rpc).toHaveBeenCalledWith('get_viewing_heatmap', expect.objectContaining({
        p_tenant_id: 'test-tenant-id',
        p_timezone: 'America/New_York',
      }));
      expect(result).toHaveLength(2);
    });

    it('uses browser timezone when not specified', async () => {
      supabase.rpc.mockResolvedValue({ data: [], error: null });

      await getViewingHeatmap('7d');

      // Should have called with some timezone (browser-detected or UTC)
      expect(supabase.rpc).toHaveBeenCalledWith('get_viewing_heatmap', expect.objectContaining({
        p_timezone: expect.any(String),
      }));
    });

    it('returns empty array when no data', async () => {
      supabase.rpc.mockResolvedValue({ data: null, error: null });

      const result = await getViewingHeatmap();

      expect(result).toEqual([]);
    });
  });

  describe('formatDuration', () => {
    it('formats seconds under a minute', () => {
      expect(formatDuration(45)).toBe('45s');
    });

    it('formats minutes and seconds', () => {
      expect(formatDuration(125)).toBe('2m 5s');
    });

    it('formats hours and minutes', () => {
      expect(formatDuration(3725)).toBe('1h 2m');
    });

    it('handles zero', () => {
      expect(formatDuration(0)).toBe('0s');
    });

    it('handles null/undefined', () => {
      expect(formatDuration(null)).toBe('0s');
      expect(formatDuration(undefined)).toBe('0s');
    });
  });

  describe('formatRelativeTime', () => {
    it('formats recent timestamps', () => {
      const now = new Date();
      const fiveMinutesAgo = new Date(now - 5 * 60 * 1000).toISOString();

      expect(formatRelativeTime(fiveMinutesAgo)).toBe('5m ago');
    });

    it('handles null timestamp', () => {
      expect(formatRelativeTime(null)).toBe('Never');
    });
  });

  describe('getDateRange', () => {
    it('returns correct range for 7d preset', () => {
      const range = getDateRange('7d');

      expect(range.label).toBe('Last 7 Days');
      expect(new Date(range.fromTs)).toBeInstanceOf(Date);
      expect(new Date(range.toTs)).toBeInstanceOf(Date);
    });

    it('defaults to 7d for unknown preset', () => {
      const range = getDateRange('unknown');

      expect(range.label).toBe('Last 7 Days');
    });
  });
});
```

Key test coverage:
- RPC parameter passing
- Default value handling
- Error propagation
- Tenant context validation
- Existing utility function behavior
  </action>
  <verify>Run tests: `npm test -- tests/unit/contentAnalyticsService.test.js`</verify>
  <done>contentAnalyticsService tests pass and cover Phase 10 functions</done>
</task>

<task type="auto">
  <name>Task 2: Final verification of all success criteria</name>
  <files></files>
  <action>
Verify all Phase 10 success criteria are met:

1. **ANA-01: View duration tracked**
   - Check: getContentMetrics returns avg_view_duration_seconds
   - Check: ContentDetailAnalyticsPage displays view duration

2. **ANA-02: View completion rates calculated**
   - Check: getContentMetrics returns completion_rate
   - Check: ContentDetailAnalyticsPage displays completion rate

3. **ANA-03: Content performance dashboard shows metrics by content item**
   - Check: AnalyticsDashboardPage Content tab shows sorted list
   - Check: getContentPerformanceList RPC sorts by total_view_time

4. **ANA-04: Time-based heatmap shows peak viewing periods**
   - Check: ViewingHeatmap component renders 7x24 grid
   - Check: getViewingHeatmap RPC returns full grid with zeros

Run verification commands:
```bash
# Check all new files exist
ls -la src/pages/AnalyticsDashboardPage.jsx
ls -la src/pages/ContentDetailAnalyticsPage.jsx
ls -la src/components/analytics/ViewingHeatmap.jsx
ls -la src/components/analytics/ContentInlineMetrics.jsx
ls -la supabase/migrations/118_content_analytics_rpcs.sql

# Check service functions exported
grep -E 'export.*(getContentMetrics|getContentPerformanceList|getViewingHeatmap)' src/services/contentAnalyticsService.js

# Check heatmap grid generation
grep 'generate_series' supabase/migrations/118_content_analytics_rpcs.sql

# Run full test suite
npm test
```

Document any failures or gaps for follow-up.
  </action>
  <verify>All 4 success criteria verified with file and code checks</verify>
  <done>Phase 10 success criteria verified: ANA-01, ANA-02, ANA-03, ANA-04 implemented</done>
</task>

</tasks>

<verification>
- [ ] tests/unit/contentAnalyticsService.test.js exists
- [ ] Tests cover getContentMetrics, getContentPerformanceList, getViewingHeatmap
- [ ] Tests verify error handling and default values
- [ ] All tests pass: `npm test -- tests/unit/contentAnalyticsService.test.js`
- [ ] ANA-01 verified: view duration tracked and displayed
- [ ] ANA-02 verified: completion rate calculated and displayed
- [ ] ANA-03 verified: dashboard shows content sorted by view time
- [ ] ANA-04 verified: heatmap shows 7x24 viewing patterns
</verification>

<success_criteria>
1. All Phase 10 service functions have test coverage
2. All 4 requirements (ANA-01 through ANA-04) verified
3. Full test suite passes without regressions
4. All new files exist and are properly integrated
</success_criteria>

<output>
After completion, create `.planning/phases/10-analytics/10-08-SUMMARY.md`
</output>
