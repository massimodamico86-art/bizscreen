---
phase: 10-analytics
plan: 05
type: execute
wave: 3
depends_on: ["10-02", "10-03", "10-04"]
files_modified:
  - src/pages/AnalyticsDashboardPage.jsx
  - src/App.jsx
autonomous: true

must_haves:
  truths:
    - "Dashboard opens with overview tab showing summary metrics"
    - "Overview shows total view hours, active screens, and top content"
    - "Content tab lists content sorted by total view time"
    - "Patterns tab shows viewing heatmap"
    - "Date range filter affects all tabs"
  artifacts:
    - path: "src/pages/AnalyticsDashboardPage.jsx"
      provides: "Main analytics dashboard with tabs"
      exports: ["default"]
      min_lines: 200
  key_links:
    - from: "AnalyticsDashboardPage"
      to: "contentAnalyticsService"
      via: "data fetching functions"
      pattern: "getContentPerformanceList|getViewingHeatmap"
    - from: "App.jsx"
      to: "AnalyticsDashboardPage"
      via: "page mapping"
      pattern: "analytics-dashboard"
---

<objective>
Create the main analytics dashboard page with tabbed sections (Overview, Content, Patterns).

Purpose: Fulfill ANA-03 (content performance dashboard) and provide access to ANA-04 (heatmap visualization).
Output: New AnalyticsDashboardPage.jsx with tabs and routing in App.jsx.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-analytics/10-CONTEXT.md
@.planning/phases/10-analytics/10-02-SUMMARY.md
@.planning/phases/10-analytics/10-03-SUMMARY.md

@src/pages/ContentPerformancePage.jsx
@src/design-system/components/Tabs.jsx
@src/design-system/components/Card.jsx
@src/App.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create AnalyticsDashboardPage</name>
  <files>src/pages/AnalyticsDashboardPage.jsx</files>
  <action>
Create new analytics dashboard page following existing page patterns:

```jsx
/**
 * Analytics Dashboard Page
 *
 * Main analytics dashboard with tabbed sections:
 * - Overview: Summary metrics (total view hours, active screens, top content)
 * - Content: Performance list sorted by total view time (ANA-03)
 * - Patterns: Viewing heatmap (ANA-04)
 */

import { useState, useEffect, useCallback } from 'react';
import { useNavigate } from 'react-router-dom';
import {
  BarChart3,
  Monitor,
  Play,
  Clock,
  TrendingUp,
  Layers,
  Calendar,
  RefreshCw,
  Eye,
  Film,
  ListVideo,
} from 'lucide-react';
import { useLogger } from '../hooks/useLogger.js';
import {
  PageLayout,
  PageHeader,
  PageContent,
  Card,
  Button,
  Tabs,
} from '../design-system';
import {
  getContentAnalyticsSummary,
  getContentPerformanceList,
  getViewingHeatmap,
  getTopScenes,
  DATE_RANGES,
  formatDuration,
  formatHours,
  formatRelativeTime,
} from '../services/contentAnalyticsService';
import { ViewingHeatmap } from '../components/analytics';

const DASHBOARD_TABS = [
  { id: 'overview', label: 'Overview', icon: BarChart3 },
  { id: 'content', label: 'Content', icon: Play },
  { id: 'patterns', label: 'Viewing Patterns', icon: Clock },
];

// Content type icons
const CONTENT_TYPE_ICONS = {
  scene: Layers,
  media: Film,
  playlist: ListVideo,
};

export default function AnalyticsDashboardPage({ showToast }) {
  const logger = useLogger('AnalyticsDashboardPage');
  const navigate = useNavigate();

  // State
  const [activeTab, setActiveTab] = useState('overview');
  const [dateRange, setDateRange] = useState('7d');
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);

  // Data
  const [summary, setSummary] = useState(null);
  const [topContent, setTopContent] = useState([]);
  const [performanceList, setPerformanceList] = useState([]);
  const [heatmapData, setHeatmapData] = useState([]);

  // Load data based on active tab
  const loadData = useCallback(async (isRefresh = false) => {
    try {
      if (isRefresh) {
        setRefreshing(true);
      } else {
        setLoading(true);
      }

      // Always load summary for overview stats
      const summaryData = await getContentAnalyticsSummary(dateRange);
      setSummary(summaryData);

      // Load tab-specific data
      if (activeTab === 'overview' || activeTab === 'content') {
        const [top, list] = await Promise.all([
          getTopScenes(dateRange, 5),
          getContentPerformanceList(dateRange, 20),
        ]);
        setTopContent(top);
        setPerformanceList(list);
      }

      if (activeTab === 'patterns') {
        const heatmap = await getViewingHeatmap(dateRange);
        setHeatmapData(heatmap);
      }
    } catch (error) {
      logger.error('Failed to load analytics:', error);
      showToast?.('Failed to load analytics data', 'error');
    } finally {
      setLoading(false);
      setRefreshing(false);
    }
  }, [dateRange, activeTab, showToast]);

  useEffect(() => {
    loadData();
  }, [loadData]);

  // Navigate to content detail analytics
  const handleContentClick = (item) => {
    navigate(`/analytics/content/${item.content_type}/${item.content_id}`);
  };

  // Render overview tab
  const renderOverview = () => (
    <div className="space-y-6">
      {/* Summary Cards */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
        <Card padding="default">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
              <Clock className="w-5 h-5 text-blue-600" />
            </div>
            <div>
              <p className="text-sm text-gray-500">Total View Time</p>
              <p className="text-2xl font-bold text-gray-900">
                {formatHours(summary?.total_playback_hours || 0)}
              </p>
            </div>
          </div>
        </Card>

        <Card padding="default">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-green-100 rounded-lg flex items-center justify-center">
              <Monitor className="w-5 h-5 text-green-600" />
            </div>
            <div>
              <p className="text-sm text-gray-500">Active Screens</p>
              <p className="text-2xl font-bold text-gray-900">
                {summary?.active_devices || 0}
              </p>
              <p className="text-xs text-gray-400">of {summary?.total_devices || 0}</p>
            </div>
          </div>
        </Card>

        <Card padding="default">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
              <Layers className="w-5 h-5 text-purple-600" />
            </div>
            <div>
              <p className="text-sm text-gray-500">Active Content</p>
              <p className="text-2xl font-bold text-gray-900">
                {summary?.active_scenes || 0}
              </p>
              <p className="text-xs text-gray-400">scenes played</p>
            </div>
          </div>
        </Card>

        <Card padding="default">
          <div className="flex items-center gap-3">
            <div className="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
              <TrendingUp className="w-5 h-5 text-orange-600" />
            </div>
            <div>
              <p className="text-sm text-gray-500">Avg. Uptime</p>
              <p className="text-2xl font-bold text-gray-900">
                {(summary?.avg_uptime_percent || 0).toFixed(1)}%
              </p>
            </div>
          </div>
        </Card>
      </div>

      {/* Top Content */}
      <Card>
        <div className="px-4 py-3 border-b border-gray-200">
          <h3 className="font-semibold text-gray-900">Top Content</h3>
          <p className="text-sm text-gray-500">By total view time</p>
        </div>
        <div className="p-4">
          {topContent.length === 0 ? (
            <p className="text-center text-gray-500 py-8">No content data available</p>
          ) : (
            <div className="space-y-3">
              {topContent.map((item, index) => {
                const maxDuration = topContent[0]?.total_duration_seconds || 1;
                const percentage = Math.round((item.total_duration_seconds / maxDuration) * 100);

                return (
                  <div key={item.scene_id} className="cursor-pointer hover:bg-gray-50 rounded-lg p-2 -mx-2">
                    <div className="flex items-center justify-between mb-1">
                      <div className="flex items-center gap-2">
                        <span className="w-6 h-6 bg-blue-100 rounded-full flex items-center justify-center text-xs font-semibold text-blue-700">
                          {index + 1}
                        </span>
                        <span className="font-medium text-gray-900 truncate max-w-[200px]">
                          {item.scene_name || 'Unnamed'}
                        </span>
                      </div>
                      <span className="text-sm font-medium text-gray-700">
                        {formatHours(item.total_duration_seconds / 3600)}
                      </span>
                    </div>
                    <div className="ml-8">
                      <div className="h-2 bg-gray-100 rounded-full overflow-hidden">
                        <div
                          className="h-full bg-gradient-to-r from-blue-500 to-purple-500 rounded-full"
                          style={{ width: `${percentage}%` }}
                        />
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          )}
        </div>
      </Card>
    </div>
  );

  // Render content tab
  const renderContent = () => (
    <Card>
      <div className="px-4 py-3 border-b border-gray-200">
        <h3 className="font-semibold text-gray-900">Content Performance</h3>
        <p className="text-sm text-gray-500">Sorted by total view time</p>
      </div>
      <div className="overflow-x-auto">
        <table className="w-full">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Content</th>
              <th className="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
              <th className="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Total Time</th>
              <th className="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Avg. Duration</th>
              <th className="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Views</th>
              <th className="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Completion</th>
              <th className="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase">Last Viewed</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-100">
            {performanceList.length === 0 ? (
              <tr>
                <td colSpan={7} className="px-4 py-8 text-center text-gray-500">
                  No content data available
                </td>
              </tr>
            ) : (
              performanceList.map((item) => {
                const Icon = CONTENT_TYPE_ICONS[item.content_type] || Layers;
                return (
                  <tr
                    key={`${item.content_type}-${item.content_id}`}
                    className="hover:bg-gray-50 cursor-pointer"
                    onClick={() => handleContentClick(item)}
                  >
                    <td className="px-4 py-3">
                      <div className="flex items-center gap-2">
                        <Icon className="w-4 h-4 text-gray-400" />
                        <span className="font-medium text-gray-900">{item.content_name || 'Unnamed'}</span>
                      </div>
                    </td>
                    <td className="px-4 py-3 text-sm text-gray-500 capitalize">{item.content_type}</td>
                    <td className="px-4 py-3 text-right text-sm font-medium text-gray-900">
                      {formatHours((item.total_view_time_seconds || 0) / 3600)}
                    </td>
                    <td className="px-4 py-3 text-right text-sm text-gray-600">
                      {formatDuration(item.avg_view_duration_seconds || 0)}
                    </td>
                    <td className="px-4 py-3 text-right text-sm text-gray-600">
                      {(item.total_views || 0).toLocaleString()}
                    </td>
                    <td className="px-4 py-3 text-right">
                      <span className={`text-sm font-medium ${
                        (item.completion_rate || 0) >= 80 ? 'text-green-600' :
                        (item.completion_rate || 0) >= 50 ? 'text-orange-600' : 'text-gray-600'
                      }`}>
                        {Math.round(item.completion_rate || 0)}%
                      </span>
                    </td>
                    <td className="px-4 py-3 text-right text-sm text-gray-500">
                      {formatRelativeTime(item.last_viewed_at)}
                    </td>
                  </tr>
                );
              })
            )}
          </tbody>
        </table>
      </div>
    </Card>
  );

  // Render patterns tab
  const renderPatterns = () => (
    <Card>
      <div className="px-4 py-3 border-b border-gray-200">
        <h3 className="font-semibold text-gray-900">Viewing Patterns</h3>
        <p className="text-sm text-gray-500">When content is most viewed (by hour and day of week)</p>
      </div>
      <div className="p-4">
        <ViewingHeatmap data={heatmapData} loading={loading} />
      </div>
    </Card>
  );

  if (loading && !refreshing) {
    return (
      <PageLayout>
        <PageContent>
          <div className="flex items-center justify-center h-64">
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4" />
              <p className="text-gray-600">Loading analytics...</p>
            </div>
          </div>
        </PageContent>
      </PageLayout>
    );
  }

  return (
    <PageLayout>
      <PageHeader
        title={
          <span className="flex items-center gap-2">
            <BarChart3 className="w-7 h-7 text-blue-600" />
            Analytics Dashboard
          </span>
        }
        description="Content performance and viewing patterns"
        actions={
          <Button
            variant="ghost"
            onClick={() => loadData(true)}
            disabled={refreshing}
          >
            <RefreshCw className={`w-4 h-4 ${refreshing ? 'animate-spin' : ''}`} />
            Refresh
          </Button>
        }
      />
      <PageContent>
        <div className="space-y-6">
          {/* Date Range Pills */}
          <div className="flex flex-wrap gap-2">
            {Object.entries(DATE_RANGES).map(([key, { label }]) => (
              <button
                key={key}
                onClick={() => setDateRange(key)}
                className={`px-3 py-1.5 text-sm rounded-full transition-colors ${
                  dateRange === key
                    ? 'bg-blue-600 text-white'
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`}
              >
                {label}
              </button>
            ))}
          </div>

          {/* Tabs */}
          <Tabs
            tabs={DASHBOARD_TABS}
            activeTab={activeTab}
            onChange={setActiveTab}
          />

          {/* Tab Content */}
          <div className="mt-6">
            {activeTab === 'overview' && renderOverview()}
            {activeTab === 'content' && renderContent()}
            {activeTab === 'patterns' && renderPatterns()}
          </div>
        </div>
      </PageContent>
    </PageLayout>
  );
}
```

Key implementation notes:
- Per CONTEXT.md: Overview shows Total view hours, Active screens, Top content
- Tabs: Overview, Content, Patterns (per CONTEXT.md - Claude's discretion on naming)
- Content tab shows sorted by total view time (ANA-03)
- Patterns tab shows heatmap (ANA-04)
- Uses existing design-system components (Tabs, Card, PageLayout)
  </action>
  <verify>Check page exists: `wc -l src/pages/AnalyticsDashboardPage.jsx` should show 200+ lines</verify>
  <done>AnalyticsDashboardPage has 3 tabs showing overview, content list, and heatmap</done>
</task>

<task type="auto">
  <name>Task 2: Add route in App.jsx</name>
  <files>src/App.jsx</files>
  <action>
Add lazy import and page mapping for AnalyticsDashboardPage:

1. Add lazy import near other analytics imports (around line 89):
```javascript
const AnalyticsDashboardPage = lazy(() => import('./pages/AnalyticsDashboardPage'));
```

2. Add page mapping in PAGE_MAP (around line 546, after content-performance):
```javascript
'analytics-dashboard': <Suspense fallback={<PageLoader />}><FeatureGate feature={Feature.ADVANCED_ANALYTICS} fallback={<FeatureUpgradePrompt feature={Feature.ADVANCED_ANALYTICS} onNavigate={() => setCurrentPage('account-plan')} />}><AnalyticsDashboardPage showToast={showToast} /></FeatureGate></Suspense>,
```

Note: Uses same FeatureGate pattern as existing analytics pages for consistency.
  </action>
  <verify>Check route added: `grep 'analytics-dashboard' src/App.jsx`</verify>
  <done>App.jsx routes 'analytics-dashboard' to AnalyticsDashboardPage</done>
</task>

</tasks>

<verification>
- [ ] src/pages/AnalyticsDashboardPage.jsx exists and exports default
- [ ] Page has 3 tabs: Overview, Content, Patterns
- [ ] Overview shows summary cards and top content
- [ ] Content tab shows sortable performance table
- [ ] Patterns tab renders ViewingHeatmap
- [ ] Date range pills filter all tabs
- [ ] App.jsx has lazy import for AnalyticsDashboardPage
- [ ] App.jsx PAGE_MAP includes 'analytics-dashboard' route
- [ ] No lint errors
</verification>

<success_criteria>
1. Dashboard accessible at 'analytics-dashboard' page
2. Overview tab shows total view hours, active screens, top content (per CONTEXT.md)
3. Content tab lists content sorted by total view time (ANA-03)
4. Patterns tab shows viewing heatmap (ANA-04)
5. Feature gate applied for ADVANCED_ANALYTICS
</success_criteria>

<output>
After completion, create `.planning/phases/10-analytics/10-05-SUMMARY.md`
</output>
