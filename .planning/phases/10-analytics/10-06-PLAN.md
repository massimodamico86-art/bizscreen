---
phase: 10-analytics
plan: 06
type: execute
wave: 3
depends_on: ["10-02", "10-04"]
files_modified:
  - src/pages/ContentDetailAnalyticsPage.jsx
  - src/App.jsx
autonomous: true

must_haves:
  truths:
    - "Content detail page shows average view duration in seconds"
    - "Content detail page shows completion rate as percentage"
    - "Page accessible via /analytics/content/:type/:id route"
  artifacts:
    - path: "src/pages/ContentDetailAnalyticsPage.jsx"
      provides: "Dedicated analytics page for single content item"
      exports: ["default"]
      min_lines: 100
  key_links:
    - from: "ContentDetailAnalyticsPage"
      to: "getContentMetrics"
      via: "useEffect data fetch"
      pattern: "getContentMetrics"
    - from: "App.jsx"
      to: "ContentDetailAnalyticsPage"
      via: "route pattern"
      pattern: "analytics/content"
---

<objective>
Create the dedicated analytics page for a single content item (scene, media, or playlist).

Purpose: Fulfill ANA-01 (view duration) and ANA-02 (completion rate) with detailed breakdowns. This is the "full analytics" page linked from ContentInlineMetrics.
Output: ContentDetailAnalyticsPage.jsx with routing.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/10-analytics/10-CONTEXT.md
@.planning/phases/10-analytics/10-02-SUMMARY.md
@.planning/phases/10-analytics/10-04-SUMMARY.md

@src/services/contentAnalyticsService.js
@src/pages/ContentPerformancePage.jsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ContentDetailAnalyticsPage</name>
  <files>src/pages/ContentDetailAnalyticsPage.jsx</files>
  <action>
Create dedicated analytics page for single content item:

```jsx
/**
 * Content Detail Analytics Page
 *
 * Detailed analytics view for a single content item (scene, media, or playlist).
 * Shows: View duration (ANA-01), Completion rate (ANA-02), timeline, screen breakdown.
 */

import { useState, useEffect } from 'react';
import { useParams, useNavigate } from 'react-router-dom';
import {
  ArrowLeft,
  Clock,
  CheckCircle,
  Eye,
  Calendar,
  Monitor,
  TrendingUp,
  Layers,
  Film,
  ListVideo,
  RefreshCw,
} from 'lucide-react';
import { useLogger } from '../hooks/useLogger.js';
import {
  PageLayout,
  PageHeader,
  PageContent,
  Card,
  Button,
} from '../design-system';
import {
  getContentMetrics,
  getSceneTimeline,
  DATE_RANGES,
  formatDuration,
  formatHours,
  formatRelativeTime,
} from '../services/contentAnalyticsService';

// Content type icons and labels
const CONTENT_CONFIG = {
  scene: { icon: Layers, label: 'Scene' },
  media: { icon: Film, label: 'Media' },
  playlist: { icon: ListVideo, label: 'Playlist' },
};

export default function ContentDetailAnalyticsPage({ showToast }) {
  const logger = useLogger('ContentDetailAnalyticsPage');
  const navigate = useNavigate();
  const { contentType, contentId } = useParams();

  const [dateRange, setDateRange] = useState('7d');
  const [metrics, setMetrics] = useState(null);
  const [timeline, setTimeline] = useState([]);
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);

  const config = CONTENT_CONFIG[contentType] || CONTENT_CONFIG.scene;
  const Icon = config.icon;

  useEffect(() => {
    async function loadData() {
      if (!contentId || !contentType) return;

      try {
        setLoading(true);

        const [metricsData, timelineData] = await Promise.all([
          getContentMetrics(contentId, contentType, dateRange),
          contentType === 'scene' ? getSceneTimeline(contentId, dateRange) : Promise.resolve([]),
        ]);

        setMetrics(metricsData);
        setTimeline(timelineData);
      } catch (error) {
        logger.error('Failed to load content analytics:', error);
        showToast?.('Failed to load analytics', 'error');
      } finally {
        setLoading(false);
        setRefreshing(false);
      }
    }

    loadData();
  }, [contentId, contentType, dateRange, showToast]);

  const handleRefresh = async () => {
    setRefreshing(true);
    // Re-trigger useEffect
    setDateRange(prev => prev);
  };

  if (loading && !refreshing) {
    return (
      <PageLayout>
        <PageContent>
          <div className="flex items-center justify-center h-64">
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4" />
              <p className="text-gray-600">Loading analytics...</p>
            </div>
          </div>
        </PageContent>
      </PageLayout>
    );
  }

  const completionRate = Math.round(metrics?.completion_rate || 0);

  return (
    <PageLayout>
      <PageHeader
        title={
          <span className="flex items-center gap-2">
            <Icon className="w-7 h-7 text-blue-600" />
            {config.label} Analytics
          </span>
        }
        description={`Detailed performance metrics for this ${config.label.toLowerCase()}`}
        actions={
          <div className="flex items-center gap-3">
            <Button variant="ghost" onClick={() => navigate(-1)}>
              <ArrowLeft className="w-4 h-4 mr-1" />
              Back
            </Button>
            <Button
              variant="ghost"
              onClick={handleRefresh}
              disabled={refreshing}
            >
              <RefreshCw className={`w-4 h-4 ${refreshing ? 'animate-spin' : ''}`} />
              Refresh
            </Button>
          </div>
        }
      />
      <PageContent>
        <div className="space-y-6">
          {/* Date Range Pills */}
          <div className="flex flex-wrap gap-2">
            {Object.entries(DATE_RANGES).map(([key, { label }]) => (
              <button
                key={key}
                onClick={() => setDateRange(key)}
                className={`px-3 py-1.5 text-sm rounded-full transition-colors ${
                  dateRange === key
                    ? 'bg-blue-600 text-white'
                    : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                }`}
              >
                {label}
              </button>
            ))}
          </div>

          {/* Primary Metrics - ANA-01 and ANA-02 */}
          <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
            {/* View Duration (ANA-01) */}
            <Card padding="default">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-blue-100 rounded-lg flex items-center justify-center">
                  <Clock className="w-5 h-5 text-blue-600" />
                </div>
                <div>
                  <p className="text-sm text-gray-500">Avg. View Duration</p>
                  <p className="text-2xl font-bold text-gray-900">
                    {formatDuration(metrics?.avg_view_duration_seconds || 0)}
                  </p>
                </div>
              </div>
            </Card>

            {/* Completion Rate (ANA-02) */}
            <Card padding="default">
              <div className="flex items-center gap-3">
                <div className={`w-10 h-10 rounded-lg flex items-center justify-center ${
                  completionRate >= 80 ? 'bg-green-100' :
                  completionRate >= 50 ? 'bg-orange-100' : 'bg-gray-100'
                }`}>
                  <CheckCircle className={`w-5 h-5 ${
                    completionRate >= 80 ? 'text-green-600' :
                    completionRate >= 50 ? 'text-orange-600' : 'text-gray-600'
                  }`} />
                </div>
                <div>
                  <p className="text-sm text-gray-500">Completion Rate</p>
                  <p className={`text-2xl font-bold ${
                    completionRate >= 80 ? 'text-green-600' :
                    completionRate >= 50 ? 'text-orange-600' : 'text-gray-900'
                  }`}>
                    {completionRate}%
                  </p>
                </div>
              </div>
            </Card>

            {/* Total Views */}
            <Card padding="default">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-purple-100 rounded-lg flex items-center justify-center">
                  <Eye className="w-5 h-5 text-purple-600" />
                </div>
                <div>
                  <p className="text-sm text-gray-500">Total Views</p>
                  <p className="text-2xl font-bold text-gray-900">
                    {(metrics?.total_views || 0).toLocaleString()}
                  </p>
                </div>
              </div>
            </Card>

            {/* Total View Time */}
            <Card padding="default">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 bg-orange-100 rounded-lg flex items-center justify-center">
                  <TrendingUp className="w-5 h-5 text-orange-600" />
                </div>
                <div>
                  <p className="text-sm text-gray-500">Total View Time</p>
                  <p className="text-2xl font-bold text-gray-900">
                    {formatHours((metrics?.total_view_time_seconds || 0) / 3600)}
                  </p>
                </div>
              </div>
            </Card>
          </div>

          {/* Timeline Chart (for scenes) */}
          {contentType === 'scene' && timeline.length > 0 && (
            <Card>
              <div className="px-4 py-3 border-b border-gray-200">
                <h3 className="font-semibold text-gray-900">Viewing Timeline</h3>
                <p className="text-sm text-gray-500">View activity over time</p>
              </div>
              <div className="p-4">
                <div className="h-32 flex items-end gap-1">
                  {timeline.slice(-48).map((bucket, i) => {
                    const maxValue = Math.max(...timeline.map(t => t.total_duration_seconds || 0));
                    const height = maxValue > 0
                      ? Math.max(4, ((bucket.total_duration_seconds || 0) / maxValue) * 100)
                      : 4;
                    return (
                      <div
                        key={i}
                        className="flex-1 bg-blue-500 rounded-t hover:bg-blue-600 transition-colors"
                        style={{ height: `${height}%` }}
                        title={`${bucket.total_duration_seconds ? Math.round(bucket.total_duration_seconds / 60) : 0} min`}
                      />
                    );
                  })}
                </div>
                <div className="flex justify-between text-xs text-gray-500 mt-2">
                  <span>Older</span>
                  <span>Recent</span>
                </div>
              </div>
            </Card>
          )}

          {/* Additional Info */}
          <Card>
            <div className="px-4 py-3 border-b border-gray-200">
              <h3 className="font-semibold text-gray-900">Details</h3>
            </div>
            <div className="p-4">
              <dl className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <dt className="text-sm text-gray-500">Content ID</dt>
                  <dd className="text-sm font-mono text-gray-900">{contentId}</dd>
                </div>
                <div>
                  <dt className="text-sm text-gray-500">Content Type</dt>
                  <dd className="text-sm text-gray-900 capitalize">{contentType}</dd>
                </div>
                <div>
                  <dt className="text-sm text-gray-500">Last Viewed</dt>
                  <dd className="text-sm text-gray-900">
                    {formatRelativeTime(metrics?.last_viewed_at)}
                  </dd>
                </div>
                <div>
                  <dt className="text-sm text-gray-500">Date Range</dt>
                  <dd className="text-sm text-gray-900">{DATE_RANGES[dateRange]?.label}</dd>
                </div>
              </dl>
            </div>
          </Card>
        </div>
      </PageContent>
    </PageLayout>
  );
}
```

Key implementation notes:
- URL params: /analytics/content/:contentType/:contentId
- Prominently shows View Duration (ANA-01) and Completion Rate (ANA-02)
- Timeline visualization for scene content
- Color-coded completion rate indicator
  </action>
  <verify>Check page exists: `wc -l src/pages/ContentDetailAnalyticsPage.jsx` should show 100+ lines</verify>
  <done>ContentDetailAnalyticsPage shows view duration and completion rate with timeline</done>
</task>

<task type="auto">
  <name>Task 2: Add dynamic route in App.jsx</name>
  <files>src/App.jsx</files>
  <action>
Add lazy import and route handling for ContentDetailAnalyticsPage:

1. Add lazy import near other analytics imports:
```javascript
const ContentDetailAnalyticsPage = lazy(() => import('./pages/ContentDetailAnalyticsPage'));
```

2. This page uses URL params (:contentType/:contentId), so it needs to be added to the routing system.

Check how the codebase handles parameterized routes. If it uses react-router-dom Routes/Route components in AppRouter.jsx, add there:
```jsx
<Route path="/analytics/content/:contentType/:contentId" element={
  <RequireAuth>
    <FeatureGate feature={Feature.ADVANCED_ANALYTICS} fallback={<FeatureUpgradePrompt />}>
      <ContentDetailAnalyticsPage showToast={showToast} />
    </FeatureGate>
  </RequireAuth>
} />
```

If routing is via PAGE_MAP pattern, add a way to handle this dynamic route or use react-router for this specific path.

Search for existing parameterized routes (e.g., /pair/:deviceId from Phase 9) to follow the same pattern.
  </action>
  <verify>Check route pattern added: `grep -r 'analytics/content' src/`</verify>
  <done>Route /analytics/content/:contentType/:contentId maps to ContentDetailAnalyticsPage</done>
</task>

</tasks>

<verification>
- [ ] src/pages/ContentDetailAnalyticsPage.jsx exists and exports default
- [ ] Page shows average view duration in seconds (ANA-01)
- [ ] Page shows completion rate as percentage (ANA-02)
- [ ] Route /analytics/content/:contentType/:contentId works
- [ ] Timeline renders for scene content
- [ ] Back button navigates to previous page
- [ ] No lint errors
</verification>

<success_criteria>
1. Page accessible via URL with contentType and contentId params
2. View duration displayed in human-readable format (ANA-01)
3. Completion rate shown with color-coded indicator (ANA-02)
4. Timeline visualization shows view activity over time
</success_criteria>

<output>
After completion, create `.planning/phases/10-analytics/10-06-SUMMARY.md`
</output>
