---
phase: 13-technical-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/Player.jsx
  - src/player/components/SceneRenderer.jsx
  - src/player/components/LayoutRenderer.jsx
  - src/player/components/ZonePlayer.jsx
  - src/player/components/AppRenderer.jsx
  - src/player/components/index.js
autonomous: true

must_haves:
  truths:
    - "Player.jsx is under 1000 lines"
    - "Offline playback works identically after refactoring"
    - "All existing Player tests pass"
    - "Scene rendering displays correctly in browser"
  artifacts:
    - path: "src/Player.jsx"
      provides: "Main player router and ViewPage shell"
      max_lines: 1000
    - path: "src/player/components/SceneRenderer.jsx"
      provides: "Scene/slide rendering with transitions"
      min_lines: 100
    - path: "src/player/components/LayoutRenderer.jsx"
      provides: "Multi-zone layout rendering"
      min_lines: 80
    - path: "src/player/components/ZonePlayer.jsx"
      provides: "Single zone playback"
      min_lines: 60
    - path: "src/player/components/AppRenderer.jsx"
      provides: "App type routing (clock, weather, qr, etc)"
      min_lines: 40
  key_links:
    - from: "src/Player.jsx"
      to: "src/player/components/SceneRenderer.jsx"
      via: "import and JSX usage"
      pattern: "import.*SceneRenderer"
    - from: "src/player/components/SceneRenderer.jsx"
      to: "src/services/sceneDesignService"
      via: "getSlideTransitionStyles import"
      pattern: "import.*sceneDesignService"
---

<objective>
Extract renderer components from Player.jsx to reduce it from 2,895 lines to under 1,000 lines.

Purpose: Player.jsx is currently 2,895 lines, making it difficult to maintain and blocking v2 feature work. Phase 7 extracted hooks (600 lines). This plan extracts renderer components (target: ~1,900 additional lines).
Output: Player.jsx under 1,000 lines with SceneRenderer, LayoutRenderer, ZonePlayer, and AppRenderer as separate components.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-technical-foundation/13-RESEARCH.md

# Existing player structure
@src/Player.jsx
@src/player/hooks/index.js
@src/player/components/widgets/index.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extract SceneRenderer and LayoutRenderer</name>
  <files>
    src/player/components/SceneRenderer.jsx
    src/player/components/LayoutRenderer.jsx
    src/Player.jsx
  </files>
  <action>
Extract scene/slide rendering logic from Player.jsx into SceneRenderer.jsx:
- Find the renderScene/renderSlide function(s) in Player.jsx (approximately lines 1200-1600)
- Create src/player/components/SceneRenderer.jsx with props: slide, slideIndex, deviceTimezone, isTransitioning, transitionDuration, previewSize, dataBindings, onSlideReady
- Move block rendering, transition styles, and data binding resolution to SceneRenderer
- Import getBlockAnimationStyles, getSlideTransitionStyles from sceneDesignService
- Import resolveSlideBindings from dataBindingResolver if used

Extract multi-zone layout rendering into LayoutRenderer.jsx:
- Find layout rendering logic in Player.jsx (handles multi-zone displays)
- Create src/player/components/LayoutRenderer.jsx with props: layout, zones, deviceTimezone, previewSize
- Move zone positioning, sizing, and orchestration logic

Update Player.jsx:
- Add imports for SceneRenderer and LayoutRenderer
- Replace inline render functions with component usage
- Pass all required props (don't rely on closure variables - critical for offline)

CRITICAL: Do not break offline capability. Pass all state as props, do not rely on closures.
  </action>
  <verify>
Run Player tests: `npm test -- tests/unit/player/Player.test.jsx`
Count lines: `wc -l src/Player.jsx` should show significant reduction (target: under 1800 after this task)
Check SceneRenderer exists: `wc -l src/player/components/SceneRenderer.jsx`
  </verify>
  <done>
SceneRenderer.jsx and LayoutRenderer.jsx exist with extracted logic.
Player.jsx reduced by approximately 800-1000 lines.
All existing Player tests pass.
  </done>
</task>

<task type="auto">
  <name>Task 2: Extract ZonePlayer and AppRenderer</name>
  <files>
    src/player/components/ZonePlayer.jsx
    src/player/components/AppRenderer.jsx
    src/player/components/index.js
    src/Player.jsx
  </files>
  <action>
Extract single zone playback into ZonePlayer.jsx:
- Find zone playback logic in Player.jsx (handles individual zone content cycling)
- Create src/player/components/ZonePlayer.jsx with props: zone, content, deviceTimezone, onContentComplete
- Move content cycling, duration handling, and zone-specific state

Extract app type routing into AppRenderer.jsx:
- Find app type switch/routing logic in Player.jsx (routes to ClockApp, WeatherApp, etc.)
- Create src/player/components/AppRenderer.jsx with props: appType, config, deviceTimezone
- Import existing widgets: ClockWidget, DateWidget, WeatherWidget, QRCodeWidget from ./widgets
- Route to appropriate widget based on appType

Create barrel export:
- Update src/player/components/index.js to export all new components:
  - SceneRenderer, LayoutRenderer, ZonePlayer, AppRenderer
  - Re-export widgets from ./widgets

Final Player.jsx cleanup:
- Import components from './player/components'
- Replace all inline render functions with component usage
- Ensure ViewPage is a clean shell that orchestrates components
- Verify no closure dependencies remain (all state passed as props)

Run offline test to verify:
- Start player in browser
- Disconnect network
- Verify playback continues correctly
  </action>
  <verify>
Run full test suite: `npm test`
Count final lines: `wc -l src/Player.jsx` must be under 1000
Verify components exist: `ls -la src/player/components/`
Manual offline test: Start player, disconnect network, verify playback continues
  </verify>
  <done>
Player.jsx is under 1000 lines.
ZonePlayer.jsx and AppRenderer.jsx exist.
src/player/components/index.js exports all components.
All tests pass.
Offline playback verified working.
  </done>
</task>

</tasks>

<verification>
1. Line count check: `wc -l src/Player.jsx` shows under 1000 lines
2. Full test suite: `npm test` passes (1396+ tests)
3. Component structure: `ls src/player/components/` shows SceneRenderer, LayoutRenderer, ZonePlayer, AppRenderer
4. No regressions: Player renders scenes, layouts, zones correctly
5. Offline works: Player continues playback when network disconnected
</verification>

<success_criteria>
- Player.jsx is under 1000 lines (currently 2895, target <1000)
- SceneRenderer, LayoutRenderer, ZonePlayer, AppRenderer components extracted
- All 1396+ existing tests pass
- Offline playback works identically to before refactoring
- No new console errors in browser during player operation
</success_criteria>

<output>
After completion, create `.planning/phases/13-technical-foundation/13-01-SUMMARY.md`
</output>
