---
phase: 13-technical-foundation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/unit/pages/hooks/pageHooks.test.jsx
autonomous: true

must_haves:
  truths:
    - "useCampaignEditor test passes 10 consecutive times"
    - "Test uses explicit waitFor with timeout for async operations"
    - "Test properly isolates state between runs"
  artifacts:
    - path: "tests/unit/pages/hooks/pageHooks.test.jsx"
      provides: "Stable useCampaignEditor tests"
      contains: "timeout: 3000"
  key_links:
    - from: "tests/unit/pages/hooks/pageHooks.test.jsx"
      to: "src/pages/hooks/useCampaignEditor.js"
      via: "import and renderHook"
      pattern: "import.*useCampaignEditor"
---

<objective>
Harden the useCampaignEditor test to eliminate flakiness and ensure 10 consecutive passing runs.

Purpose: The useCampaignEditor test has been noted as flaky due to timing issues with async picker data loading. While currently passing (5/5 runs), the test lacks explicit waitFor conditions that could cause intermittent failures in CI.
Output: Stable test that passes reliably with explicit async handling.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/13-technical-foundation/13-RESEARCH.md

# Test file
@tests/unit/pages/hooks/pageHooks.test.jsx
# Hook under test
@src/pages/hooks/useCampaignEditor.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Harden useCampaignEditor test with explicit async handling</name>
  <files>
    tests/unit/pages/hooks/pageHooks.test.jsx
  </files>
  <action>
Update the useCampaignEditor test section (around lines 539-699) to add explicit waitFor conditions:

1. Find the "loads picker data" test (around line 618):
   Current pattern:
   ```javascript
   await waitFor(() => {
     expect(result.current.playlists).toBeDefined();
   });
   ```

   Update to explicitly wait for loading first:
   ```javascript
   // Wait for loading to complete FIRST
   await waitFor(() => {
     expect(result.current.loading).toBe(false);
   }, { timeout: 3000 });

   // Then verify picker data
   expect(result.current.playlists).toHaveLength(1);
   expect(result.current.layouts).toHaveLength(1);
   ```

2. Find the "loads campaign data for existing id" test (around line 605):
   Ensure it also has explicit timeout:
   ```javascript
   await waitFor(() => {
     expect(result.current.loading).toBe(false);
   }, { timeout: 3000 });
   ```

3. Review all async tests in useCampaignEditor block:
   - Any test that waits for async state should use explicit timeout
   - Timeout should be 3000ms (reasonable for CI environments)
   - Always wait for loading=false BEFORE checking derived state

4. Ensure beforeEach properly resets state:
   ```javascript
   beforeEach(() => {
     localStorageStore = {};
     vi.clearAllMocks();
     // Reset service mocks to known state
     campaignService.getCampaign.mockResolvedValue({
       id: '123',
       name: 'Test Campaign',
       description: 'Test description',
       status: 'draft',
       start_at: '2024-01-01T00:00:00Z',
       end_at: '2024-12-31T23:59:59Z',
       priority: 100,
       targets: [],
       contents: []
     });
   });
   ```

5. Ensure afterEach restores mocks:
   ```javascript
   afterEach(() => {
     vi.restoreAllMocks();
   });
   ```
  </action>
  <verify>
Run test 10 times consecutively:
```bash
for i in {1..10}; do
  echo "Run $i:" && npm test -- tests/unit/pages/hooks/pageHooks.test.jsx --reporter=dot && echo "PASS" || echo "FAIL"
done
```
All 10 runs should pass.
  </verify>
  <done>
useCampaignEditor test has explicit waitFor with timeout for all async operations.
Test passes 10 consecutive times without flakiness.
State properly isolated between test runs.
  </done>
</task>

<task type="auto">
  <name>Task 2: Run full test suite verification</name>
  <files>
    (no files modified - verification only)
  </files>
  <action>
Run comprehensive verification:

1. Run full test suite: `npm test`
   - All 1396+ tests should pass
   - No new failures introduced by test hardening

2. Run pageHooks.test.jsx specifically 10 times:
   ```bash
   for i in {1..10}; do
     npm test -- tests/unit/pages/hooks/pageHooks.test.jsx --reporter=dot
   done
   ```
   - All 89 tests in file should pass each run
   - No intermittent failures

3. Check for any remaining timing-sensitive patterns:
   ```bash
   grep -n "setTimeout\|setInterval" tests/unit/pages/hooks/pageHooks.test.jsx
   ```
   - Should return empty (no raw timers in tests)

4. Verify waitFor usage has timeouts:
   ```bash
   grep -A2 "waitFor" tests/unit/pages/hooks/pageHooks.test.jsx | grep -v "timeout"
   ```
   - Any waitFor without timeout in useCampaignEditor section should be fixed
  </action>
  <verify>
Full suite passes: `npm test` shows all tests passing
10 consecutive runs pass: Script above shows 10/10 PASS
No timing anti-patterns remain in useCampaignEditor tests
  </verify>
  <done>
Full test suite passes (1396+ tests).
useCampaignEditor section passes 10 consecutive runs.
TECH-03 requirement satisfied.
  </done>
</task>

</tasks>

<verification>
1. Run `npm test -- tests/unit/pages/hooks/pageHooks.test.jsx` 10 times - all should pass
2. Run full `npm test` - all 1396+ tests pass
3. Check explicit timeouts: `grep "timeout:" tests/unit/pages/hooks/pageHooks.test.jsx` shows timeouts in useCampaignEditor section
4. No setTimeout in tests: `grep "setTimeout" tests/unit/pages/hooks/pageHooks.test.jsx` returns empty (except in mocks if any)
</verification>

<success_criteria>
- useCampaignEditor test passes 10 consecutive runs (TECH-03)
- All async operations use explicit waitFor with timeout
- State properly isolated in beforeEach/afterEach
- Full test suite continues to pass
</success_criteria>

<output>
After completion, create `.planning/phases/13-technical-foundation/13-03-SUMMARY.md`
</output>
