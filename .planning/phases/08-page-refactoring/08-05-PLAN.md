---
phase: 08-page-refactoring
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/hooks/index.js
  - src/pages/hooks/useMediaLibrary.js
  - src/pages/MediaLibraryPage.jsx
autonomous: true

must_haves:
  truths:
    - "MediaLibraryPage lists media assets in grid and list views"
    - "File uploads work via drag-drop and modal"
    - "Folders can be navigated and managed"
    - "Media can be filtered by type and searched"
    - "Bulk selection and bulk actions work"
    - "Media can be deleted with usage check"
    - "Media can be added to playlists"
    - "Media can be pushed to screens"
  artifacts:
    - path: "src/pages/hooks/useMediaLibrary.js"
      provides: "Media data, folder navigation, filter/search, bulk selection, CRUD"
      min_lines: 350
    - path: "src/pages/MediaLibraryPage.jsx"
      provides: "Refactored page using useMediaLibrary hook"
      max_lines: 800
  key_links:
    - from: "src/pages/MediaLibraryPage.jsx"
      to: "src/pages/hooks/useMediaLibrary.js"
      via: "import { useMediaLibrary }"
      pattern: "useMediaLibrary"
    - from: "src/pages/hooks/useMediaLibrary.js"
      to: "services/mediaService"
      via: "fetchMediaAssets, deleteMediaAssetSafely, etc."
      pattern: "mediaService"
---

<objective>
Extract custom hook from MediaLibraryPage.jsx to reduce complexity.

Purpose: MediaLibraryPage (2543 lines) has the highest complexity with media data, folders (already uses useMediaFolders), bulk selection, modals, drag-drop upload. Extracting to useMediaLibrary coordinates existing hooks and adds missing state management.

Output: useMediaLibrary.js hook, updated barrel export, refactored page under ~700 lines.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-page-refactoring/08-RESEARCH.md

# Existing hooks the page uses (coordinate, don't replace)
@src/hooks/useMediaFolders.js
@src/hooks/useS3Upload.jsx

# Reference patterns
@src/player/hooks/usePlayerContent.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useMediaLibrary hook</name>
  <files>
    - src/pages/hooks/useMediaLibrary.js
    - src/pages/hooks/index.js
  </files>
  <action>
Create useMediaLibrary.js hook that extracts from MediaLibraryPage.jsx:

**IMPORTANT:** MediaLibraryPage already uses useMediaFolders and useS3Upload. The new hook should COMPOSE these existing hooks, not replace them.

**Media data state:**
- mediaAssets array
- loading, error
- limits object
- totalCount, totalPages, currentPage

**Filter/search state:**
- search, filter (type filter), orientationFilter
- viewMode ('grid' | 'list')

**Bulk selection state:**
- selectedIds (Set)
- toggleSelection, selectAll, deselectAll, clearSelection
- bulkActionLoading

**Modal state:**
- showAddMediaModal, showDetailModal, showDeleteConfirm
- showMoveModal, showAddToPlaylistModal, showPushToScreenModal
- editingAsset, deleteTarget
- playlists (for add-to-playlist picker)
- screens (for push-to-screen picker)

**Actions:**
- fetchAssets(page) - load media with current filters
- handleSearch, handleFilterChange, handleViewModeChange
- handleCreateAsset, handleUpdateAsset
- handleDelete (with usage check), handleDeleteConfirm
- handleMove, handleMoveConfirm
- handleBulkDelete, handleBulkDownload, handleBulkAddToPlaylist
- handleAddToPlaylist, handlePushToScreen
- handleDuplicateAsset

**Compose existing hooks:**
```javascript
// Inside useMediaLibrary
const folderHook = useMediaFolders(); // reuse for folder navigation
const uploadHook = useS3Upload(); // reuse for file upload

return {
  // Spread existing hook values
  ...folderHook, // currentFolderId, folderPath, folders, etc.
  ...uploadHook, // isUploading, uploadProgress, handleUpload
  // Add new state and actions
  mediaAssets, loading, error, limits,
  // ... etc
};
```

Hook signature:
```javascript
export function useMediaLibrary({ showToast }) {
  // Compose existing hooks
  const folders = useMediaFolders();
  const upload = useS3Upload();

  return {
    // From useMediaFolders
    ...folders,
    // From useS3Upload
    ...upload,
    // Media data
    mediaAssets, loading, error, limits,
    totalCount, totalPages, currentPage, setCurrentPage,
    // Filter/search
    search, setSearch, filter, setFilter,
    orientationFilter, setOrientationFilter,
    viewMode, setViewMode,
    // Bulk selection
    selectedIds, selectedCount, hasSelection,
    toggleSelection, selectAll, deselectAll, clearSelection,
    bulkActionLoading,
    // Modal state
    showAddMediaModal, setShowAddMediaModal,
    showDetailModal, setShowDetailModal,
    showDeleteConfirm, setShowDeleteConfirm,
    showMoveModal, setShowMoveModal,
    showAddToPlaylistModal, setShowAddToPlaylistModal,
    showPushToScreenModal, setShowPushToScreenModal,
    editingAsset, setEditingAsset,
    deleteTarget, setDeleteTarget,
    playlists, screens,
    // Actions
    fetchAssets, handleRefresh,
    handleCreateAsset, handleUpdateAsset,
    handleDelete, handleDeleteConfirm,
    handleMove, handleMoveConfirm,
    handleBulkDelete, handleBulkDownload, handleBulkAddToPlaylist,
    handleAddToPlaylist, handlePushToScreen,
    handleDuplicateAsset,
    handleReorderMedia,
  };
}
```

Use createScopedLogger('useMediaLibrary') for logging.

Update index.js:
```javascript
export { useMediaLibrary } from './useMediaLibrary.js';
```
  </action>
  <verify>
    - src/pages/hooks/useMediaLibrary.js exports useMediaLibrary function
    - Hook imports and composes useMediaFolders and useS3Upload
    - Hook handles media data, bulk selection, modals
    - index.js exports useMediaLibrary
  </verify>
  <done>
    - useMediaLibrary hook created composing existing hooks
    - Barrel export updated
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor MediaLibraryPage to use useMediaLibrary hook</name>
  <files>
    - src/pages/MediaLibraryPage.jsx
  </files>
  <action>
Update MediaLibraryPage.jsx to use the new useMediaLibrary hook:

1. Import hook: `import { useMediaLibrary } from './hooks';`

2. Remove direct useMediaFolders and useS3Upload imports (now composed in useMediaLibrary)

3. Call hook:
```javascript
const {
  // From useMediaFolders (via composition)
  currentFolderId, setCurrentFolderId, folderPath, folders,
  handleCreateFolder, handleNavigateFolder, handleNavigateUp,
  // From useS3Upload (via composition)
  isUploading, uploadProgress, handleUpload,
  // Media data
  mediaAssets, loading, error, limits,
  totalCount, totalPages, currentPage, setCurrentPage,
  // Filter/search
  search, setSearch, filter, setFilter,
  viewMode, setViewMode,
  // Bulk selection
  selectedIds, selectedCount, hasSelection,
  toggleSelection, selectAll, deselectAll, clearSelection,
  bulkActionLoading,
  // Modal state
  showAddMediaModal, setShowAddMediaModal,
  showDetailModal, setShowDetailModal,
  // ... other modals
  editingAsset, setEditingAsset,
  playlists, screens,
  // Actions
  fetchAssets, handleRefresh,
  handleDelete, handleDeleteConfirm,
  handleMove, handleBulkDelete, handleBulkDownload,
  handleAddToPlaylist, handlePushToScreen,
  handleDuplicateAsset,
} = useMediaLibrary({ showToast });
```

4. Remove all state declarations that moved to hook
5. Remove data loading functions and useEffects
6. Remove handler functions now in hook
7. Keep JSX rendering and inline sub-components:
   - LimitWarningBanner
   - MediaListRow
   - MediaGridCard
   - FolderGridCard
   - Pagination components
   - Modal rendering

The DropZoneOverlay integration should still work - the hook exposes upload state.

Target: Under 800 lines (largest page, has many inline sub-components).
  </action>
  <verify>
    - `npm run lint src/pages/MediaLibraryPage.jsx` passes
    - Page file is under 800 lines: `wc -l src/pages/MediaLibraryPage.jsx`
    - No direct imports of useMediaFolders or useS3Upload in page
  </verify>
  <done>
    - MediaLibraryPage.jsx uses useMediaLibrary hook
    - Page reduced from 2543 lines to under 800 lines
    - Existing hooks properly composed (not replaced)
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify page functionality and run tests</name>
  <files>None (verification only)</files>
  <action>
1. Run lint check:
```bash
npm run lint src/pages/MediaLibraryPage.jsx src/pages/hooks/useMediaLibrary.js
```

2. Run tests:
```bash
npm test -- --run
```

3. Verify line counts:
```bash
wc -l src/pages/MediaLibraryPage.jsx src/pages/hooks/useMediaLibrary.js
```

4. Verify hook composition (should NOT see direct imports in page):
```bash
grep -E "useMediaFolders|useS3Upload" src/pages/MediaLibraryPage.jsx
```
(Should return nothing or only the old import being removed)

Fix any issues before completing.
  </action>
  <verify>
    - Lint passes
    - Tests pass (allow pre-existing failures)
    - Line count targets met
    - useMediaFolders/useS3Upload not directly imported in page
  </verify>
  <done>
    - All linting passes
    - No new test regressions
    - Hook properly composes existing hooks
  </done>
</task>

</tasks>

<verification>
1. Hook created: `ls src/pages/hooks/useMediaLibrary.js`
2. Barrel export updated: `grep "useMediaLibrary" src/pages/hooks/index.js`
3. Page imports hook: `grep "useMediaLibrary" src/pages/MediaLibraryPage.jsx`
4. Line reduction: `wc -l src/pages/MediaLibraryPage.jsx` shows under 800 lines
5. Hook composition: useMediaLibrary.js contains `useMediaFolders` and `useS3Upload` calls
6. Lint passes: `npm run lint src/pages/MediaLibraryPage.jsx`
</verification>

<success_criteria>
- useMediaLibrary.js hook extracts media data, bulk selection, modals
- useMediaLibrary COMPOSES useMediaFolders and useS3Upload (not replaces)
- MediaLibraryPage.jsx reduced from 2543 to under 800 lines
- All existing functionality preserved (upload, folders, bulk, delete)
- Lint and existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-page-refactoring/08-05-SUMMARY.md`
</output>
