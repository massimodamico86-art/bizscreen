---
phase: 08-page-refactoring
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/pages/hooks/index.js
  - src/pages/hooks/useScreensData.js
  - src/pages/ScreensPage.jsx
autonomous: true

must_haves:
  truths:
    - "ScreensPage lists all screens with status badges"
    - "New screen can be created with OTP code"
    - "Screens can be assigned playlists, layouts, schedules"
    - "Device commands work (reboot, reload, clear cache)"
    - "Realtime updates reflect screen status changes"
    - "Analytics modal shows screen metrics"
    - "Kiosk mode can be configured"
  artifacts:
    - path: "src/pages/hooks/useScreensData.js"
      provides: "Screen data, picker data, realtime subscription, device commands"
      min_lines: 300
    - path: "src/pages/ScreensPage.jsx"
      provides: "Refactored page using useScreensData hook"
      max_lines: 700
  key_links:
    - from: "src/pages/ScreensPage.jsx"
      to: "src/pages/hooks/useScreensData.js"
      via: "import { useScreensData }"
      pattern: "useScreensData"
    - from: "src/pages/hooks/useScreensData.js"
      to: "services/screenService"
      via: "fetchScreens, createScreen, device commands"
      pattern: "screenService"
---

<objective>
Extract custom hook from ScreensPage.jsx to reduce complexity.

Purpose: ScreensPage (1931 lines) has high complexity with screen data, realtime subscriptions, device commands, bulk operations, and multiple modals. Extracting to useScreensData isolates data and command logic.

Output: useScreensData.js hook, updated barrel export, refactored page under ~600 lines.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-page-refactoring/08-RESEARCH.md

# Reference patterns
@src/player/hooks/usePlayerContent.js
@src/player/hooks/usePlayerCommands.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useScreensData hook</name>
  <files>
    - src/pages/hooks/useScreensData.js
    - src/pages/hooks/index.js
  </files>
  <action>
Create useScreensData.js hook that extracts from ScreensPage.jsx:

**Screen data state:**
- screens array
- playlists, layouts, schedules, locations, screenGroups arrays (for assignment pickers)
- limits object
- loading, error

**Filter/search state:**
- search, filter, selectedGroup

**Modal state:**
- showAddModal, showDeleteConfirm, showLimitModal
- showAnalyticsModal, showKioskModal, showInsertContentModal
- selectedScreen (for detail drawer)
- editingScreen (for modals)
- analyticsData, analyticsLoading

**Realtime:**
- Set up supabase realtime subscription for screen status updates
- Return cleanup function for useEffect

**Device commands:**
- handleReboot, handleReload, handleClearCache, handleReset
- handleSetKioskMode

**Screen CRUD:**
- handleCreateScreen, handleUpdateScreen, handleDeleteScreen
- handleAssignPlaylist, handleAssignLayout, handleAssignSchedule
- handleAssignLocation

Hook signature:
```javascript
export function useScreensData({ showToast }) {
  return {
    // Data
    screens, playlists, layouts, schedules, locations, screenGroups, limits,
    loading, error,
    // Filter/search
    search, setSearch, filter, setFilter, selectedGroup, setSelectedGroup,
    filteredScreens, // computed
    // Modal state
    showAddModal, setShowAddModal,
    showDeleteConfirm, setShowDeleteConfirm,
    showLimitModal, setShowLimitModal,
    showAnalyticsModal, setShowAnalyticsModal,
    showKioskModal, setShowKioskModal,
    showInsertContentModal, setShowInsertContentModal,
    selectedScreen, setSelectedScreen,
    editingScreen, setEditingScreen,
    analyticsData, analyticsLoading,
    // Actions
    loadData, handleRefresh,
    handleCreateScreen, handleUpdateScreen, handleDeleteScreen,
    handleAssignPlaylist, handleAssignLayout, handleAssignSchedule, handleAssignLocation,
    handleReboot, handleReload, handleClearCache, handleReset,
    handleSetKioskMode,
    handleLoadAnalytics,
    handleCopyOTP,
  };
}
```

Realtime subscription pattern (cleanup in useEffect):
```javascript
useEffect(() => {
  const channel = supabase
    .channel('screens-page')
    .on('postgres_changes', { event: '*', schema: 'public', table: 'tv_devices' }, handleScreenUpdate)
    .subscribe();

  return () => { supabase.removeChannel(channel); };
}, []);
```

Use createScopedLogger('useScreensData') for logging.

Update index.js:
```javascript
export { useScreensData } from './useScreensData.js';
```
  </action>
  <verify>
    - src/pages/hooks/useScreensData.js exports useScreensData function
    - Hook handles screens, picker data, realtime, commands
    - index.js exports useScreensData
  </verify>
  <done>
    - useScreensData hook created with screen data, realtime, commands
    - Barrel export updated
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor ScreensPage to use useScreensData hook</name>
  <files>
    - src/pages/ScreensPage.jsx
  </files>
  <action>
Update ScreensPage.jsx to use the new useScreensData hook:

1. Import hook: `import { useScreensData } from './hooks';`

2. Call hook:
```javascript
const {
  screens, playlists, layouts, schedules, locations, screenGroups, limits,
  loading, error,
  search, setSearch, filter, setFilter, selectedGroup, setSelectedGroup,
  filteredScreens,
  showAddModal, setShowAddModal,
  // ... all modal state
  selectedScreen, setSelectedScreen,
  editingScreen, setEditingScreen,
  analyticsData, analyticsLoading,
  loadData, handleRefresh,
  handleCreateScreen, handleUpdateScreen, handleDeleteScreen,
  handleAssignPlaylist, handleAssignLayout, handleAssignSchedule, handleAssignLocation,
  handleReboot, handleReload, handleClearCache, handleReset,
  handleSetKioskMode,
  handleLoadAnalytics,
  handleCopyOTP,
} = useScreensData({ showToast });
```

3. Remove all state declarations that moved to hook
4. Remove data loading, realtime subscription setup
5. Remove handler functions now in hook
6. Keep JSX rendering and inline sub-components:
   - DemoPairingBanner
   - LimitWarningBanner
   - NoScreensState
   - PromoCards
   - ScreenRow
   - ScreenActionMenu
   - AddScreenModal
   - LimitReachedModal
   - AnalyticsModal
   - ScreensErrorState
   - KioskModeModal

These sub-components are inline functions that can remain in the page file since they're tightly coupled to the page UI.

Target: Under 700 lines.
  </action>
  <verify>
    - `npm run lint src/pages/ScreensPage.jsx` passes
    - Page file is under 700 lines: `wc -l src/pages/ScreensPage.jsx`
  </verify>
  <done>
    - ScreensPage.jsx uses useScreensData hook
    - Page reduced from 1931 lines to under 700 lines
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify page functionality</name>
  <files>None (verification only)</files>
  <action>
1. Run lint check:
```bash
npm run lint src/pages/ScreensPage.jsx src/pages/hooks/useScreensData.js
```

2. Run tests:
```bash
npm test -- --run
```

3. Verify line counts:
```bash
wc -l src/pages/ScreensPage.jsx src/pages/hooks/useScreensData.js
```

Fix any issues before completing.
  </action>
  <verify>
    - Lint passes
    - Tests pass (allow pre-existing failures)
    - Line count targets met
  </verify>
  <done>
    - All linting passes
    - No new test regressions
  </done>
</task>

</tasks>

<verification>
1. Hook created: `ls src/pages/hooks/useScreensData.js`
2. Barrel export updated: `grep "useScreensData" src/pages/hooks/index.js`
3. Page imports hook: `grep "useScreensData" src/pages/ScreensPage.jsx`
4. Line reduction: `wc -l src/pages/ScreensPage.jsx` shows under 700 lines
5. Lint passes: `npm run lint src/pages/ScreensPage.jsx`
</verification>

<success_criteria>
- useScreensData.js hook extracts screen data, realtime subscription, device commands
- ScreensPage.jsx reduced from 1931 to under 700 lines
- All existing functionality preserved (list, create, assign, commands, analytics)
- Realtime subscription properly set up with cleanup
- Lint and existing tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/08-page-refactoring/08-04-SUMMARY.md`
</output>
